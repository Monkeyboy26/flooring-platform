<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme-color" content="#1c1917">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Roma Admin">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <title>Admin - Roma Flooring Designs</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --stone-50: #fafaf9;
      --stone-100: #f5f5f4;
      --stone-200: #e7e5e4;
      --stone-300: #d6d3d1;
      --stone-400: #a8a29e;
      --stone-500: #78716c;
      --stone-600: #57534e;
      --stone-700: #44403c;
      --stone-800: #292524;
      --stone-900: #1c1917;
      --gold: #c9a668;
      --gold-light: #d4b87a;
      --green: #16a34a;
      --green-light: #dcfce7;
      --red: #dc2626;
      --red-light: #fee2e2;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--stone-50);
      color: var(--stone-800);
    }

    /* Auth Gate */
    .auth-gate {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--stone-100) 0%, var(--stone-200) 100%);
    }
    .auth-box {
      background: white;
      padding: 3rem;
      width: 400px;
      max-width: 90vw;
      border: 1px solid var(--stone-200);
    }
    .auth-box h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }
    .auth-box p {
      color: var(--stone-600);
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }
    .auth-box input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--stone-200);
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
      margin-bottom: 1rem;
    }
    .auth-box input:focus { outline: none; border-color: var(--gold); }
    .auth-error {
      color: var(--red);
      font-size: 0.8125rem;
      margin-bottom: 1rem;
    }

    /* Layout */
    .admin-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .admin-sidebar {
      background: var(--stone-900);
      color: white;
      padding: 2rem 0;
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .sidebar-logo {
      padding: 0 1.5rem;
      margin-bottom: 0.25rem;
    }
    .sidebar-logo img {
      width: 100px;
      height: auto;
      display: block;
    }
    .sidebar-subtitle {
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--stone-500);
      padding: 0 1.5rem;
      margin-bottom: 2.5rem;
    }
    .sidebar-nav { flex: 1; }
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      color: var(--stone-400);
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
    }
    .sidebar-item:hover {
      color: white;
      background: rgba(255,255,255,0.05);
    }
    .sidebar-item.active {
      color: white;
      background: rgba(255,255,255,0.08);
      border-left-color: var(--gold);
    }
    .sidebar-item svg { width: 18px; height: 18px; flex-shrink: 0; }
    .sidebar-logout {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--stone-700);
    }

    /* Content area */
    .admin-content {
      padding: 2rem 2.5rem;
      min-height: 100vh;
    }
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .content-header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 300;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.8125rem;
      font-family: 'Inter', sans-serif;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .btn-primary { background: var(--stone-900); color: white; }
    .btn-primary:hover { background: var(--gold); }
    .btn-secondary { background: white; color: var(--stone-800); border: 1px solid var(--stone-300); }
    .btn-secondary:hover { background: var(--stone-100); }
    .btn-danger { background: var(--red); color: white; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-link { background: none; border: none; color: var(--stone-600); cursor: pointer; font-size: 0.8125rem; padding: 0.2rem 0.4rem; text-decoration: underline; }
    .btn-link:hover { color: var(--stone-900); }
    .btn-link-danger { color: var(--red); }
    .btn-link-danger:hover { color: #b91c1c; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.75rem; }

    /* Stat cards */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }
    .stat-card {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 1.5rem;
    }
    .stat-card-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-500);
      margin-bottom: 0.5rem;
    }
    .stat-card-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      font-weight: 400;
      color: var(--stone-900);
    }

    /* Tables */
    .admin-table {
      width: 100%;
      background: white;
      border: 1px solid var(--stone-200);
      border-collapse: collapse;
    }
    .admin-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--stone-500);
      border-bottom: 2px solid var(--stone-200);
      background: var(--stone-50);
    }
    .admin-table td {
      padding: 0.875rem 1rem;
      font-size: 0.875rem;
      border-bottom: 1px solid var(--stone-100);
      vertical-align: middle;
    }
    .admin-table tr:hover td { background: var(--stone-50); }
    .admin-table .actions { white-space: nowrap; }
    .admin-table .actions button { margin-right: 0.5rem; }

    /* Status badges */
    .badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-radius: 2px;
    }
    .badge-active { background: var(--green-light); color: var(--green); }
    .badge-draft { background: var(--stone-100); color: var(--stone-500); }
    .badge-inactive { background: var(--red-light); color: var(--red); }
    .badge-pending { background: #fef3c7; color: #d97706; }
    .badge-confirmed { background: var(--green-light); color: var(--green); }
    .badge-shipped { background: #dbeafe; color: #2563eb; }
    .badge-delivered { background: var(--green-light); color: #15803d; }
    .badge-cancelled { background: var(--red-light); color: var(--red); }
    .badge-refunded { background: #ede9fe; color: #6d28d9; }
    .badge-running { background: #fef3c7; color: #d97706; }
    .badge-completed { background: var(--green-light); color: var(--green); }
    .badge-failed { background: var(--red-light); color: var(--red); }
    .badge-cancelled { background: #fef3c7; color: #92400e; }
    .badge-contacted { background: #dbeafe; color: #2563eb; }
    .badge-quoted { background: #f3e8ff; color: #9333ea; }
    .badge-scheduled { background: #ccfbf1; color: #0d9488; }
    .badge-closed { background: var(--stone-100); color: var(--stone-500); }
    .badge-new { background: #fef3c7; color: #d97706; }
    .badge-sent { background: #dbeafe; color: #2563eb; }
    .badge-acknowledged { background: #fef3c7; color: #d97706; }
    .badge-fulfilled { background: var(--green-light); color: #15803d; }

    /* Order Status Stepper */
    .order-stepper {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      position: relative;
      padding: 0.5rem 0 1rem;
    }
    .stepper-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    .stepper-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      border: 2px solid var(--stone-300);
      background: white;
      color: var(--stone-400);
      transition: all 0.3s ease;
    }
    .stepper-step.completed .stepper-circle {
      background: var(--green);
      border-color: var(--green);
      color: white;
    }
    .stepper-step.current .stepper-circle {
      border-color: var(--gold);
      background: white;
      color: var(--gold);
      box-shadow: 0 0 0 4px rgba(180, 151, 90, 0.15);
      animation: stepper-pulse 2s ease-in-out infinite;
    }
    @keyframes stepper-pulse {
      0%, 100% { box-shadow: 0 0 0 4px rgba(180, 151, 90, 0.15); }
      50% { box-shadow: 0 0 0 8px rgba(180, 151, 90, 0.08); }
    }
    .stepper-step.cancelled .stepper-circle {
      background: var(--red);
      border-color: var(--red);
      color: white;
    }
    .stepper-label {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-400);
    }
    .stepper-step.completed .stepper-label { color: var(--green); font-weight: 600; }
    .stepper-step.current .stepper-label { color: var(--stone-800); font-weight: 700; }
    .stepper-step.cancelled .stepper-label { color: var(--red); font-weight: 600; }
    .stepper-timestamp {
      font-size: 0.6875rem;
      color: var(--stone-400);
      margin-top: 0.2rem;
    }
    .stepper-connector {
      position: absolute;
      top: 18px;
      height: 2px;
      background: var(--stone-200);
      border: none;
      z-index: 0;
    }
    .stepper-connector.completed {
      background: var(--green);
    }
    .stepper-connector.upcoming {
      background: transparent;
      border-top: 2px dashed var(--stone-300);
    }
    .stepper-cancelled-banner {
      background: var(--red-light);
      border: 1px solid var(--red);
      color: var(--red);
      text-align: center;
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }
    .stepper-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1.5rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--stone-100);
    }
    .stepper-cancel-link {
      background: none;
      border: none;
      color: var(--stone-400);
      font-size: 0.8125rem;
      cursor: pointer;
      text-decoration: underline;
      font-family: 'Inter', sans-serif;
      padding: 0;
    }
    .stepper-cancel-link:hover { color: var(--red); }
    .stepper-revert-link {
      background: none;
      border: none;
      color: var(--stone-400);
      font-size: 0.8125rem;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      padding: 0.35rem 0.75rem;
      border: 1px solid var(--stone-300);
      transition: all 0.15s ease;
    }
    .stepper-revert-link:hover { color: var(--stone-700); border-color: var(--stone-400); background: var(--stone-50); }
    .stepper-tracking-info {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: var(--stone-50);
      border: 1px solid var(--stone-200);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      font-size: 0.8125rem;
    }

    .order-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .order-info-item label {
      display: block;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-500);
      margin-bottom: 0.25rem;
    }
    .order-info-item span {
      font-size: 0.875rem;
      color: var(--stone-800);
    }

    /* Toggle switch */
    .toggle {
      position: relative;
      width: 40px;
      height: 22px;
      background: var(--stone-300);
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle.on { background: var(--green); }
    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle.on::after { transform: translateX(18px); }

    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.25rem;
    }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-600);
      margin-bottom: 0.4rem;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--stone-300);
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
      background: white;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--gold);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-card {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    .form-card h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--stone-200);
    }
    .form-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .form-card-header h3 {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .form-card-header .toggle-icon {
      font-size: 1.25rem;
      color: var(--stone-400);
      transition: transform 0.2s ease;
      line-height: 1;
    }
    .form-card-header .toggle-icon.collapsed { transform: rotate(-90deg); }
    .form-card.collapsed { padding-bottom: 0; }
    .form-card.collapsed .form-card-body { display: none; }
    .form-card .form-card-body {
      padding-top: 1rem;
      border-top: 1px solid var(--stone-200);
      margin-top: 0.75rem;
    }

    /* SKU cards */
    .sku-card {
      background: var(--stone-50);
      border: 1px solid var(--stone-200);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .sku-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .sku-card-header h4 {
      font-size: 0.875rem;
      font-weight: 600;
    }

    /* Category tree */
    .cat-tree-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--stone-100);
      background: white;
    }
    .cat-tree-item:hover { background: var(--stone-50); }
    .cat-tree-child {
      padding-left: 2.5rem;
      font-size: 0.875rem;
    }
    .cat-tree-parent { font-weight: 600; }
    .cat-tree-slug {
      font-size: 0.75rem;
      color: var(--stone-400);
      margin-left: 0.75rem;
    }
    .cat-tree-count {
      font-size: 0.75rem;
      color: var(--stone-500);
      background: var(--stone-100);
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      margin-left: 0.5rem;
    }

    /* Delete confirm modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-box {
      background: white;
      padding: 2rem;
      width: 420px;
      max-width: 90vw;
    }
    .modal-box h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 1rem;
    }
    .modal-box p {
      color: var(--stone-600);
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--stone-400);
      font-size: 0.875rem;
    }

    /* Bulk actions toolbar */
    .bulk-toolbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--stone-900);
      color: white;
      margin-bottom: 1rem;
      font-size: 0.8125rem;
    }
    .bulk-toolbar .bulk-count {
      font-weight: 600;
      margin-right: auto;
    }
    .bulk-toolbar select {
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--stone-600);
      background: var(--stone-800);
      color: white;
      cursor: pointer;
    }
    .bulk-toolbar select:focus { outline: none; border-color: var(--gold); }
    .admin-table input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
      accent-color: var(--gold);
    }
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .filter-bar input,
    .filter-bar select {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--stone-300);
      background: white;
      color: var(--stone-800);
    }
    .filter-bar input:focus,
    .filter-bar select:focus {
      outline: none;
      border-color: var(--gold);
    }
    .filter-bar input[type="text"] { min-width: 220px; }
    .filter-bar .filter-count {
      margin-left: auto;
      font-size: 0.75rem;
      color: var(--stone-400);
    }
    .admin-table th.sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    .admin-table th.sortable:hover { color: var(--gold); }
    .admin-table th .sort-arrow {
      display: inline-block;
      margin-left: 0.25rem;
      font-size: 0.625rem;
      vertical-align: middle;
      color: var(--stone-400);
    }
    .admin-table th.sorted .sort-arrow { color: var(--gold); }

    /* Media Manager */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
    }
    .media-card {
      position: relative;
      border: 1px solid var(--stone-200);
      background: white;
      border-radius: 8px;
      overflow: hidden;
      cursor: grab;
    }
    .media-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
    }
    .media-card-info {
      padding: 0.5rem 0.625rem;
      font-size: 0.75rem;
    }
    .media-card-type {
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--stone-500);
      font-size: 0.65rem;
      margin-bottom: 0.25rem;
    }
    .media-card-actions {
      display: flex;
      gap: 0.375rem;
    }
    .media-card-actions button {
      font-size: 0.65rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--stone-200);
      background: var(--stone-50);
      cursor: pointer;
    }
    .media-card-actions button:hover { border-color: var(--stone-400); }
    .media-card-actions button.delete-btn { color: var(--red); border-color: var(--red-light); }
    .media-card-actions button.delete-btn:hover { background: var(--red-light); }
    .media-card.dragging {
      opacity: 0.5;
      border: 2px dashed var(--gold);
    }
    .media-upload-zone {
      border: 2px dashed var(--stone-300);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      color: var(--stone-400);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
    }
    .media-upload-zone:hover { border-color: var(--gold); color: var(--stone-600); }
    .media-upload-zone.drag-active {
      border-color: var(--gold);
      background: rgba(201, 166, 104, 0.06);
      color: var(--gold);
    }
    .media-url-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .media-url-form input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--stone-200);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    /* Analytics */
    .analytics-period-bar {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .period-btn {
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      font-family: 'Inter', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border: 1px solid var(--stone-300);
      background: white;
      color: var(--stone-600);
      cursor: pointer;
      transition: all 0.15s;
    }
    .period-btn:hover { border-color: var(--gold); color: var(--stone-800); }
    .period-btn.active {
      background: var(--gold);
      color: white;
      border-color: var(--gold);
    }
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .analytics-two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .chart-container {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .chart-container h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--stone-200);
    }
    .vendor-margin-bar {
      display: inline-block;
      height: 8px;
      background: var(--stone-200);
      border-radius: 4px;
      width: 100px;
      position: relative;
      vertical-align: middle;
    }
    .vendor-margin-bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: var(--gold);
      border-radius: 4px;
    }
    /* Mobile Top Bar */
    .mobile-topbar {
      display: none;
      position: sticky; top: 0; z-index: 90;
      height: 56px; background: var(--stone-900); color: white;
      padding: 0 1rem; align-items: center; justify-content: space-between;
    }
    .mobile-topbar .hamburger-btn {
      background: none; border: none; color: white;
      cursor: pointer; padding: 0.5rem;
    }
    /* Sidebar Backdrop */
    .sidebar-backdrop {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 98;
    }
    .sidebar-backdrop.visible { display: block; }
    /* Table Scroll Wrapper */
    .table-scroll-wrapper {
      overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    /* Responsive Grid Utilities */
    .resp-grid-2 { display: grid; grid-template-columns: 1fr 1fr; }
    .resp-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; }

    @media (max-width: 1024px) {
      .admin-content { padding: 1.5rem; }
      .stat-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
      .filter-bar input[type="text"] { min-width: 160px; }
    }

    @media (max-width: 900px) {
      .analytics-grid { grid-template-columns: repeat(2, 1fr); }
      .analytics-two-col { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .mobile-topbar { display: flex; }
      .admin-layout { grid-template-columns: 1fr; }
      .admin-sidebar {
        position: fixed; top: 0; left: -260px; width: 260px;
        height: 100vh; z-index: 99; transition: left 0.3s ease;
      }
      .admin-sidebar.open { left: 0; }
      .admin-content { padding: 1rem; }
      .content-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .content-header h1 { font-size: 1.5rem; }
      .stat-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; }
      .form-grid { grid-template-columns: 1fr; }
      .order-info-grid { grid-template-columns: 1fr; }
      .resp-grid-2, .resp-grid-3 { grid-template-columns: 1fr !important; }
      .admin-table, .data-table { min-width: 600px; }
      .filter-bar { flex-direction: column; align-items: stretch; }
      .filter-bar input[type="text"] { min-width: unset; width: 100%; }
      .filter-bar select { width: 100%; }
      .bulk-toolbar { flex-wrap: wrap; gap: 0.5rem; }
      .bulk-toolbar .bulk-count { width: 100%; }
      .form-card { padding: 1.25rem; }
      .modal-box { padding: 1.25rem; max-height: 90vh; }
      .sidebar-item { padding: 0.875rem 1.5rem; }
      .order-stepper { flex-wrap: wrap; gap: 0.5rem; }
      .stepper-connector { display: none; }
      .analytics-grid { grid-template-columns: 1fr !important; }
      .analytics-two-col { grid-template-columns: 1fr !important; }
      .media-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }

    @media (max-width: 480px) {
      .admin-content { padding: 0.75rem; }
      .content-header h1 { font-size: 1.25rem; }
      .stat-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
      .form-card { padding: 1rem; }
      .auth-box { padding: 1.5rem; }
      .filter-bar input, .filter-bar select,
      .form-group input, .form-group select, .form-group textarea { font-size: 1rem; }
      .media-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useCallback, useRef } = React;

        const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3001'
      : `${window.location.protocol}//${window.location.hostname}:3001`;

    // ========== Admin Fetch Helper ==========
    function getAuthHeaders() {
      const staffToken = sessionStorage.getItem('staff_token');
      if (staffToken) return { 'X-Staff-Token': staffToken };
      return {};
    }

    function adminFetch(path, options = {}) {
      return fetch(API + path, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...getAuthHeaders(),
          ...(options.headers || {})
        }
      }).then(r => {
        if (r.status === 401) {
          sessionStorage.removeItem('staff_token');
          sessionStorage.removeItem('staff_data');
          window.location.reload();
          throw new Error('Unauthorized');
        }
        const ct = r.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          throw new Error('Server returned non-JSON (status ' + r.status + '). Is the API running?');
        }
        return r.json();
      });
    }

    function adminUpload(path, file) {
      const formData = new FormData();
      formData.append('file', file);
      return fetch(API + path, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: formData
      }).then(r => {
        if (r.status === 401) {
          sessionStorage.removeItem('staff_token');
          sessionStorage.removeItem('staff_data');
          window.location.reload();
          throw new Error('Unauthorized');
        }
        return r.json();
      });
    }

    // ========== AdminApp ==========
    function AdminApp() {
      const [authed, setAuthed] = useState(false);
      const [checking, setChecking] = useState(true);
      const [staffData, setStaffData] = useState(null);

      useEffect(() => {
        // Check for existing staff session
        const token = sessionStorage.getItem('staff_token');
        const saved = sessionStorage.getItem('staff_data');
        if (token && saved) {
          fetch(API + '/api/staff/me', { headers: { 'X-Staff-Token': token } })
            .then(r => {
              if (r.ok) return r.json();
              throw new Error('Invalid session');
            })
            .then(data => {
              setStaffData(data.staff);
              setAuthed(true);
              setChecking(false);
            })
            .catch(() => {
              sessionStorage.removeItem('staff_token');
              sessionStorage.removeItem('staff_data');
              setChecking(false);
            });
          return;
        }
        setChecking(false);
      }, []);

      const handleLogout = () => {
        const token = sessionStorage.getItem('staff_token');
        if (token) {
          fetch(API + '/api/staff/logout', {
            method: 'POST',
            headers: { 'X-Staff-Token': token }
          }).catch(() => {});
        }
        sessionStorage.removeItem('staff_token');
        sessionStorage.removeItem('staff_data');
        setAuthed(false);
        setStaffData(null);
      };

      const handleAuth = (data) => {
        setStaffData(data);
        setAuthed(true);
      };

      if (checking) return React.createElement('div', { className: 'loading' }, 'Loading...');
      if (!authed) return React.createElement(AuthGate, { onAuth: handleAuth });
      return React.createElement(AdminLayout, { onLogout: handleLogout, staffData });
    }

    // ========== AuthGate ==========
    function AuthGate({ onAuth }) {
      const [mode, setMode] = useState('checking'); // 'checking', 'setup', 'login'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [firstName, setFirstName] = useState('');
      const [lastName, setLastName] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        fetch(API + '/api/staff/setup-check')
          .then(r => r.json())
          .then(data => setMode(data.needs_setup ? 'setup' : 'login'))
          .catch(() => setMode('login'));
      }, []);

      const [needs2FA, setNeeds2FA] = useState(false);
      const [twoFACode, setTwoFACode] = useState('');
      const [twoFAStaffId, setTwoFAStaffId] = useState(null);
      const [rememberDevice, setRememberDevice] = useState(true);

      const handleLogin = (e) => {
        e.preventDefault();
        if (!email.trim() || !password) return;
        setLoading(true);
        setError('');
        fetch(API + '/api/staff/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email.trim(), password, device_fingerprint: navigator.userAgent })
        })
          .then(r => r.json().then(data => ({ ok: r.ok, data })))
          .then(({ ok, data }) => {
            if (ok && data.requires_2fa) {
              setNeeds2FA(true);
              setTwoFAStaffId(data.staff_id);
              setLoading(false);
            } else if (ok) {
              sessionStorage.setItem('staff_token', data.token);
              sessionStorage.setItem('staff_data', JSON.stringify(data.staff));
              onAuth(data.staff);
            } else {
              setError(data.error || 'Login failed');
            }
            setLoading(false);
          })
          .catch(() => { setError('Cannot reach API'); setLoading(false); });
      };

      const handleVerify2FA = (e) => {
        e.preventDefault();
        if (!twoFACode) return;
        setLoading(true);
        setError('');
        fetch(API + '/api/staff/verify-2fa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ staff_id: twoFAStaffId, code: twoFACode, trust_device: rememberDevice, device_fingerprint: navigator.userAgent })
        })
          .then(r => r.json().then(data => ({ ok: r.ok, data })))
          .then(({ ok, data }) => {
            if (ok) {
              sessionStorage.setItem('staff_token', data.token);
              sessionStorage.setItem('staff_data', JSON.stringify(data.staff));
              onAuth(data.staff);
            } else {
              setError(data.error || 'Invalid code');
            }
            setLoading(false);
          })
          .catch(() => { setError('Cannot reach API'); setLoading(false); });
      };

      const resend2FA = () => {
        fetch(API + '/api/staff/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email.trim(), password, device_fingerprint: navigator.userAgent })
        }).then(() => setError('')).catch(() => {});
      };

      const handleSetup = (e) => {
        e.preventDefault();
        if (!email.trim() || !password || !firstName.trim() || !lastName.trim()) return;
        setLoading(true);
        setError('');
        fetch(API + '/api/staff/setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email.trim(), password, first_name: firstName.trim(), last_name: lastName.trim() })
        })
          .then(r => r.json().then(data => ({ ok: r.ok, data })))
          .then(({ ok, data }) => {
            if (ok) {
              sessionStorage.setItem('staff_token', data.token);
              sessionStorage.setItem('staff_data', JSON.stringify(data.staff));
              onAuth(data.staff);
            } else {
              setError(data.error || 'Setup failed');
            }
            setLoading(false);
          })
          .catch(() => { setError('Cannot reach API'); setLoading(false); });
      };

      if (mode === 'checking') return <div className="loading">Loading...</div>;

      if (mode === 'setup') {
        return (
          <div className="auth-gate">
            <form className="auth-box" onSubmit={handleSetup}>
              <h1>Welcome</h1>
              <p>Create your admin account to get started</p>
              {error && <div className="auth-error">{error}</div>}
              <input type="text" placeholder="First Name" value={firstName} onChange={e => setFirstName(e.target.value)} autoFocus />
              <input type="text" placeholder="Last Name" value={lastName} onChange={e => setLastName(e.target.value)} />
              <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} />
              <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} />
              <button className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>
                {loading ? 'Creating Account...' : 'Create Admin Account'}
              </button>
            </form>
          </div>
        );
      }

      if (needs2FA) {
        return (
          <div className="auth-gate">
            <form className="auth-box" onSubmit={handleVerify2FA}>
              <h1>Verification</h1>
              <p>A 6-digit code was sent to your email. Enter it below.</p>
              {error && <div className="auth-error">{error}</div>}
              <input type="text" placeholder="Enter 6-digit code" value={twoFACode} onChange={e => setTwoFACode(e.target.value.replace(/\D/g, '').slice(0, 6))} autoFocus
                style={{ textAlign: 'center', letterSpacing: '0.3em', fontSize: '1.5rem' }} />
              <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.8125rem', color: 'var(--stone-600)', margin: '0.5rem 0 1rem' }}>
                <input type="checkbox" checked={rememberDevice} onChange={e => setRememberDevice(e.target.checked)} />
                Trust this device for 30 days
              </label>
              <button className="btn btn-primary" style={{ width: '100%' }} disabled={loading || twoFACode.length < 6}>
                {loading ? 'Verifying...' : 'Verify'}
              </button>
              <div style={{ textAlign: 'center', marginTop: '1rem' }}>
                <a onClick={resend2FA} style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', cursor: 'pointer', textDecoration: 'underline' }}>Resend code</a>
              </div>
            </form>
          </div>
        );
      }

      return (
        <div className="auth-gate">
          <form className="auth-box" onSubmit={handleLogin}>
            <h1>Admin Dashboard</h1>
            <p>Sign in with your staff account</p>
            {error && <div className="auth-error">{error}</div>}
            <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} autoFocus />
            <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} />
            <button className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>
              {loading ? 'Signing in...' : 'Sign In'}
            </button>
          </form>
        </div>
      );
    }

    // ========== AdminLayout ==========
    function AdminLayout({ onLogout, staffData }) {
      const [view, setView] = useState('dashboard');
      const [editId, setEditId] = useState(null);
      const scrollPositions = React.useRef({});
      const pendingScroll = React.useRef(null);
      const staffRole = staffData ? staffData.role : 'admin';
      const [sidebarOpen, setSidebarOpen] = useState(false);

      useEffect(() => {
        const mq = window.matchMedia('(min-width: 769px)');
        const handler = (e) => { if (e.matches) setSidebarOpen(false); };
        mq.addEventListener('change', handler);
        return () => mq.removeEventListener('change', handler);
      }, []);

      const navigate = (v, id) => {
        scrollPositions.current[view] = window.scrollY;
        setSidebarOpen(false);
        setView(v);
        setEditId(id || null);
        if (scrollPositions.current[v] != null) {
          pendingScroll.current = scrollPositions.current[v];
        } else {
          window.scrollTo(0, 0);
        }
      };

      const consumePendingScroll = () => {
        if (pendingScroll.current != null) {
          const y = pendingScroll.current;
          pendingScroll.current = null;
          requestAnimationFrame(() => window.scrollTo(0, y));
        }
      };

      const allNavItems = [
        { key: 'dashboard', label: 'Dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4', roles: ['admin', 'manager', 'sales_rep', 'warehouse'] },
        { key: 'orders', label: 'Orders', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01', roles: ['admin', 'manager', 'sales_rep', 'warehouse'] },
        { key: 'customers', label: 'Customers', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z', roles: ['admin', 'manager', 'sales_rep'] },
        { key: 'products', label: 'Products', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4', roles: ['admin', 'manager'] },
        { key: 'vendors', label: 'Vendors', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', roles: ['admin', 'manager'] },
        { key: 'categories', label: 'Categories', icon: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z', roles: ['admin', 'manager'] },
        { key: 'scrapers', label: 'Scrapers', icon: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9', roles: ['admin', 'manager'] },
        { key: 'trade', label: 'Trade', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z', roles: ['admin', 'manager', 'sales_rep'] },
        { key: 'promos', label: 'Promo Codes', icon: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4zM17 3h2a2 2 0 012 2v2', roles: ['admin', 'manager'] },
        { key: 'inquiries', label: 'Inquiries', icon: 'M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085', roles: ['admin', 'manager', 'sales_rep'] },
        { key: 'staff', label: 'Staff', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', roles: ['admin', 'manager'] },
        { key: 'audit', label: 'Audit Log', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', roles: ['admin', 'manager'] },
        { key: 'edi', label: 'EDI', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4', roles: ['admin', 'manager'] },
      ];

      const navItems = allNavItems.filter(item => item.roles.includes(staffRole));

      const activeBase = view === 'inquiry-detail' ? 'inquiries' :
                          view.split('-')[0] === 'product' ? 'products' :
                          view.split('-')[0] === 'vendor' ? 'vendors' :
                          view.split('-')[0] === 'category' ? 'categories' :
                          view.split('-')[0] === 'customer' ? 'customers' :
                          view.split('-')[0] === 'order' ? 'orders' :
                          view.split('-')[0] === 'scraper' || view === 'scrapers' ? 'scrapers' :
                          view.split('-')[0] === 'promo' || view === 'promos' ? 'promos' :
                          view.split('-')[0] === 'trade' ? 'trade' :
                          view.split('-')[0] === 'staff' ? 'staff' :
                          view === 'audit' ? 'audit' : view;

      return (
        <div className="admin-layout">
          <div className="mobile-topbar">
            <button className="hamburger-btn" onClick={() => setSidebarOpen(true)}>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            <img src="/assets/logo/roma-square.png" alt="Roma" style={{ height: 32 }} />
            <div style={{ width: 40 }}></div>
          </div>
          <div className={'sidebar-backdrop' + (sidebarOpen ? ' visible' : '')} onClick={() => setSidebarOpen(false)}></div>
          <div className={'admin-sidebar' + (sidebarOpen ? ' open' : '')}>
            <div className="sidebar-logo"><img src="/assets/logo/roma-square.png" alt="Roma Flooring Designs" /></div>
            <div className="sidebar-subtitle">Admin Panel</div>
            <div className="sidebar-nav">
              {navItems.map(item => (
                <div
                  key={item.key}
                  className={'sidebar-item' + (activeBase === item.key ? ' active' : '')}
                  onClick={() => navigate(item.key)}
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d={item.icon} />
                  </svg>
                  {item.label}
                </div>
              ))}
            </div>
            <div className="sidebar-logout">
              {staffData && <div style={{ padding: '0 1.5rem 0.75rem', fontSize: '0.75rem', color: 'var(--stone-500)' }}>
                {staffData.first_name} {staffData.last_name}
                <br /><span style={{ textTransform: 'capitalize' }}>{(staffData.role || '').replace('_', ' ')}</span>
              </div>}
              <div className="sidebar-item" onClick={onLogout}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
              </div>
            </div>
          </div>
          <div className="admin-content">
            {view === 'dashboard' && <DashboardView navigate={navigate} />}
            {view === 'orders' && <OrdersListView navigate={navigate} />}
            {view === 'order-detail' && <OrderDetailView navigate={navigate} editId={editId} staffRole={staffRole} />}
            {view === 'customers' && <CustomersListView navigate={navigate} />}
            {view === 'customer-detail' && <CustomerDetailView navigate={navigate} editId={editId} />}
            {view === 'products' && <ProductsListView navigate={navigate} onReady={consumePendingScroll} />}
            {view === 'product-create' && <ProductFormView navigate={navigate} />}
            {view === 'product-edit' && <ProductFormView navigate={navigate} editId={editId} />}
            {view === 'vendors' && <VendorsListView navigate={navigate} />}
            {view === 'vendor-create' && <VendorFormView navigate={navigate} />}
            {view === 'vendor-edit' && <VendorFormView navigate={navigate} editId={editId} />}
            {view === 'categories' && <CategoriesListView navigate={navigate} />}
            {view === 'category-create' && <CategoryFormView navigate={navigate} />}
            {view === 'category-edit' && <CategoryFormView navigate={navigate} editId={editId} />}
            {view === 'scrapers' && <ScrapersView navigate={navigate} />}
            {view === 'scraper-source-create' && <ScraperSourceFormView navigate={navigate} />}
            {view === 'scraper-source-edit' && <ScraperSourceFormView navigate={navigate} editId={editId} />}
            {view === 'scraper-jobs' && <ScraperJobsView navigate={navigate} editId={editId} />}
            {view === 'scraper-job-detail' && <ScraperJobDetailView navigate={navigate} editId={editId} />}
            {view === 'inquiries' && <InquiriesListView navigate={navigate} />}
            {view === 'inquiry-detail' && <InquiryDetailView navigate={navigate} editId={editId} staffRole={staffRole} />}
            {view === 'trade' && <TradeManagementView navigate={navigate} />}
            {view === 'staff' && <StaffListView navigate={navigate} />}
            {view === 'staff-create' && <StaffFormView navigate={navigate} />}
            {view === 'staff-edit' && <StaffFormView navigate={navigate} editId={editId} />}
            {view === 'promos' && <PromoCodesListView navigate={navigate} />}
            {view === 'promo-create' && <PromoCodeFormView navigate={navigate} />}
            {view === 'promo-edit' && <PromoCodeFormView navigate={navigate} editId={editId} />}
            {view === 'audit' && <AuditLogView navigate={navigate} />}
            {view === 'edi' && <EDIView navigate={navigate} />}
          </div>
        </div>
      );
    }

    // ========== DashboardView ==========
    function DashboardView({ navigate }) {
      const [stats, setStats] = useState(null);
      const [period, setPeriod] = useState('30d');
      const [analytics, setAnalytics] = useState(null);
      const [analyticsLoading, setAnalyticsLoading] = useState(true);
      const revenueChartRef = React.useRef(null);
      const revenueChartInstance = React.useRef(null);
      const statusChartRef = React.useRef(null);
      const statusChartInstance = React.useRef(null);

      useEffect(() => {
        adminFetch('/api/admin/stats').then(setStats).catch(() => {});
      }, []);

      useEffect(() => {
        setAnalyticsLoading(true);
        adminFetch(`/api/admin/analytics?period=${period}`)
          .then(data => { setAnalytics(data); setAnalyticsLoading(false); })
          .catch(() => setAnalyticsLoading(false));
      }, [period]);

      // Revenue line chart â€” use setTimeout to ensure canvas is mounted after React render
      useEffect(() => {
        if (!analytics) return;
        const data = analytics.revenue_over_time || [];
        if (data.length === 0) {
          if (revenueChartInstance.current) { revenueChartInstance.current.destroy(); revenueChartInstance.current = null; }
          return;
        }
        const timer = setTimeout(() => {
          if (!revenueChartRef.current) return;
          if (revenueChartInstance.current) revenueChartInstance.current.destroy();
          const ctx = revenueChartRef.current.getContext('2d');
          revenueChartInstance.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => d.date),
              datasets: [{
                label: 'Revenue',
                data: data.map(d => d.revenue),
                borderColor: '#b8960c',
                backgroundColor: 'rgba(184, 150, 12, 0.08)',
                fill: true,
                tension: 0.3,
                pointRadius: data.length > 60 ? 0 : 3,
                pointBackgroundColor: '#b8960c'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(ctx) {
                      const idx = ctx.dataIndex;
                      const rev = '$' + ctx.parsed.y.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                      const orders = data[idx] ? data[idx].order_count : 0;
                      return [rev, orders + ' order' + (orders !== 1 ? 's' : '')];
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { callback: v => '$' + v.toLocaleString() }
                }
              }
            }
          });
        }, 50);
        return () => { clearTimeout(timer); if (revenueChartInstance.current) revenueChartInstance.current.destroy(); };
      }, [analytics]);

      // Order status donut chart
      useEffect(() => {
        if (!analytics) return;
        const data = analytics.order_status || [];
        if (data.length === 0) {
          if (statusChartInstance.current) { statusChartInstance.current.destroy(); statusChartInstance.current = null; }
          return;
        }
        const timer = setTimeout(() => {
          if (!statusChartRef.current) return;
          if (statusChartInstance.current) statusChartInstance.current.destroy();
          const ctx = statusChartRef.current.getContext('2d');
          const colorMap = {
            pending: '#a8a29e', confirmed: '#c9a668', shipped: '#6b8f71',
            delivered: '#16a34a', cancelled: '#dc2626', draft: '#d6d3d1'
          };
          statusChartInstance.current = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: data.map(d => d.status),
              datasets: [{
                data: data.map(d => d.count),
                backgroundColor: data.map(d => colorMap[d.status] || '#78716c'),
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 16, font: { size: 11 } } }
              }
            }
          });
        }, 50);
        return () => { clearTimeout(timer); if (statusChartInstance.current) statusChartInstance.current.destroy(); };
      }, [analytics]);

      if (!stats) return <div className="loading">Loading dashboard...</div>;

      const fmtMoney = v => '$' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      const periods = [
        { key: '30d', label: '30 Days' },
        { key: '90d', label: '90 Days' },
        { key: '12m', label: '12 Months' },
        { key: 'all', label: 'All Time' }
      ];

      return (
        <div>
          <div className="content-header">
            <h1>Dashboard</h1>
          </div>

          {/* Period selector */}
          <div className="analytics-period-bar">
            {periods.map(p => (
              <button key={p.key} className={'period-btn' + (period === p.key ? ' active' : '')} onClick={() => setPeriod(p.key)}>{p.label}</button>
            ))}
          </div>

          {/* Analytics summary cards */}
          {analyticsLoading ? (
            <div className="stat-grid"><div className="stat-card"><div className="stat-card-label">Loading analytics...</div></div></div>
          ) : analytics ? (
            <React.Fragment>
              <div className="analytics-grid">
                <div className="stat-card">
                  <div className="stat-card-label">Revenue</div>
                  <div className="stat-card-value">{fmtMoney(analytics.summary.revenue)}</div>
                </div>
                <div className="stat-card">
                  <div className="stat-card-label">Orders</div>
                  <div className="stat-card-value">{analytics.summary.orders}</div>
                </div>
                <div className="stat-card">
                  <div className="stat-card-label">Avg Order Value</div>
                  <div className="stat-card-value">{fmtMoney(analytics.summary.avg_order_value)}</div>
                </div>
                <div className="stat-card">
                  <div className="stat-card-label">Margin</div>
                  <div className="stat-card-value">{analytics.summary.margin_pct}%</div>
                </div>
              </div>

              {/* Revenue over time chart */}
              <div className="chart-container">
                <h3>Revenue Over Time</h3>
                {(analytics.revenue_over_time || []).length === 0 && (
                  <div style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '3rem' }}>No data for this period</div>
                )}
                <div style={{ height: '300px', display: (analytics.revenue_over_time || []).length > 0 ? 'block' : 'none' }}>
                  <canvas ref={revenueChartRef}></canvas>
                </div>
              </div>

              {/* Two column: Top Products + Order Status */}
              <div className="analytics-two-col">
                <div className="chart-container" style={{ marginBottom: 0 }}>
                  <h3>Top Products</h3>
                  {(analytics.top_products || []).length === 0 ? (
                    <div style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No data for this period</div>
                  ) : (
                    <div className="table-scroll-wrapper">
                    <table className="admin-table">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Product</th>
                          <th>Revenue</th>
                          <th>Units</th>
                        </tr>
                      </thead>
                      <tbody>
                        {analytics.top_products.map((p, i) => (
                          <tr key={p.product_id || i}>
                            <td>{i + 1}</td>
                            <td>{p.name || 'Unknown'}</td>
                            <td>{fmtMoney(p.revenue)}</td>
                            <td>{p.units_sold}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    </div>
                  )}
                </div>
                <div className="chart-container" style={{ marginBottom: 0 }}>
                  <h3>Order Status</h3>
                  {(analytics.order_status || []).length === 0 && (
                    <div style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No data for this period</div>
                  )}
                  <div style={{ height: '280px', display: (analytics.order_status || []).length > 0 ? 'block' : 'none' }}>
                    <canvas ref={statusChartRef}></canvas>
                  </div>
                </div>
              </div>

              {/* Vendor performance table */}
              {(analytics.vendor_performance || []).length > 0 && (
                <div className="chart-container">
                  <h3>Vendor Performance</h3>
                  <div className="table-scroll-wrapper">
                  <table className="admin-table">
                    <thead>
                      <tr>
                        <th>Vendor</th>
                        <th>Revenue</th>
                        <th>Cost</th>
                        <th>Margin %</th>
                        <th>Margin</th>
                      </tr>
                    </thead>
                    <tbody>
                      {analytics.vendor_performance.map(v => (
                        <tr key={v.vendor_id}>
                          <td>{v.name}</td>
                          <td>{fmtMoney(v.revenue)}</td>
                          <td>{fmtMoney(v.cost)}</td>
                          <td>{v.margin_pct}%</td>
                          <td>
                            <span className="vendor-margin-bar">
                              <span className="vendor-margin-bar-fill" style={{ width: Math.min(v.margin_pct, 100) + '%' }}></span>
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  </div>
                </div>
              )}
            </React.Fragment>
          ) : (
            <div style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '3rem' }}>Failed to load analytics</div>
          )}

          {/* Existing inventory count cards */}
          <div className="stat-grid" style={{ marginTop: '1rem' }}>
            {[
              { label: 'Orders', value: stats.counts.orders },
              { label: 'Products', value: stats.counts.products },
              { label: 'Vendors', value: stats.counts.vendors },
              { label: 'Categories', value: stats.counts.categories },
              { label: 'SKUs', value: stats.counts.skus },
            ].map(c => (
              <div key={c.label} className="stat-card">
                <div className="stat-card-label">{c.label}</div>
                <div className="stat-card-value">{c.value}</div>
              </div>
            ))}
          </div>

          {/* Recent Orders */}
          <div className="form-card">
            <h3>Recent Orders</h3>
            <div className="table-scroll-wrapper">
            <table className="admin-table">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {(stats.recent_orders || []).map(o => (
                  <tr key={o.id}>
                    <td><a style={{ cursor: 'pointer', color: 'var(--stone-800)', textDecoration: 'underline' }} onClick={() => navigate('order-detail', o.id)}>{o.order_number}</a></td>
                    <td>{o.customer_name}</td>
                    <td>${parseFloat(o.total).toFixed(2)}</td>
                    <td><span className={'badge badge-' + o.status}>{o.status}</span></td>
                    <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{new Date(o.created_at).toLocaleDateString()}</td>
                  </tr>
                ))}
                {(stats.recent_orders || []).length === 0 && (
                  <tr><td colSpan="5" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No orders yet</td></tr>
                )}
              </tbody>
            </table>
            </div>
          </div>

          {/* Recent Products */}
          <div className="form-card">
            <h3>Recent Products</h3>
            <div className="table-scroll-wrapper">
            <table className="admin-table">
              <thead>
                <tr>
                  <th>Vendor</th>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                {(stats.recent_products || []).map(p => (
                  <tr key={p.id}>
                    <td>{p.vendor_name || 'â€”'}</td>
                    <td><a style={{ cursor: 'pointer', color: 'var(--stone-800)', textDecoration: 'underline' }} onClick={() => navigate('product-edit', p.id)}>{p.name}</a></td>
                    <td><span className={'badge badge-' + (p.status || 'draft')}>{p.status || 'draft'}</span></td>
                    <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{new Date(p.created_at).toLocaleDateString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
            </div>
          </div>
        </div>
      );
    }

    // ========== ProductsListView ==========
    const PAGE_SIZE = 50;

    function ProductsListView({ navigate, onReady }) {
      const [products, setProducts] = useState([]);
      const [total, setTotal] = useState(0);
      const [loading, setLoading] = useState(true);
      const [loadingMore, setLoadingMore] = useState(false);
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [selected, setSelected] = useState(new Set());
      const [categories, setCategories] = useState([]);
      const [bulkCategory, setBulkCategory] = useState('');
      const [searchTerm, setSearchTerm] = useState('');
      const [filterVendor, setFilterVendor] = useState('');
      const [filterCategory, setFilterCategory] = useState('');
      const [filterStatus, setFilterStatus] = useState('');
      const [vendors, setVendors] = useState([]);
      const [sortCol, setSortCol] = useState('vendor');
      const [sortDir, setSortDir] = useState('asc');

      const clearSelection = () => { setSelected(new Set()); setBulkCategory(''); };

      const searchTimerRef = useRef(null);

      const buildQuery = (offset = 0) => {
        const params = new URLSearchParams();
        params.set('limit', PAGE_SIZE);
        params.set('offset', offset);
        if (searchTerm) params.set('search', searchTerm);
        if (filterVendor) params.set('vendor_id', filterVendor);
        if (filterCategory) params.set('category_id', filterCategory);
        if (filterStatus) params.set('status', filterStatus);
        params.set('sort', sortCol);
        params.set('sort_dir', sortDir);
        return params.toString();
      };

      const loadFresh = () => {
        setLoading(true);
        clearSelection();
        adminFetch(`/api/admin/products?${buildQuery(0)}`)
          .then(data => {
            setProducts(data.products || []);
            setTotal(data.total || 0);
            setLoading(false);
            if (onReady) requestAnimationFrame(onReady);
          })
          .catch(() => setLoading(false));
      };

      const loadMore = () => {
        setLoadingMore(true);
        adminFetch(`/api/admin/products?${buildQuery(products.length)}`)
          .then(data => {
            setProducts(prev => [...prev, ...(data.products || [])]);
            setTotal(data.total || 0);
            setLoadingMore(false);
          })
          .catch(() => setLoadingMore(false));
      };

      useEffect(() => {
        loadFresh();
        adminFetch('/api/admin/categories').then(d => setCategories(d.flat || [])).catch(() => {});
        adminFetch('/api/admin/vendors').then(d => setVendors(d.vendors || [])).catch(() => {});
      }, []);

      // Reload when filters or sort change
      useEffect(() => {
        if (loading) return; // skip initial mount
        loadFresh();
      }, [filterVendor, filterCategory, filterStatus, sortCol, sortDir]);

      // Debounced search
      useEffect(() => {
        if (loading) return;
        if (searchTimerRef.current) clearTimeout(searchTimerRef.current);
        searchTimerRef.current = setTimeout(() => loadFresh(), 300);
        return () => clearTimeout(searchTimerRef.current);
      }, [searchTerm]);

      const handleDelete = () => {
        if (!deleteTarget) return;
        adminFetch('/api/admin/products/' + deleteTarget.id, { method: 'DELETE' })
          .then(() => { setDeleteTarget(null); loadFresh(); })
          .catch(() => {});
      };

      const toggleSelect = (id) => {
        setSelected(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id); else next.add(id);
          return next;
        });
      };

      const toggleSort = (col) => {
        if (sortCol === col) setSortDir(d => d === 'asc' ? 'desc' : 'asc');
        else { setSortCol(col); setSortDir('asc'); }
      };

      const SortHeader = ({ col, children }) => (
        <th className={'sortable' + (sortCol === col ? ' sorted' : '')} onClick={() => toggleSort(col)}>
          {children}<span className="sort-arrow">{sortCol === col ? (sortDir === 'asc' ? ' \u25B2' : ' \u25BC') : ' \u25B2'}</span>
        </th>
      );

      const allSelected = selected.size === products.length && products.length > 0;
      const toggleAll = () => {
        if (allSelected) setSelected(new Set());
        else setSelected(new Set(products.map(p => p.id)));
      };

      const bulkSetStatus = (status) => {
        const ids = Array.from(selected);
        adminFetch('/api/admin/products/bulk/status', {
          method: 'PATCH',
          body: JSON.stringify({ ids, status })
        }).then(() => loadFresh()).catch(() => {});
      };

      const bulkSetCategory = () => {
        const ids = Array.from(selected);
        adminFetch('/api/admin/products/bulk/category', {
          method: 'PATCH',
          body: JSON.stringify({ ids, category_id: bulkCategory || null })
        }).then(() => loadFresh()).catch(() => {});
      };

      const bulkDelete = () => {
        const ids = Array.from(selected);
        if (!window.confirm(`Delete ${ids.length} product(s)? This will also delete all associated SKUs, packaging, and pricing data.`)) return;
        adminFetch('/api/admin/products/bulk', {
          method: 'DELETE',
          body: JSON.stringify({ ids })
        }).then(() => loadFresh()).catch(() => {});
      };

      const hasMore = products.length < total;

      if (loading) return <div className="loading">Loading products...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Products</h1>
            <button className="btn btn-primary" onClick={() => navigate('product-create')}>+ Add Product</button>
          </div>

          <div className="filter-bar">
            <input type="text" placeholder="Search products..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
            <select value={filterVendor} onChange={e => setFilterVendor(e.target.value)}>
              <option value="">All Vendors</option>
              {vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
            </select>
            <select value={filterCategory} onChange={e => setFilterCategory(e.target.value)}>
              <option value="">All Categories</option>
              {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
            <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
              <option value="">All Statuses</option>
              <option value="active">active</option>
              <option value="draft">draft</option>
            </select>
            <span className="filter-count">Showing {products.length} of {total} products</span>
          </div>

          {selected.size > 0 && (
            <div className="bulk-toolbar">
              <span className="bulk-count">{selected.size} selected</span>
              <button className="btn btn-secondary btn-sm" onClick={() => bulkSetStatus('active')}>Set Active</button>
              <button className="btn btn-secondary btn-sm" onClick={() => bulkSetStatus('draft')}>Set Draft</button>
              <select value={bulkCategory} onChange={e => setBulkCategory(e.target.value)}>
                <option value="">â€” Choose Category â€”</option>
                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <button className="btn btn-secondary btn-sm" onClick={bulkSetCategory}>Apply</button>
              <button className="btn btn-danger btn-sm" onClick={bulkDelete}>Delete</button>
            </div>
          )}

          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th style={{ width: '40px' }}><input type="checkbox" checked={allSelected} onChange={toggleAll} /></th>
                <SortHeader col="vendor">Vendor</SortHeader>
                <SortHeader col="name">Name</SortHeader>
                <SortHeader col="category">Category</SortHeader>
                <SortHeader col="price">Price</SortHeader>
                <SortHeader col="skus">SKUs</SortHeader>
                <SortHeader col="status">Status</SortHeader>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {products.map(p => (
                <tr key={p.id}>
                  <td><input type="checkbox" checked={selected.has(p.id)} onChange={() => toggleSelect(p.id)} /></td>
                  <td>{p.vendor_name || 'â€”'}</td>
                  <td style={{ fontWeight: 500, display: 'flex', alignItems: 'center', gap: '0.625rem' }}>
                    {p.primary_image ? (
                      <img src={p.primary_image} alt="" style={{ width: '36px', height: '36px', objectFit: 'cover', borderRadius: '4px', flexShrink: 0 }} />
                    ) : (
                      <span style={{ width: '36px', height: '36px', borderRadius: '4px', background: 'var(--stone-100)', display: 'inline-block', flexShrink: 0 }} />
                    )}
                    {p.name}
                  </td>
                  <td>{p.category_name || 'â€”'}</td>
                  <td>{p.price ? '$' + parseFloat(p.price).toFixed(2) : 'â€”'}</td>
                  <td>{p.sku_count}</td>
                  <td><span className={'badge badge-' + (p.status || 'draft')}>{p.status || 'draft'}</span></td>
                  <td className="actions">
                    <button className="btn btn-secondary btn-sm" onClick={() => navigate('product-edit', p.id)}>Edit</button>
                    <button className="btn btn-danger btn-sm" onClick={() => setDeleteTarget(p)}>Delete</button>
                  </td>
                </tr>
              ))}
              {products.length === 0 && (
                <tr><td colSpan="8" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No products found</td></tr>
              )}
            </tbody>
          </table>
          </div>

          {hasMore && (
            <div style={{ textAlign: 'center', padding: '1.5rem 0' }}>
              <button
                className="btn btn-secondary"
                onClick={loadMore}
                disabled={loadingMore}
                style={{ minWidth: '200px' }}
              >
                {loadingMore ? 'Loading...' : `Load More (${total - products.length} remaining)`}
              </button>
            </div>
          )}

          {deleteTarget && (
            <DeleteConfirmModal
              title="Delete Product"
              message={`Are you sure you want to delete "${deleteTarget.name}"? This will also delete all associated SKUs, packaging, and pricing data.`}
              onConfirm={handleDelete}
              onCancel={() => setDeleteTarget(null)}
            />
          )}
        </div>
      );
    }

    // ========== CollapsibleSection ==========
    function CollapsibleSection({ title, defaultOpen = true, headerRight, children }) {
      const [open, setOpen] = useState(defaultOpen);
      return (
        <div className={'form-card' + (open ? '' : ' collapsed')}>
          <div className="form-card-header" onClick={() => setOpen(o => !o)}>
            <h3>{title}</h3>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
              {headerRight}
              <span className={'toggle-icon' + (open ? '' : ' collapsed')}>&#9660;</span>
            </div>
          </div>
          {open && <div className="form-card-body">{children}</div>}
        </div>
      );
    }

    // ========== ProductFormView ==========
    function ProductFormView({ navigate, editId }) {
      const [form, setForm] = useState({ name: '', collection: '', vendor_id: '', category_id: '', status: 'draft', description_short: '', description_long: '' });
      const [skus, setSkus] = useState([]);
      const [media, setMedia] = useState([]);
      const [vendors, setVendors] = useState([]);
      const [categories, setCategories] = useState([]);
      const [loading, setLoading] = useState(!!editId);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        adminFetch('/api/admin/vendors').then(d => setVendors(d.vendors || [])).catch(() => {});
        adminFetch('/api/admin/categories').then(d => setCategories(d.flat || [])).catch(() => {});

        if (editId) {
          adminFetch('/api/admin/products/' + editId)
            .then(data => {
              const p = data.product;
              setForm({
                name: p.name || '',
                collection: p.collection || '',
                vendor_id: p.vendor_id || '',
                category_id: p.category_id || '',
                status: p.status || 'draft',
                description_short: p.description_short || '',
                description_long: p.description_long || ''
              });
              setSkus((data.skus || []).map(s => ({ ...s, _existing: true })));
              setMedia(data.media || []);
              setLoading(false);
            })
            .catch(() => setLoading(false));
        }
      }, [editId]);

      const updateForm = (field, value) => setForm(prev => ({ ...prev, [field]: value }));

      const addSku = () => {
        setSkus(prev => [...prev, {
          _new: true, _key: Date.now(),
          vendor_sku: '', internal_sku: '', variant_name: '', sell_by: 'sqft',
          sqft_per_box: '', pieces_per_box: '', weight_per_box_lbs: '', freight_class: '70',
          boxes_per_pallet: '', sqft_per_pallet: '', weight_per_pallet_lbs: '',
          cost: '', retail_price: '', price_basis: 'per_sqft',
          cut_price: '', roll_price: '', cut_cost: '', roll_cost: '', roll_min_sqft: '', roll_width_ft: ''
        }]);
      };

      const updateSku = (index, field, value) => {
        setSkus(prev => prev.map((s, i) => i === index ? { ...s, [field]: value } : s));
      };

      const removeSku = (index) => {
        const sku = skus[index];
        if (sku._existing && sku.id) {
          adminFetch('/api/admin/skus/' + sku.id, { method: 'DELETE' }).catch(() => {});
        }
        setSkus(prev => prev.filter((_, i) => i !== index));
      };

      const handleSave = async () => {
        if (!form.name.trim()) { alert('Product name is required'); return; }
        setSaving(true);

        try {
          let productId = editId;

          if (editId) {
            const data = await adminFetch('/api/admin/products/' + editId, {
              method: 'PUT',
              body: JSON.stringify(form)
            });
            productId = data.product.id;
          } else {
            const data = await adminFetch('/api/admin/products', {
              method: 'POST',
              body: JSON.stringify(form)
            });
            productId = data.product.id;
          }

          // Save SKUs
          for (const sku of skus) {
            const skuData = {
              vendor_sku: sku.vendor_sku,
              internal_sku: sku.internal_sku,
              variant_name: sku.variant_name,
              sell_by: sku.sell_by || 'sqft',
              sqft_per_box: sku.sqft_per_box ? parseFloat(sku.sqft_per_box) : null,
              pieces_per_box: sku.pieces_per_box ? parseInt(sku.pieces_per_box) : null,
              weight_per_box_lbs: sku.weight_per_box_lbs ? parseFloat(sku.weight_per_box_lbs) : null,
              freight_class: sku.freight_class ? parseInt(sku.freight_class) : 70,
              boxes_per_pallet: sku.boxes_per_pallet ? parseInt(sku.boxes_per_pallet) : null,
              sqft_per_pallet: sku.sqft_per_pallet ? parseFloat(sku.sqft_per_pallet) : null,
              weight_per_pallet_lbs: sku.weight_per_pallet_lbs ? parseFloat(sku.weight_per_pallet_lbs) : null,
              cost: sku.cost ? parseFloat(sku.cost) : null,
              retail_price: sku.retail_price ? parseFloat(sku.retail_price) : null,
              price_basis: sku.price_basis || 'per_sqft',
              cut_price: sku.cut_price ? parseFloat(sku.cut_price) : null,
              roll_price: sku.roll_price ? parseFloat(sku.roll_price) : null,
              cut_cost: sku.cut_cost ? parseFloat(sku.cut_cost) : null,
              roll_cost: sku.roll_cost ? parseFloat(sku.roll_cost) : null,
              roll_min_sqft: sku.roll_min_sqft ? parseFloat(sku.roll_min_sqft) : null,
              roll_width_ft: sku.roll_width_ft ? parseFloat(sku.roll_width_ft) : null
            };

            if (sku._existing && sku.id) {
              await adminFetch('/api/admin/skus/' + sku.id, {
                method: 'PUT',
                body: JSON.stringify(skuData)
              });
            } else if (sku._new && sku.vendor_sku && sku.internal_sku) {
              await adminFetch('/api/admin/products/' + productId + '/skus', {
                method: 'POST',
                body: JSON.stringify(skuData)
              });
            }
          }

          navigate('products');
        } catch (err) {
          alert('Save failed: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      if (loading) return <div className="loading">Loading product...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>{editId ? 'Edit Product' : 'New Product'}</h1>
            <div style={{ display: 'flex', gap: '0.75rem' }}>
              <button className="btn btn-secondary" onClick={() => navigate('products')}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
                {saving ? 'Saving...' : 'Save Product'}
              </button>
            </div>
          </div>

          <CollapsibleSection title="Product Details" defaultOpen={true}>
            <div className="form-grid">
              <div className="form-group">
                <label>Product Name *</label>
                <input value={form.name} onChange={e => updateForm('name', e.target.value)} placeholder="e.g. Calacatta Gold Marble" />
              </div>
              <div className="form-group">
                <label>Collection</label>
                <input value={form.collection} onChange={e => updateForm('collection', e.target.value)} placeholder="e.g. Natural Stone Collection" />
              </div>
              <div className="form-group">
                <label>Vendor</label>
                <select value={form.vendor_id} onChange={e => updateForm('vendor_id', e.target.value)}>
                  <option value="">Select vendor...</option>
                  {vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                </select>
              </div>
              <div className="form-group">
                <label>Category</label>
                <select value={form.category_id} onChange={e => updateForm('category_id', e.target.value)}>
                  <option value="">Select category...</option>
                  {categories.map(c => (
                    <option key={c.id} value={c.id}>{c.parent_id ? '  -- ' : ''}{c.name}</option>
                  ))}
                </select>
              </div>
              <div className="form-group">
                <label>Status</label>
                <select value={form.status} onChange={e => updateForm('status', e.target.value)}>
                  <option value="draft">Draft</option>
                  <option value="active">Active</option>
                </select>
              </div>
              <div className="form-group full">
                <label>Short Description</label>
                <input value={form.description_short} onChange={e => updateForm('description_short', e.target.value)} placeholder="Brief product description" />
              </div>
              <div className="form-group full">
                <label>Long Description</label>
                <textarea value={form.description_long} onChange={e => updateForm('description_long', e.target.value)} placeholder="Detailed product description" />
              </div>
            </div>
          </CollapsibleSection>

          {editId && (
            <CollapsibleSection title={`Media (${media.length})`} defaultOpen={true}>
              <ProductMediaManager productId={editId} media={media} setMedia={setMedia} />
            </CollapsibleSection>
          )}

          <CollapsibleSection title="SKUs" defaultOpen={true} headerRight={<button className="btn btn-secondary btn-sm" onClick={e => { e.stopPropagation(); addSku(); }}>+ Add SKU</button>}>
            {skus.length === 0 && (
              <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--stone-400)', fontSize: '0.875rem' }}>
                No SKUs yet. Click "Add SKU" to create one.
              </div>
            )}
            {skus.map((sku, i) => (
              <SkuCard key={sku.id || sku._key} sku={sku} index={i} updateSku={updateSku} removeSku={removeSku} />
            ))}
          </CollapsibleSection>
        </div>
      );
    }

    // ========== SkuCard ==========
    function SkuCard({ sku, index, updateSku, removeSku }) {
      const { useState } = React;
      const u = (field, value) => updateSku(index, field, value);
      const [attrsOpen, setAttrsOpen] = useState(false);
      const [attrEdits, setAttrEdits] = useState(null);
      const [attrSaving, setAttrSaving] = useState(false);

      const attrs = sku.attributes || [];

      const startEditAttrs = () => {
        const edits = {};
        for (const a of attrs) edits[a.slug] = a.value;
        setAttrEdits(edits);
        setAttrsOpen(true);
      };

      const saveAttrs = async () => {
        if (!sku.id || !attrEdits) return;
        setAttrSaving(true);
        try {
          const payload = Object.entries(attrEdits).map(([slug, value]) => ({ slug, value }));
          const data = await adminFetch('/api/admin/skus/' + sku.id + '/attributes', {
            method: 'PUT',
            body: JSON.stringify({ attributes: payload })
          });
          if (data.attributes) {
            updateSku(index, 'attributes', data.attributes);
          }
          setAttrEdits(null);
        } catch (err) {
          alert('Failed to save attributes: ' + err.message);
        } finally {
          setAttrSaving(false);
        }
      };

      return (
        <div className="sku-card">
          <div className="sku-card-header">
            <h4>SKU #{index + 1}{sku.variant_name ? ': ' + sku.variant_name : ''}</h4>
            <button className="btn btn-danger btn-sm" onClick={() => removeSku(index)}>Remove</button>
          </div>
          <div className="form-grid">
            <div className="form-group">
              <label>Vendor SKU *</label>
              <input value={sku.vendor_sku} onChange={e => u('vendor_sku', e.target.value)} placeholder="MSI-CALG-1212-POL" />
            </div>
            <div className="form-group">
              <label>Internal SKU *</label>
              <input value={sku.internal_sku} onChange={e => u('internal_sku', e.target.value)} placeholder="CAL-GOLD-12X12-P" />
            </div>
            <div className="form-group">
              <label>Variant Name</label>
              <input value={sku.variant_name || ''} onChange={e => u('variant_name', e.target.value)} placeholder="12x12 Polished" />
            </div>
            <div className="form-group">
              <label>Sell By</label>
              <select value={sku.sell_by || 'sqft'} onChange={e => u('sell_by', e.target.value)}>
                <option value="sqft">Per SqFt</option>
                <option value="box">Per Box</option>
                <option value="unit">Per Unit</option>
              </select>
            </div>
            <div className="form-group">
              <label>SqFt Per Box</label>
              <input type="number" step="0.01" value={sku.sqft_per_box || ''} onChange={e => u('sqft_per_box', e.target.value)} />
            </div>
            <div className="form-group">
              <label>Pieces Per Box</label>
              <input type="number" value={sku.pieces_per_box || ''} onChange={e => u('pieces_per_box', e.target.value)} />
            </div>
            <div className="form-group">
              <label>Weight Per Box (lbs)</label>
              <input type="number" step="0.01" value={sku.weight_per_box_lbs || ''} onChange={e => u('weight_per_box_lbs', e.target.value)} />
            </div>
            <div className="form-group">
              <label>Freight Class</label>
              <select value={sku.freight_class || '70'} onChange={e => u('freight_class', e.target.value)}>
                <option value="50">50</option>
                <option value="55">55</option>
                <option value="60">60 â€” Hardwood</option>
                <option value="65">65</option>
                <option value="70">70 â€” Tile / Stone</option>
                <option value="77.5">77.5</option>
                <option value="85">85</option>
                <option value="92.5">92.5</option>
                <option value="100">100</option>
              </select>
            </div>
            <div className="form-group">
              <label>Boxes Per Pallet</label>
              <input type="number" value={sku.boxes_per_pallet || ''} onChange={e => u('boxes_per_pallet', e.target.value)} />
            </div>
            <div className="form-group">
              <label>SqFt Per Pallet</label>
              <input type="number" step="0.01" value={sku.sqft_per_pallet || ''} onChange={e => u('sqft_per_pallet', e.target.value)} />
            </div>
            <div className="form-group">
              <label>Weight Per Pallet (lbs)</label>
              <input type="number" step="0.01" value={sku.weight_per_pallet_lbs || ''} onChange={e => u('weight_per_pallet_lbs', e.target.value)} />
            </div>
            <div className="form-group">
              <label>Cost</label>
              <input type="number" step="0.01" value={sku.cost || ''} onChange={e => u('cost', e.target.value)} placeholder="0.00" />
            </div>
            <div className="form-group">
              <label>Retail Price</label>
              <input type="number" step="0.01" value={sku.retail_price || ''} onChange={e => u('retail_price', e.target.value)} placeholder="0.00" />
            </div>
            <div className="form-group">
              <label>Price Basis</label>
              <select value={sku.price_basis || 'per_sqft'} onChange={e => u('price_basis', e.target.value)}>
                <option value="per_sqft">Per SqFt</option>
                <option value="per_unit">Per Unit</option>
              </select>
            </div>
          </div>

          {/* Carpet Pricing Fields â€” shown when cut_price has a value or can be toggled */}
          {(sku.cut_price || sku.roll_price) ? (
            <div style={{ borderTop: '1px solid var(--stone-200)', paddingTop: '0.75rem', marginTop: '0.5rem' }}>
              <div style={{ fontSize: '0.8125rem', fontWeight: '600', color: 'var(--stone-600)', marginBottom: '0.5rem' }}>Carpet Pricing (Cut / Roll)</div>
              <div className="form-grid">
                <div className="form-group">
                  <label>Cut Price (retail /sqft)</label>
                  <input type="number" step="0.01" value={sku.cut_price || ''} onChange={e => u('cut_price', e.target.value)} placeholder="0.00" />
                </div>
                <div className="form-group">
                  <label>Roll Price (retail /sqft)</label>
                  <input type="number" step="0.01" value={sku.roll_price || ''} onChange={e => u('roll_price', e.target.value)} placeholder="0.00" />
                </div>
                <div className="form-group">
                  <label>Cut Cost (dealer /sqft)</label>
                  <input type="number" step="0.01" value={sku.cut_cost || ''} onChange={e => u('cut_cost', e.target.value)} placeholder="0.00" />
                </div>
                <div className="form-group">
                  <label>Roll Cost (dealer /sqft)</label>
                  <input type="number" step="0.01" value={sku.roll_cost || ''} onChange={e => u('roll_cost', e.target.value)} placeholder="0.00" />
                </div>
                <div className="form-group">
                  <label>Roll Minimum (sqft)</label>
                  <input type="number" step="1" value={sku.roll_min_sqft || ''} onChange={e => u('roll_min_sqft', e.target.value)} placeholder="e.g. 600" />
                </div>
                <div className="form-group">
                  <label>Roll Width (ft)</label>
                  <input type="number" step="0.5" value={sku.roll_width_ft || ''} onChange={e => u('roll_width_ft', e.target.value)} placeholder="e.g. 12" />
                </div>
              </div>
            </div>
          ) : (
            <div style={{ marginTop: '0.5rem' }}>
              <button className="btn btn-secondary btn-sm" style={{ fontSize: '0.75rem' }}
                onClick={() => { u('cut_price', '0'); u('roll_price', '0'); }}>
                + Add Carpet Pricing
              </button>
            </div>
          )}

          {/* Attributes Section */}
          {sku._existing && attrs.length > 0 && (
            <div style={{ marginTop: '1rem', borderTop: '1px solid var(--stone-200)', paddingTop: '0.75rem' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem', cursor: 'pointer' }}
                onClick={() => attrEdits ? null : setAttrsOpen(!attrsOpen)}>
                <span style={{ fontSize: '0.8125rem', fontWeight: '600', color: 'var(--stone-600)' }}>
                  Attributes ({attrs.length})
                </span>
                {!attrEdits && (
                  <button className="btn btn-secondary btn-sm" onClick={e => { e.stopPropagation(); startEditAttrs(); }} style={{ fontSize: '0.75rem', padding: '2px 8px' }}>Edit</button>
                )}
              </div>
              {(attrsOpen || attrEdits) && (
                <div className="form-grid" style={{ gap: '0.5rem' }}>
                  {attrEdits ? (
                    <>
                      {Object.entries(attrEdits).map(([slug, value]) => {
                        const label = (attrs.find(a => a.slug === slug) || {}).name || slug;
                        return (
                          <div className="form-group" key={slug}>
                            <label style={{ fontSize: '0.75rem' }}>{label}</label>
                            <input value={value} onChange={e => setAttrEdits(prev => ({ ...prev, [slug]: e.target.value }))} style={{ fontSize: '0.8125rem' }} />
                          </div>
                        );
                      })}
                      <div style={{ gridColumn: '1 / -1', display: 'flex', gap: '0.5rem', justifyContent: 'flex-end' }}>
                        <button className="btn btn-secondary btn-sm" onClick={() => setAttrEdits(null)} disabled={attrSaving}>Cancel</button>
                        <button className="btn btn-primary btn-sm" onClick={saveAttrs} disabled={attrSaving}>
                          {attrSaving ? 'Saving...' : 'Save Attributes'}
                        </button>
                      </div>
                    </>
                  ) : (
                    attrs.map(a => (
                      <div className="form-group" key={a.slug}>
                        <label style={{ fontSize: '0.75rem' }}>{a.name}</label>
                        <div style={{ fontSize: '0.8125rem', padding: '0.375rem 0', color: 'var(--stone-700)' }}>{a.value}</div>
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // ========== ProductMediaManager ==========
    function ProductMediaManager({ productId, media, setMedia }) {
      const { useState, useRef, useCallback } = React;
      const [uploading, setUploading] = useState(false);
      const [urlInput, setUrlInput] = useState('');
      const [addAssetType, setAddAssetType] = useState('alternate');
      const [dragActive, setDragActive] = useState(false);
      const [draggedId, setDraggedId] = useState(null);
      const [deleteTarget, setDeleteTarget] = useState(null);
      const fileInputRef = useRef(null);

      const API = '';
      const assetTypes = ['primary', 'alternate', 'lifestyle', 'detail', 'spec_pdf', 'swatch'];

      const handleFiles = async (files) => {
        setUploading(true);
        for (const file of files) {
          try {
            const fd = new FormData();
            fd.append('file', file);
            fd.append('asset_type', addAssetType);
            const resp = await fetch(API + '/api/admin/products/' + productId + '/media/upload', {
              method: 'POST',
              headers: getAuthHeaders(),
              body: fd
            });
            if (resp.ok) {
              const data = await resp.json();
              if (data.media) setMedia(prev => [...prev, data.media]);
            }
          } catch (_) {}
        }
        setUploading(false);
      };

      const handleUrlSubmit = async () => {
        if (!urlInput.trim()) return;
        try {
          const data = await adminFetch('/api/admin/products/' + productId + '/media/url', {
            method: 'POST',
            body: JSON.stringify({ url: urlInput.trim(), asset_type: addAssetType })
          });
          if (data.media) {
            setMedia(prev => [...prev, data.media]);
            setUrlInput('');
          }
        } catch (_) {}
      };

      const handleDelete = async (mediaId) => {
        try {
          await adminFetch('/api/admin/media/' + mediaId, { method: 'DELETE' });
          setMedia(prev => prev.filter(m => m.id !== mediaId));
          setDeleteTarget(null);
        } catch (_) {}
      };

      const handleTypeChange = async (mediaId, newType) => {
        try {
          const data = await adminFetch('/api/admin/media/' + mediaId, {
            method: 'PUT',
            body: JSON.stringify({ asset_type: newType })
          });
          if (data.media) {
            setMedia(prev => prev.map(m => m.id === mediaId ? data.media : m));
          }
        } catch (_) {}
      };

      const handleDragStart = (e, id) => {
        setDraggedId(id);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = (e, targetId) => {
        e.preventDefault();
        if (!draggedId || draggedId === targetId) return;
        setMedia(prev => {
          const items = [...prev];
          const fromIdx = items.findIndex(m => m.id === draggedId);
          const toIdx = items.findIndex(m => m.id === targetId);
          if (fromIdx < 0 || toIdx < 0) return prev;
          const [moved] = items.splice(fromIdx, 1);
          items.splice(toIdx, 0, moved);
          return items;
        });
      };

      const handleDrop = async (e) => {
        e.preventDefault();
        setDraggedId(null);
        const order = media.map((m, i) => ({ id: m.id, sort_order: i }));
        try {
          const data = await adminFetch('/api/admin/products/' + productId + '/media/reorder', {
            method: 'PATCH',
            body: JSON.stringify({ order })
          });
          if (data.media) setMedia(data.media);
        } catch (_) {}
      };

      const onZoneDragOver = (e) => { e.preventDefault(); setDragActive(true); };
      const onZoneDragLeave = () => setDragActive(false);
      const onZoneDrop = (e) => {
        e.preventDefault();
        setDragActive(false);
        if (e.dataTransfer.files.length) handleFiles(Array.from(e.dataTransfer.files));
      };

      const isPdf = (url) => url && url.toLowerCase().endsWith('.pdf');

      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
          {media.length > 0 ? (
            <div className="media-grid">
              {media.map(m => (
                <div
                  key={m.id}
                  className={'media-card' + (draggedId === m.id ? ' dragging' : '')}
                  draggable
                  onDragStart={e => handleDragStart(e, m.id)}
                  onDragOver={e => handleDragOver(e, m.id)}
                  onDrop={handleDrop}
                  onDragEnd={() => setDraggedId(null)}
                >
                  {isPdf(m.url) ? (
                    <div style={{ width: '100%', height: 160, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--stone-100)', color: 'var(--stone-400)', fontSize: '0.75rem' }}>PDF</div>
                  ) : (
                    <img src={m.url} alt={m.asset_type} />
                  )}
                  <div className="media-card-info">
                    <select
                      value={m.asset_type}
                      onChange={e => handleTypeChange(m.id, e.target.value)}
                      style={{ width: '100%', fontSize: '0.7rem', padding: '0.2rem', marginBottom: '0.375rem', border: '1px solid var(--stone-200)', borderRadius: '4px' }}
                    >
                      {assetTypes.map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                    <div className="media-card-actions">
                      <button onClick={() => window.open(m.url, '_blank')}>View</button>
                      <button className="delete-btn" onClick={() => setDeleteTarget(m)}>Delete</button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div style={{ textAlign: 'center', padding: '1.5rem', color: 'var(--stone-400)', fontSize: '0.875rem' }}>
              No media yet. Upload files or paste URLs below.
            </div>
          )}

          <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center', flexWrap: 'wrap' }}>
            <label style={{ fontSize: '0.8rem', color: 'var(--stone-600)' }}>Type for new uploads:</label>
            <select
              value={addAssetType}
              onChange={e => setAddAssetType(e.target.value)}
              style={{ fontSize: '0.8rem', padding: '0.3rem 0.5rem', border: '1px solid var(--stone-200)', borderRadius: '6px' }}
            >
              {assetTypes.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </div>

          <div
            className={'media-upload-zone' + (dragActive ? ' drag-active' : '')}
            onClick={() => fileInputRef.current && fileInputRef.current.click()}
            onDragOver={onZoneDragOver}
            onDragLeave={onZoneDragLeave}
            onDrop={onZoneDrop}
          >
            {uploading ? 'Uploading...' : 'Drop images here or click to browse'}
            <input
              ref={fileInputRef}
              type="file"
              multiple
              accept=".jpg,.jpeg,.png,.webp,.pdf"
              style={{ display: 'none' }}
              onChange={e => { if (e.target.files.length) handleFiles(Array.from(e.target.files)); e.target.value = ''; }}
            />
          </div>

          <div className="media-url-form">
            <input
              value={urlInput}
              onChange={e => setUrlInput(e.target.value)}
              placeholder="Paste external image URL..."
              onKeyDown={e => { if (e.key === 'Enter') handleUrlSubmit(); }}
            />
            <button className="btn btn-secondary btn-sm" onClick={handleUrlSubmit}>Add URL</button>
          </div>

          {deleteTarget && (
            <DeleteConfirmModal
              title="Delete Media"
              message={`Delete this ${deleteTarget.asset_type} image? This cannot be undone.`}
              onConfirm={() => handleDelete(deleteTarget.id)}
              onCancel={() => setDeleteTarget(null)}
            />
          )}
        </div>
      );
    }

    // ========== VendorsListView ==========
    function VendorsListView({ navigate }) {
      const [vendors, setVendors] = useState([]);
      const [loading, setLoading] = useState(true);

      const load = () => {
        setLoading(true);
        adminFetch('/api/admin/vendors')
          .then(data => { setVendors(data.vendors || []); setLoading(false); })
          .catch(() => setLoading(false));
      };
      useEffect(load, []);

      const toggleActive = (id) => {
        adminFetch('/api/admin/vendors/' + id + '/toggle', { method: 'PATCH' })
          .then(data => {
            if (data.vendor) {
              setVendors(prev => prev.map(v => v.id === id ? { ...v, is_active: data.vendor.is_active } : v));
            }
          })
          .catch(() => {});
      };

      if (loading) return <div className="loading">Loading vendors...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Vendors</h1>
            <button className="btn btn-primary" onClick={() => navigate('vendor-create')}>+ Add Vendor</button>
          </div>
          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Code</th>
                <th>Website</th>
                <th>Products</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {vendors.map(v => (
                <tr key={v.id}>
                  <td style={{ fontWeight: 500 }}>{v.name}</td>
                  <td><code style={{ fontSize: '0.8125rem', background: 'var(--stone-100)', padding: '0.15rem 0.4rem' }}>{v.code}</code></td>
                  <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{v.website || 'â€”'}</td>
                  <td>{v.product_count}</td>
                  <td>
                    <div className={'toggle' + (v.is_active ? ' on' : '')} onClick={() => toggleActive(v.id)} />
                  </td>
                  <td className="actions">
                    <button className="btn btn-secondary btn-sm" onClick={() => navigate('vendor-edit', v.id)}>Edit</button>
                  </td>
                </tr>
              ))}
              {vendors.length === 0 && (
                <tr><td colSpan="6" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No vendors found</td></tr>
              )}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    // ========== VendorFormView ==========
    function VendorFormView({ navigate, editId }) {
      const [form, setForm] = useState({ name: '', code: '', website: '', email: '' });
      const [loading, setLoading] = useState(!!editId);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        if (editId) {
          adminFetch('/api/admin/vendors')
            .then(data => {
              const v = (data.vendors || []).find(v => v.id === editId);
              if (v) setForm({ name: v.name || '', code: v.code || '', website: v.website || '', email: v.email || '' });
              setLoading(false);
            })
            .catch(() => setLoading(false));
        }
      }, [editId]);

      const handleSave = async () => {
        if (!form.name.trim() || !form.code.trim()) { alert('Name and code are required'); return; }
        setSaving(true);
        try {
          if (editId) {
            await adminFetch('/api/admin/vendors/' + editId, { method: 'PUT', body: JSON.stringify(form) });
          } else {
            await adminFetch('/api/admin/vendors', { method: 'POST', body: JSON.stringify(form) });
          }
          navigate('vendors');
        } catch (err) {
          alert('Save failed: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      if (loading) return <div className="loading">Loading vendor...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>{editId ? 'Edit Vendor' : 'New Vendor'}</h1>
            <div style={{ display: 'flex', gap: '0.75rem' }}>
              <button className="btn btn-secondary" onClick={() => navigate('vendors')}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
                {saving ? 'Saving...' : 'Save Vendor'}
              </button>
            </div>
          </div>
          <div className="form-card">
            <h3>Vendor Details</h3>
            <div className="form-grid">
              <div className="form-group">
                <label>Vendor Name *</label>
                <input value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} placeholder="e.g. MSI Surfaces" />
              </div>
              <div className="form-group">
                <label>Code *</label>
                <input value={form.code} onChange={e => setForm(prev => ({ ...prev, code: e.target.value }))} placeholder="e.g. MSI" />
              </div>
              <div className="form-group full">
                <label>Website</label>
                <input value={form.website} onChange={e => setForm(prev => ({ ...prev, website: e.target.value }))} placeholder="https://..." />
              </div>
              <div className="form-group full">
                <label>Email</label>
                <input type="email" value={form.email} onChange={e => setForm(prev => ({ ...prev, email: e.target.value }))} placeholder="orders@vendor.com" />
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ========== CategoriesListView ==========
    function CategoriesListView({ navigate }) {
      const [tree, setTree] = useState([]);
      const [loading, setLoading] = useState(true);
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [deleteError, setDeleteError] = useState('');

      const load = () => {
        setLoading(true);
        adminFetch('/api/admin/categories')
          .then(data => { setTree(data.tree || []); setLoading(false); })
          .catch(() => setLoading(false));
      };
      useEffect(load, []);

      const handleDelete = () => {
        if (!deleteTarget) return;
        setDeleteError('');
        adminFetch('/api/admin/categories/' + deleteTarget.id, { method: 'DELETE' })
          .then(data => {
            if (data.error) { setDeleteError(data.error); return; }
            setDeleteTarget(null);
            load();
          })
          .catch(err => setDeleteError(err.message));
      };

      if (loading) return <div className="loading">Loading categories...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Categories</h1>
            <button className="btn btn-primary" onClick={() => navigate('category-create')}>+ Add Category</button>
          </div>
          <div style={{ background: 'white', border: '1px solid var(--stone-200)' }}>
            {tree.length === 0 && (
              <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--stone-400)', fontSize: '0.875rem' }}>No categories found</div>
            )}
            {tree.map(parent => (
              <div key={parent.id}>
                <div className="cat-tree-item cat-tree-parent">
                  <div>
                    {parent.name}
                    <span className="cat-tree-slug">/{parent.slug}</span>
                    <span className="cat-tree-count">{parent.product_count} product{parent.product_count !== 1 ? 's' : ''}</span>
                  </div>
                  <div className="actions">
                    <button className="btn btn-secondary btn-sm" onClick={() => navigate('category-edit', parent.id)}>Edit</button>
                    <button className="btn btn-danger btn-sm" onClick={() => { setDeleteError(''); setDeleteTarget(parent); }}>Delete</button>
                  </div>
                </div>
                {(parent.children || []).map(child => (
                  <div key={child.id} className="cat-tree-item cat-tree-child">
                    <div>
                      {child.name}
                      <span className="cat-tree-slug">/{child.slug}</span>
                      <span className="cat-tree-count">{child.product_count} product{child.product_count !== 1 ? 's' : ''}</span>
                    </div>
                    <div className="actions">
                      <button className="btn btn-secondary btn-sm" onClick={() => navigate('category-edit', child.id)}>Edit</button>
                      <button className="btn btn-danger btn-sm" onClick={() => { setDeleteError(''); setDeleteTarget(child); }}>Delete</button>
                    </div>
                  </div>
                ))}
              </div>
            ))}
          </div>
          {deleteTarget && (
            <DeleteConfirmModal
              title="Delete Category"
              message={`Are you sure you want to delete "${deleteTarget.name}"? This will fail if the category has subcategories or products.`}
              error={deleteError}
              onConfirm={handleDelete}
              onCancel={() => { setDeleteTarget(null); setDeleteError(''); }}
            />
          )}
        </div>
      );
    }

    // ========== CategoryFormView ==========
    function CategoryFormView({ navigate, editId }) {
      const [form, setForm] = useState({ name: '', slug: '', parent_id: '', sort_order: 0 });
      const [categories, setCategories] = useState([]);
      const [loading, setLoading] = useState(!!editId);
      const [saving, setSaving] = useState(false);
      const [autoSlug, setAutoSlug] = useState(true);

      useEffect(() => {
        adminFetch('/api/admin/categories').then(data => {
          setCategories(data.flat || []);
          if (editId) {
            const cat = (data.flat || []).find(c => c.id === editId);
            if (cat) {
              setForm({ name: cat.name || '', slug: cat.slug || '', parent_id: cat.parent_id || '', sort_order: cat.sort_order || 0 });
              setAutoSlug(false);
            }
            setLoading(false);
          }
        }).catch(() => setLoading(false));
      }, [editId]);

      const updateName = (value) => {
        setForm(prev => ({
          ...prev,
          name: value,
          slug: autoSlug ? value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') : prev.slug
        }));
      };

      const handleSave = async () => {
        if (!form.name.trim() || !form.slug.trim()) { alert('Name and slug are required'); return; }
        setSaving(true);
        try {
          const payload = { ...form, parent_id: form.parent_id || null, sort_order: parseInt(form.sort_order) || 0 };
          if (editId) {
            await adminFetch('/api/admin/categories/' + editId, { method: 'PUT', body: JSON.stringify(payload) });
          } else {
            await adminFetch('/api/admin/categories', { method: 'POST', body: JSON.stringify(payload) });
          }
          navigate('categories');
        } catch (err) {
          alert('Save failed: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      if (loading) return <div className="loading">Loading category...</div>;

      // Only show parents (no parent_id) as parent options, exclude self
      const parentOptions = categories.filter(c => !c.parent_id && c.id !== editId);

      return (
        <div>
          <div className="content-header">
            <h1>{editId ? 'Edit Category' : 'New Category'}</h1>
            <div style={{ display: 'flex', gap: '0.75rem' }}>
              <button className="btn btn-secondary" onClick={() => navigate('categories')}>Cancel</button>
              <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
                {saving ? 'Saving...' : 'Save Category'}
              </button>
            </div>
          </div>
          <div className="form-card">
            <h3>Category Details</h3>
            <div className="form-grid">
              <div className="form-group">
                <label>Name *</label>
                <input value={form.name} onChange={e => updateName(e.target.value)} placeholder="e.g. Natural Stone" />
              </div>
              <div className="form-group">
                <label>Slug *</label>
                <input value={form.slug} onChange={e => { setAutoSlug(false); setForm(prev => ({ ...prev, slug: e.target.value })); }} placeholder="natural-stone" />
              </div>
              <div className="form-group">
                <label>Parent Category</label>
                <select value={form.parent_id} onChange={e => setForm(prev => ({ ...prev, parent_id: e.target.value }))}>
                  <option value="">None (top-level)</option>
                  {parentOptions.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              <div className="form-group">
                <label>Sort Order</label>
                <input type="number" value={form.sort_order} onChange={e => setForm(prev => ({ ...prev, sort_order: e.target.value }))} />
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ========== OrdersListView ==========
    function OrdersListView({ navigate }) {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [statusGroup, setStatusGroup] = useState('open');
      const [myOrders, setMyOrders] = useState(false);

      const openStatuses = ['pending', 'confirmed', 'shipped'];
      const closedStatuses = ['delivered', 'cancelled'];

      const load = () => {
        setLoading(true);
        adminFetch('/api/admin/orders')
          .then(data => { setOrders(data.orders || []); setLoading(false); })
          .catch(() => setLoading(false));
      };
      useEffect(load, []);

      const staffData = JSON.parse(sessionStorage.getItem('staff_data') || 'null');
      const isRepOrManager = staffData && (staffData.role === 'sales_rep' || staffData.role === 'manager');

      const filtered = orders.filter(o => {
        const inGroup = statusGroup === 'open' ? openStatuses.includes(o.status) : closedStatuses.includes(o.status);
        if (!inGroup) return false;
        if (myOrders && staffData) return o.sales_rep_id === staffData.id;
        return true;
      });

      if (loading) return <div className="loading">Loading orders...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Orders</h1>
          </div>
          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem', alignItems: 'center' }}>
            <button className={statusGroup === 'open' ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'} onClick={() => setStatusGroup('open')}>Open</button>
            <button className={statusGroup === 'closed' ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'} onClick={() => setStatusGroup('closed')}>Closed</button>
            {isRepOrManager && (
              <label style={{ marginLeft: '1rem', display: 'flex', alignItems: 'center', gap: '0.35rem', fontSize: '0.8125rem', color: 'var(--stone-600)', cursor: 'pointer' }}>
                <input type="checkbox" checked={myOrders} onChange={e => setMyOrders(e.target.checked)} />
                My Orders
              </label>
            )}
            <span style={{ marginLeft: 'auto', fontSize: '0.8125rem', color: 'var(--stone-400)' }}>{filtered.length} order{filtered.length !== 1 ? 's' : ''}</span>
          </div>
          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th>Order #</th>
                <th>Customer</th>
                <th>Email</th>
                <th>Items</th>
                <th>Total</th>
                <th>Method</th>
                <th>Status</th>
                <th>Rep</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map(o => (
                <tr key={o.id}>
                  <td style={{ fontWeight: 500 }}>{o.order_number}</td>
                  <td>{o.customer_name}</td>
                  <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{o.customer_email}</td>
                  <td>{o.item_count}</td>
                  <td>${parseFloat(o.total).toFixed(2)}</td>
                  <td>
                    {o.delivery_method === 'pickup'
                      ? <span className="badge badge-draft">Pickup</span>
                      : o.shipping_method === 'ltl_freight'
                        ? <span className="badge badge-shipped">LTL</span>
                        : <span className="badge badge-active">Parcel</span>
                    }
                  </td>
                  <td><span className={'badge badge-' + o.status}>{o.delivery_method === 'pickup' && o.status === 'shipped' ? 'ready' : o.delivery_method === 'pickup' && o.status === 'delivered' ? 'picked up' : o.status}</span></td>
                  <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{o.rep_name || '\u2014'}</td>
                  <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{new Date(o.created_at).toLocaleDateString()}</td>
                  <td className="actions">
                    <button className="btn btn-secondary btn-sm" onClick={() => navigate('order-detail', o.id)}>View</button>
                  </td>
                </tr>
              ))}
              {filtered.length === 0 && (
                <tr><td colSpan="10" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No {statusGroup} orders found</td></tr>
              )}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    // ========== DocumentPreviewModal ==========
    function DocumentPreviewModal({ url, title, onClose }) {
      const iframeRef = React.useRef(null);
      const previewUrl = url + (url.includes('?') ? '&' : '?') + 'preview=true';
      return (
        <div className="modal-overlay" onClick={e => { if (e.target === e.currentTarget) onClose(); }}>
          <div style={{ background: 'white', width: '90vw', height: '85vh', display: 'flex', flexDirection: 'column' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem 1rem', borderBottom: '1px solid var(--stone-200)' }}>
              <h3 style={{ fontFamily: "'Cormorant Garamond', serif", fontSize: '1.25rem', fontWeight: 400, margin: 0 }}>{title}</h3>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '1.25rem', cursor: 'pointer', color: 'var(--stone-500)' }}>{'\u2715'}</button>
            </div>
            <div style={{ flex: 1, overflow: 'hidden' }}>
              <iframe ref={iframeRef} src={previewUrl} style={{ width: '100%', height: '100%', border: 'none' }} />
            </div>
            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '0.5rem', padding: '0.75rem 1rem', borderTop: '1px solid var(--stone-200)' }}>
              <button className="btn btn-secondary" onClick={() => {
                try { iframeRef.current.contentWindow.print(); } catch(e) { window.open(previewUrl, '_blank'); }
              }}>Print</button>
              <button className="btn btn-primary" onClick={() => window.open(url, '_blank')}>Download PDF</button>
            </div>
          </div>
        </div>
      );
    }

    // ========== OrderDetailView ==========
    function OrderDetailView({ navigate, editId, staffRole }) {
      const [order, setOrder] = useState(null);
      const [items, setItems] = useState([]);
      const [loading, setLoading] = useState(true);
      const [updating, setUpdating] = useState(false);
      const [reps, setReps] = useState([]);
      const [purchaseOrders, setPurchaseOrders] = useState([]);
      const [docPreview, setDocPreview] = useState(null);
      const [posLoading, setPosLoading] = useState(false);
      const [poUpdating, setPoUpdating] = useState(false);
      const [showTrackingForm, setShowTrackingForm] = useState(false);
      const [trackingData, setTrackingData] = useState({ tracking_number: '', carrier: '', shipped_at: new Date().toISOString().slice(0, 10) });
      const [addingItemPOId, setAddingItemPOId] = useState(null);
      const [newPOItem, setNewPOItem] = useState({ product_name: '', vendor_sku: '', qty: 1, cost: '' });
      const [poActivity, setPOActivity] = useState({});
      const [showRefundModal, setShowRefundModal] = useState(false);
      const [refunding, setRefunding] = useState(false);
      const [showDeliveryForm, setShowDeliveryForm] = useState(false);
      const [deliveryAddress, setDeliveryAddress] = useState({ line1: '', line2: '', city: '', state: '', zip: '' });
      const [shippingOptions, setShippingOptions] = useState(null);
      const [deliveryUpdating, setDeliveryUpdating] = useState(false);
      const [payments, setPayments] = useState([]);
      const [paymentRequests, setPaymentRequests] = useState([]);
      const [balanceInfo, setBalanceInfo] = useState(null);
      const [showPartialRefundModal, setShowPartialRefundModal] = useState(false);
      const [partialRefundAmount, setPartialRefundAmount] = useState('');
      const [partialRefundReason, setPartialRefundReason] = useState('');
      const [showPaymentRequestModal, setShowPaymentRequestModal] = useState(false);
      const [paymentRequestMessage, setPaymentRequestMessage] = useState('');
      const [addingItem, setAddingItem] = useState(false);
      const [addItemSku, setAddItemSku] = useState('');
      const [addItemBoxes, setAddItemBoxes] = useState(1);
      const [skuSearchResults, setSkuSearchResults] = useState([]);
      const [skuSearching, setSkuSearching] = useState(false);
      const [addItemMode, setAddItemMode] = useState('sku');
      const [customItemName, setCustomItemName] = useState('');
      const [customItemPrice, setCustomItemPrice] = useState('');
      const [customItemVendor, setCustomItemVendor] = useState('');
      const [customItemDesc, setCustomItemDesc] = useState('');
      const [customItemBoxes, setCustomItemBoxes] = useState(1);
      const [addItemVendors, setAddItemVendors] = useState([]);
      const [orderActivity, setOrderActivity] = useState(null);

      const orderActionLabel = (action) => {
        const labels = {
          status_changed: 'Status Changed', delivery_method_changed: 'Delivery Changed',
          refund_issued: 'Refund Issued', item_added: 'Item Added', item_removed: 'Item Removed',
          payment_request_sent: 'Payment Request Sent', payment_request_cancelled: 'Payment Request Cancelled',
          rep_assigned: 'Rep Assigned', price_adjusted: 'Price Adjusted'
        };
        return labels[action] || action;
      };

      const orderActivityDetail = (entry) => {
        const d = entry.details || {};
        switch (entry.action) {
          case 'status_changed': return (d.from || '?') + ' â†’ ' + (d.to || '?') + (d.tracking_number ? ' (tracking: ' + d.tracking_number + ')' : '');
          case 'delivery_method_changed': return (d.from || '?') + ' â†’ ' + (d.to || '?') + (d.shipping_cost ? ' ($' + d.shipping_cost + ')' : '');
          case 'refund_issued': return '$' + (d.amount || '0') + (d.is_full ? ' (full)' : ' (partial)') + (d.reason ? ' â€” ' + d.reason : '');
          case 'item_added': return (d.product_name || '?') + (d.is_custom ? ' (custom)' : '') + ' Ã— ' + (d.num_boxes || '?') + ' â€” $' + (d.subtotal || '0');
          case 'item_removed': return (d.product_name || '?') + ' Ã— ' + (d.num_boxes || '?') + ' â€” $' + (d.subtotal || '0');
          case 'payment_request_sent': return '$' + (d.amount || '0') + ' to ' + (d.sent_to || '?');
          case 'payment_request_cancelled': return '$' + (d.amount || '0');
          case 'rep_assigned': return d.unassigned ? 'Unassigned' : (d.rep_name || '?');
          case 'price_adjusted': return (d.product_name || '?') + ': $' + (d.previous_price || '?') + ' â†’ $' + (d.new_price || '?') + (d.reason ? ' â€” ' + d.reason : '');
          default: return JSON.stringify(d);
        }
      };

      const loadOrderActivity = async () => {
        try {
          const data = await adminFetch('/api/admin/orders/' + editId + '/activity');
          setOrderActivity(data.activity || []);
        } catch (err) { console.error('Failed to load order activity:', err); }
      };

      const loadPOs = () => {
        if (!editId) return;
        setPosLoading(true);
        adminFetch('/api/admin/orders/' + editId + '/purchase-orders')
          .then(data => {
            const pos = data.purchase_orders || [];
            setPurchaseOrders(pos);
            setPosLoading(false);
            // Auto-load activity for all POs
            pos.forEach(po => {
              adminFetch('/api/admin/purchase-orders/' + po.id + '/activity')
                .then(actData => setPOActivity(prev => ({ ...prev, [po.id]: actData.activity || [] })))
                .catch(() => {});
            });
          })
          .catch(() => setPosLoading(false));
      };

      useEffect(() => {
        if (!editId) return;
        adminFetch('/api/admin/orders/' + editId)
          .then(data => {
            setOrder(data.order);
            setItems(data.items || []);
            setPayments(data.payments || []);
            setPaymentRequests(data.payment_requests || []);
            setBalanceInfo(data.balance || null);
            setLoading(false);
          })
          .catch(() => setLoading(false));
        adminFetch('/api/admin/staff').then(data => setReps((data.staff || []).filter(s => ['sales_rep', 'manager'].includes(s.role) && s.is_active))).catch(() => {});
        loadPOs();
      }, [editId]);

      const updatePOStatus = async (poId, newStatus) => {
        const labels = { sent: 'Mark as Sent', acknowledged: 'Mark as Acknowledged', fulfilled: 'Mark as Fulfilled', cancelled: 'Cancel', draft: 'Revert to Draft' };
        if (!confirm((labels[newStatus] || newStatus) + ' this PO?')) return;
        setPoUpdating(true);
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId + '/status', {
            method: 'PUT', body: JSON.stringify({ status: newStatus })
          });
          loadPOs();
        } catch (err) { alert(err.message); }
        setPoUpdating(false);
      };

      const updatePONotes = async (poId, notes) => {
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId, {
            method: 'PUT', body: JSON.stringify({ notes })
          });
        } catch (err) { alert(err.message); }
      };

      const updatePOItem = async (poId, itemId, updates) => {
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId + '/items/' + itemId, {
            method: 'PUT', body: JSON.stringify(updates)
          });
          loadPOs();
        } catch (err) { alert(err.message); }
      };

      const addPOItem = async (poId, itemData) => {
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId + '/items', {
            method: 'POST', body: JSON.stringify(itemData)
          });
          loadPOs();
        } catch (err) { alert(err.message); }
      };

      const deletePOItem = async (poId, itemId) => {
        if (!confirm('Delete this line item?')) return;
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId + '/items/' + itemId, {
            method: 'DELETE'
          });
          loadPOs();
        } catch (err) { alert(err.message); }
      };

      const loadPOActivity = async (poId) => {
        try {
          const data = await adminFetch('/api/admin/purchase-orders/' + poId + '/activity');
          setPOActivity(prev => ({ ...prev, [poId]: data.activity || [] }));
        } catch (err) { console.error('Failed to load PO activity:', err); }
      };

      const sendPOToVendor = async (poId, ediEnabled) => {
        const method = ediEnabled ? 'EDI' : 'email';
        if (!confirm('Send this PO to the vendor via ' + method + '?')) return;
        setPoUpdating(true);
        try {
          const result = await adminFetch('/api/admin/purchase-orders/' + poId + '/send', { method: 'POST' });
          if (result.sent_via === 'edi') {
            alert('PO sent via EDI successfully (' + (result.edi?.docs_sent || 1) + ' document(s))');
          } else if (result.email_sent === false) {
            alert('PO status updated but email could not be sent. Check server SMTP configuration.');
          }
          loadPOs();
          loadPOActivity(poId);
        } catch (err) { alert(err.message); }
        setPoUpdating(false);
      };

      const actionLabel = (action) => {
        const labels = { sent: 'Sent', resent: 'Resent', revised_and_sent: 'Revised & Sent', acknowledged: 'Acknowledged', fulfilled: 'Fulfilled', cancelled: 'Cancelled', reverted: 'Reverted to Draft', created: 'Created', notes_updated: 'Notes Updated', edi_sent: 'Sent via EDI', edi_acknowledged: 'EDI Acknowledged', edi_shipped: 'EDI Ship Notice', edi_invoiced: 'EDI Invoice Received' };
        return labels[action] || action;
      };

      const updatePOItemStatus = async (poId, itemId, status) => {
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId + '/items/' + itemId + '/status', {
            method: 'PUT', body: JSON.stringify({ status })
          });
          loadPOs();
        } catch (err) { alert(err.message); }
      };

      const bulkUpdatePOItemStatus = async (poId, status) => {
        if (!confirm('Set all non-terminal items to ' + status + '?')) return;
        try {
          await adminFetch('/api/admin/purchase-orders/' + poId + '/items/bulk-status', {
            method: 'PUT', body: JSON.stringify({ status })
          });
          loadPOs();
        } catch (err) { alert(err.message); }
      };

      const updateStatus = (newStatus) => {
        // For shipping orders being marked shipped, show tracking form first
        if (newStatus === 'shipped' && order.delivery_method === 'shipping' && !showTrackingForm) {
          setShowTrackingForm(true);
          return;
        }
        setUpdating(true);
        const body = { status: newStatus };
        if (newStatus === 'shipped' && showTrackingForm) {
          body.tracking_number = trackingData.tracking_number;
          body.carrier = trackingData.carrier;
          body.shipped_at = trackingData.shipped_at;
        }
        adminFetch('/api/admin/orders/' + editId + '/status', {
          method: 'PUT',
          body: JSON.stringify(body)
        })
          .then(data => {
            if (data.order) setOrder(data.order);
            loadPOs();
            setShowTrackingForm(false);
            setTrackingData({ tracking_number: '', carrier: '', shipped_at: new Date().toISOString().slice(0, 10) });
            setUpdating(false);
          })
          .catch(() => setUpdating(false));
      };

      const assignRep = (repId) => {
        adminFetch('/api/admin/orders/' + editId + '/assign', {
          method: 'PUT',
          body: JSON.stringify({ sales_rep_id: repId || null })
        }).then(data => {
          if (data.order) setOrder(data.order);
        }).catch(() => {});
      };

      if (loading) return <div className="loading">Loading order...</div>;
      if (!order) return <div className="loading">Order not found</div>;

      const statusFlow = { pending: 'confirmed', confirmed: 'shipped', shipped: 'delivered' };
      const reverseFlow = { confirmed: 'pending', shipped: 'confirmed', delivered: 'shipped', cancelled: 'pending' };
      const nextStatus = statusFlow[order.status];
      const prevStatus = reverseFlow[order.status];
      const canCancel = order.status !== 'cancelled' && order.status !== 'delivered' && order.status !== 'refunded';

      const productItems = items.filter(i => !i.is_sample);
      const sampleItems = items.filter(i => i.is_sample);

      return (
        <React.Fragment>
        <div>
          <div className="content-header">
            <h1>Order {order.order_number}</h1>
            <button className="btn btn-secondary" onClick={() => navigate('orders')}>Back to Orders</button>
          </div>

          {(() => {
            const isPickup = order.delivery_method === 'pickup';
            const steps = ['pending', 'confirmed', 'shipped', 'delivered'];
            const stepLabels = isPickup
              ? { pending: 'Pending', confirmed: 'Confirmed', shipped: 'Ready for Pickup', delivered: 'Picked Up' }
              : { pending: 'Pending', confirmed: 'Confirmed', shipped: 'Shipped', delivered: 'Delivered' };
            const stepTimestamps = {
              pending: order.created_at,
              confirmed: order.confirmed_at,
              shipped: order.shipped_at,
              delivered: order.delivered_at
            };
            const isCancelled = order.status === 'cancelled' || order.status === 'refunded';
            // For cancelled/refunded orders, figure out how far it got based on timestamps
            const currentIdx = isCancelled
              ? (order.shipped_at ? 2 : order.confirmed_at ? 1 : 0)
              : steps.indexOf(order.status);

            const getStepState = (stepIdx) => {
              if (isCancelled) return stepIdx <= currentIdx ? 'cancelled' : 'upcoming';
              if (stepIdx < currentIdx) return 'completed';
              if (stepIdx === currentIdx) return 'current';
              return 'upcoming';
            };

            return (
              <div className="form-card">
                <h3>Order Status</h3>

                {order.status === 'cancelled' && (
                  <div className="stepper-cancelled-banner">Order Cancelled</div>
                )}
                {order.status === 'refunded' && (
                  <div className="stepper-cancelled-banner" style={{ background: '#ede9fe', color: '#6d28d9', borderColor: '#6d28d9' }}>Order Refunded</div>
                )}

                <div className="order-stepper">
                  {/* Render connectors */}
                  {steps.slice(1).map((step, idx) => {
                    const prevState = getStepState(idx);
                    const curState = getStepState(idx + 1);
                    const connClass = (prevState === 'completed' && (curState === 'completed' || curState === 'current'))
                      ? 'completed'
                      : (prevState === 'cancelled' ? 'completed' : 'upcoming');
                    const pct = 100 / (steps.length - 1);
                    const leftPct = idx * pct;
                    return (
                      <div
                        key={'conn-' + idx}
                        className={'stepper-connector ' + connClass}
                        style={{
                          left: 'calc(' + (leftPct + pct * 0.15) + '% + 18px)',
                          width: 'calc(' + (pct * 0.7) + '% - 36px)',
                        }}
                      />
                    );
                  })}
                  {/* Render step nodes */}
                  {steps.map((step, idx) => {
                    const state = getStepState(idx);
                    const ts = stepTimestamps[step];
                    return (
                      <div key={step} className={'stepper-step ' + state}>
                        <div className="stepper-circle">
                          {state === 'completed' ? '\u2713' : state === 'cancelled' ? '\u2717' : (idx + 1)}
                        </div>
                        <div className="stepper-label">{stepLabels[step]}</div>
                        {ts && (state === 'completed' || state === 'current' || state === 'cancelled') && (
                          <div className="stepper-timestamp">{new Date(ts).toLocaleDateString()}</div>
                        )}
                      </div>
                    );
                  })}
                </div>

                {/* Tracking info display below stepper when shipped/delivered */}
                {order.tracking_number && !showTrackingForm && (
                  <div className="stepper-tracking-info">
                    <div><strong style={{ color: 'var(--stone-500)' }}>Tracking:</strong> {order.tracking_number}</div>
                    {order.shipping_carrier && <div><strong style={{ color: 'var(--stone-500)' }}>Carrier:</strong> {order.shipping_carrier}</div>}
                    {order.shipped_at && <div><strong style={{ color: 'var(--stone-500)' }}>Shipped:</strong> {new Date(order.shipped_at).toLocaleDateString()}</div>}
                  </div>
                )}

                {/* Tracking form - slides in when advancing to shipped */}
                {showTrackingForm && (
                  <div style={{ marginTop: '1rem', padding: '1rem', background: 'var(--stone-50)', border: '1px solid var(--stone-200)' }}>
                    <h4 style={{ margin: '0 0 0.75rem', fontSize: '0.875rem', color: 'var(--stone-700)' }}>Shipment Details</h4>
                    <div className="resp-grid-3" style={{ gap: '0.75rem' }}>
                      <div>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>Carrier *</label>
                        <select className="form-control" value={trackingData.carrier} onChange={e => setTrackingData({ ...trackingData, carrier: e.target.value })} style={{ fontSize: '0.8125rem' }}>
                          <option value="">Select carrier...</option>
                          <option>UPS</option>
                          <option>FedEx</option>
                          <option>USPS</option>
                          <option>FedEx Freight</option>
                          <option>XPO Logistics</option>
                          <option>R+L Carriers</option>
                          <option>SAIA</option>
                          <option>Old Dominion</option>
                          <option>Other</option>
                        </select>
                      </div>
                      <div>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>Tracking Number *</label>
                        <input className="form-control" type="text" placeholder="Enter tracking number" value={trackingData.tracking_number} onChange={e => setTrackingData({ ...trackingData, tracking_number: e.target.value })} style={{ fontSize: '0.8125rem' }} />
                      </div>
                      <div>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>Ship Date</label>
                        <input className="form-control" type="date" value={trackingData.shipped_at} onChange={e => setTrackingData({ ...trackingData, shipped_at: e.target.value })} style={{ fontSize: '0.8125rem' }} />
                      </div>
                    </div>
                    <div style={{ marginTop: '0.75rem', display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
                      <button className="btn btn-primary btn-sm" onClick={() => updateStatus('shipped')} disabled={updating || !trackingData.carrier || !trackingData.tracking_number}>
                        {updating ? 'Submitting...' : 'Confirm Shipment'}
                      </button>
                      <button className="btn btn-secondary btn-sm" onClick={() => setShowTrackingForm(false)}>Cancel</button>
                    </div>
                  </div>
                )}

                {/* Action bar below stepper */}
                {!showTrackingForm && (
                  <div className="stepper-actions">
                    {prevStatus && (
                      <button className="stepper-revert-link" onClick={() => { if (confirm('Revert order to ' + (stepLabels[prevStatus] || prevStatus) + '? This will clear any data from later steps (e.g. tracking info).')) updateStatus(prevStatus); }} disabled={updating}>
                        {'\u21A9'} Revert to {stepLabels[prevStatus] || prevStatus.charAt(0).toUpperCase() + prevStatus.slice(1)}
                      </button>
                    )}
                    {nextStatus && (
                      <button className="btn btn-primary" onClick={() => updateStatus(nextStatus)} disabled={updating}>
                        {updating ? 'Updating...' : 'Mark as ' + (stepLabels[nextStatus] || nextStatus.charAt(0).toUpperCase() + nextStatus.slice(1))}
                      </button>
                    )}
                    <button className="btn btn-secondary btn-sm" onClick={() => {
                      const token = sessionStorage.getItem('staff_token');
                      setDocPreview({ url: API + '/api/staff/orders/' + editId + '/packing-slip?token=' + encodeURIComponent(token), title: 'Packing Slip' });
                    }}>
                      Generate Packing Slip
                    </button>
                    <button className="btn btn-secondary btn-sm" onClick={() => {
                      const token = sessionStorage.getItem('staff_token');
                      setDocPreview({ url: API + '/api/staff/orders/' + editId + '/invoice?token=' + encodeURIComponent(token), title: 'Invoice' });
                    }}>
                      Generate Invoice
                    </button>
                    {canCancel && !isCancelled && (
                      <button className="stepper-cancel-link" onClick={() => updateStatus('cancelled')} disabled={updating}>
                        Cancel Order
                      </button>
                    )}
                    {order.status === 'cancelled' && !order.stripe_refund_id && order.stripe_payment_intent_id && ['admin', 'manager'].includes(staffRole) && (
                      <button className="btn" style={{ background: '#fef3c7', color: '#92400e' }}
                        onClick={() => setShowRefundModal(true)}>
                        Issue Refund
                      </button>
                    )}
                    {order.status === 'refunded' && (
                      <span className="badge badge-refunded" style={{ fontSize: '0.8125rem', padding: '0.35rem 0.85rem' }}>
                        Refunded ${parseFloat(order.refund_amount || 0).toFixed(2)}
                      </span>
                    )}
                  </div>
                )}
              </div>
            );
          })()}

          {/* Unsent PO warning */}
          {(() => {
            const unsentPOs = purchaseOrders.filter(po => po.status === 'draft');
            if (unsentPOs.length === 0) return null;
            return (
              <div style={{ padding: '0.75rem 1rem', background: '#fef3c7', border: '1px solid #f59e0b', color: '#92400e', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                {'\u26A0'} {unsentPOs.length} purchase order{unsentPOs.length > 1 ? 's have' : ' has'} not been sent to vendor{unsentPOs.length > 1 ? 's' : ''}
              </div>
            );
          })()}

          <div className="form-card">
            <h3>Assign Sales Rep</h3>
            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
              <select
                value={order.sales_rep_id || ''}
                onChange={e => assignRep(e.target.value)}
                style={{ padding: '0.5rem 0.75rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)', fontFamily: 'Inter, sans-serif' }}
              >
                <option value="">Unassigned</option>
                {reps.map(r => (
                  <option key={r.id} value={r.id}>{r.first_name} {r.last_name}</option>
                ))}
              </select>
              {order.rep_name && <span style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>Currently: {order.rep_name}</span>}
            </div>
          </div>

          <div className="form-card">
            <h3>Customer Information</h3>
            <div className="order-info-grid">
              <div className="order-info-item">
                <label>Name</label>
                <span>{order.customer_name}</span>
              </div>
              <div className="order-info-item">
                <label>Email</label>
                <span>{order.customer_email}</span>
              </div>
              <div className="order-info-item">
                <label>Phone</label>
                <span>{order.phone || 'â€”'}</span>
              </div>
              <div className="order-info-item">
                <label>Stripe Payment ID</label>
                <span style={{ fontSize: '0.75rem', fontFamily: 'monospace', wordBreak: 'break-all' }}>{order.stripe_payment_intent_id || 'â€”'}</span>
              </div>
            </div>
          </div>

          <div className="form-card">
            {order.delivery_method === 'pickup' ? (
              <>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h3 style={{ margin: 0 }}>Store Pickup</h3>
                  {['pending', 'confirmed'].includes(order.status) && (
                    <button className="btn btn-secondary btn-sm" disabled={deliveryUpdating} onClick={() => {
                      setDeliveryAddress({ line1: order.shipping_address_line1 || '', line2: order.shipping_address_line2 || '', city: order.shipping_city || '', state: order.shipping_state || '', zip: order.shipping_zip || '' });
                      setShippingOptions(null);
                      setShowDeliveryForm(true);
                    }}>Switch to Shipping</button>
                  )}
                </div>
                <div className="order-info-grid" style={{ marginTop: '0.75rem' }}>
                  <div className="order-info-item" style={{ gridColumn: '1 / -1' }}>
                    <span>
                      <strong>Roma Flooring Designs</strong><br />
                      1440 S. State College Blvd., Suite 6M<br />
                      Anaheim, CA 92806
                    </span>
                  </div>
                </div>
                {showDeliveryForm && (
                  <div style={{ marginTop: '1rem', padding: '1rem', background: 'var(--stone-50)', border: '1px solid var(--stone-200)', borderRadius: '6px' }}>
                    <h4 style={{ margin: '0 0 0.75rem', fontSize: '0.875rem', color: 'var(--stone-700)' }}>Shipping Address</h4>
                    <div className="resp-grid-2" style={{ gap: '0.75rem' }}>
                      <div style={{ gridColumn: '1 / -1' }}>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>Address Line 1 *</label>
                        <input className="form-control" value={deliveryAddress.line1} onChange={e => setDeliveryAddress({ ...deliveryAddress, line1: e.target.value })} style={{ fontSize: '0.8125rem' }} />
                      </div>
                      <div style={{ gridColumn: '1 / -1' }}>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>Address Line 2</label>
                        <input className="form-control" value={deliveryAddress.line2} onChange={e => setDeliveryAddress({ ...deliveryAddress, line2: e.target.value })} style={{ fontSize: '0.8125rem' }} />
                      </div>
                      <div>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>City *</label>
                        <input className="form-control" value={deliveryAddress.city} onChange={e => setDeliveryAddress({ ...deliveryAddress, city: e.target.value })} style={{ fontSize: '0.8125rem' }} />
                      </div>
                      <div className="resp-grid-2" style={{ gap: '0.75rem' }}>
                        <div>
                          <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>State *</label>
                          <input className="form-control" value={deliveryAddress.state} onChange={e => setDeliveryAddress({ ...deliveryAddress, state: e.target.value })} maxLength={2} style={{ fontSize: '0.8125rem' }} />
                        </div>
                        <div>
                          <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem' }}>ZIP *</label>
                          <input className="form-control" value={deliveryAddress.zip} onChange={e => setDeliveryAddress({ ...deliveryAddress, zip: e.target.value })} maxLength={10} style={{ fontSize: '0.8125rem' }} />
                        </div>
                      </div>
                    </div>
                    {!shippingOptions && (
                      <div style={{ marginTop: '0.75rem', display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
                        <button className="btn btn-primary btn-sm" disabled={deliveryUpdating || !deliveryAddress.line1 || !deliveryAddress.city || !deliveryAddress.state || !deliveryAddress.zip} onClick={async () => {
                          setDeliveryUpdating(true);
                          try {
                            const data = await adminFetch('/api/admin/orders/' + editId + '/delivery-method', {
                              method: 'PUT',
                              body: JSON.stringify({ delivery_method: 'shipping', shipping_address: deliveryAddress })
                            });
                            if (data.shipping_options) setShippingOptions(data.shipping_options);
                          } catch (err) {}
                          setDeliveryUpdating(false);
                        }}>{deliveryUpdating ? 'Calculating...' : 'Get Rates'}</button>
                        <button className="btn btn-secondary btn-sm" onClick={() => { setShowDeliveryForm(false); setShippingOptions(null); }}>Cancel</button>
                      </div>
                    )}
                    {shippingOptions && (
                      <div style={{ marginTop: '0.75rem' }}>
                        <div style={{ fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)', marginBottom: '0.5rem', fontWeight: 600 }}>Select Shipping Rate</div>
                        {shippingOptions.map((opt, idx) => (
                          <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.5rem 0.75rem', border: '1px solid var(--stone-200)', borderRadius: '4px', marginBottom: '0.5rem', background: '#fff' }}>
                            <div>
                              <strong style={{ fontSize: '0.8125rem' }}>{opt.carrier || 'Standard'}</strong>
                              {opt.service && <span style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginLeft: '0.5rem' }}>{opt.service}</span>}
                              {opt.transit_days && <span style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginLeft: '0.5rem' }}>({opt.transit_days} days)</span>}
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                              <strong>${parseFloat(opt.amount).toFixed(2)}</strong>
                              <button className="btn btn-primary btn-sm" disabled={deliveryUpdating} onClick={async () => {
                                setDeliveryUpdating(true);
                                try {
                                  const data = await adminFetch('/api/admin/orders/' + editId + '/delivery-method', {
                                    method: 'PUT',
                                    body: JSON.stringify({ delivery_method: 'shipping', shipping_address: deliveryAddress, shipping_option_index: idx })
                                  });
                                  if (data.order) { setOrder(data.order); setShowDeliveryForm(false); setShippingOptions(null); }
                                  if (data.balance) setBalanceInfo(data.balance);
                                } catch (err) {}
                                setDeliveryUpdating(false);
                              }}>{deliveryUpdating ? 'Applying...' : 'Apply'}</button>
                            </div>
                          </div>
                        ))}
                        <div style={{ marginTop: '0.5rem', textAlign: 'center' }}>
                          <button className="btn btn-secondary btn-sm" onClick={() => { setShowDeliveryForm(false); setShippingOptions(null); }}>Cancel</button>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </>
            ) : (
              <>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h3 style={{ margin: 0 }}>Shipping Address</h3>
                  {['pending', 'confirmed'].includes(order.status) && (
                    <button className="btn btn-secondary btn-sm" disabled={deliveryUpdating} onClick={async () => {
                      if (!confirm('Switch this order to store pickup? Shipping will be set to $0.')) return;
                      setDeliveryUpdating(true);
                      try {
                        const data = await adminFetch('/api/admin/orders/' + editId + '/delivery-method', {
                          method: 'PUT',
                          body: JSON.stringify({ delivery_method: 'pickup' })
                        });
                        if (data.order) setOrder(data.order);
                        if (data.balance) setBalanceInfo(data.balance);
                      } catch (err) {}
                      setDeliveryUpdating(false);
                    }}>{deliveryUpdating ? 'Updating...' : 'Switch to Pickup'}</button>
                  )}
                </div>
                <div className="order-info-grid" style={{ marginTop: '0.75rem' }}>
                  <div className="order-info-item" style={{ gridColumn: '1 / -1' }}>
                    <span>
                      {order.shipping_address_line1}
                      {order.shipping_address_line2 && <><br />{order.shipping_address_line2}</>}
                      <br />{order.shipping_city}, {order.shipping_state} {order.shipping_zip}
                    </span>
                  </div>
                </div>
                {order.shipping_method && (
                  <div style={{ marginTop: '1.25rem', paddingTop: '1.25rem', borderTop: '1px solid var(--stone-200)' }}>
                    <div style={{ fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)', marginBottom: '0.75rem', fontWeight: 600 }}>Shipping Details</div>
                    <div className="order-info-grid">
                      <div className="order-info-item">
                        <label>Method</label>
                        <span>
                          <span className={'badge ' + (order.shipping_method === 'ltl_freight' ? 'badge-shipped' : 'badge-active')} style={{ marginRight: '0.5rem' }}>
                            {order.shipping_method === 'ltl_freight' ? 'LTL Freight' : 'Parcel'}
                          </span>
                        </span>
                      </div>
                      {order.shipping_carrier && (
                        <div className="order-info-item">
                          <label>Carrier</label>
                          <span>{order.shipping_carrier}</span>
                        </div>
                      )}
                      {order.shipping_transit_days && (
                        <div className="order-info-item">
                          <label>Est. Transit</label>
                          <span>{order.shipping_transit_days} business day{order.shipping_transit_days !== 1 ? 's' : ''}</span>
                        </div>
                      )}
                      {order.shipping_method === 'ltl_freight' && (
                        <div className="order-info-item">
                          <label>Services</label>
                          <span style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                            {order.shipping_residential && <span className="badge badge-draft">Residential</span>}
                            {order.shipping_liftgate && <span className="badge badge-draft">Liftgate</span>}
                            {!order.shipping_residential && !order.shipping_liftgate && 'â€”'}
                          </span>
                        </div>
                      )}
                    </div>
                    {order.shipping_is_fallback && (
                      <div style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#d97706', fontStyle: 'italic' }}>
                        Rate was estimated (FreightView unavailable at checkout)
                      </div>
                    )}
                  </div>
                )}
              </>
            )}
          </div>

          <div className="form-card">
            <h3>Order Items</h3>
            <div className="table-scroll-wrapper">
            <table className="admin-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Collection</th>
                  <th>Type</th>
                  <th>SqFt</th>
                  <th>Boxes</th>
                  <th>Unit Price</th>
                  <th>Subtotal</th>
                  {['pending', 'confirmed'].includes(order.status) && ['admin', 'manager'].includes(staffRole) && <th>Actions</th>}
                </tr>
              </thead>
              <tbody>
                {items.map(item => (
                  <tr key={item.id}>
                    <td style={{ fontWeight: 500 }}>{item.product_name || item.current_product_name || 'â€”'}</td>
                    <td>{item.collection || item.current_collection || 'â€”'}</td>
                    <td>
                      <span className={'badge ' + (item.is_sample ? 'badge-draft' : 'badge-active')}>
                        {item.is_sample ? 'Sample' : 'Product'}
                      </span>
                    </td>
                    <td>{item.sqft_needed ? parseFloat(item.sqft_needed).toFixed(1) : 'â€”'}</td>
                    <td>{item.num_boxes}</td>
                    <td>{item.unit_price ? '$' + parseFloat(item.unit_price).toFixed(2) : 'â€”'}</td>
                    <td>{item.subtotal ? '$' + parseFloat(item.subtotal).toFixed(2) : 'â€”'}</td>
                    {['pending', 'confirmed'].includes(order.status) && ['admin', 'manager'].includes(staffRole) && (
                      <td>
                        {!item.is_sample && (
                          <button className="btn btn-sm btn-secondary" style={{ color: '#dc2626', fontSize: '0.75rem' }}
                            onClick={async () => {
                              if (!confirm('Remove this item from the order?')) return;
                              try {
                                const data = await adminFetch('/api/admin/orders/' + editId + '/items/' + item.id, { method: 'DELETE' });
                                if (data.order) setOrder(data.order);
                                if (data.items) setItems(data.items);
                                if (data.balance) setBalanceInfo(data.balance);
                                loadPOs();
                              } catch (err) { alert(err.message); }
                            }}>Remove</button>
                        )}
                      </td>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
            </div>
            {['pending', 'confirmed'].includes(order.status) && ['admin', 'manager'].includes(staffRole) && (
              <div style={{ marginTop: '0.75rem' }}>
                {!addingItem ? (
                  <button className="btn btn-sm btn-secondary" onClick={() => {
                    setAddingItem(true); setAddItemMode('sku'); setAddItemSku(''); setAddItemBoxes(1);
                    setSkuSearchResults([]); setCustomItemName(''); setCustomItemPrice('');
                    setCustomItemVendor(''); setCustomItemDesc(''); setCustomItemBoxes(1);
                    if (addItemVendors.length === 0) {
                      adminFetch('/api/admin/vendors').then(d => setAddItemVendors(d.vendors || [])).catch(() => {});
                    }
                  }}>
                    + Add Item
                  </button>
                ) : (
                  <div style={{ padding: '1rem', border: '1px solid var(--stone-200)', background: 'var(--stone-50)' }}>
                    {/* Mode toggle */}
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                      <button className={addItemMode === 'sku' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-secondary'}
                        onClick={() => { setAddItemMode('sku'); setCustomItemName(''); setCustomItemPrice(''); setCustomItemVendor(''); setCustomItemDesc(''); setCustomItemBoxes(1); }}>
                        Search SKU
                      </button>
                      <button className={addItemMode === 'custom' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-secondary'}
                        onClick={() => { setAddItemMode('custom'); setAddItemSku(''); setSkuSearchResults([]); setAddItemBoxes(1); }}>
                        Custom Item
                      </button>
                      <div style={{ flex: 1 }}></div>
                      <button className="btn btn-sm btn-secondary" onClick={() => setAddingItem(false)}>Cancel</button>
                    </div>

                    {addItemMode === 'sku' ? (
                      /* SKU search mode */
                      <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'flex-end', flexWrap: 'wrap' }}>
                        <div style={{ flex: 2, minWidth: '0' }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Search SKU</label>
                          <input type="text" value={addItemSku} placeholder="Type SKU or product name..."
                            onChange={async (e) => {
                              const q = e.target.value; setAddItemSku(q);
                              if (q.length >= 2) {
                                setSkuSearching(true);
                                try {
                                  const data = await adminFetch('/api/admin/skus/search?q=' + encodeURIComponent(q));
                                  setSkuSearchResults((data.results || []).map(r => ({
                                    sku_id: r.sku_id,
                                    label: r.product_name + ' â€” ' + (r.variant_name || r.internal_sku),
                                    price: r.retail_price || 0,
                                    vendor_name: r.vendor_name
                                  })));
                                } catch (e) {}
                                setSkuSearching(false);
                              } else { setSkuSearchResults([]); }
                            }}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
                          {skuSearchResults.length > 0 && (
                            <div style={{ border: '1px solid var(--stone-200)', maxHeight: '150px', overflow: 'auto', background: '#fff' }}>
                              {skuSearchResults.map((r, i) => (
                                <div key={i} style={{ padding: '0.5rem', cursor: 'pointer', borderBottom: '1px solid var(--stone-100)', fontSize: '0.8125rem' }}
                                  onClick={async () => {
                                    try {
                                      const data = await adminFetch('/api/admin/orders/' + editId + '/add-item', {
                                        method: 'POST', body: JSON.stringify({ sku_id: r.sku_id, num_boxes: addItemBoxes })
                                      });
                                      if (data.order) setOrder(data.order);
                                      if (data.items) setItems(data.items);
                                      if (data.balance) setBalanceInfo(data.balance);
                                      loadPOs();
                                      setAddingItem(false); setSkuSearchResults([]);
                                    } catch (err) { alert(err.message); }
                                  }}>
                                  {r.label}{r.vendor_name ? ' (' + r.vendor_name + ')' : ''} â€” ${parseFloat(r.price).toFixed(2)}
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                        <div style={{ width: '80px' }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Boxes</label>
                          <input type="number" min="1" value={addItemBoxes} onChange={e => setAddItemBoxes(parseInt(e.target.value) || 1)}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
                        </div>
                      </div>
                    ) : (
                      /* Custom item mode */
                      <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'flex-end', flexWrap: 'wrap' }}>
                        <div style={{ minWidth: '160px', flex: 1 }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Vendor *</label>
                          <select value={customItemVendor} onChange={e => setCustomItemVendor(e.target.value)}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }}>
                            <option value="">Select vendor...</option>
                            {addItemVendors.map(v => (
                              <option key={v.id} value={v.id}>{v.name}</option>
                            ))}
                          </select>
                        </div>
                        <div style={{ minWidth: '160px', flex: 2 }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Product Name *</label>
                          <input type="text" value={customItemName} onChange={e => setCustomItemName(e.target.value)}
                            placeholder="e.g. Custom transition strip"
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
                        </div>
                        <div style={{ width: '100px' }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Unit Price *</label>
                          <input type="number" min="0" step="0.01" value={customItemPrice} onChange={e => setCustomItemPrice(e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
                        </div>
                        <div style={{ width: '70px' }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Boxes *</label>
                          <input type="number" min="1" value={customItemBoxes} onChange={e => setCustomItemBoxes(parseInt(e.target.value) || 1)}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
                        </div>
                        <div style={{ minWidth: '140px', flex: 1 }}>
                          <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Description</label>
                          <input type="text" value={customItemDesc} onChange={e => setCustomItemDesc(e.target.value)}
                            placeholder="Optional notes"
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
                        </div>
                        <button className="btn btn-sm btn-primary" disabled={!customItemVendor || !customItemName.trim() || !customItemPrice}
                          onClick={async () => {
                            try {
                              const data = await adminFetch('/api/admin/orders/' + editId + '/add-item', {
                                method: 'POST', body: JSON.stringify({
                                  product_name: customItemName.trim(),
                                  unit_price: parseFloat(customItemPrice),
                                  vendor_id: customItemVendor,
                                  num_boxes: customItemBoxes,
                                  description: customItemDesc || undefined
                                })
                              });
                              if (data.order) setOrder(data.order);
                              if (data.items) setItems(data.items);
                              if (data.balance) setBalanceInfo(data.balance);
                              loadPOs();
                              setAddingItem(false);
                            } catch (err) { alert(err.message); }
                          }}>
                          Add
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Purchase Orders */}
          {purchaseOrders.length > 0 && (
            <div className="form-card">
              <h3>Purchase Orders</h3>
              {posLoading ? <p>Loading...</p> : purchaseOrders.map(po => {
                const isDraft = po.status === 'draft';
                const isSentOrLater = ['sent', 'acknowledged', 'fulfilled'].includes(po.status);
                const statusActions = {
                  sent: [{ label: 'Mark Acknowledged', status: 'acknowledged' }],
                  acknowledged: [{ label: 'Mark Fulfilled', status: 'fulfilled' }],
                };
                const revertTargets = { sent: 'draft', acknowledged: 'sent', fulfilled: 'acknowledged' };
                const revertTarget = revertTargets[po.status];
                const actions = statusActions[po.status] || [];
                return (
                  <div key={po.id} style={{ marginBottom: '2rem', border: '1px solid var(--stone-200)', padding: '1.5rem' }}>
                    {/* PO Header */}
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem', flexWrap: 'wrap', gap: '0.5rem' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                        <strong>{po.vendor_name}</strong>
                        <code style={{ fontSize: '0.75rem', background: 'var(--stone-100)', padding: '0.2rem 0.5rem' }}>{po.po_number}</code>
                        <span className={'badge badge-' + po.status}>{po.status}</span>
                        {po.is_revised && (
                          <span className="badge" style={{ background: '#fef3c7', color: '#92400e' }}>REVISED</span>
                        )}
                        {po.edi_ack_status && (
                          <span className="badge" style={{
                            background: po.edi_ack_status === 'accepted' ? '#dcfce7' : po.edi_ack_status === 'rejected' ? '#fef2f2' : '#fef9c3',
                            color: po.edi_ack_status === 'accepted' ? '#166534' : po.edi_ack_status === 'rejected' ? '#991b1b' : '#854d0e'
                          }}>EDI: {po.edi_ack_status === 'accepted' ? 'Accepted' : po.edi_ack_status === 'rejected' ? 'Rejected' : 'Partial'}</span>
                        )}
                        {po.edi_interchange_id && !po.edi_ack_status && (
                          <span className="badge" style={{ background: '#dbeafe', color: '#1e40af' }}>EDI Sent</span>
                        )}
                      </div>
                      <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center' }}>
                        {revertTarget && (
                          <button className="stepper-revert-link" style={{ fontSize: '0.75rem' }}
                            onClick={() => updatePOStatus(po.id, revertTarget)} disabled={poUpdating}>
                            {'\u21A9'} Revert to {revertTarget.charAt(0).toUpperCase() + revertTarget.slice(1)}
                          </button>
                        )}
                        {(po.status === 'draft' || po.status === 'sent') && (
                          <button className="btn btn-primary" style={{ fontSize: '0.75rem', padding: '0.3rem 0.75rem' }}
                            onClick={() => sendPOToVendor(po.id, po.edi_config?.enabled)} disabled={poUpdating}>
                            {po.edi_config?.enabled
                              ? (po.status === 'sent' ? 'Resend via EDI' : 'Send via EDI')
                              : (po.status === 'sent' ? 'Resend to Vendor' : 'Send to Vendor')}
                          </button>
                        )}
                        {actions.map(a => (
                          <button key={a.status} className="btn btn-primary" style={{ fontSize: '0.75rem', padding: '0.3rem 0.75rem' }}
                            onClick={() => updatePOStatus(po.id, a.status)} disabled={poUpdating}>
                            {a.label}
                          </button>
                        ))}
                        <button className="btn btn-secondary" style={{ fontSize: '0.75rem', padding: '0.3rem 0.75rem' }}
                          onClick={() => {
                            const token = sessionStorage.getItem('staff_token');
                            setDocPreview({ url: API + '/api/staff/purchase-orders/' + po.id + '/pdf?token=' + encodeURIComponent(token), title: 'Purchase Order - ' + po.po_number });
                          }}>
                          Download PO
                        </button>
                      </div>
                    </div>

                    {/* Bulk item status (for sent or later) */}
                    {isSentOrLater && (
                      <div style={{ marginBottom: '0.75rem', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                        <span style={{ fontSize: '0.75rem', color: 'var(--stone-500)' }}>Set All Items:</span>
                        {['ordered', 'shipped', 'received', 'cancelled'].map(s => (
                          <button key={s} className="btn btn-secondary" style={{ fontSize: '0.6875rem', padding: '0.2rem 0.5rem', textTransform: 'capitalize' }}
                            onClick={() => bulkUpdatePOItemStatus(po.id, s)} disabled={poUpdating}>
                            {s}
                          </button>
                        ))}
                      </div>
                    )}

                    {po.approved_by_name && (
                      <p style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.75rem' }}>
                        Approved by {po.approved_by_name} on {new Date(po.approved_at).toLocaleDateString()}
                      </p>
                    )}

                    {/* PO Items Table */}
                    <div className="table-scroll-wrapper">
                    <table className="admin-table" style={{ fontSize: '0.8125rem' }}>
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Vendor SKU</th>
                          <th>Qty</th>
                          <th>Retail</th>
                          <th>Cost</th>
                          <th>Margin</th>
                          {isSentOrLater && <th>Status</th>}
                          {po.items?.some(i => i.dye_lot) && <th>Dye Lot</th>}
                          {po.items?.some(i => i.qty_shipped != null) && <th>Shipped</th>}
                          <th style={{ textAlign: 'right' }}>Subtotal</th>
                          {isDraft && <th></th>}
                        </tr>
                      </thead>
                      <tbody>
                        {(po.items || []).map(item => {
                          const cost = parseFloat(item.cost);
                          const retail = parseFloat(item.retail_price || 0);
                          const margin = retail > 0 ? ((retail - cost) / retail * 100) : 0;
                          return (
                            <tr key={item.id}>
                              <td>{item.product_name || 'â€”'}</td>
                              <td>{item.vendor_sku || 'â€”'}</td>
                              <td>
                                {isDraft ? (
                                  <input type="number" min="1" defaultValue={item.qty} style={{ width: '60px', padding: '0.2rem 0.4rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)' }}
                                    onBlur={e => { const v = parseInt(e.target.value); if (v && v !== item.qty) updatePOItem(po.id, item.id, { qty: v }); }} />
                                ) : item.qty}
                              </td>
                              <td>{item.retail_price ? '$' + retail.toFixed(2) : 'â€”'}</td>
                              <td>
                                {isDraft ? (
                                  <input type="number" step="0.01" min="0" defaultValue={cost.toFixed(2)} style={{ width: '80px', padding: '0.2rem 0.4rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)' }}
                                    onBlur={e => { const v = parseFloat(e.target.value); if (!isNaN(v) && v !== cost) updatePOItem(po.id, item.id, { cost: v }); }} />
                                ) : '$' + cost.toFixed(2)}
                              </td>
                              <td style={{ color: margin <= 0 ? 'var(--red)' : 'inherit', fontWeight: margin <= 0 ? 600 : 400 }}>
                                {retail > 0 ? margin.toFixed(1) + '%' : 'â€”'}
                              </td>
                              {isSentOrLater && (
                                <td>
                                  <select value={item.status || 'pending'} onChange={e => updatePOItemStatus(po.id, item.id, e.target.value)}
                                    style={{ fontSize: '0.75rem', padding: '0.2rem 0.3rem', border: '1px solid var(--stone-300)' }}>
                                    <option value="pending">Pending</option>
                                    <option value="ordered">Ordered</option>
                                    <option value="shipped">Shipped</option>
                                    <option value="received">Received</option>
                                    <option value="cancelled">Cancelled</option>
                                  </select>
                                  {item.edi_line_status && (
                                    <span style={{ fontSize: '0.625rem', marginLeft: '0.25rem', color: item.edi_line_status === 'accepted' ? '#166534' : item.edi_line_status === 'rejected' ? '#991b1b' : '#854d0e' }}>
                                      ({item.edi_line_status})
                                    </span>
                                  )}
                                </td>
                              )}
                              {po.items?.some(i => i.dye_lot) && <td style={{ fontSize: '0.75rem' }}>{item.dye_lot || 'â€”'}</td>}
                              {po.items?.some(i => i.qty_shipped != null) && <td>{item.qty_shipped != null ? item.qty_shipped : 'â€”'}</td>}
                              <td style={{ textAlign: 'right' }}>${parseFloat(item.subtotal).toFixed(2)}</td>
                              {isDraft && (
                                <td>
                                  <button onClick={() => deletePOItem(po.id, item.id)} title="Delete item"
                                    style={{ background: 'none', border: 'none', color: 'var(--red)', cursor: 'pointer', fontSize: '1rem', padding: '0.2rem' }}>
                                    {'\u2715'}
                                  </button>
                                </td>
                              )}
                            </tr>
                          );
                        })}
                        {/* Add line item row (draft only) */}
                        {isDraft && addingItemPOId !== po.id && (
                          <tr><td colSpan="9">
                            <button onClick={() => { setAddingItemPOId(po.id); setNewPOItem({ product_name: '', vendor_sku: '', qty: 1, cost: '' }); }} style={{ background: 'none', border: 'none', color: 'var(--gold)', cursor: 'pointer', fontSize: '0.8125rem', fontWeight: 500 }}>
                              + Add Line Item
                            </button>
                          </td></tr>
                        )}
                        {isDraft && addingItemPOId === po.id && (
                          <tr>
                            <td><input type="text" placeholder="Product name" value={newPOItem.product_name} onChange={e => setNewPOItem({...newPOItem, product_name: e.target.value})} style={{ width: '100%', padding: '0.2rem 0.4rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)' }} /></td>
                            <td><input type="text" placeholder="Vendor SKU" value={newPOItem.vendor_sku} onChange={e => setNewPOItem({...newPOItem, vendor_sku: e.target.value})} style={{ width: '100%', padding: '0.2rem 0.4rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)' }} /></td>
                            <td><input type="number" min="1" value={newPOItem.qty} onChange={e => setNewPOItem({...newPOItem, qty: parseInt(e.target.value) || 1})} style={{ width: '60px', padding: '0.2rem 0.4rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)' }} /></td>
                            <td>â€”</td>
                            <td><input type="number" step="0.01" min="0" placeholder="0.00" value={newPOItem.cost} onChange={e => setNewPOItem({...newPOItem, cost: e.target.value})} style={{ width: '80px', padding: '0.2rem 0.4rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)' }} /></td>
                            <td>â€”</td>
                            <td style={{ textAlign: 'right' }}>
                              <button className="btn btn-primary" style={{ fontSize: '0.6875rem', padding: '0.2rem 0.5rem' }}
                                disabled={!newPOItem.product_name || !newPOItem.cost}
                                onClick={() => { addPOItem(po.id, newPOItem); setAddingItemPOId(null); setNewPOItem({ product_name: '', vendor_sku: '', qty: 1, cost: '' }); }}>
                                Save
                              </button>
                              <button className="btn btn-secondary" style={{ fontSize: '0.6875rem', padding: '0.2rem 0.5rem', marginLeft: '0.25rem' }}
                                onClick={() => { setAddingItemPOId(null); setNewPOItem({ product_name: '', vendor_sku: '', qty: 1, cost: '' }); }}>
                                Cancel
                              </button>
                            </td>
                            <td></td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                    </div>
                    <div style={{ textAlign: 'right', marginTop: '0.75rem', fontWeight: 600, fontSize: '0.9rem' }}>
                      PO Total: ${parseFloat(po.subtotal).toFixed(2)}
                    </div>

                    {/* Notes (draft editable) */}
                    {isDraft ? (
                      <div style={{ marginTop: '1rem' }}>
                        <label style={{ display: 'block', fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '0.25rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Notes</label>
                        <textarea
                          defaultValue={po.notes || ''}
                          placeholder="Add notes for this PO..."
                          onBlur={e => { if (e.target.value !== (po.notes || '')) updatePONotes(po.id, e.target.value); }}
                          style={{ width: '100%', minHeight: '60px', padding: '0.5rem', fontSize: '0.8125rem', border: '1px solid var(--stone-300)', fontFamily: 'Inter, sans-serif', resize: 'vertical' }}
                        />
                      </div>
                    ) : po.notes ? (
                      <div style={{ marginTop: '1rem', padding: '0.75rem', background: 'var(--stone-50)', border: '1px solid var(--stone-200)', fontSize: '0.8125rem' }}>
                        <strong style={{ fontSize: '0.6875rem', color: 'var(--stone-500)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Notes</strong>
                        <div style={{ marginTop: '0.25rem' }}>{po.notes}</div>
                      </div>
                    ) : null}

                    {/* Activity Log */}
                    <div style={{ marginTop: '1rem', borderTop: '1px solid var(--stone-200)', paddingTop: '0.75rem' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                        <strong style={{ fontSize: '0.6875rem', color: 'var(--stone-500)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Activity Log</strong>
                        {!poActivity[po.id] && (
                          <button className="btn btn-secondary" style={{ fontSize: '0.6875rem', padding: '0.15rem 0.5rem' }}
                            onClick={() => loadPOActivity(po.id)}>Load Activity</button>
                        )}
                      </div>
                      {poActivity[po.id] && (poActivity[po.id].length > 0 ? poActivity[po.id].map(entry => (
                        <div key={entry.id} style={{ fontSize: '0.75rem', padding: '0.35rem 0', borderBottom: '1px solid var(--stone-100)', display: 'flex', justifyContent: 'space-between' }}>
                          <span>
                            <strong>{actionLabel(entry.action)}</strong>
                            {entry.recipient_email && <span> to {entry.recipient_email}</span>}
                            {entry.revision > 1 && <span> (Rev {entry.revision})</span>}
                            {entry.performer_name && <span> â€” {entry.performer_name}</span>}
                          </span>
                          <span style={{ color: 'var(--stone-400)', whiteSpace: 'nowrap', marginLeft: '1rem' }}>{new Date(entry.created_at).toLocaleString()}</span>
                        </div>
                      )) : (
                        <p style={{ fontSize: '0.75rem', color: 'var(--stone-400)', margin: 0 }}>No activity yet</p>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* Order Activity */}
          <div className="form-card">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
              <h3 style={{ margin: 0 }}>Order Activity</h3>
              <button className="btn btn-secondary" style={{ fontSize: '0.75rem', padding: '0.3rem 0.75rem' }}
                onClick={loadOrderActivity}>{orderActivity ? 'Refresh' : 'Load Activity'}</button>
            </div>
            {orderActivity === null ? (
              <p style={{ fontSize: '0.8125rem', color: 'var(--stone-400)' }}>Click "Load Activity" to view order history</p>
            ) : orderActivity.length === 0 ? (
              <p style={{ fontSize: '0.8125rem', color: 'var(--stone-400)' }}>No activity recorded yet</p>
            ) : (
              <div>
                {orderActivity.map(entry => (
                  <div key={entry.id} style={{ fontSize: '0.8125rem', padding: '0.5rem 0', borderBottom: '1px solid var(--stone-100)', display: 'flex', justifyContent: 'space-between', gap: '1rem' }}>
                    <div>
                      <strong>{orderActionLabel(entry.action)}</strong>
                      <span style={{ color: 'var(--stone-500)', marginLeft: '0.5rem' }}>{orderActivityDetail(entry)}</span>
                      {entry.performer_name && <span style={{ color: 'var(--stone-400)', marginLeft: '0.5rem' }}>â€” {entry.performer_name}</span>}
                    </div>
                    <span style={{ color: 'var(--stone-400)', whiteSpace: 'nowrap', fontSize: '0.75rem' }}>{new Date(entry.created_at).toLocaleString()}</span>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="form-card">
            <h3>Order Totals</h3>
            <div style={{ maxWidth: '350px', marginLeft: 'auto' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', fontSize: '0.875rem' }}>
                <span>Subtotal</span>
                <span>${parseFloat(order.subtotal).toFixed(2)}</span>
              </div>
              {order.delivery_method === 'pickup' ? (
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', fontSize: '0.875rem' }}>
                  <span>Shipping (Store Pickup)</span>
                  <span style={{ color: '#16a34a', fontWeight: 500 }}>FREE</span>
                </div>
              ) : parseFloat(order.shipping || 0) > 0 ? (
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', fontSize: '0.875rem' }}>
                  <span>Shipping {order.shipping_method ? '(' + (order.shipping_method === 'ltl_freight' ? 'LTL Freight' : 'Parcel') + ')' : ''}</span>
                  <span>${parseFloat(order.shipping).toFixed(2)}</span>
                </div>
              ) : null}
              {parseFloat(order.sample_shipping || 0) > 0 && (
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', fontSize: '0.875rem' }}>
                  <span>Sample Shipping</span>
                  <span>${parseFloat(order.sample_shipping).toFixed(2)}</span>
                </div>
              )}
              {parseFloat(order.discount_amount || 0) > 0 && (
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', fontSize: '0.875rem', color: '#16a34a' }}>
                  <span>Discount{order.promo_code ? ` (${order.promo_code})` : ''}</span>
                  <span>-${parseFloat(order.discount_amount).toFixed(2)}</span>
                </div>
              )}
              <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.75rem 0', fontSize: '1rem', fontWeight: 600, borderTop: '2px solid var(--stone-200)', marginTop: '0.5rem' }}>
                <span>Total</span>
                <span>${parseFloat(order.total).toFixed(2)}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', fontSize: '0.875rem', color: 'var(--stone-500)' }}>
                <span>Amount Paid</span>
                <span>${parseFloat(order.amount_paid || 0).toFixed(2)}</span>
              </div>
              {balanceInfo && balanceInfo.balance_status === 'paid' && (
                <div style={{ padding: '0.5rem 0.75rem', background: '#dcfce7', color: '#166534', fontSize: '0.8125rem', fontWeight: 500, textAlign: 'center', marginTop: '0.5rem' }}>
                  Paid in Full
                </div>
              )}
              {balanceInfo && balanceInfo.balance_status === 'credit' && (
                <div style={{ padding: '0.5rem 0.75rem', background: '#dbeafe', color: '#1e40af', fontSize: '0.8125rem', fontWeight: 500, textAlign: 'center', marginTop: '0.5rem' }}>
                  Credit Available: ${Math.abs(balanceInfo.balance).toFixed(2)}
                </div>
              )}
              {balanceInfo && balanceInfo.balance_status === 'balance_due' && (
                <div style={{ padding: '0.5rem 0.75rem', background: '#fef3c7', color: '#92400e', fontSize: '0.8125rem', fontWeight: 500, textAlign: 'center', marginTop: '0.5rem' }}>
                  Balance Due: ${balanceInfo.balance.toFixed(2)}
                </div>
              )}
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.75rem', justifyContent: 'flex-end' }}>
                {balanceInfo && balanceInfo.balance_status === 'credit' && ['admin', 'manager'].includes(staffRole) && (
                  <button className="btn btn-sm" style={{ background: '#dbeafe', color: '#1e40af' }}
                    onClick={() => { setPartialRefundAmount(Math.abs(balanceInfo.balance).toFixed(2)); setPartialRefundReason(''); setShowPartialRefundModal(true); }}>
                    Issue Refund (${Math.abs(balanceInfo.balance).toFixed(2)} max)
                  </button>
                )}
                {balanceInfo && balanceInfo.balance_status === 'balance_due' && (
                  <button className="btn btn-sm" style={{ background: '#fef3c7', color: '#92400e' }}
                    onClick={() => { setPaymentRequestMessage(''); setShowPaymentRequestModal(true); }}>
                    Send Payment Request (${balanceInfo.balance.toFixed(2)})
                  </button>
                )}
              </div>
            </div>
          </div>

          {payments.length > 0 && (
            <div className="form-card">
              <h3>Payment History</h3>
              <div className="table-scroll-wrapper">
              <table className="admin-table" style={{ fontSize: '0.8125rem' }}>
                <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Description</th><th>By</th></tr></thead>
                <tbody>
                  {payments.map(p => (
                    <tr key={p.id}>
                      <td>{new Date(p.created_at).toLocaleDateString()}</td>
                      <td>
                        <span className={'badge ' + (p.payment_type === 'refund' ? 'badge-cancelled' : p.payment_type === 'additional_charge' ? 'badge-active' : 'badge-confirmed')} style={{ fontSize: '0.6875rem' }}>
                          {p.payment_type === 'charge' ? 'Charge' : p.payment_type === 'refund' ? 'Refund' : 'Additional'}
                        </span>
                      </td>
                      <td style={{ color: parseFloat(p.amount) < 0 ? '#dc2626' : '#16a34a', fontWeight: 500 }}>
                        {parseFloat(p.amount) < 0 ? '-' : '+'}${Math.abs(parseFloat(p.amount)).toFixed(2)}
                      </td>
                      <td>{p.description || 'â€”'}</td>
                      <td>{p.initiated_by_name || 'â€”'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              </div>
            </div>
          )}

          {paymentRequests.length > 0 && (
            <div className="form-card">
              <h3>Payment Requests</h3>
              <div className="table-scroll-wrapper">
              <table className="admin-table" style={{ fontSize: '0.8125rem' }}>
                <thead><tr><th>Date</th><th>Amount</th><th>Sent To</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody>
                  {paymentRequests.map(pr => (
                    <tr key={pr.id}>
                      <td>{new Date(pr.created_at).toLocaleDateString()}</td>
                      <td>${parseFloat(pr.amount).toFixed(2)}</td>
                      <td>{pr.sent_to_email}</td>
                      <td>
                        <span className={'badge ' + (pr.status === 'paid' ? 'badge-active' : pr.status === 'pending' ? 'badge-confirmed' : 'badge-cancelled')} style={{ fontSize: '0.6875rem' }}>
                          {pr.status}
                        </span>
                      </td>
                      <td>
                        {pr.status === 'pending' && (
                          <button className="btn btn-sm btn-secondary" onClick={async () => {
                            if (!confirm('Cancel this payment request?')) return;
                            try {
                              await adminFetch('/api/admin/orders/' + editId + '/payment-requests/' + pr.id + '/cancel', { method: 'POST' });
                              const data = await adminFetch('/api/admin/orders/' + editId);
                              setPaymentRequests(data.payment_requests || []);
                            } catch (err) { alert(err.message); }
                          }}>Cancel</button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              </div>
            </div>
          )}
        </div>

        {docPreview && <DocumentPreviewModal url={docPreview.url} title={docPreview.title} onClose={() => setDocPreview(null)} />}

        {showRefundModal && (
          <div className="modal-overlay" onClick={() => !refunding && setShowRefundModal(false)}>
            <div className="modal-box" onClick={e => e.stopPropagation()}>
              <h3>Confirm Refund</h3>
              <p>Issue a full refund of <strong style={{ color: 'var(--stone-900)', fontSize: '1.1rem' }}>${parseFloat(order.total).toFixed(2)}</strong> to the customer's original payment method?</p>
              <p style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginTop: '-0.75rem' }}>This will process a Stripe refund and cannot be undone.</p>
              <div className="modal-actions">
                <button className="btn btn-secondary" onClick={() => setShowRefundModal(false)} disabled={refunding}>Cancel</button>
                <button className="btn" style={{ background: '#fef3c7', color: '#92400e' }} disabled={refunding}
                  onClick={async () => {
                    setRefunding(true);
                    try {
                      const data = await adminFetch('/api/admin/orders/' + editId + '/refund', { method: 'POST' });
                      if (data.order) { setOrder(data.order); setBalanceInfo(data.balance || null); }
                      setShowRefundModal(false);
                      const refreshed = await adminFetch('/api/admin/orders/' + editId);
                      setPayments(refreshed.payments || []);
                    } catch (err) { alert(err.message); }
                    setRefunding(false);
                  }}>
                  {refunding ? 'Processing...' : 'Refund $' + parseFloat(order.total).toFixed(2)}
                </button>
              </div>
            </div>
          </div>
        )}

        {showPartialRefundModal && (
          <div className="modal-overlay" onClick={() => !refunding && setShowPartialRefundModal(false)}>
            <div className="modal-box" onClick={e => e.stopPropagation()}>
              <h3>Issue Partial Refund</h3>
              <p style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>Max refundable: ${(() => {
                const charges = payments.filter(p => ['charge','additional_charge'].includes(p.payment_type) && p.status === 'completed').reduce((s,p) => s + parseFloat(p.amount), 0);
                const refunds = payments.filter(p => p.payment_type === 'refund' && p.status === 'completed').reduce((s,p) => s + Math.abs(parseFloat(p.amount)), 0);
                return (charges - refunds).toFixed(2);
              })()}</p>
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Refund Amount ($)</label>
                <input type="number" step="0.01" min="0.01" value={partialRefundAmount} onChange={e => setPartialRefundAmount(e.target.value)}
                  style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
              </div>
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Reason (optional)</label>
                <input type="text" value={partialRefundReason} onChange={e => setPartialRefundReason(e.target.value)}
                  placeholder="e.g. Shipping credit, price adjustment"
                  style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)' }} />
              </div>
              <div className="modal-actions">
                <button className="btn btn-secondary" onClick={() => setShowPartialRefundModal(false)} disabled={refunding}>Cancel</button>
                <button className="btn" style={{ background: '#dbeafe', color: '#1e40af' }} disabled={refunding || !partialRefundAmount}
                  onClick={async () => {
                    setRefunding(true);
                    try {
                      const data = await adminFetch('/api/admin/orders/' + editId + '/refund', {
                        method: 'POST', body: JSON.stringify({ amount: parseFloat(partialRefundAmount), reason: partialRefundReason || undefined })
                      });
                      if (data.order) { setOrder(data.order); setBalanceInfo(data.balance || null); }
                      setShowPartialRefundModal(false);
                      const refreshed = await adminFetch('/api/admin/orders/' + editId);
                      setPayments(refreshed.payments || []);
                      setBalanceInfo(refreshed.balance || null);
                    } catch (err) { alert(err.message); }
                    setRefunding(false);
                  }}>
                  {refunding ? 'Processing...' : 'Refund $' + (parseFloat(partialRefundAmount) || 0).toFixed(2)}
                </button>
              </div>
            </div>
          </div>
        )}

        {showPaymentRequestModal && (
          <div className="modal-overlay" onClick={() => setShowPaymentRequestModal(false)}>
            <div className="modal-box" onClick={e => e.stopPropagation()}>
              <h3>Send Payment Request</h3>
              <p>Send a payment link for <strong>${balanceInfo ? balanceInfo.balance.toFixed(2) : '0.00'}</strong> to <strong>{order.customer_email}</strong>.</p>
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.25rem' }}>Message to Customer (optional)</label>
                <textarea value={paymentRequestMessage} onChange={e => setPaymentRequestMessage(e.target.value)}
                  placeholder="e.g. Additional items were added to your order..."
                  rows={3} style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-200)', resize: 'vertical' }} />
              </div>
              <div className="modal-actions">
                <button className="btn btn-secondary" onClick={() => setShowPaymentRequestModal(false)} disabled={updating}>Cancel</button>
                <button className="btn" style={{ background: '#fef3c7', color: '#92400e' }} disabled={updating}
                  onClick={async () => {
                    setUpdating(true);
                    try {
                      await adminFetch('/api/admin/orders/' + editId + '/payment-request', {
                        method: 'POST', body: JSON.stringify({ message: paymentRequestMessage || undefined })
                      });
                      setShowPaymentRequestModal(false);
                      alert('Payment request sent to ' + order.customer_email);
                      const refreshed = await adminFetch('/api/admin/orders/' + editId);
                      setPaymentRequests(refreshed.payment_requests || []);
                    } catch (err) { alert(err.message); }
                    setUpdating(false);
                  }}>
                  {updating ? 'Sending...' : 'Send Payment Request'}
                </button>
              </div>
            </div>
          </div>
        )}

        </React.Fragment>
      );
    }

    // ========== ScrapersView ==========
    function ScrapersView({ navigate }) {
      const [sources, setSources] = useState([]);
      const [loading, setLoading] = useState(true);
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [deleteError, setDeleteError] = useState('');
      const [uploadingId, setUploadingId] = useState(null);

      const loadSources = () => {
        adminFetch('/api/admin/vendor-sources')
          .then(d => { setSources(d.sources || []); setLoading(false); })
          .catch(() => setLoading(false));
      };

      useEffect(() => { loadSources(); }, []);

      const handleScrapeNow = async (source) => {
        if (!confirm('Start scraping "' + source.name + '" now?')) return;
        try {
          const d = await adminFetch('/api/admin/vendor-sources/' + source.id + '/scrape', { method: 'POST' });
          if (d.error) { alert(d.error); return; }
          alert('Scrape job started! Check job history for progress.');
          loadSources();
        } catch (err) {
          alert('Failed to start scrape: ' + err.message);
        }
      };

      const handleStopScrape = async (source) => {
        const jobId = source.last_job && source.last_job.id;
        if (!jobId) return;
        if (!confirm('Stop the running scrape for "' + source.name + '"?')) return;
        try {
          const d = await adminFetch('/api/admin/scrape-jobs/' + jobId + '/stop', { method: 'POST' });
          if (d.error) { alert(d.error); return; }
          loadSources();
        } catch (err) {
          alert('Failed to stop scrape: ' + err.message);
        }
      };

      const handleUploadPriceList = async (source, file) => {
        setUploadingId(source.id);
        try {
          const d = await adminUpload('/api/admin/vendor-sources/' + source.id + '/upload-pricelist', file);
          if (d.error) { alert('Upload failed: ' + d.error); return; }
          if (confirm('PDF uploaded successfully. Run pricing scraper now?')) {
            await handleScrapeNow(source);
          } else {
            loadSources();
          }
        } catch (err) {
          alert('Upload failed: ' + err.message);
        } finally {
          setUploadingId(null);
        }
      };

      const handleToggleActive = async (source) => {
        try {
          await adminFetch('/api/admin/vendor-sources/' + source.id, {
            method: 'PUT',
            body: JSON.stringify({ is_active: !source.is_active })
          });
          loadSources();
        } catch (err) {
          alert('Failed to toggle: ' + err.message);
        }
      };

      const handleDelete = async () => {
        if (!deleteTarget) return;
        try {
          const d = await adminFetch('/api/admin/vendor-sources/' + deleteTarget.id, { method: 'DELETE' });
          if (d.error) { setDeleteError(d.error); return; }
          setDeleteTarget(null);
          loadSources();
        } catch (err) {
          setDeleteError(err.message);
        }
      };

      const formatDate = (d) => {
        if (!d) return 'â€”';
        return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      };

      const scheduleLabel = (s) => {
        if (!s) return 'Manual';
        if (s === '0 0 * * 0') return 'Weekly';
        if (s === '0 0 * * *') return 'Daily';
        if (s === '0 0 1 * *') return 'Monthly';
        return s;
      };

      if (loading) return <div className="loading">Loading...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Web Scrapers</h1>
            <button className="btn btn-primary" onClick={() => navigate('scraper-source-create')}>Add Source</button>
          </div>

          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th>Vendor</th>
                <th>Source Name</th>
                <th>Type</th>
                <th>Scraper</th>
                <th>Schedule</th>
                <th>Last Scraped</th>
                <th>Last Status</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {sources.length === 0 && (
                <tr><td colSpan="9" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '3rem' }}>
                  No scraper sources configured yet.
                </td></tr>
              )}
              {sources.map(s => {
                const lastJob = s.last_job;
                return (
                  <tr key={s.id}>
                    <td>{s.vendor_name}</td>
                    <td>
                      <strong>{s.name}</strong>
                      {s.source_type === 'pdf' && s.config && s.config.pdf_path && (
                        <div style={{ fontSize: '0.75rem', color: 'var(--stone-400)', marginTop: '2px' }}>
                          {s.config.pdf_path.split('/').pop()}
                        </div>
                      )}
                    </td>
                    <td>{s.source_type}</td>
                    <td style={{ fontFamily: 'monospace', fontSize: '0.8125rem' }}>{s.scraper_key || 'â€”'}</td>
                    <td>{scheduleLabel(s.schedule)}</td>
                    <td style={{ fontSize: '0.8125rem' }}>{formatDate(s.last_scraped_at)}</td>
                    <td>
                      {lastJob ? (
                        <span className={'badge badge-' + lastJob.status}>{lastJob.status}</span>
                      ) : <span style={{ color: 'var(--stone-400)' }}>â€”</span>}
                    </td>
                    <td>
                      <div className={'toggle' + (s.is_active ? ' on' : '')} onClick={() => handleToggleActive(s)} />
                    </td>
                    <td className="actions">
                      {s.source_type === 'pdf' && (
                        <React.Fragment>
                          <input
                            type="file"
                            accept=".pdf,.xlsb,.xlsx,.xls"
                            id={'pdf-upload-' + s.id}
                            style={{ display: 'none' }}
                            onChange={(e) => {
                              const file = e.target.files[0];
                              if (file) handleUploadPriceList(s, file);
                              e.target.value = '';
                            }}
                          />
                          <button
                            className="btn btn-sm btn-secondary"
                            disabled={uploadingId === s.id}
                            onClick={() => document.getElementById('pdf-upload-' + s.id).click()}
                          >
                            {uploadingId === s.id ? 'Uploading...' : 'Upload File'}
                          </button>
                        </React.Fragment>
                      )}
                      {lastJob && lastJob.status === 'running' ? (
                        <button className="btn btn-sm btn-danger" onClick={() => handleStopScrape(s)}>Stop</button>
                      ) : (
                        <button className="btn btn-sm btn-primary" onClick={() => handleScrapeNow(s)}>Scrape Now</button>
                      )}
                      <button className="btn btn-sm btn-secondary" onClick={() => navigate('scraper-jobs', s.id)}>Jobs</button>
                      <button className="btn btn-sm btn-secondary" onClick={() => navigate('scraper-source-edit', s.id)}>Edit</button>
                      <button className="btn btn-sm btn-danger" onClick={() => { setDeleteError(''); setDeleteTarget(s); }}>Delete</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          </div>

          {deleteTarget && (
            <DeleteConfirmModal
              title="Delete Source"
              message={'Delete "' + deleteTarget.name + '" and all its job history? This cannot be undone.'}
              error={deleteError}
              onConfirm={handleDelete}
              onCancel={() => setDeleteTarget(null)}
            />
          )}
        </div>
      );
    }

    // ========== ScraperSourceFormView ==========
    function ScraperSourceFormView({ navigate, editId }) {
      const [vendors, setVendors] = useState([]);
      const [form, setForm] = useState({
        vendor_id: '', name: '', source_type: 'website', base_url: '',
        scraper_key: '', schedule: '', categories: '', is_active: true
      });
      const [saving, setSaving] = useState(false);
      const [pdfFile, setPdfFile] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [scraperKeys, setScraperKeys] = useState([]);

      useEffect(() => {
        adminFetch('/api/admin/vendors').then(d => setVendors(d.vendors || [])).catch(() => {});
        adminFetch('/api/admin/scrapers').then(d => setScraperKeys(d.scrapers || [])).catch(() => {});
        if (editId) {
          adminFetch('/api/admin/vendor-sources').then(d => {
            const source = (d.sources || []).find(s => s.id === editId);
            if (source) {
              const cfg = source.config || {};
              setForm({
                vendor_id: source.vendor_id,
                name: source.name,
                source_type: source.source_type || 'website',
                base_url: source.base_url,
                scraper_key: source.scraper_key || '',
                schedule: source.schedule || '',
                categories: (cfg.categories || []).join('\n'),
                is_active: source.is_active
              });
            }
          }).catch(() => {});
        }
      }, [editId]);

      const set = (k, v) => setForm(prev => ({ ...prev, [k]: v }));

      const handleSave = async () => {
        if (!form.vendor_id || !form.name) {
          return alert('Vendor and name are required');
        }
        if (form.source_type !== 'pdf' && !form.base_url) {
          return alert('Base URL is required for this source type');
        }
        if (form.source_type === 'pdf' && !editId && !pdfFile) {
          return alert('Please select a file to upload');
        }
        setSaving(true);
        try {
          const config = {};
          if (form.categories.trim()) {
            config.categories = form.categories.split('\n').map(l => l.trim()).filter(Boolean);
          }
          const body = {
            vendor_id: form.vendor_id,
            name: form.name,
            source_type: form.source_type,
            base_url: form.base_url || (form.source_type === 'pdf' ? 'pdf-upload' : ''),
            scraper_key: form.scraper_key || null,
            schedule: form.schedule || null,
            config,
            is_active: form.is_active
          };

          let d;
          if (editId) {
            d = await adminFetch('/api/admin/vendor-sources/' + editId, {
              method: 'PUT', body: JSON.stringify(body)
            });
          } else {
            d = await adminFetch('/api/admin/vendor-sources', {
              method: 'POST', body: JSON.stringify(body)
            });
          }
          if (d.error) { alert('Server error: ' + d.error); return; }

          // Upload PDF if one was selected
          const sourceId = d.source ? d.source.id : editId;
          if (pdfFile && sourceId) {
            setUploading(true);
            try {
              const uploadResult = await adminUpload('/api/admin/vendor-sources/' + sourceId + '/upload-pricelist', pdfFile);
              if (uploadResult.error) {
                alert('Source saved but PDF upload failed: ' + uploadResult.error);
              }
            } catch (uploadErr) {
              alert('Source saved but PDF upload failed: ' + uploadErr.message);
            }
            setUploading(false);
          }

          navigate('scrapers');
        } catch (err) {
          alert('Save failed: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      const schedulePresets = [
        { value: '', label: 'Manual Only' },
        { value: '0 0 * * *', label: 'Daily (midnight)' },
        { value: '0 0 * * 0', label: 'Weekly (Sunday midnight)' },
        { value: '0 0 1 * *', label: 'Monthly (1st of month)' },
      ];

      return (
        <div>
          <div className="content-header">
            <h1>{editId ? 'Edit Source' : 'Add Scraper Source'}</h1>
            <button className="btn btn-secondary" onClick={() => navigate('scrapers')}>Back</button>
          </div>

          <div className="form-card">
            <div className="form-grid">
              <div className="form-group">
                <label>Vendor *</label>
                <select value={form.vendor_id} onChange={e => set('vendor_id', e.target.value)}>
                  <option value="">Select vendor...</option>
                  {vendors.filter(v => v.is_active).map(v => (
                    <option key={v.id} value={v.id}>{v.name}</option>
                  ))}
                </select>
              </div>
              <div className="form-group">
                <label>Source Name *</label>
                <input value={form.name} onChange={e => set('name', e.target.value)} placeholder="e.g., MSI Public Catalog" />
              </div>
              <div className="form-group">
                <label>Source Type</label>
                <select value={form.source_type} onChange={e => set('source_type', e.target.value)}>
                  <option value="website">Website</option>
                  <option value="portal">Dealer Portal</option>
                  <option value="api">API</option>
                  <option value="pdf">File Upload (PDF/Excel)</option>
                </select>
              </div>
              <div className="form-group">
                <label>Scraper</label>
                <select value={form.scraper_key} onChange={e => {
                  const key = e.target.value;
                  const meta = scraperKeys.find(s => s.key === key);
                  if (meta) {
                    setForm(prev => ({
                      ...prev,
                      scraper_key: key,
                      name: meta.label,
                      source_type: meta.source_type || prev.source_type,
                      base_url: meta.base_url || prev.base_url,
                      categories: (meta.categories || []).join('\n')
                    }));
                  } else {
                    set('scraper_key', '');
                  }
                }}>
                  <option value="">None (manual only)</option>
                  {scraperKeys.map(s => (
                    <option key={s.key} value={s.key}>{s.label}</option>
                  ))}
                </select>
              </div>
              {form.source_type !== 'pdf' && (
                <div className="form-group full">
                  <label>Base URL *</label>
                  <input value={form.base_url} onChange={e => set('base_url', e.target.value)} placeholder="https://www.msisurfaces.com" />
                </div>
              )}
              {form.source_type === 'pdf' && (
                <div className="form-group full">
                  <label>Price List File {!editId && '*'}</label>
                  <div
                    style={{
                      border: '2px dashed ' + (pdfFile ? 'var(--green)' : 'var(--stone-300)'),
                      borderStyle: pdfFile ? 'solid' : 'dashed',
                      borderRadius: '8px', padding: '1.5rem', textAlign: 'center',
                      cursor: 'pointer', transition: 'border-color 0.2s, background 0.2s'
                    }}
                    onClick={() => document.getElementById('source-pdf-input').click()}
                    onMouseOver={e => { if (!pdfFile) e.currentTarget.style.borderColor = 'var(--gold)'; }}
                    onMouseOut={e => { if (!pdfFile) e.currentTarget.style.borderColor = 'var(--stone-300)'; }}
                  >
                    <input
                      id="source-pdf-input"
                      type="file"
                      accept=".pdf,.xlsb,.xlsx,.xls"
                      style={{ display: 'none' }}
                      onChange={e => setPdfFile(e.target.files[0] || null)}
                    />
                    {pdfFile ? (
                      <div>
                        <div style={{ fontSize: '1.125rem', fontWeight: 500 }}>{pdfFile.name}</div>
                        <div style={{ color: 'var(--stone-500)', marginTop: '0.25rem', fontSize: '0.875rem' }}>{(pdfFile.size / 1024).toFixed(1)} KB â€” Click to change</div>
                      </div>
                    ) : (
                      <div>
                        <div style={{ fontSize: '1.125rem', color: 'var(--stone-400)' }}>Click to select a file</div>
                        <div style={{ color: 'var(--stone-400)', marginTop: '0.25rem', fontSize: '0.875rem' }}>Vendor price list (PDF or Excel)</div>
                      </div>
                    )}
                  </div>
                </div>
              )}
              <div className="form-group">
                <label>Schedule</label>
                <select value={form.schedule} onChange={e => set('schedule', e.target.value)}>
                  {schedulePresets.map(p => (
                    <option key={p.value} value={p.value}>{p.label}</option>
                  ))}
                </select>
              </div>
              <div className="form-group">
                <label>Active</label>
                <div style={{ paddingTop: '0.5rem' }}>
                  <div className={'toggle' + (form.is_active ? ' on' : '')} onClick={() => set('is_active', !form.is_active)} />
                </div>
              </div>
              <div className="form-group full">
                <label>Category URLs (one per line)</label>
                <textarea rows="6" value={form.categories} onChange={e => set('categories', e.target.value)}
                  placeholder={"/porcelain-tile\n/luxury-vinyl-flooring\n/waterproof-hybrid-rigid-core"} />
              </div>
            </div>
            <div style={{ display: 'flex', gap: '0.75rem', marginTop: '1rem' }}>
              <button className="btn btn-primary" onClick={handleSave} disabled={saving || uploading}>
                {uploading ? 'Uploading PDF...' : saving ? 'Saving...' : (editId ? 'Update Source' : 'Create Source')}
              </button>
              <button className="btn btn-secondary" onClick={() => navigate('scrapers')}>Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    // ========== ScraperJobsView ==========
    function ScraperJobsView({ navigate, editId: sourceId }) {
      const [jobs, setJobs] = useState([]);
      const [loading, setLoading] = useState(true);

      const loadJobs = () => {
        const url = sourceId
          ? '/api/admin/scrape-jobs?vendor_source_id=' + sourceId + '&limit=50'
          : '/api/admin/scrape-jobs?limit=50';
        adminFetch(url)
          .then(d => { setJobs(d.jobs || []); setLoading(false); })
          .catch(() => setLoading(false));
      };

      useEffect(() => { loadJobs(); }, [sourceId]);

      const handleStopJob = async (jobId) => {
        if (!confirm('Stop this running scrape job?')) return;
        try {
          const d = await adminFetch('/api/admin/scrape-jobs/' + jobId + '/stop', { method: 'POST' });
          if (d.error) { alert(d.error); return; }
          loadJobs();
        } catch (err) {
          alert('Failed to stop job: ' + err.message);
        }
      };

      const formatDate = (d) => {
        if (!d) return 'â€”';
        return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      };

      const formatDuration = (started, completed) => {
        if (!started || !completed) return 'â€”';
        const ms = new Date(completed) - new Date(started);
        if (ms < 60000) return Math.round(ms / 1000) + 's';
        return Math.round(ms / 60000) + 'm';
      };

      if (loading) return <div className="loading">Loading...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Scrape Jobs</h1>
            <button className="btn btn-secondary" onClick={() => navigate('scrapers')}>Back to Sources</button>
          </div>

          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Vendor</th>
                <th>Status</th>
                <th>Found</th>
                <th>Created</th>
                <th>Updated</th>
                <th>SKUs</th>
                <th>Duration</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {jobs.length === 0 && (
                <tr><td colSpan="10" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '3rem' }}>
                  No scrape jobs found.
                </td></tr>
              )}
              {jobs.map(j => (
                <tr key={j.id}>
                  <td style={{ fontSize: '0.8125rem' }}>{formatDate(j.started_at || j.created_at)}</td>
                  <td>{j.source_name}</td>
                  <td>{j.vendor_name}</td>
                  <td><span className={'badge badge-' + j.status}>{j.status}</span></td>
                  <td>{j.products_found}</td>
                  <td>{j.products_created}</td>
                  <td>{j.products_updated}</td>
                  <td>{j.skus_created}</td>
                  <td>{formatDuration(j.started_at, j.completed_at)}</td>
                  <td className="actions">
                    {j.status === 'running' && (
                      <button className="btn btn-sm btn-danger" onClick={() => handleStopJob(j.id)}>Stop</button>
                    )}
                    <button className="btn btn-sm btn-secondary" onClick={() => navigate('scraper-job-detail', j.id)}>Details</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    // ========== ScraperJobDetailView ==========
    function ScraperJobDetailView({ navigate, editId: jobId }) {
      const [job, setJob] = useState(null);
      const [loading, setLoading] = useState(true);
      const [refreshing, setRefreshing] = useState(false);

      const loadJob = () => {
        adminFetch('/api/admin/scrape-jobs/' + jobId)
          .then(d => { setJob(d.job || null); setLoading(false); setRefreshing(false); })
          .catch(() => { setLoading(false); setRefreshing(false); });
      };

      useEffect(() => { loadJob(); }, [jobId]);

      const handleStopJob = async () => {
        if (!confirm('Stop this running scrape job?')) return;
        try {
          const d = await adminFetch('/api/admin/scrape-jobs/' + jobId + '/stop', { method: 'POST' });
          if (d.error) { alert(d.error); return; }
          loadJob();
        } catch (err) {
          alert('Failed to stop job: ' + err.message);
        }
      };

      // Auto-refresh if running
      useEffect(() => {
        if (!job || job.status !== 'running') return;
        const interval = setInterval(loadJob, 5000);
        return () => clearInterval(interval);
      }, [job?.status]);

      if (loading) return <div className="loading">Loading...</div>;
      if (!job) return <div>Job not found.</div>;

      const formatDate = (d) => {
        if (!d) return 'â€”';
        return new Date(d).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
      };

      const errors = job.errors || [];

      return (
        <div>
          <div className="content-header">
            <h1>Job Detail</h1>
            <div style={{ display: 'flex', gap: '0.75rem' }}>
              {job.status === 'running' && (
                <button className="btn btn-danger" onClick={handleStopJob}>Stop Job</button>
              )}
              <button className="btn btn-secondary" onClick={() => { setRefreshing(true); loadJob(); }}>
                {refreshing ? 'Refreshing...' : 'Refresh'}
              </button>
              <button className="btn btn-secondary" onClick={() => navigate('scraper-jobs', job.vendor_source_id)}>Back</button>
            </div>
          </div>

          <div className="form-card">
            <div style={{ display: 'flex', gap: '2rem', flexWrap: 'wrap', marginBottom: '1.5rem' }}>
              <div>
                <div style={{ fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' }}>Status</div>
                <span className={'badge badge-' + job.status} style={{ marginTop: '0.25rem' }}>{job.status}</span>
              </div>
              <div>
                <div style={{ fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' }}>Source</div>
                <div style={{ fontSize: '0.875rem', marginTop: '0.25rem' }}>{job.source_name} ({job.vendor_name})</div>
              </div>
              <div>
                <div style={{ fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' }}>Started</div>
                <div style={{ fontSize: '0.875rem', marginTop: '0.25rem' }}>{formatDate(job.started_at)}</div>
              </div>
              <div>
                <div style={{ fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' }}>Completed</div>
                <div style={{ fontSize: '0.875rem', marginTop: '0.25rem' }}>{formatDate(job.completed_at)}</div>
              </div>
            </div>

            <div className="stat-grid" style={{ marginBottom: '1.5rem' }}>
              <div className="stat-card">
                <div className="stat-card-label">Products Found</div>
                <div className="stat-card-value">{job.products_found}</div>
              </div>
              <div className="stat-card">
                <div className="stat-card-label">Created</div>
                <div className="stat-card-value">{job.products_created}</div>
              </div>
              <div className="stat-card">
                <div className="stat-card-label">Updated</div>
                <div className="stat-card-value">{job.products_updated}</div>
              </div>
              <div className="stat-card">
                <div className="stat-card-label">SKUs Created</div>
                <div className="stat-card-value">{job.skus_created}</div>
              </div>
            </div>

            {errors.length > 0 && (
              <div style={{ marginBottom: '1.5rem' }}>
                <h3 style={{ fontSize: '0.875rem', fontWeight: 600, marginBottom: '0.75rem' }}>Errors ({errors.length})</h3>
                <div style={{ maxHeight: '200px', overflowY: 'auto', border: '1px solid var(--red-light)', background: '#fef2f2', padding: '0.75rem' }}>
                  {errors.map((err, i) => (
                    <div key={i} style={{ padding: '0.375rem 0', borderBottom: '1px solid var(--red-light)', fontSize: '0.8125rem', color: 'var(--red)' }}>
                      {err.message || JSON.stringify(err)}
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div>
              <h3 style={{ fontSize: '0.875rem', fontWeight: 600, marginBottom: '0.75rem' }}>Log</h3>
              <pre style={{
                background: 'var(--stone-900)', color: '#a7f3d0', padding: '1rem',
                fontSize: '0.75rem', lineHeight: '1.6', maxHeight: '400px',
                overflowY: 'auto', whiteSpace: 'pre-wrap', fontFamily: 'monospace'
              }}>
                {job.log || 'No log output yet...'}
              </pre>
            </div>
          </div>
        </div>
      );
    }

    // ========== DeleteConfirmModal ==========
    function DeleteConfirmModal({ title, message, error, onConfirm, onCancel }) {
      return (
        <div className="modal-overlay" onClick={onCancel}>
          <div className="modal-box" onClick={e => e.stopPropagation()}>
            <h3>{title}</h3>
            <p>{message}</p>
            {error && <div className="auth-error" style={{ marginBottom: '1rem' }}>{error}</div>}
            <div className="modal-actions">
              <button className="btn btn-secondary" onClick={onCancel}>Cancel</button>
              <button className="btn btn-danger" onClick={onConfirm}>Delete</button>
            </div>
          </div>
        </div>
      );
    }

    // ========== Installation Inquiries ==========
    function InquiriesListView({ navigate }) {
      const [inquiries, setInquiries] = useState([]);
      const [loading, setLoading] = useState(true);
      const [statusFilter, setStatusFilter] = useState('');
      const [search, setSearch] = useState('');
      const [total, setTotal] = useState(0);

      const load = () => {
        setLoading(true);
        const params = new URLSearchParams();
        if (statusFilter) params.set('status', statusFilter);
        if (search) params.set('search', search);
        params.set('limit', '50');
        adminFetch(`/api/admin/installation-inquiries?${params}`)
          .then(data => { setInquiries(data.inquiries || []); setTotal(data.total || 0); setLoading(false); })
          .catch(() => setLoading(false));
      };
      useEffect(load, [statusFilter]);

      const statusTabs = ['', 'new', 'contacted', 'quoted', 'scheduled', 'completed', 'closed'];
      const statusLabels = { '': 'All', new: 'New', contacted: 'Contacted', quoted: 'Quoted', scheduled: 'Scheduled', completed: 'Completed', closed: 'Closed' };

      const fmtDate = (d) => {
        if (!d) return '';
        const dt = new Date(d);
        return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      };

      if (loading) return <div className="loading">Loading inquiries...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Installation Inquiries</h1>
            <span style={{ fontSize: '0.8125rem', color: 'var(--stone-400)' }}>{total} total</span>
          </div>
          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem', flexWrap: 'wrap', alignItems: 'center' }}>
            {statusTabs.map(s => (
              <button key={s} className={statusFilter === s ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'} onClick={() => setStatusFilter(s)}>{statusLabels[s]}</button>
            ))}
          </div>
          <div style={{ marginBottom: '1rem', display: 'flex', gap: '0.5rem' }}>
            <input type="text" className="form-input" placeholder="Search name or email..." value={search} onChange={e => setSearch(e.target.value)} style={{ maxWidth: 300 }} onKeyDown={e => e.key === 'Enter' && load()} />
            <button className="btn btn-secondary btn-sm" onClick={load}>Search</button>
          </div>
          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Product</th>
                <th>Zip</th>
                <th>Sqft</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {inquiries.length === 0 && <tr><td colSpan="9" style={{ textAlign: 'center', color: 'var(--stone-400)' }}>No inquiries found</td></tr>}
              {inquiries.map(inq => (
                <tr key={inq.id}>
                  <td style={{ fontWeight: 500 }}>{inq.customer_name}</td>
                  <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{inq.customer_email}</td>
                  <td style={{ fontSize: '0.8125rem' }}>{inq.phone || 'â€”'}</td>
                  <td style={{ fontSize: '0.8125rem' }}>{[inq.collection, inq.product_name].filter(Boolean).join(' â€” ') || 'â€”'}</td>
                  <td>{inq.zip_code || 'â€”'}</td>
                  <td>{inq.estimated_sqft ? parseFloat(inq.estimated_sqft).toFixed(0) : 'â€”'}</td>
                  <td><span className={`badge badge-${inq.status}`}>{inq.status}</span></td>
                  <td style={{ fontSize: '0.8125rem', whiteSpace: 'nowrap' }}>{fmtDate(inq.created_at)}</td>
                  <td><button className="btn btn-secondary btn-sm" onClick={() => navigate('inquiry-detail', inq.id)}>View</button></td>
                </tr>
              ))}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    function InquiryDetailView({ navigate, editId, staffRole }) {
      const [inquiry, setInquiry] = useState(null);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [staffList, setStaffList] = useState([]);
      const [form, setForm] = useState({ status: '', staff_notes: '', assigned_to: '' });

      useEffect(() => {
        adminFetch(`/api/admin/installation-inquiries/${editId}`)
          .then(data => {
            setInquiry(data.inquiry);
            setForm({ status: data.inquiry.status || 'new', staff_notes: data.inquiry.staff_notes || '', assigned_to: data.inquiry.assigned_to || '' });
            setLoading(false);
          })
          .catch(() => setLoading(false));
        adminFetch('/api/admin/staff')
          .then(data => setStaffList((data.staff || []).filter(s => s.is_active)))
          .catch(() => {});
      }, [editId]);

      const handleSave = async () => {
        setSaving(true);
        try {
          const data = await adminFetch(`/api/admin/installation-inquiries/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(form)
          });
          setInquiry(data.inquiry);
          setSaving(false);
        } catch { setSaving(false); }
      };

      const handleDelete = async () => {
        if (!confirm('Delete this inquiry permanently?')) return;
        try {
          await adminFetch(`/api/admin/installation-inquiries/${editId}`, { method: 'DELETE' });
          navigate('inquiries');
        } catch {}
      };

      const fmtDate = (d) => {
        if (!d) return '';
        const dt = new Date(d);
        return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' at ' + dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      };

      if (loading) return <div className="loading">Loading inquiry...</div>;
      if (!inquiry) return <div className="loading">Inquiry not found</div>;

      return (
        <div>
          <div className="content-header">
            <button className="btn btn-secondary btn-sm" onClick={() => navigate('inquiries')}>&larr; Back</button>
            <h1 style={{ marginLeft: '1rem' }}>Inquiry from {inquiry.customer_name}</h1>
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(340px, 1fr))', gap: '1.5rem' }}>
            <div className="detail-card">
              <h3>Customer Info</h3>
              <div className="detail-grid">
                <div className="detail-label">Name</div><div className="detail-value">{inquiry.customer_name}</div>
                <div className="detail-label">Email</div><div className="detail-value"><a href={`mailto:${inquiry.customer_email}`} style={{ color: 'var(--gold)' }}>{inquiry.customer_email}</a></div>
                <div className="detail-label">Phone</div><div className="detail-value">{inquiry.phone ? <a href={`tel:${inquiry.phone}`} style={{ color: 'var(--gold)' }}>{inquiry.phone}</a> : 'â€”'}</div>
                <div className="detail-label">Zip Code</div><div className="detail-value">{inquiry.zip_code || 'â€”'}</div>
              </div>
            </div>

            <div className="detail-card">
              <h3>Inquiry Details</h3>
              <div className="detail-grid">
                <div className="detail-label">Product</div><div className="detail-value">{[inquiry.collection, inquiry.product_name].filter(Boolean).join(' â€” ') || 'â€”'}</div>
                <div className="detail-label">Est. Sqft</div><div className="detail-value">{inquiry.estimated_sqft ? parseFloat(inquiry.estimated_sqft).toFixed(0) + ' sqft' : 'â€”'}</div>
                <div className="detail-label">Message</div><div className="detail-value">{inquiry.message || 'â€”'}</div>
                <div className="detail-label">Submitted</div><div className="detail-value">{fmtDate(inquiry.created_at)}</div>
              </div>
            </div>

            <div className="detail-card" style={{ gridColumn: '1 / -1' }}>
              <h3>Manage</h3>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                <div>
                  <label className="form-label">Status</label>
                  <select className="form-input" value={form.status} onChange={e => setForm({ ...form, status: e.target.value })}>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="quoted">Quoted</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="completed">Completed</option>
                    <option value="closed">Closed</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">Assign To</label>
                  <select className="form-input" value={form.assigned_to} onChange={e => setForm({ ...form, assigned_to: e.target.value })}>
                    <option value="">Unassigned</option>
                    {staffList.map(s => <option key={s.id} value={s.id}>{s.first_name} {s.last_name} ({s.role})</option>)}
                  </select>
                </div>
              </div>
              <div style={{ marginBottom: '1rem' }}>
                <label className="form-label">Staff Notes</label>
                <textarea className="form-input" rows="4" value={form.staff_notes} onChange={e => setForm({ ...form, staff_notes: e.target.value })} placeholder="Internal notes about this inquiry..." />
              </div>
              <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                <button className="btn btn-primary" onClick={handleSave} disabled={saving}>{saving ? 'Saving...' : 'Save Changes'}</button>
                {(staffRole === 'admin' || staffRole === 'manager') && (
                  <button className="btn btn-secondary" style={{ color: 'var(--red)' }} onClick={handleDelete}>Delete</button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ========== Trade Management ==========
    function TradeManagementView({ navigate }) {
      const [tab, setTab] = useState('customers');

      return (
        <div>
          <div className="content-header">
            <h1>Trade Program</h1>
          </div>
          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem' }}>
            <button className={tab === 'customers' ? 'btn btn-primary' : 'btn btn-secondary'} onClick={() => setTab('customers')}>
              Trade Customers
            </button>
            <button className={tab === 'tiers' ? 'btn btn-primary' : 'btn btn-secondary'} onClick={() => setTab('tiers')}>
              Margin Tiers
            </button>
          </div>
          {tab === 'customers' && <TradeCustomersTab />}
          {tab === 'tiers' && <MarginTiersTab />}
        </div>
      );
    }

    function MarginTiersTab() {
      const [tiers, setTiers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [editTier, setEditTier] = useState(null);
      const [name, setName] = useState('');
      const [discountPercent, setDiscountPercent] = useState('');
      const [saving, setSaving] = useState(false);

      const fetchTiers = () => {
        adminFetch('/api/admin/margin-tiers')
          .then(data => { setTiers(data.tiers || []); setLoading(false); })
          .catch(() => setLoading(false));
      };

      useEffect(() => { fetchTiers(); }, []);

      const openCreate = () => {
        setEditTier(null);
        setName('');
        setDiscountPercent('');
        setShowForm(true);
      };

      const openEdit = (tier) => {
        setEditTier(tier);
        setName(tier.name);
        setDiscountPercent(tier.discount_percent);
        setShowForm(true);
      };

      const handleSave = async () => {
        setSaving(true);
        try {
          if (editTier) {
            await adminFetch('/api/admin/margin-tiers/' + editTier.id, {
              method: 'PUT',
              body: JSON.stringify({ name, discount_percent: parseFloat(discountPercent) })
            });
          } else {
            await adminFetch('/api/admin/margin-tiers', {
              method: 'POST',
              body: JSON.stringify({ name, discount_percent: parseFloat(discountPercent) })
            });
          }
          setShowForm(false);
          fetchTiers();
        } catch (err) {
          alert(err.message || 'Error saving tier');
        }
        setSaving(false);
      };

      const handleDelete = async (tier) => {
        if (!confirm(`Delete tier "${tier.name}"?`)) return;
        try {
          await adminFetch('/api/admin/margin-tiers/' + tier.id, { method: 'DELETE' });
          fetchTiers();
        } catch (err) {
          alert(err.message || 'Cannot delete tier');
        }
      };

      if (loading) return <div className="loading">Loading tiers...</div>;

      return (
        <div>
          <div style={{ marginBottom: '1rem' }}>
            <button className="btn btn-primary" onClick={openCreate}>+ Add Tier</button>
          </div>

          {showForm && (
            <div className="form-card" style={{ marginBottom: '1.5rem' }}>
              <h3>{editTier ? 'Edit Tier' : 'New Margin Tier'}</h3>
              <div style={{ display: 'flex', gap: '1rem', alignItems: 'flex-end' }}>
                <div className="form-group" style={{ flex: 1 }}>
                  <label>Tier Name</label>
                  <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="e.g. Silver" />
                </div>
                <div className="form-group" style={{ flex: 1 }}>
                  <label>Discount %</label>
                  <input type="number" step="0.01" min="0" max="100" value={discountPercent} onChange={e => setDiscountPercent(e.target.value)} placeholder="e.g. 10" />
                </div>
                <div style={{ display: 'flex', gap: '0.5rem' }}>
                  <button className="btn btn-primary" onClick={handleSave} disabled={saving || !name || !discountPercent}>
                    {saving ? 'Saving...' : 'Save'}
                  </button>
                  <button className="btn btn-secondary" onClick={() => setShowForm(false)}>Cancel</button>
                </div>
              </div>
            </div>
          )}

          <div className="table-scroll-wrapper">
          <table className="data-table">
            <thead>
              <tr>
                <th>Tier Name</th>
                <th>Discount</th>
                <th>Customers</th>
                <th>Example ($10.00 retail)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {tiers.length === 0 ? (
                <tr><td colSpan="5" style={{ textAlign: 'center', color: 'var(--stone-400)' }}>No margin tiers yet</td></tr>
              ) : tiers.map(t => (
                <tr key={t.id}>
                  <td><strong>{t.name}</strong></td>
                  <td>{parseFloat(t.discount_percent).toFixed(1)}%</td>
                  <td>{t.customer_count}</td>
                  <td>${(10 * (1 - parseFloat(t.discount_percent) / 100)).toFixed(2)}</td>
                  <td>
                    <button className="btn-link" onClick={() => openEdit(t)}>Edit</button>
                    <button className="btn-link btn-link-danger" onClick={() => handleDelete(t)} style={{ marginLeft: '0.5rem' }}>Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    function TradeCustomersTab() {
      const [customers, setCustomers] = useState([]);
      const [tiers, setTiers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [statusFilter, setStatusFilter] = useState('');
      const [expandedId, setExpandedId] = useState(null);
      const [docs, setDocs] = useState([]);
      const [docsLoading, setDocsLoading] = useState(false);
      const [denialReason, setDenialReason] = useState('');
      const [actionLoading, setActionLoading] = useState(false);
      const [reps, setReps] = useState([]);

      const fetchCustomers = () => {
        let url = '/api/admin/trade-customers';
        if (statusFilter) url += '?status=' + statusFilter;
        adminFetch(url)
          .then(data => { setCustomers(data.customers || []); setLoading(false); })
          .catch(() => setLoading(false));
      };

      const fetchTiers = () => {
        adminFetch('/api/admin/margin-tiers')
          .then(data => setTiers(data.tiers || []))
          .catch(() => {});
      };

      const fetchReps = () => {
        adminFetch('/api/admin/staff')
          .then(data => setReps((data.staff || []).filter(s => ['sales_rep', 'manager'].includes(s.role) && s.is_active)))
          .catch(() => {});
      };

      useEffect(() => { fetchTiers(); fetchReps(); }, []);
      useEffect(() => { fetchCustomers(); }, [statusFilter]);

      const loadDocs = (customerId) => {
        setDocsLoading(true);
        adminFetch('/api/admin/trade-customers/' + customerId + '/documents')
          .then(data => { setDocs(data.documents || []); setDocsLoading(false); })
          .catch(() => { setDocs([]); setDocsLoading(false); });
      };

      const toggleExpand = (id) => {
        if (expandedId === id) { setExpandedId(null); return; }
        setExpandedId(id);
        setDenialReason('');
        loadDocs(id);
      };

      const approveCustomer = async (id) => {
        if (!confirm('Approve this trade customer? A $99/year Stripe subscription will be created.')) return;
        setActionLoading(true);
        try {
          await adminFetch('/api/admin/trade-customers/' + id + '/approve', { method: 'POST' });
          fetchCustomers();
          setExpandedId(null);
        } catch (err) {
          alert(err.message || 'Error approving customer');
        }
        setActionLoading(false);
      };

      const denyCustomer = async (id) => {
        if (!confirm('Deny this trade application?')) return;
        setActionLoading(true);
        try {
          await adminFetch('/api/admin/trade-customers/' + id + '/deny', {
            method: 'POST',
            body: JSON.stringify({ reason: denialReason })
          });
          fetchCustomers();
          setExpandedId(null);
        } catch (err) {
          alert(err.message || 'Error denying customer');
        }
        setActionLoading(false);
      };

      const updateCustomer = async (id, updates) => {
        try {
          await adminFetch('/api/admin/trade-customers/' + id, {
            method: 'PUT',
            body: JSON.stringify(updates)
          });
          fetchCustomers();
        } catch (err) {
          alert(err.message || 'Error updating customer');
        }
      };

      const deleteCustomer = async (id, name) => {
        if (!confirm(`Delete trade customer "${name}"? This cannot be undone.`)) return;
        try {
          await adminFetch('/api/admin/trade-customers/' + id, { method: 'DELETE' });
          fetchCustomers();
        } catch (err) {
          alert(err.message || 'Error deleting customer');
        }
      };

      const assignRep = async (customerId, repId) => {
        try {
          await adminFetch('/api/admin/trade-customers/' + customerId + '/assign-rep', {
            method: 'PUT',
            body: JSON.stringify({ rep_id: repId || null, reason: 'Manual assignment from admin' })
          });
          fetchCustomers();
        } catch (err) {
          alert(err.message || 'Error assigning rep');
        }
      };

      const statusBadge = (status) => {
        const cls = status === 'approved' ? 'badge-active' : status === 'pending' ? 'badge-pending' : 'badge-inactive';
        return <span className={'badge ' + cls}>{status}</span>;
      };

      const docTypeLabel = (t) => ({ ein: 'EIN Certificate', resale_cert: 'Resale Certificate', contractor_license: 'Contractor License' }[t] || t);

      if (loading) return <div className="loading">Loading trade customers...</div>;

      return (
        <div>
          <div style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '1rem' }}>
            <label style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>Filter by status:</label>
            <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)}
              style={{ padding: '0.4rem 0.6rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem' }}>
              <option value="">All</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>

          <div className="table-scroll-wrapper">
          <table className="data-table">
            <thead>
              <tr>
                <th>Company</th>
                <th>Contact</th>
                <th>Email</th>
                <th>Type</th>
                <th>Status</th>
                <th>Tier</th>
                <th>Applied</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {customers.length === 0 ? (
                <tr><td colSpan="8" style={{ textAlign: 'center', color: 'var(--stone-400)' }}>No trade customers found</td></tr>
              ) : customers.map(c => (
                <React.Fragment key={c.id}>
                  <tr style={{ cursor: 'pointer' }} onClick={() => toggleExpand(c.id)}>
                    <td><strong>{c.company_name}</strong></td>
                    <td>{c.contact_name}</td>
                    <td>{c.email}</td>
                    <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', textTransform: 'capitalize' }}>{(c.business_type || '').replace('_', ' ') || '\u2014'}</td>
                    <td>{statusBadge(c.status)}</td>
                    <td>
                      <select value={c.margin_tier_id || ''} onClick={e => e.stopPropagation()} onChange={e => updateCustomer(c.id, { margin_tier_id: e.target.value || null })}
                        style={{ padding: '0.3rem 0.4rem', border: '1px solid var(--stone-300)', fontSize: '0.8125rem' }}>
                        <option value="">No tier</option>
                        {tiers.map(t => <option key={t.id} value={t.id}>{t.name} ({parseFloat(t.discount_percent).toFixed(0)}%)</option>)}
                      </select>
                    </td>
                    <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>
                      {new Date(c.created_at).toLocaleDateString()}
                    </td>
                    <td onClick={e => e.stopPropagation()}>
                      <div style={{ display: 'flex', gap: '0.35rem', flexWrap: 'wrap' }}>
                        {c.status === 'pending' && (
                          <>
                            <button className="btn-link" onClick={() => approveCustomer(c.id)} disabled={actionLoading}>Approve</button>
                            <button className="btn-link btn-link-danger" onClick={() => { setExpandedId(c.id); loadDocs(c.id); }}>Review</button>
                          </>
                        )}
                        {c.status === 'approved' && (
                          <button className="btn-link btn-link-danger" onClick={() => updateCustomer(c.id, { status: 'rejected' })}>Revoke</button>
                        )}
                        {c.status === 'rejected' && (
                          <button className="btn-link" onClick={() => approveCustomer(c.id)} disabled={actionLoading}>Approve</button>
                        )}
                        <button className="btn-link btn-link-danger" onClick={() => deleteCustomer(c.id, c.company_name)}>Delete</button>
                      </div>
                    </td>
                  </tr>
                  {expandedId === c.id && (
                    <tr><td colSpan="8" style={{ background: 'var(--stone-50)', padding: '1.5rem' }}>
                      <div className="resp-grid-2" style={{ gap: '1.5rem' }}>
                        <div>
                          <h4 style={{ fontSize: '0.875rem', fontWeight: 600, marginBottom: '0.75rem' }}>Documents</h4>
                          {docsLoading ? <div>Loading documents...</div> : docs.length === 0 ? <div style={{ color: 'var(--stone-400)', fontSize: '0.8125rem' }}>No documents uploaded</div> : (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                              {docs.map(d => (
                                <div key={d.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.5rem 0.75rem', background: 'white', border: '1px solid var(--stone-200)', fontSize: '0.8125rem' }}>
                                  <div>
                                    <strong>{docTypeLabel(d.doc_type)}</strong>
                                    <div style={{ color: 'var(--stone-400)', fontSize: '0.75rem' }}>{d.file_name} â€” {(d.file_size / 1024).toFixed(0)} KB</div>
                                  </div>
                                  {d.url && <a href={d.url} target="_blank" rel="noopener" style={{ color: 'var(--gold)', fontWeight: 500, fontSize: '0.8125rem' }}>View</a>}
                                </div>
                              ))}
                            </div>
                          )}
                          {c.subscription_status && (
                            <div style={{ marginTop: '1rem', fontSize: '0.8125rem' }}>
                              <strong>Subscription:</strong> {c.subscription_status}
                              {c.subscription_expires_at && <span> â€” expires {new Date(c.subscription_expires_at).toLocaleDateString()}</span>}
                            </div>
                          )}
                          {c.total_spend !== undefined && (
                            <div style={{ marginTop: '0.5rem', fontSize: '0.8125rem' }}>
                              <strong>Total Spend:</strong> ${parseFloat(c.total_spend || 0).toLocaleString()}
                            </div>
                          )}
                          <div style={{ marginTop: '1rem', fontSize: '0.8125rem' }}>
                            <strong>Assigned Rep:</strong>{' '}
                            <select value={c.assigned_rep_id || ''} onChange={e => assignRep(c.id, e.target.value)}
                              style={{ padding: '0.3rem 0.4rem', border: '1px solid var(--stone-300)', fontSize: '0.8125rem', marginLeft: '0.25rem' }}>
                              <option value="">Unassigned</option>
                              {reps.map(r => <option key={r.id} value={r.id}>{r.first_name} {r.last_name}</option>)}
                            </select>
                          </div>
                        </div>
                        <div>
                          {c.status === 'pending' && (
                            <>
                              <h4 style={{ fontSize: '0.875rem', fontWeight: 600, marginBottom: '0.75rem' }}>Actions</h4>
                              <div style={{ marginBottom: '1rem' }}>
                                <button className="btn btn-primary btn-sm" onClick={() => approveCustomer(c.id)} disabled={actionLoading} style={{ marginRight: '0.5rem' }}>
                                  {actionLoading ? 'Processing...' : 'Approve & Create Subscription'}
                                </button>
                              </div>
                              <div>
                                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>Denial Reason (optional)</label>
                                <textarea value={denialReason} onChange={e => setDenialReason(e.target.value)}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif', minHeight: '60px', resize: 'vertical' }}
                                  placeholder="Reason for denial..." />
                                <button className="btn btn-danger btn-sm" onClick={() => denyCustomer(c.id)} disabled={actionLoading} style={{ marginTop: '0.5rem' }}>
                                  Deny Application
                                </button>
                              </div>
                            </>
                          )}
                          {c.denial_reason && (
                            <div style={{ marginTop: '1rem', fontSize: '0.8125rem' }}>
                              <strong>Denial Reason:</strong> {c.denial_reason}
                            </div>
                          )}
                        </div>
                      </div>
                    </td></tr>
                  )}
                </React.Fragment>
              ))}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    // ========== StaffListView ==========
    function StaffListView({ navigate }) {
      const [staff, setStaff] = useState([]);
      const [loading, setLoading] = useState(true);

      const fetchStaff = () => {
        adminFetch('/api/admin/staff')
          .then(data => { setStaff(data.staff || []); setLoading(false); })
          .catch(() => setLoading(false));
      };

      useEffect(fetchStaff, []);

      const toggleActive = (id) => {
        adminFetch('/api/admin/staff/' + id + '/toggle', { method: 'PATCH' })
          .then(() => fetchStaff())
          .catch(err => alert(err.message));
      };

      const terminateStaff = async (s) => {
        if (!confirm(`Terminate "${s.first_name} ${s.last_name}"? This will deactivate their account and unassign all their trade customers.`)) return;
        try {
          const data = await adminFetch('/api/admin/staff/' + s.id + '/terminate', { method: 'PATCH' });
          let msg = `${data.terminated.name} has been terminated.`;
          if (data.freed_customers.length > 0) {
            msg += ` ${data.freed_customers.length} customer(s) unassigned.`;
            if (data.recommended_rep) msg += ` Recommended reassignment: ${data.recommended_rep.name}`;
          }
          alert(msg);
          fetchStaff();
        } catch (err) {
          alert(err.message || 'Error terminating staff');
        }
      };

      const roleLabels = { admin: 'Admin', manager: 'Manager', sales_rep: 'Sales Rep', warehouse: 'Warehouse' };

      return (
        <div>
          <div className="content-header">
            <h1>Staff Accounts</h1>
            <button className="btn btn-primary" onClick={() => navigate('staff-create')}>Add Staff</button>
          </div>
          <div className="table-scroll-wrapper">
          <table className="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Customers</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr><td colSpan="7" style={{ textAlign: 'center', padding: '2rem' }}>Loading...</td></tr>
              ) : staff.length === 0 ? (
                <tr><td colSpan="7" style={{ textAlign: 'center', padding: '2rem', color: 'var(--stone-500)' }}>No staff accounts</td></tr>
              ) : staff.map(s => (
                <tr key={s.id}>
                  <td><strong>{s.first_name} {s.last_name}</strong></td>
                  <td>{s.email}</td>
                  <td style={{ fontSize: '0.8125rem' }}>{s.phone || '\u2014'}</td>
                  <td><span className={'status-badge status-' + (s.role === 'admin' ? 'active' : s.role === 'manager' ? 'confirmed' : 'draft')}>{roleLabels[s.role] || s.role}</span></td>
                  <td>{s.assigned_customers || 0}</td>
                  <td><span className={'status-badge status-' + (s.is_active ? 'active' : 'draft')}>{s.is_active ? 'Active' : 'Inactive'}</span></td>
                  <td>
                    <button className="btn-link" onClick={() => navigate('staff-edit', s.id)}>Edit</button>
                    <button className="btn-link" onClick={() => toggleActive(s.id)} style={{ marginLeft: '0.5rem' }}>{s.is_active ? 'Deactivate' : 'Activate'}</button>
                    {s.is_active && ['sales_rep', 'manager'].includes(s.role) && (
                      <button className="btn-link btn-link-danger" onClick={() => terminateStaff(s)} style={{ marginLeft: '0.5rem' }}>Terminate</button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    // ========== StaffFormView ==========
    function StaffFormView({ navigate, editId }) {
      const [form, setForm] = useState({ email: '', first_name: '', last_name: '', phone: '', role: 'sales_rep', password: '' });
      const [loading, setLoading] = useState(!!editId);
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState('');
      const [assignedCustomers, setAssignedCustomers] = useState([]);

      useEffect(() => {
        if (editId) {
          adminFetch('/api/admin/staff')
            .then(data => {
              const s = (data.staff || []).find(x => x.id === editId);
              if (s) setForm({ email: s.email, first_name: s.first_name, last_name: s.last_name, phone: s.phone || '', role: s.role, password: '' });
              setLoading(false);
            })
            .catch(() => setLoading(false));
          // Load assigned customers for reps/managers
          adminFetch('/api/admin/trade-customers')
            .then(data => setAssignedCustomers((data.customers || []).filter(c => c.assigned_rep_id === editId)))
            .catch(() => {});
        }
      }, [editId]);

      const handleSave = async (e) => {
        e.preventDefault();
        setSaving(true);
        setError('');
        try {
          if (editId) {
            const payload = { email: form.email, first_name: form.first_name, last_name: form.last_name, phone: form.phone || null, role: form.role };
            await adminFetch('/api/admin/staff/' + editId, { method: 'PUT', body: JSON.stringify(payload) });
            if (form.password) {
              await adminFetch('/api/admin/staff/' + editId + '/password', { method: 'PUT', body: JSON.stringify({ password: form.password }) });
            }
          } else {
            if (!form.password) { setError('Password is required'); setSaving(false); return; }
            await adminFetch('/api/admin/staff', { method: 'POST', body: JSON.stringify(form) });
          }
          navigate('staff');
        } catch (err) {
          setError(err.message || 'Failed to save');
          setSaving(false);
        }
      };

      if (loading) return <div className="loading">Loading...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>{editId ? 'Edit Staff Member' : 'Add Staff Member'}</h1>
            <button className="btn btn-secondary" onClick={() => navigate('staff')}>Back</button>
          </div>
          <div className="form-card" style={{ background: 'white', border: '1px solid var(--stone-200)', padding: '2rem', maxWidth: '600px' }}>
            {error && <div className="auth-error">{error}</div>}
            <form onSubmit={handleSave}>
              <div className="form-group" style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>First Name *</label>
                <input style={{ width: '100%', padding: '0.625rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif' }} value={form.first_name} onChange={e => setForm({ ...form, first_name: e.target.value })} required />
              </div>
              <div className="form-group" style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>Last Name *</label>
                <input style={{ width: '100%', padding: '0.625rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif' }} value={form.last_name} onChange={e => setForm({ ...form, last_name: e.target.value })} required />
              </div>
              <div className="form-group" style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>Email *</label>
                <input type="email" style={{ width: '100%', padding: '0.625rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif' }} value={form.email} onChange={e => setForm({ ...form, email: e.target.value })} required />
              </div>
              <div className="form-group" style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>Phone</label>
                <input style={{ width: '100%', padding: '0.625rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif' }} value={form.phone} onChange={e => setForm({ ...form, phone: e.target.value })} />
              </div>
              <div className="form-group" style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>Role *</label>
                <select style={{ width: '100%', padding: '0.625rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif' }} value={form.role} onChange={e => setForm({ ...form, role: e.target.value })}>
                  <option value="admin">Admin</option>
                  <option value="manager">Manager</option>
                  <option value="sales_rep">Sales Rep</option>
                  <option value="warehouse">Warehouse</option>
                </select>
              </div>
              <div className="form-group" style={{ marginBottom: '1.5rem' }}>
                <label style={{ display: 'block', fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.375rem' }}>{editId ? 'New Password (leave blank to keep)' : 'Password *'}</label>
                <input type="password" style={{ width: '100%', padding: '0.625rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: 'Inter, sans-serif' }} value={form.password} onChange={e => setForm({ ...form, password: e.target.value })} {...(!editId ? { required: true } : {})} />
              </div>
              <button className="btn btn-primary" type="submit" disabled={saving}>{saving ? 'Saving...' : (editId ? 'Update' : 'Create')}</button>
            </form>
          </div>
          {editId && assignedCustomers.length > 0 && (
            <div style={{ marginTop: '2rem' }}>
              <h3 style={{ fontSize: '1rem', fontWeight: 600, marginBottom: '0.75rem' }}>Assigned Trade Customers ({assignedCustomers.length})</h3>
              <div className="table-scroll-wrapper">
              <table className="data-table">
                <thead>
                  <tr>
                    <th>Company</th>
                    <th>Contact</th>
                    <th>Status</th>
                    <th>Tier</th>
                    <th>Total Spend</th>
                  </tr>
                </thead>
                <tbody>
                  {assignedCustomers.map(c => (
                    <tr key={c.id}>
                      <td><strong>{c.company_name}</strong></td>
                      <td>{c.contact_name}</td>
                      <td><span className={'badge badge-' + (c.status === 'approved' ? 'active' : c.status === 'pending' ? 'pending' : 'inactive')}>{c.status}</span></td>
                      <td>{c.tier_name || '\u2014'}</td>
                      <td>${parseFloat(c.total_spend || 0).toLocaleString()}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ========== PromoCodesListView ==========
    function PromoCodesListView({ navigate }) {
      const [codes, setCodes] = useState([]);
      const [loading, setLoading] = useState(true);

      const load = () => {
        setLoading(true);
        adminFetch('/api/admin/promo-codes')
          .then(data => { setCodes(data.promo_codes || []); setLoading(false); })
          .catch(() => setLoading(false));
      };
      useEffect(load, []);

      const toggleActive = (id) => {
        adminFetch('/api/admin/promo-codes/' + id + '/toggle', { method: 'PATCH' })
          .then(data => {
            if (data.promo_code) {
              setCodes(prev => prev.map(c => c.id === id ? { ...c, is_active: data.promo_code.is_active } : c));
            }
          })
          .catch(() => {});
      };

      if (loading) return <div className="loading">Loading promo codes...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>Promo Codes</h1>
            <button className="btn btn-primary" onClick={() => navigate('promo-create')}>+ Create Promo Code</button>
          </div>
          <div className="table-scroll-wrapper">
          <table className="admin-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Discount</th>
                <th>Min Order</th>
                <th>Uses</th>
                <th>Expires</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {codes.map(c => (
                <tr key={c.id}>
                  <td>
                    <code style={{ fontSize: '0.8125rem', background: 'var(--stone-100)', padding: '0.15rem 0.4rem', fontWeight: 600 }}>{c.code}</code>
                    {c.description && <div style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginTop: '0.15rem' }}>{c.description}</div>}
                  </td>
                  <td style={{ fontWeight: 500 }}>
                    {c.discount_type === 'percent' ? parseFloat(c.discount_value) + '%' : '$' + parseFloat(c.discount_value).toFixed(2)}
                  </td>
                  <td>{parseFloat(c.min_order_amount || 0) > 0 ? '$' + parseFloat(c.min_order_amount).toFixed(2) : 'â€”'}</td>
                  <td>
                    {c.usage_count || 0}{c.max_uses ? ' / ' + c.max_uses : ''}
                    {c.max_uses_per_customer && <div style={{ fontSize: '0.7rem', color: 'var(--stone-500)' }}>Max {c.max_uses_per_customer}/customer</div>}
                  </td>
                  <td style={{ fontSize: '0.8125rem' }}>
                    {c.expires_at ? (
                      <span style={{ color: new Date(c.expires_at) < new Date() ? '#dc2626' : 'inherit' }}>
                        {new Date(c.expires_at).toLocaleDateString()}
                        {new Date(c.expires_at) < new Date() && <span style={{ fontSize: '0.7rem' }}> (expired)</span>}
                      </span>
                    ) : 'Never'}
                  </td>
                  <td>
                    <div className={'toggle' + (c.is_active ? ' on' : '')} onClick={() => toggleActive(c.id)} />
                  </td>
                  <td className="actions">
                    <button className="btn btn-secondary btn-sm" onClick={() => navigate('promo-edit', c.id)}>Edit</button>
                  </td>
                </tr>
              ))}
              {codes.length === 0 && (
                <tr><td colSpan="7" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No promo codes yet</td></tr>
              )}
            </tbody>
          </table>
          </div>
        </div>
      );
    }

    // ========== PromoCodeFormView ==========
    function PromoCodeFormView({ navigate, editId }) {
      const [loading, setLoading] = useState(!!editId);
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState('');
      const [categories, setCategories] = useState([]);
      const [products, setProducts] = useState([]);
      const [productSearch, setProductSearch] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const searchTimeout = useRef(null);
      const [form, setForm] = useState({
        code: '',
        description: '',
        discount_type: 'percent',
        discount_value: '',
        min_order_amount: '',
        max_uses: '',
        max_uses_per_customer: '',
        restricted_category_ids: [],
        restricted_product_ids: [],
        is_active: true,
        expires_at: ''
      });
      const [usages, setUsages] = useState([]);

      useEffect(() => {
        // Load categories for restriction checkboxes
        adminFetch('/api/admin/categories')
          .then(data => setCategories(data.categories || []))
          .catch(() => {});
      }, []);

      useEffect(() => {
        if (!editId) return;
        adminFetch('/api/admin/promo-codes/' + editId + '/usages')
          .then(data => setUsages(data.usages || []))
          .catch(() => {});
      }, [editId]);

      useEffect(() => {
        if (!editId) return;
        // Load existing code data â€” fetch from list and find, or fetch individually
        adminFetch('/api/admin/promo-codes')
          .then(data => {
            const code = (data.promo_codes || []).find(c => c.id === editId);
            if (code) {
              setForm({
                code: code.code || '',
                description: code.description || '',
                discount_type: code.discount_type || 'percent',
                discount_value: code.discount_value ? parseFloat(code.discount_value).toString() : '',
                min_order_amount: parseFloat(code.min_order_amount || 0) > 0 ? parseFloat(code.min_order_amount).toString() : '',
                max_uses: code.max_uses || '',
                max_uses_per_customer: code.max_uses_per_customer || '',
                restricted_category_ids: code.restricted_category_ids || [],
                restricted_product_ids: code.restricted_product_ids || [],
                is_active: code.is_active,
                expires_at: code.expires_at ? new Date(code.expires_at).toISOString().slice(0, 16) : ''
              });
              // Load restricted product names
              if (code.restricted_product_ids && code.restricted_product_ids.length > 0) {
                Promise.all(code.restricted_product_ids.map(pid =>
                  fetch(API + '/api/products/' + pid).then(r => r.json()).then(d => ({ id: pid, name: d.name || pid })).catch(() => ({ id: pid, name: pid }))
                )).then(setProducts);
              }
            }
            setLoading(false);
          })
          .catch(() => setLoading(false));
      }, [editId]);

      const handleProductSearch = (term) => {
        setProductSearch(term);
        if (searchTimeout.current) clearTimeout(searchTimeout.current);
        if (term.length < 2) { setSearchResults([]); return; }
        searchTimeout.current = setTimeout(() => {
          fetch(API + '/api/products?search=' + encodeURIComponent(term))
            .then(r => r.json())
            .then(data => setSearchResults(data.products || []))
            .catch(() => {});
        }, 300);
      };

      const addProductRestriction = (product) => {
        if (form.restricted_product_ids.includes(product.id)) return;
        setForm(f => ({ ...f, restricted_product_ids: [...f.restricted_product_ids, product.id] }));
        setProducts(prev => [...prev, { id: product.id, name: product.name }]);
        setProductSearch('');
        setSearchResults([]);
      };

      const removeProductRestriction = (productId) => {
        setForm(f => ({ ...f, restricted_product_ids: f.restricted_product_ids.filter(id => id !== productId) }));
        setProducts(prev => prev.filter(p => p.id !== productId));
      };

      const toggleCategoryRestriction = (catId) => {
        setForm(f => {
          const ids = f.restricted_category_ids.includes(catId)
            ? f.restricted_category_ids.filter(id => id !== catId)
            : [...f.restricted_category_ids, catId];
          return { ...f, restricted_category_ids: ids };
        });
      };

      const handleSave = async () => {
        setError('');
        setSaving(true);
        try {
          const payload = {
            code: form.code,
            description: form.description || null,
            discount_type: form.discount_type,
            discount_value: parseFloat(form.discount_value),
            min_order_amount: form.min_order_amount ? parseFloat(form.min_order_amount) : 0,
            max_uses: form.max_uses ? parseInt(form.max_uses) : null,
            max_uses_per_customer: form.max_uses_per_customer ? parseInt(form.max_uses_per_customer) : null,
            restricted_category_ids: form.restricted_category_ids,
            restricted_product_ids: form.restricted_product_ids,
            is_active: form.is_active,
            expires_at: form.expires_at || null
          };

          if (editId) {
            await adminFetch('/api/admin/promo-codes/' + editId, {
              method: 'PUT',
              body: JSON.stringify(payload)
            });
          } else {
            await adminFetch('/api/admin/promo-codes', {
              method: 'POST',
              body: JSON.stringify(payload)
            });
          }
          navigate('promos');
        } catch (err) {
          setError(err.message || 'Failed to save');
        }
        setSaving(false);
      };

      if (loading) return <div className="loading">Loading...</div>;

      return (
        <div>
          <div className="content-header">
            <h1>{editId ? 'Edit Promo Code' : 'Create Promo Code'}</h1>
            <button className="btn btn-secondary" onClick={() => navigate('promos')}>Back to Promo Codes</button>
          </div>

          {error && <div style={{ background: '#fef2f2', border: '1px solid #fca5a5', color: '#dc2626', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.875rem' }}>{error}</div>}

          <div className="form-card">
            <h3>Code Details</h3>
            <div className="form-grid">
              <div className="form-group">
                <label>Code *</label>
                <input type="text" value={form.code} onChange={e => setForm(f => ({ ...f, code: e.target.value.toUpperCase() }))} placeholder="e.g., SAVE10" style={{ textTransform: 'uppercase', fontWeight: 600 }} />
              </div>
              <div className="form-group">
                <label>Description (shown to customers)</label>
                <input type="text" value={form.description} onChange={e => setForm(f => ({ ...f, description: e.target.value }))} placeholder="e.g., 10% off your order" />
              </div>
            </div>
            <div className="form-grid">
              <div className="form-group">
                <label>Discount Type *</label>
                <select value={form.discount_type} onChange={e => setForm(f => ({ ...f, discount_type: e.target.value }))}>
                  <option value="percent">Percentage (%)</option>
                  <option value="fixed">Fixed Amount ($)</option>
                </select>
              </div>
              <div className="form-group">
                <label>{form.discount_type === 'percent' ? 'Discount Percentage *' : 'Discount Amount ($) *'}</label>
                <input type="number" value={form.discount_value} onChange={e => setForm(f => ({ ...f, discount_value: e.target.value }))}
                  min="0" max={form.discount_type === 'percent' ? '100' : undefined} step="0.01"
                  placeholder={form.discount_type === 'percent' ? 'e.g., 10' : 'e.g., 25.00'} />
              </div>
            </div>
          </div>

          <div className="form-card">
            <h3>Constraints</h3>
            <div className="form-grid">
              <div className="form-group">
                <label>Minimum Order Amount ($)</label>
                <input type="number" value={form.min_order_amount} onChange={e => setForm(f => ({ ...f, min_order_amount: e.target.value }))}
                  min="0" step="0.01" placeholder="No minimum" />
              </div>
              <div className="form-group">
                <label>Max Total Uses</label>
                <input type="number" value={form.max_uses} onChange={e => setForm(f => ({ ...f, max_uses: e.target.value }))}
                  min="1" placeholder="Unlimited" />
              </div>
            </div>
            <div className="form-grid">
              <div className="form-group">
                <label>Max Uses Per Customer</label>
                <input type="number" value={form.max_uses_per_customer} onChange={e => setForm(f => ({ ...f, max_uses_per_customer: e.target.value }))}
                  min="1" placeholder="Unlimited" />
              </div>
              <div className="form-group">
                <label>Expiration Date</label>
                <input type="datetime-local" value={form.expires_at} onChange={e => setForm(f => ({ ...f, expires_at: e.target.value }))} />
              </div>
            </div>
            <div className="form-group" style={{ marginTop: '0.5rem' }}>
              <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                <div className={'toggle' + (form.is_active ? ' on' : '')} onClick={() => setForm(f => ({ ...f, is_active: !f.is_active }))} />
                Active
              </label>
            </div>
          </div>

          <div className="form-card">
            <h3>Category Restrictions</h3>
            <p style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', marginBottom: '0.75rem' }}>
              Leave unchecked for all categories. Check specific categories to limit the discount.
            </p>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
              {categories.map(cat => (
                <label key={cat.id} style={{ display: 'flex', alignItems: 'center', gap: '0.35rem', fontSize: '0.8125rem', cursor: 'pointer', padding: '0.3rem 0.6rem', border: '1px solid var(--stone-200)', borderRadius: '4px', background: form.restricted_category_ids.includes(cat.id) ? '#dcfce7' : 'white' }}>
                  <input type="checkbox" checked={form.restricted_category_ids.includes(cat.id)}
                    onChange={() => toggleCategoryRestriction(cat.id)} />
                  {cat.name}
                </label>
              ))}
              {categories.length === 0 && <span style={{ color: 'var(--stone-400)', fontSize: '0.8125rem' }}>No categories loaded</span>}
            </div>
          </div>

          <div className="form-card">
            <h3>Product Restrictions</h3>
            <p style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', marginBottom: '0.75rem' }}>
              Leave empty for all products. Add specific products to limit the discount.
            </p>
            <div style={{ position: 'relative', maxWidth: '400px' }}>
              <input type="text" value={productSearch} onChange={e => handleProductSearch(e.target.value)}
                placeholder="Search products to restrict..." />
              {searchResults.length > 0 && (
                <div style={{ position: 'absolute', top: '100%', left: 0, right: 0, background: 'white', border: '1px solid var(--stone-200)', borderRadius: '0 0 6px 6px', maxHeight: '200px', overflowY: 'auto', zIndex: 10 }}>
                  {searchResults.map(p => (
                    <div key={p.id} onClick={() => addProductRestriction(p)}
                      style={{ padding: '0.5rem 0.75rem', cursor: 'pointer', fontSize: '0.8125rem', borderBottom: '1px solid var(--stone-100)' }}
                      onMouseEnter={e => e.target.style.background = 'var(--stone-50)'}
                      onMouseLeave={e => e.target.style.background = 'white'}>
                      {p.name} {p.collection && <span style={{ color: 'var(--stone-500)' }}>({p.collection})</span>}
                    </div>
                  ))}
                </div>
              )}
            </div>
            {products.length > 0 && (
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.4rem', marginTop: '0.75rem' }}>
                {products.map(p => (
                  <span key={p.id} style={{ display: 'flex', alignItems: 'center', gap: '0.3rem', background: 'var(--stone-100)', padding: '0.25rem 0.5rem', borderRadius: '4px', fontSize: '0.8rem' }}>
                    {p.name}
                    <span onClick={() => removeProductRestriction(p.id)} style={{ cursor: 'pointer', color: 'var(--stone-500)', fontWeight: 600 }}>&times;</span>
                  </span>
                ))}
              </div>
            )}
          </div>

          <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1rem' }}>
            <button className="btn btn-secondary" onClick={() => navigate('promos')}>Cancel</button>
            <button className="btn btn-primary" onClick={handleSave} disabled={saving || !form.code || !form.discount_value}>
              {saving ? 'Saving...' : (editId ? 'Save Changes' : 'Create Promo Code')}
            </button>
          </div>

          {editId && usages.length > 0 && (
            <div className="form-card" style={{ marginTop: '1.5rem' }}>
              <h3>Usage History ({usages.length})</h3>
              <div className="table-scroll-wrapper">
              <table className="admin-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Order / Quote</th>
                    <th>Discount</th>
                  </tr>
                </thead>
                <tbody>
                  {usages.map(u => (
                    <tr key={u.id}>
                      <td style={{ fontSize: '0.8125rem' }}>{new Date(u.created_at).toLocaleString()}</td>
                      <td style={{ fontSize: '0.8125rem' }}>{u.customer_email}</td>
                      <td style={{ fontSize: '0.8125rem' }}>
                        {u.order_number && <span onClick={() => navigate('order-detail', u.order_id)} style={{ cursor: 'pointer', color: 'var(--accent-gold)', textDecoration: 'underline' }}>{u.order_number}</span>}
                        {u.quote_number && !u.order_number && <span style={{ color: 'var(--stone-500)' }}>{u.quote_number} (quote)</span>}
                      </td>
                      <td style={{ fontSize: '0.8125rem', color: '#16a34a' }}>-${parseFloat(u.discount_amount).toFixed(2)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ========== CustomersListView ==========
    function CustomersListView({ navigate }) {
      const [customers, setCustomers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [searchInput, setSearchInput] = useState('');
      const [typeFilter, setTypeFilter] = useState('all');
      const [sortCol, setSortCol] = useState('last_order');
      const [sortDir, setSortDir] = useState('desc');
      const [page, setPage] = useState(1);
      const [total, setTotal] = useState(0);
      const limit = 50;

      const load = () => {
        setLoading(true);
        let url = '/api/admin/customers?page=' + page + '&limit=' + limit + '&sort=' + sortCol + '&dir=' + sortDir + '&type=' + typeFilter;
        if (searchTerm) url += '&search=' + encodeURIComponent(searchTerm);
        adminFetch(url)
          .then(data => {
            setCustomers(data.customers || []);
            setTotal(data.total || 0);
            setLoading(false);
          })
          .catch(() => setLoading(false));
      };
      useEffect(load, [page, sortCol, sortDir, typeFilter, searchTerm]);

      const handleSort = (col) => {
        if (sortCol === col) { setSortDir(d => d === 'asc' ? 'desc' : 'asc'); }
        else { setSortCol(col); setSortDir('desc'); }
        setPage(1);
      };

      const handleSearch = (e) => {
        e.preventDefault();
        setSearchTerm(searchInput);
        setPage(1);
      };

      const totalPages = Math.ceil(total / limit) || 1;

      const typeBadge = (t) => {
        if (t === 'retail') return React.createElement('span', { className: 'badge badge-active' }, 'Retail');
        if (t === 'trade') return React.createElement('span', { className: 'badge badge-shipped' }, 'Trade');
        return React.createElement('span', { className: 'badge badge-draft' }, 'Guest');
      };

      const sortIcon = (col) => sortCol === col ? (sortDir === 'asc' ? ' \u25B2' : ' \u25BC') : '';

      return (
        React.createElement('div', null,
          React.createElement('div', { className: 'content-header' },
            React.createElement('h1', null, 'Customers'),
            React.createElement('span', { style: { fontSize: '0.875rem', color: 'var(--stone-400)', marginLeft: '1rem' } }, total + ' total')
          ),
          React.createElement('form', { onSubmit: handleSearch, style: { display: 'flex', gap: '0.75rem', marginBottom: '1rem', alignItems: 'center' } },
            React.createElement('input', {
              type: 'text', value: searchInput, onChange: e => setSearchInput(e.target.value),
              placeholder: 'Search name, email, phone, company...',
              style: { padding: '0.5rem 0.75rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', maxWidth: '300px', width: '100%' }
            }),
            React.createElement('button', { type: 'submit', className: 'btn btn-secondary btn-sm' }, 'Search'),
            searchTerm && React.createElement('button', { type: 'button', className: 'btn btn-secondary btn-sm', onClick: () => { setSearchInput(''); setSearchTerm(''); setPage(1); } }, 'Clear'),
            React.createElement('select', {
              value: typeFilter, onChange: e => { setTypeFilter(e.target.value); setPage(1); },
              style: { padding: '0.5rem 0.75rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem' }
            },
              React.createElement('option', { value: 'all' }, 'All Types'),
              React.createElement('option', { value: 'retail' }, 'Retail'),
              React.createElement('option', { value: 'guest' }, 'Guest'),
              React.createElement('option', { value: 'trade' }, 'Trade')
            ),
            React.createElement('span', { style: { marginLeft: 'auto', fontSize: '0.8125rem', color: 'var(--stone-400)' } }, customers.length + ' shown')
          ),
          loading ? React.createElement('div', { className: 'loading' }, 'Loading customers...') :
          React.createElement('table', { className: 'admin-table' },
            React.createElement('thead', null,
              React.createElement('tr', null,
                React.createElement('th', { style: { cursor: 'pointer' }, onClick: () => handleSort('name') }, 'Name' + sortIcon('name')),
                React.createElement('th', { style: { cursor: 'pointer' }, onClick: () => handleSort('email') }, 'Email' + sortIcon('email')),
                React.createElement('th', null, 'Phone'),
                React.createElement('th', null, 'Type'),
                React.createElement('th', { style: { cursor: 'pointer' }, onClick: () => handleSort('orders') }, 'Orders' + sortIcon('orders')),
                React.createElement('th', { style: { cursor: 'pointer' }, onClick: () => handleSort('spent') }, 'Total Spent' + sortIcon('spent')),
                React.createElement('th', { style: { cursor: 'pointer' }, onClick: () => handleSort('last_order') }, 'Last Order' + sortIcon('last_order')),
                React.createElement('th', { style: { cursor: 'pointer' }, onClick: () => handleSort('created') }, 'Created' + sortIcon('created')),
                React.createElement('th', null, 'Actions')
              )
            ),
            React.createElement('tbody', null,
              customers.map(c =>
                React.createElement('tr', { key: c.id, style: { cursor: 'pointer' }, onClick: () => navigate('customer-detail', c.id) },
                  React.createElement('td', { style: { fontWeight: 500 } },
                    c.name || '\u2014',
                    c.company_name ? React.createElement('div', { style: { fontSize: '0.75rem', color: 'var(--stone-400)' } }, c.company_name) : null
                  ),
                  React.createElement('td', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, c.email),
                  React.createElement('td', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, c.phone || '\u2014'),
                  React.createElement('td', null, typeBadge(c.customer_type)),
                  React.createElement('td', null, c.order_count),
                  React.createElement('td', null, '$' + (parseFloat(c.total_spent) || 0).toFixed(2)),
                  React.createElement('td', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, c.last_order_date ? new Date(c.last_order_date).toLocaleDateString() : '\u2014'),
                  React.createElement('td', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, new Date(c.created_at).toLocaleDateString()),
                  React.createElement('td', { className: 'actions', onClick: e => e.stopPropagation() },
                    React.createElement('button', { className: 'btn btn-secondary btn-sm', onClick: () => navigate('customer-detail', c.id) }, 'View')
                  )
                )
              ),
              customers.length === 0 && React.createElement('tr', null,
                React.createElement('td', { colSpan: 9, style: { textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' } }, 'No customers found')
              )
            )
          ),
          totalPages > 1 && React.createElement('div', { style: { display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '0.75rem', marginTop: '1rem' } },
            React.createElement('button', { className: 'btn btn-secondary btn-sm', disabled: page <= 1, onClick: () => setPage(p => p - 1) }, 'Previous'),
            React.createElement('span', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, 'Page ' + page + ' of ' + totalPages),
            React.createElement('button', { className: 'btn btn-secondary btn-sm', disabled: page >= totalPages, onClick: () => setPage(p => p + 1) }, 'Next')
          )
        )
      );
    }

    // ========== CustomerDetailView ==========
    function CustomerDetailView({ navigate, editId }) {
      const [customer, setCustomer] = useState(null);
      const [orders, setOrders] = useState([]);
      const [notes, setNotes] = useState([]);
      const [stats, setStats] = useState(null);
      const [loading, setLoading] = useState(true);
      const [quotes, setQuotes] = useState([]);
      const [paymentRequests, setPaymentRequests] = useState([]);
      const [newNote, setNewNote] = useState('');
      const [addingNote, setAddingNote] = useState(false);

      // Parse the composite ID: retail_UUID, trade_UUID, guest_email
      const parseId = (compositeId) => {
        if (!compositeId) return { type: null, ref: null };
        const idx = compositeId.indexOf('_');
        if (idx === -1) return { type: null, ref: null };
        const type = compositeId.substring(0, idx);
        const ref = compositeId.substring(idx + 1);
        return { type, ref };
      };

      const { type, ref } = parseId(editId);

      useEffect(() => {
        if (!type || !ref) return;
        setLoading(true);
        adminFetch('/api/admin/customers/' + encodeURIComponent(ref) + '?type=' + type)
          .then(data => {
            setCustomer(data.customer);
            setOrders(data.orders || []);
            setNotes(data.notes || []);
            setQuotes(data.quotes || []);
            setPaymentRequests(data.payment_requests || []);
            setStats(data.stats || {});
            setLoading(false);
          })
          .catch(() => setLoading(false));
      }, [editId]);

      const addNote = () => {
        if (!newNote.trim()) return;
        setAddingNote(true);
        adminFetch('/api/admin/customers/' + encodeURIComponent(ref) + '/notes', {
          method: 'POST',
          body: JSON.stringify({ customer_type: type, customer_ref: ref, note: newNote.trim() })
        })
          .then(data => {
            setNotes(prev => [data.note, ...prev]);
            setNewNote('');
            setAddingNote(false);
          })
          .catch(() => setAddingNote(false));
      };

      const pendingPaymentOrderIds = new Set(paymentRequests.map(pr => pr.order_id));

      if (loading) return React.createElement('div', { className: 'loading' }, 'Loading customer...');
      if (!customer) return React.createElement('div', { style: { padding: '2rem', textAlign: 'center', color: 'var(--stone-400)' } }, 'Customer not found');

      const typeBadge = (t) => {
        if (t === 'retail') return React.createElement('span', { className: 'badge badge-active' }, 'Retail');
        if (t === 'trade') return React.createElement('span', { className: 'badge badge-shipped' }, 'Trade');
        return React.createElement('span', { className: 'badge badge-draft' }, 'Guest');
      };

      const statusBadge = (s) => React.createElement('span', { className: 'badge badge-' + s }, s);

      const statCard = (label, value, extraStyle) =>
        React.createElement('div', { style: Object.assign({ background: 'white', border: '1px solid var(--stone-200)', padding: '1.25rem', flex: 1, minWidth: '140px' }, extraStyle || {}) },
          React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)', marginBottom: '0.5rem' } }, label),
          React.createElement('div', { style: { fontSize: '1.5rem', fontWeight: 500, fontFamily: "'Cormorant Garamond', serif" } }, value)
        );

      return React.createElement('div', null,
        // Back button + header
        React.createElement('div', { className: 'content-header' },
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '1rem' } },
            React.createElement('button', { className: 'btn btn-secondary btn-sm', onClick: () => navigate('customers') }, '\u2190 Back'),
            React.createElement('h1', null, customer.name || customer.email),
            typeBadge(customer.customer_type)
          )
        ),

        // Stats row 1 â€” Order stats
        stats && React.createElement('div', { style: { display: 'flex', gap: '1rem', marginBottom: '0.75rem', flexWrap: 'wrap' } },
          statCard('Total Orders', stats.total_orders || 0),
          statCard('Total Spent', '$' + (parseFloat(stats.total_spent) || 0).toFixed(2)),
          statCard('Avg Order', '$' + (parseFloat(stats.avg_order_value) || 0).toFixed(2)),
          statCard('First Order', stats.first_order_date ? new Date(stats.first_order_date).toLocaleDateString() : '\u2014'),
          statCard('Last Order', stats.last_order_date ? new Date(stats.last_order_date).toLocaleDateString() : '\u2014')
        ),

        // Stats row 2 â€” Financial stats
        stats && React.createElement('div', { style: { display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' } },
          statCard('Open Balance', '$' + (parseFloat(stats.open_balance) || 0).toFixed(2),
            (parseFloat(stats.open_balance) || 0) > 0 ? { background: '#fef2f2', borderColor: '#fecaca' } : null),
          statCard('Available Credit', '$' + (parseFloat(stats.available_credit) || 0).toFixed(2),
            (parseFloat(stats.available_credit) || 0) > 0 ? { background: '#f0fdf4', borderColor: '#bbf7d0' } : null),
          statCard('Open Quotes', (stats.open_quotes_count || 0) + ' ($' + (parseFloat(stats.open_quotes_value) || 0).toFixed(2) + ')'),
          statCard('Pending Payments', (stats.pending_payments_count || 0) + ' ($' + (parseFloat(stats.pending_payments_total) || 0).toFixed(2) + ')'),
          customer.customer_type === 'trade'
            ? statCard('Lifetime Spend', '$' + (parseFloat(customer.total_spend) || 0).toFixed(2))
            : React.createElement('div', { style: { flex: 1, minWidth: '140px' } })
        ),

        // Customer Information
        React.createElement(CollapsibleSection, { title: 'Customer Information', defaultOpen: true },
          React.createElement('div', { className: 'resp-grid-2', style: { gap: '1.5rem' } },
            React.createElement('div', null,
              React.createElement('div', { style: { marginBottom: '0.75rem' } },
                React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Name'),
                React.createElement('div', null, customer.name || '\u2014')
              ),
              React.createElement('div', { style: { marginBottom: '0.75rem' } },
                React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Email'),
                React.createElement('div', null, customer.email || '\u2014')
              ),
              React.createElement('div', { style: { marginBottom: '0.75rem' } },
                React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Phone'),
                React.createElement('div', null, customer.phone || '\u2014')
              )
            ),
            React.createElement('div', null,
              React.createElement('div', { style: { marginBottom: '0.75rem' } },
                React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Address'),
                React.createElement('div', null,
                  customer.address_line1 ? [
                    customer.address_line1,
                    customer.address_line2 ? React.createElement('br', { key: 'br1' }) : null,
                    customer.address_line2 || null,
                    React.createElement('br', { key: 'br2' }),
                    [customer.city, customer.state, customer.zip].filter(Boolean).join(', ')
                  ] : '\u2014'
                )
              ),
              React.createElement('div', { style: { marginBottom: '0.75rem' } },
                React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Customer Since'),
                React.createElement('div', null, customer.created_at ? new Date(customer.created_at).toLocaleDateString() : '\u2014')
              ),
              // Trade-specific fields
              customer.customer_type === 'trade' && React.createElement(React.Fragment, null,
                React.createElement('div', { style: { marginBottom: '0.75rem' } },
                  React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Company'),
                  React.createElement('div', null, customer.company_name || '\u2014')
                ),
                React.createElement('div', { style: { marginBottom: '0.75rem' } },
                  React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Tier / Status'),
                  React.createElement('div', null,
                    (customer.tier_name || 'No tier') + ' \u2022 ',
                    React.createElement('span', { className: 'badge badge-' + (customer.status === 'approved' ? 'active' : customer.status === 'pending' ? 'pending' : 'draft') }, customer.status || 'unknown')
                  )
                ),
                React.createElement('div', { style: { marginBottom: '0.75rem' } },
                  React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Subscription'),
                  React.createElement('div', null, (customer.subscription_status || 'none') + (customer.subscription_expires_at ? ' (expires ' + new Date(customer.subscription_expires_at).toLocaleDateString() + ')' : ''))
                ),
                customer.rep_name && React.createElement('div', { style: { marginBottom: '0.75rem' } },
                  React.createElement('div', { style: { fontSize: '0.6875rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)' } }, 'Assigned Rep'),
                  React.createElement('div', null, customer.rep_name)
                )
              )
            )
          )
        ),

        // Order History
        React.createElement(CollapsibleSection, { title: 'Order History (' + orders.length + ')', defaultOpen: true },
          orders.length === 0
            ? React.createElement('div', { style: { padding: '1rem', textAlign: 'center', color: 'var(--stone-400)' } }, 'No orders yet')
            : React.createElement('table', { className: 'admin-table' },
                React.createElement('thead', null,
                  React.createElement('tr', null,
                    React.createElement('th', null, 'Order #'),
                    React.createElement('th', null, 'Date'),
                    React.createElement('th', null, 'Status'),
                    React.createElement('th', null, 'Items'),
                    React.createElement('th', null, 'Total'),
                    React.createElement('th', null, 'Paid'),
                    React.createElement('th', null, 'Balance')
                  )
                ),
                React.createElement('tbody', null,
                  orders.map(o =>
                    React.createElement('tr', { key: o.id, style: { cursor: 'pointer' }, onClick: () => navigate('order-detail', o.id) },
                      React.createElement('td', { style: { fontWeight: 500 } }, o.order_number),
                      React.createElement('td', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, new Date(o.created_at).toLocaleDateString()),
                      React.createElement('td', null, statusBadge(o.status)),
                      React.createElement('td', null, o.item_count || '\u2014'),
                      React.createElement('td', null, '$' + (parseFloat(o.total) || 0).toFixed(2)),
                      React.createElement('td', null, '$' + (parseFloat(o.amount_paid) || 0).toFixed(2)),
                      React.createElement('td', null,
                        '$' + ((parseFloat(o.total) || 0) - (parseFloat(o.amount_paid) || 0)).toFixed(2),
                        pendingPaymentOrderIds.has(o.id)
                          ? React.createElement('span', {
                              style: { marginLeft: '0.5rem', fontSize: '0.625rem', padding: '0.125rem 0.375rem', background: '#fef3c7', color: '#92400e', borderRadius: '3px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.03em' }
                            }, 'Payment Requested')
                          : null
                      )
                    )
                  )
                )
              )
        ),

        // Open Quotes
        React.createElement(CollapsibleSection, { title: 'Open Quotes (' + quotes.length + ')', defaultOpen: quotes.length > 0 },
          quotes.length === 0
            ? React.createElement('div', { style: { padding: '1rem', textAlign: 'center', color: 'var(--stone-400)' } }, 'No open quotes')
            : React.createElement('table', { className: 'admin-table' },
                React.createElement('thead', null,
                  React.createElement('tr', null,
                    React.createElement('th', null, 'Quote #'),
                    React.createElement('th', null, 'Date'),
                    React.createElement('th', null, 'Status'),
                    React.createElement('th', null, 'Items'),
                    React.createElement('th', null, 'Total'),
                    React.createElement('th', null, 'Expires'),
                    React.createElement('th', null, 'Actions')
                  )
                ),
                React.createElement('tbody', null,
                  quotes.map(q => {
                    const expired = q.expires_at && new Date(q.expires_at) < new Date();
                    return React.createElement('tr', { key: q.id },
                      React.createElement('td', { style: { fontWeight: 500 } }, q.quote_number || q.id.slice(0, 8)),
                      React.createElement('td', { style: { fontSize: '0.8125rem', color: 'var(--stone-500)' } }, new Date(q.created_at).toLocaleDateString()),
                      React.createElement('td', null,
                        React.createElement('span', { className: 'badge badge-' + (q.status === 'sent' ? 'shipped' : 'draft') }, q.status)
                      ),
                      React.createElement('td', null, q.item_count || '\u2014'),
                      React.createElement('td', null, '$' + (parseFloat(q.total) || 0).toFixed(2)),
                      React.createElement('td', { style: expired ? { color: '#dc2626', fontWeight: 500, fontSize: '0.8125rem' } : { fontSize: '0.8125rem', color: 'var(--stone-500)' } },
                        expired ? 'Expired' : (q.expires_at ? new Date(q.expires_at).toLocaleDateString() : '\u2014')
                      ),
                      React.createElement('td', { className: 'actions' },
                        React.createElement('button', { className: 'btn btn-secondary btn-sm', onClick: () => alert('Quote: ' + (q.quote_number || q.id.slice(0, 8))) }, 'View')
                      )
                    );
                  })
                )
              )
        ),

        // Admin Notes
        React.createElement(CollapsibleSection, { title: 'Admin Notes (' + notes.length + ')', defaultOpen: true },
          React.createElement('div', { style: { display: 'flex', gap: '0.5rem', marginBottom: '1rem' } },
            React.createElement('textarea', {
              value: newNote, onChange: e => setNewNote(e.target.value),
              placeholder: 'Add a note about this customer...',
              rows: 2,
              style: { flex: 1, padding: '0.5rem 0.75rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', fontFamily: "'Inter', sans-serif", resize: 'vertical' }
            }),
            React.createElement('button', {
              className: 'btn btn-primary btn-sm',
              onClick: addNote,
              disabled: addingNote || !newNote.trim(),
              style: { alignSelf: 'flex-end' }
            }, addingNote ? 'Adding...' : 'Add Note')
          ),
          notes.length === 0
            ? React.createElement('div', { style: { padding: '0.5rem', textAlign: 'center', color: 'var(--stone-400)', fontSize: '0.8125rem' } }, 'No notes yet')
            : notes.map(n =>
                React.createElement('div', { key: n.id, style: { padding: '0.75rem', borderBottom: '1px solid var(--stone-100)', fontSize: '0.875rem' } },
                  React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '0.25rem' } },
                    React.createElement('span', { style: { fontWeight: 500, fontSize: '0.8125rem' } }, n.staff_name || 'Staff'),
                    React.createElement('span', { style: { fontSize: '0.75rem', color: 'var(--stone-400)' } }, new Date(n.created_at).toLocaleString())
                  ),
                  React.createElement('div', { style: { color: 'var(--stone-600)', whiteSpace: 'pre-wrap' } }, n.note)
                )
              )
        )
      );
    }

    // ========== AuditLogView ==========
    function AuditLogView({ navigate }) {
      const [logs, setLogs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [page, setPage] = useState(1);
      const [totalPages, setTotalPages] = useState(1);
      const [actionFilter, setActionFilter] = useState('');

      const load = () => {
        setLoading(true);
        let url = '/api/admin/audit-log?page=' + page + '&limit=50';
        if (actionFilter) url += '&action=' + encodeURIComponent(actionFilter);
        adminFetch(url)
          .then(data => {
            setLogs(data.logs || []);
            setTotalPages(data.total_pages || 1);
            setLoading(false);
          })
          .catch(() => setLoading(false));
      };

      useEffect(load, [page, actionFilter]);

      return (
        <div>
          <div className="content-header">
            <h1>Audit Log</h1>
          </div>
          <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem', alignItems: 'center' }}>
            <label style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>Filter action:</label>
            <input type="text" value={actionFilter} onChange={e => { setActionFilter(e.target.value); setPage(1); }}
              placeholder="e.g. staff.login, trade.approve"
              style={{ padding: '0.4rem 0.6rem', border: '1px solid var(--stone-300)', fontSize: '0.875rem', maxWidth: '250px', width: '100%' }} />
            <span style={{ marginLeft: 'auto', fontSize: '0.8125rem', color: 'var(--stone-400)' }}>Page {page} of {totalPages}</span>
          </div>
          {loading ? <div className="loading">Loading...</div> : (
            <div className="table-scroll-wrapper">
            <table className="admin-table">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Staff</th>
                  <th>Action</th>
                  <th>Entity</th>
                  <th>Details</th>
                  <th>IP</th>
                </tr>
              </thead>
              <tbody>
                {logs.map(log => (
                  <tr key={log.id}>
                    <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', whiteSpace: 'nowrap' }}>{new Date(log.created_at).toLocaleString()}</td>
                    <td style={{ fontSize: '0.8125rem' }}>{log.staff_name || log.staff_id || '\u2014'}</td>
                    <td style={{ fontWeight: 500, fontSize: '0.8125rem' }}>{log.action}</td>
                    <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{log.entity_type ? log.entity_type + (log.entity_id ? ' #' + log.entity_id.slice(0, 8) : '') : '\u2014'}</td>
                    <td style={{ fontSize: '0.75rem', color: 'var(--stone-400)', maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                      {log.details ? JSON.stringify(log.details) : '\u2014'}
                    </td>
                    <td style={{ fontSize: '0.75rem', color: 'var(--stone-400)' }}>{log.ip_address || '\u2014'}</td>
                  </tr>
                ))}
                {logs.length === 0 && (
                  <tr><td colSpan="6" style={{ textAlign: 'center', color: 'var(--stone-400)', padding: '2rem' }}>No audit log entries found</td></tr>
                )}
              </tbody>
            </table>
            </div>
          )}
          <div style={{ display: 'flex', justifyContent: 'center', gap: '0.5rem', marginTop: '1rem' }}>
            <button className="btn btn-secondary btn-sm" disabled={page <= 1} onClick={() => setPage(p => p - 1)}>Previous</button>
            <button className="btn btn-secondary btn-sm" disabled={page >= totalPages} onClick={() => setPage(p => p + 1)}>Next</button>
          </div>
        </div>
      );
    }

    // ========== EDI View ==========
    function EDIView({ navigate }) {
      const [tab, setTab] = useState('transactions');
      const [transactions, setTransactions] = useState([]);
      const [invoices, setInvoices] = useState([]);
      const [txnTotal, setTxnTotal] = useState(0);
      const [invTotal, setInvTotal] = useState(0);
      const [loading, setLoading] = useState(true);
      const [selectedTxn, setSelectedTxn] = useState(null);
      const [selectedInvoice, setSelectedInvoice] = useState(null);
      const [invoiceItems, setInvoiceItems] = useState([]);
      const [filters, setFilters] = useState({ document_type: '', direction: '', status: '' });
      const [polling, setPolling] = useState(false);

      const loadTransactions = async () => {
        setLoading(true);
        try {
          const params = new URLSearchParams();
          if (filters.document_type) params.set('document_type', filters.document_type);
          if (filters.direction) params.set('direction', filters.direction);
          if (filters.status) params.set('status', filters.status);
          params.set('limit', '50');
          const data = await adminFetch('/api/admin/edi/transactions?' + params.toString());
          setTransactions(data.transactions || []);
          setTxnTotal(data.total || 0);
        } catch (err) { console.error(err); }
        setLoading(false);
      };

      const loadInvoices = async () => {
        setLoading(true);
        try {
          const data = await adminFetch('/api/admin/edi/invoices?limit=50');
          setInvoices(data.invoices || []);
          setInvTotal(data.total || 0);
        } catch (err) { console.error(err); }
        setLoading(false);
      };

      React.useEffect(() => {
        if (tab === 'transactions') loadTransactions();
        else loadInvoices();
      }, [tab, filters]);

      const pollNow = async () => {
        setPolling(true);
        try {
          const result = await adminFetch('/api/admin/edi/poll-now', { method: 'POST' });
          alert('EDI poll triggered (Job ID: ' + result.job_id + '). Refresh in a few minutes to see results.');
          setTimeout(() => { loadTransactions(); loadInvoices(); }, 5000);
        } catch (err) { alert('Poll failed: ' + err.message); }
        setPolling(false);
      };

      const viewTxnDetail = async (id) => {
        try {
          const data = await adminFetch('/api/admin/edi/transactions/' + id);
          setSelectedTxn(data.transaction);
        } catch (err) { alert(err.message); }
      };

      const viewInvoiceDetail = async (id) => {
        try {
          const data = await adminFetch('/api/admin/edi/invoices/' + id);
          setSelectedInvoice(data.invoice);
          setInvoiceItems(data.items || []);
        } catch (err) { alert(err.message); }
      };

      const updateInvoiceStatus = async (id, status) => {
        try {
          await adminFetch('/api/admin/edi/invoices/' + id + '/status', {
            method: 'PUT', body: JSON.stringify({ status })
          });
          loadInvoices();
          if (selectedInvoice?.id === id) setSelectedInvoice(prev => ({ ...prev, status }));
        } catch (err) { alert(err.message); }
      };

      const statusColor = (status) => {
        const map = { sent: '#dbeafe', received: '#dbeafe', processed: '#dcfce7', failed: '#fef2f2',
          pending: '#f5f5f4', matched: '#dbeafe', approved: '#dcfce7', paid: '#dcfce7', disputed: '#fef2f2' };
        return map[status] || '#f5f5f4';
      };
      const statusTextColor = (status) => {
        const map = { sent: '#1e40af', received: '#1e40af', processed: '#166534', failed: '#991b1b',
          pending: '#57534e', matched: '#1e40af', approved: '#166534', paid: '#166534', disputed: '#991b1b' };
        return map[status] || '#57534e';
      };

      // Transaction detail modal
      if (selectedTxn) {
        return (
          <div>
            <button className="btn btn-secondary btn-sm" onClick={() => setSelectedTxn(null)} style={{ marginBottom: '1rem' }}>
              {'\u2190'} Back to Transactions
            </button>
            <h3 style={{ fontFamily: 'var(--font-heading)', fontWeight: 400 }}>EDI Transaction Detail</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>
              <div><strong>Type:</strong> {selectedTxn.document_type}</div>
              <div><strong>Direction:</strong> {selectedTxn.direction}</div>
              <div><strong>Vendor:</strong> {selectedTxn.vendor_name}</div>
              <div><strong>Status:</strong> <span style={{ background: statusColor(selectedTxn.status), color: statusTextColor(selectedTxn.status), padding: '0.15rem 0.5rem', fontSize: '0.75rem' }}>{selectedTxn.status}</span></div>
              <div><strong>Filename:</strong> {selectedTxn.filename || 'â€”'}</div>
              <div><strong>ICN:</strong> {selectedTxn.interchange_control_number || 'â€”'}</div>
              <div><strong>PO:</strong> {selectedTxn.po_number || 'â€”'}</div>
              <div><strong>Created:</strong> {new Date(selectedTxn.created_at).toLocaleString()}</div>
              {selectedTxn.processed_at && <div><strong>Processed:</strong> {new Date(selectedTxn.processed_at).toLocaleString()}</div>}
              {selectedTxn.error_message && <div style={{ gridColumn: '1/3', color: '#991b1b' }}><strong>Error:</strong> {selectedTxn.error_message}</div>}
            </div>
            {selectedTxn.raw_content && (
              <div>
                <strong style={{ fontSize: '0.8125rem' }}>Raw X12 Content:</strong>
                <pre style={{ background: 'var(--stone-100)', padding: '1rem', fontSize: '0.6875rem', overflow: 'auto', maxHeight: '400px', marginTop: '0.5rem', whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>
                  {selectedTxn.raw_content}
                </pre>
              </div>
            )}
          </div>
        );
      }

      // Invoice detail modal
      if (selectedInvoice) {
        return (
          <div>
            <button className="btn btn-secondary btn-sm" onClick={() => { setSelectedInvoice(null); setInvoiceItems([]); }} style={{ marginBottom: '1rem' }}>
              {'\u2190'} Back to Invoices
            </button>
            <h3 style={{ fontFamily: 'var(--font-heading)', fontWeight: 400 }}>EDI Invoice #{selectedInvoice.invoice_number}</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>
              <div><strong>Vendor:</strong> {selectedInvoice.vendor_name}</div>
              <div><strong>Date:</strong> {selectedInvoice.invoice_date ? new Date(selectedInvoice.invoice_date).toLocaleDateString() : 'â€”'}</div>
              <div><strong>PO:</strong> {selectedInvoice.po_number || 'â€”'}</div>
              <div><strong>Total:</strong> ${parseFloat(selectedInvoice.total_amount || 0).toFixed(2)}</div>
              <div><strong>Status:</strong>
                <select value={selectedInvoice.status} onChange={e => updateInvoiceStatus(selectedInvoice.id, e.target.value)}
                  style={{ fontSize: '0.75rem', padding: '0.2rem 0.3rem', border: '1px solid var(--stone-300)', marginLeft: '0.5rem' }}>
                  <option value="pending">Pending</option>
                  <option value="matched">Matched</option>
                  <option value="approved">Approved</option>
                  <option value="paid">Paid</option>
                  <option value="disputed">Disputed</option>
                </select>
              </div>
            </div>
            {invoiceItems.length > 0 && (
              <div className="table-scroll-wrapper">
                <table className="admin-table" style={{ fontSize: '0.8125rem' }}>
                  <thead>
                    <tr><th>#</th><th>Vendor SKU</th><th>Description</th><th>Qty</th><th>UoM</th><th style={{ textAlign: 'right' }}>Unit Price</th><th style={{ textAlign: 'right' }}>Subtotal</th></tr>
                  </thead>
                  <tbody>
                    {invoiceItems.map((item, idx) => (
                      <tr key={item.id}>
                        <td>{item.line_number || idx + 1}</td>
                        <td>{item.vendor_sku || 'â€”'}</td>
                        <td>{item.description || 'â€”'}</td>
                        <td>{item.qty}</td>
                        <td>{item.unit_of_measure || 'â€”'}</td>
                        <td style={{ textAlign: 'right' }}>${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                        <td style={{ textAlign: 'right' }}>${parseFloat(item.subtotal || 0).toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      }

      return (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
            <h2 style={{ fontFamily: 'var(--font-heading)', fontWeight: 400, margin: 0 }}>EDI</h2>
            <button className="btn btn-primary btn-sm" onClick={pollNow} disabled={polling}>
              {polling ? 'Polling...' : 'Poll Now'}
            </button>
          </div>

          <div style={{ display: 'flex', gap: '1rem', marginBottom: '1rem' }}>
            <button className={tab === 'transactions' ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'}
              onClick={() => setTab('transactions')}>Transactions ({txnTotal})</button>
            <button className={tab === 'invoices' ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm'}
              onClick={() => setTab('invoices')}>Invoices ({invTotal})</button>
          </div>

          {tab === 'transactions' && (
            <div>
              <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem', flexWrap: 'wrap' }}>
                <select value={filters.document_type} onChange={e => setFilters(f => ({ ...f, document_type: e.target.value }))}
                  style={{ fontSize: '0.75rem', padding: '0.3rem', border: '1px solid var(--stone-300)' }}>
                  <option value="">All Types</option>
                  <option value="850">850 (PO)</option>
                  <option value="855">855 (Ack)</option>
                  <option value="856">856 (ASN)</option>
                  <option value="810">810 (Invoice)</option>
                </select>
                <select value={filters.direction} onChange={e => setFilters(f => ({ ...f, direction: e.target.value }))}
                  style={{ fontSize: '0.75rem', padding: '0.3rem', border: '1px solid var(--stone-300)' }}>
                  <option value="">All Directions</option>
                  <option value="outbound">Outbound</option>
                  <option value="inbound">Inbound</option>
                </select>
                <select value={filters.status} onChange={e => setFilters(f => ({ ...f, status: e.target.value }))}
                  style={{ fontSize: '0.75rem', padding: '0.3rem', border: '1px solid var(--stone-300)' }}>
                  <option value="">All Statuses</option>
                  <option value="pending">Pending</option>
                  <option value="sent">Sent</option>
                  <option value="received">Received</option>
                  <option value="processed">Processed</option>
                  <option value="failed">Failed</option>
                </select>
              </div>

              {loading ? <p>Loading...</p> : (
                <div className="table-scroll-wrapper">
                  <table className="admin-table" style={{ fontSize: '0.8125rem' }}>
                    <thead>
                      <tr><th>Date</th><th>Type</th><th>Dir</th><th>Vendor</th><th>PO</th><th>Filename</th><th>Status</th><th></th></tr>
                    </thead>
                    <tbody>
                      {transactions.map(t => (
                        <tr key={t.id}>
                          <td style={{ whiteSpace: 'nowrap' }}>{new Date(t.created_at).toLocaleString()}</td>
                          <td><strong>{t.document_type}</strong></td>
                          <td>{t.direction === 'outbound' ? '\u2191' : '\u2193'} {t.direction}</td>
                          <td>{t.vendor_name}</td>
                          <td>{t.po_number || 'â€”'}</td>
                          <td style={{ fontSize: '0.6875rem', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis' }}>{t.filename || 'â€”'}</td>
                          <td><span style={{ background: statusColor(t.status), color: statusTextColor(t.status), padding: '0.15rem 0.5rem', fontSize: '0.6875rem' }}>{t.status}</span></td>
                          <td><button className="btn btn-secondary" style={{ fontSize: '0.6875rem', padding: '0.15rem 0.4rem' }} onClick={() => viewTxnDetail(t.id)}>View</button></td>
                        </tr>
                      ))}
                      {!transactions.length && <tr><td colSpan="8" style={{ textAlign: 'center', color: 'var(--stone-400)' }}>No EDI transactions found</td></tr>}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {tab === 'invoices' && (
            <div>
              {loading ? <p>Loading...</p> : (
                <div className="table-scroll-wrapper">
                  <table className="admin-table" style={{ fontSize: '0.8125rem' }}>
                    <thead>
                      <tr><th>Date</th><th>Invoice #</th><th>Vendor</th><th>PO</th><th>Total</th><th>Status</th><th></th></tr>
                    </thead>
                    <tbody>
                      {invoices.map(inv => (
                        <tr key={inv.id}>
                          <td>{inv.invoice_date ? new Date(inv.invoice_date).toLocaleDateString() : 'â€”'}</td>
                          <td><strong>{inv.invoice_number}</strong></td>
                          <td>{inv.vendor_name}</td>
                          <td>{inv.po_number || 'â€”'}</td>
                          <td>${parseFloat(inv.total_amount || 0).toFixed(2)}</td>
                          <td>
                            <select value={inv.status} onChange={e => updateInvoiceStatus(inv.id, e.target.value)}
                              style={{ fontSize: '0.75rem', padding: '0.2rem 0.3rem', border: '1px solid var(--stone-300)' }}>
                              <option value="pending">Pending</option>
                              <option value="matched">Matched</option>
                              <option value="approved">Approved</option>
                              <option value="paid">Paid</option>
                              <option value="disputed">Disputed</option>
                            </select>
                          </td>
                          <td><button className="btn btn-secondary" style={{ fontSize: '0.6875rem', padding: '0.15rem 0.4rem' }} onClick={() => viewInvoiceDetail(inv.id)}>Detail</button></td>
                        </tr>
                      ))}
                      {!invoices.length && <tr><td colSpan="7" style={{ textAlign: 'center', color: 'var(--stone-400)' }}>No EDI invoices found</td></tr>}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<AdminApp />, document.getElementById('root'));
  </script>
</body>
</html>
