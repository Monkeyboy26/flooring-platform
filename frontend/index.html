<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roma Flooring Designs | Premium Flooring &amp; Tile in Anaheim, CA</title>
  <meta name="description" content="Roma Flooring Designs offers premium flooring, tile, stone, and countertop products in Anaheim, CA. Shop our curated collections of hardwood, porcelain, marble, and more.">
  <link rel="canonical" href="https://romaflooringdesigns.com/">
  <meta property="og:title" content="Roma Flooring Designs | Premium Flooring &amp; Tile in Anaheim, CA">
  <meta property="og:description" content="Roma Flooring Designs offers premium flooring, tile, stone, and countertop products in Anaheim, CA. Shop our curated collections of hardwood, porcelain, marble, and more.">
  <meta property="og:image" content="https://romaflooringdesigns.com/uploads/og-default.jpg">
  <meta property="og:url" content="https://romaflooringdesigns.com/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Roma Flooring Designs">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Roma Flooring Designs | Premium Flooring &amp; Tile in Anaheim, CA">
  <meta name="twitter:description" content="Roma Flooring Designs offers premium flooring, tile, stone, and countertop products in Anaheim, CA. Shop our curated collections of hardwood, porcelain, marble, and more.">
  <meta name="twitter:image" content="https://romaflooringdesigns.com/uploads/og-default.jpg">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "LocalBusiness",
        "name": "Roma Flooring Designs",
        "url": "https://romaflooringdesigns.com",
        "logo": "https://romaflooringdesigns.com/uploads/logo.png",
        "image": "https://romaflooringdesigns.com/uploads/og-default.jpg",
        "telephone": "(714) 999-0009",
        "email": "Sales@romaflooringdesigns.com",
        "address": {
          "@type": "PostalAddress",
          "streetAddress": "1440 South State College Blvd #6m",
          "addressLocality": "Anaheim",
          "addressRegion": "CA",
          "postalCode": "92806",
          "addressCountry": "US"
        },
        "description": "Premium flooring, tile, stone, and countertop products in Anaheim, CA.",
        "priceRange": "$$"
      },
      {
        "@type": "WebSite",
        "name": "Roma Flooring Designs",
        "url": "https://romaflooringdesigns.com",
        "potentialAction": {
          "@type": "SearchAction",
          "target": "https://romaflooringdesigns.com/shop?q={search_term_string}",
          "query-input": "required name=search_term_string"
        }
      }
    ]
  }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --stone-50: #fafaf9;
      --stone-100: #f5f5f4;
      --stone-200: #e7e5e4;
      --stone-300: #d6d3d1;
      --stone-400: #a8a29e;
      --stone-500: #78716c;
      --stone-600: #57534e;
      --stone-800: #292524;
      --stone-900: #1c1917;
      --gold: #c9a668;
      --gold-light: #dbb87a;
      --sage: #87996b;
      --terracotta: #c87e5a;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--stone-50);
      color: var(--stone-800);
    }

    /* Header */
    header {
      padding: 2rem 3rem;
      border-bottom: 1px solid var(--stone-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.75rem;
      color: var(--stone-900);
      cursor: pointer;
    }
    nav { display: flex; gap: 2rem; }
    nav a {
      text-decoration: none;
      color: var(--stone-600);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
    }

    /* Header Search */
    .header-search {
      position: relative;
      display: flex;
      align-items: center;
    }
    .header-search input {
      width: 200px;
      padding: 0.5rem 0.75rem 0.5rem 2rem;
      border: 1px solid var(--stone-200);
      background: var(--stone-50);
      font-family: 'Inter', sans-serif;
      font-size: 0.8125rem;
      color: var(--stone-800);
      outline: none;
      transition: border-color 0.2s, width 0.3s;
    }
    .header-search input::placeholder {
      color: var(--stone-600);
      font-size: 0.8125rem;
    }
    .header-search input:focus {
      border-color: var(--gold);
      width: 260px;
    }
    .header-search-icon {
      position: absolute;
      left: 0.6rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--stone-600);
    }
    .header-search-icon svg {
      width: 14px;
      height: 14px;
      display: block;
    }

    /* Hero */
    .hero {
      height: 70vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: linear-gradient(135deg, #f5f5f4 0%, #e7e5e4 100%);
    }
    .hero h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 4rem;
      font-weight: 300;
      margin-bottom: 1rem;
    }
    .hero p {
      font-size: 1.125rem;
      color: var(--stone-600);
      margin-bottom: 2rem;
    }
    .btn {
      display: inline-block;
      padding: 1rem 3rem;
      background: var(--stone-900);
      color: white;
      text-decoration: none;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }
    .btn:hover { background: var(--gold); }
    .btn-secondary {
      background: white;
      color: var(--stone-900);
      border: 1px solid var(--stone-300);
    }
    .btn-secondary:hover {
      background: var(--stone-100);
    }

    /* Product Grid */
    .section {
      max-width: 1400px;
      margin: 6rem auto;
      padding: 0 3rem;
    }
    .section-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 3rem;
      text-align: center;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 2rem;
    }
    .product-card {
      cursor: pointer;
      transition: transform 0.3s;
    }
    .product-card:hover { transform: translateY(-8px); }
    .product-image {
      width: 100%;
      aspect-ratio: 1;
      background: #e7e5e4;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .product-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .product-meta {
      font-size: 0.875rem;
      color: var(--stone-600);
      margin-bottom: 0.5rem;
    }
    .product-price {
      font-size: 1.125rem;
      font-weight: 500;
    }

    /* Product Detail Page */
    .product-detail {
      max-width: 1400px;
      margin: 3rem auto;
      padding: 0 3rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4rem;
    }
    .product-detail-image {
      width: 100%;
      aspect-ratio: 1;
      background: #e7e5e4;
      overflow: hidden;
    }
    .product-detail-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .product-gallery-thumbs {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .product-gallery-thumb {
      width: 80px;
      height: 80px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }
    .product-gallery-thumb.active {
      border-color: var(--gold);
    }
    .product-gallery-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .product-detail-info h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3rem;
      font-weight: 300;
      margin-bottom: 1rem;
    }
    .product-detail-meta {
      font-size: 1rem;
      color: var(--stone-600);
      margin-bottom: 2rem;
    }
    .product-detail-price {
      font-size: 2rem;
      font-weight: 500;
      margin-bottom: 3rem;
    }
    .product-detail-price span {
      font-size: 1.25rem;
      color: var(--stone-600);
      font-weight: 400;
    }

    /* Calculator Widget - Elysium Style */
    .calculator-widget {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .calculator-widget h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.75rem;
      font-weight: 400;
      margin-bottom: 1.5rem;
    }
    .calc-input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .calc-input-group {
      margin-bottom: 1.5rem;
    }
    .calc-input-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--stone-800);
      margin-bottom: 0.5rem;
    }
    .calc-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--stone-200);
      font-size: 1.125rem;
      background: white;
      font-weight: 500;
      text-align: center;
    }
    .calc-input:focus {
      outline: none;
      border-color: var(--gold);
    }
    .calc-summary {
      background: var(--stone-50);
      padding: 1.5rem;
      margin-top: 1.5rem;
      border-left: 3px solid var(--gold);
    }
    .calc-summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      font-size: 0.95rem;
    }
    .calc-summary-total {
      display: flex;
      justify-content: space-between;
      padding: 1rem 0;
      margin-top: 0.5rem;
      padding-top: 1rem;
      border-top: 2px solid var(--stone-300);
      font-weight: 600;
      font-size: 1.25rem;
    }
    .packaging-info {
      background: var(--stone-50);
      padding: 1.5rem;
      margin-bottom: 2rem;
      font-size: 0.875rem;
      line-height: 1.8;
    }
    .packaging-info h4 {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .note {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
      padding: 1rem;
      margin: 1.5rem 0;
      font-size: 0.875rem;
      line-height: 1.6;
    }

    /* Back Button */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--stone-600);
      text-decoration: none;
      font-size: 0.875rem;
      margin-bottom: 2rem;
      cursor: pointer;
    }
    .back-btn:hover { color: var(--stone-900); }

    /* Shop Page */
    .shop-page {
      max-width: 1400px;
      margin: 3rem auto;
      padding: 0 3rem;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 3rem;
    }
    .shop-page-header {
      grid-column: 1 / -1;
    }
    .shop-page-header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      font-weight: 300;
    }

    /* Category Sidebar */
    .category-sidebar {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 2rem;
      position: sticky;
      top: 120px;
      align-self: start;
    }
    .category-sidebar h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 1.5rem;
    }
    .category-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--stone-600);
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .category-item:hover {
      background: var(--stone-50);
    }
    .category-item.active {
      border-left-color: var(--gold);
      color: var(--stone-900);
      font-weight: 500;
      background: var(--stone-50);
    }
    .category-count {
      background: var(--stone-100);
      color: var(--stone-600);
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      min-width: 1.5rem;
      text-align: center;
    }
    .category-item.active .category-count {
      background: var(--gold);
      color: white;
    }
    .category-parent-row {
      display: flex;
      align-items: center;
      width: 100%;
      justify-content: space-between;
    }
    .category-parent-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .category-expand {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--stone-600);
      font-size: 0.75rem;
      padding: 0;
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .category-children {
      margin-left: 1rem;
    }
    .shop-empty {
      text-align: center;
      padding: 4rem 0;
      color: var(--stone-600);
      font-size: 1rem;
    }

    /* Filter Panel */
    .filter-panel {
      padding-top: 1.5rem;
      margin-top: 1.5rem;
      border-top: 1px solid var(--stone-200);
    }
    .filter-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .filter-panel-header h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin: 0;
    }
    .filter-clear {
      background: none;
      border: none;
      color: var(--stone-600);
      font-size: 0.75rem;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }
    .filter-clear:hover { color: var(--stone-900); }
    .filter-group {
      margin-bottom: 1.25rem;
    }
    .filter-group-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--stone-600);
      margin-bottom: 0.5rem;
    }
    .filter-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.3rem 0;
    }
    .filter-option input[type="checkbox"] {
      width: 0.875rem;
      height: 0.875rem;
      cursor: pointer;
      accent-color: var(--gold);
      flex-shrink: 0;
    }
    .filter-option label {
      cursor: pointer;
      flex-grow: 1;
      font-size: 0.8125rem;
      color: var(--stone-800);
    }
    .filter-option .filter-count {
      font-size: 0.7rem;
      color: var(--stone-600);
      flex-shrink: 0;
    }

    /* Active Filter Pills */
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: var(--stone-100);
      border: 1px solid var(--stone-200);
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
      color: var(--stone-800);
      cursor: default;
    }
    .filter-pill button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--stone-600);
      font-size: 0.875rem;
      padding: 0;
      line-height: 1;
    }
    .filter-pill button:hover { color: var(--stone-900); }

    footer {
      background: var(--stone-900);
      color: white;
      padding: 3rem;
      text-align: center;
      margin-top: 6rem;
    }

    /* Cart Icon & Badge */
    .cart-icon-wrap {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--stone-600);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .cart-icon-wrap:hover { color: var(--stone-900); }
    .cart-icon-wrap svg { width: 20px; height: 20px; }
    .cart-badge {
      position: absolute;
      top: -6px;
      right: -10px;
      background: var(--gold);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Cart Dropdown */
    .cart-dropdown-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 199;
    }
    .cart-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      width: 380px;
      background: white;
      border: 1px solid var(--stone-200);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      z-index: 200;
      max-height: 420px;
      display: flex;
      flex-direction: column;
    }
    .cart-dropdown-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--stone-200);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
    }
    .cart-dropdown-items {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    .cart-dropdown-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--stone-100);
    }
    .cart-dropdown-item-info { flex: 1; }
    .cart-dropdown-item-name {
      font-weight: 500;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    .cart-dropdown-item-meta {
      font-size: 0.75rem;
      color: var(--stone-600);
    }
    .cart-dropdown-item-price {
      font-weight: 500;
      font-size: 0.875rem;
      white-space: nowrap;
      margin-left: 1rem;
    }
    .cart-dropdown-item-remove {
      background: none;
      border: none;
      color: var(--stone-600);
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0;
      margin-left: 0.75rem;
      text-decoration: underline;
    }
    .cart-dropdown-item-remove:hover { color: var(--stone-900); }
    .cart-dropdown-footer {
      padding: 1.25rem 1.5rem;
      border-top: 1px solid var(--stone-200);
    }
    .cart-dropdown-total {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .cart-dropdown-empty {
      padding: 3rem 1.5rem;
      text-align: center;
      color: var(--stone-600);
      font-size: 0.875rem;
    }

    /* Cart Page */
    .cart-page {
      max-width: 1400px;
      margin: 3rem auto;
      padding: 0 3rem;
    }
    .cart-page h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 2rem;
    }
    .cart-page-layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 3rem;
      align-items: start;
    }
    .cart-table { width: 100%; }
    .cart-table-header {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 2px solid var(--stone-200);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-600);
    }
    .cart-table-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 1rem;
      padding: 1.5rem 0;
      border-bottom: 1px solid var(--stone-100);
      align-items: center;
    }
    .cart-table-product-name {
      font-weight: 500;
    }
    .cart-table-product-meta {
      font-size: 0.8rem;
      color: var(--stone-600);
      margin-top: 0.25rem;
    }
    .cart-qty-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .cart-qty-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--stone-200);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }
    .cart-qty-btn:hover { background: var(--stone-100); }
    .cart-qty-value {
      width: 40px;
      text-align: center;
      font-weight: 500;
    }
    .cart-remove-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--stone-600);
      padding: 0.25rem;
    }
    .cart-remove-btn:hover { color: var(--stone-900); }

    /* Order Summary Sidebar */
    .order-summary {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 2rem;
      position: sticky;
      top: 120px;
    }
    .order-summary h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 1.5rem;
    }
    .order-summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      font-size: 0.95rem;
    }
    .order-summary-row.muted { color: var(--stone-600); font-size: 0.875rem; }
    .order-summary-total {
      display: flex;
      justify-content: space-between;
      padding: 1rem 0;
      margin-top: 0.5rem;
      border-top: 2px solid var(--stone-300);
      font-weight: 600;
      font-size: 1.25rem;
    }

    /* Sample Tags & Styling */
    .sample-tag {
      display: inline-block;
      background: var(--gold);
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.15rem 0.5rem;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    .sample-item {
      background: var(--stone-50);
    }

    /* Cart flash animation */
    .cart-flash { animation: cartPulse 0.6s ease; }
    @keyframes cartPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    @media (max-width: 968px) {
      .shop-page {
        grid-template-columns: 1fr;
      }
      .category-sidebar {
        position: static;
      }
    }

    @media (max-width: 768px) {
      .product-detail {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      .calc-input-row {
        grid-template-columns: 1fr;
      }
      .hero h1 { font-size: 2.5rem; }
      .cart-dropdown { width: 100%; left: 0; right: 0; margin-top: 0; }
      .cart-page-layout {
        grid-template-columns: 1fr;
      }
      .cart-table-header { display: none; }
      .cart-table-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      .checkout-page {
        grid-template-columns: 1fr !important;
      }
    }

    /* Checkout Page */
    .checkout-page {
      max-width: 1400px;
      margin: 3rem auto;
      padding: 0 3rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 3rem;
      align-items: start;
    }
    .checkout-page h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 2rem;
      grid-column: 1 / -1;
    }
    .checkout-form {}
    .checkout-section {
      margin-bottom: 2.5rem;
    }
    .checkout-section h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--stone-200);
    }
    .checkout-field {
      margin-bottom: 1rem;
    }
    .checkout-field label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--stone-800);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .checkout-input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--stone-200);
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      background: white;
      color: var(--stone-800);
      transition: border-color 0.2s;
    }
    .checkout-input:focus {
      outline: none;
      border-color: var(--gold);
    }
    .checkout-input::placeholder {
      color: var(--stone-600);
      font-size: 0.875rem;
    }
    .checkout-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .checkout-row-3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 1rem;
    }
    .stripe-element {
      padding: 0.875rem 1rem;
      border: 2px solid var(--stone-200);
      background: white;
      transition: border-color 0.2s;
    }
    .stripe-element.StripeElement--focus {
      border-color: var(--gold);
    }
    .checkout-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-left: 3px solid #ef4444;
      color: #991b1b;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.875rem;
    }
    .checkout-btn {
      width: 100%;
      padding: 1.25rem;
      background: var(--stone-900);
      color: white;
      border: none;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .checkout-btn:hover:not(:disabled) { background: var(--gold); }
    .checkout-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .checkout-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Confirmation Page */
    .confirmation-page {
      max-width: 800px;
      margin: 4rem auto;
      padding: 0 3rem;
      text-align: center;
    }
    .confirmation-check {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #d1fae5;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
    }
    .confirmation-check svg {
      width: 40px;
      height: 40px;
      color: #059669;
    }
    .confirmation-page h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3rem;
      font-weight: 300;
      margin-bottom: 1rem;
    }
    .confirmation-order-number {
      font-size: 1.125rem;
      color: var(--stone-600);
      margin-bottom: 3rem;
    }
    .confirmation-order-number strong {
      color: var(--stone-900);
      font-weight: 600;
    }
    .confirmation-details {
      background: white;
      border: 1px solid var(--stone-200);
      padding: 2rem;
      text-align: left;
      margin-bottom: 2rem;
    }
    .confirmation-details h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--stone-200);
    }
    .confirmation-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--stone-100);
      font-size: 0.95rem;
    }
    .confirmation-item:last-child { border-bottom: none; }
    .confirmation-address {
      font-size: 0.95rem;
      line-height: 1.8;
      color: var(--stone-800);
    }

    /* Variant Type Tabs & SKU Selector */
    .variant-type-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .variant-type-tab {
      padding: 0.5rem 1.25rem;
      border: 1px solid var(--stone-200);
      background: white;
      font-family: 'Inter', sans-serif;
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--stone-600);
    }
    .variant-type-tab:hover {
      border-color: var(--stone-600);
      color: var(--stone-800);
    }
    .variant-type-tab.active {
      border-color: var(--gold);
      color: var(--gold);
      background: white;
    }
    .sku-selector {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--stone-200);
      background: white;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      color: var(--stone-800);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2357534e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      margin-bottom: 1.5rem;
    }
    .sku-selector:focus {
      outline: none;
      border-color: var(--gold);
    }

    /* Stock Badges */
    .stock-badge {
      display: inline-block;
      font-family: 'Inter', sans-serif;
      font-size: 0.6875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 0.25rem 0.625rem;
      border-radius: 2px;
    }
    .stock-badge--in-stock {
      background: #ecfdf5;
      color: #065f46;
    }
    .stock-badge--low-stock {
      background: #fffbeb;
      color: #92400e;
    }
    .stock-badge--out-of-stock {
      background: #fef2f2;
      color: #991b1b;
    }
    .stock-badge--unknown {
      background: var(--stone-100);
      color: var(--stone-600);
    }
    .product-card {
      position: relative;
    }
    .product-card .stock-badge {
      position: absolute;
      top: 0.75rem;
      left: 0.75rem;
      z-index: 2;
    }
    .stock-status-detail {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .stock-status-detail .stock-qty {
      font-size: 0.8125rem;
      color: var(--stone-600);
    }
    .stock-status-detail .stock-qty--low {
      color: #92400e;
      font-weight: 500;
    }
    .stock-status-detail .stock-qty--transit {
      font-style: italic;
      color: var(--stone-600);
    }

    /* Trade pricing */
    .price-strike {
      text-decoration: line-through;
      color: var(--stone-400);
      font-size: 0.9em;
    }
    .trade-price {
      color: #b8860b;
      font-weight: 600;
    }
    .trade-tier-badge {
      display: inline-block;
      background: linear-gradient(135deg, #b8860b, #daa520);
      color: white;
      font-size: 0.65rem;
      padding: 0.15rem 0.5rem;
      border-radius: 2px;
      margin-left: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 600;
      vertical-align: middle;
    }
    .trade-header-info {
      display: inline-flex;
      align-items: center;
      font-size: 0.8125rem;
      color: var(--stone-700);
    }
    .trade-header-label {
      color: #b8860b;
      font-weight: 500;
    }

    /* Trade modal */
    .trade-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .trade-modal {
      background: white;
      padding: 2.5rem;
      max-width: 420px;
      width: 90%;
      position: relative;
    }
    .trade-modal-close {
      position: absolute;
      top: 1rem; right: 1rem;
      background: none; border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--stone-400);
      line-height: 1;
    }
    .trade-modal-close:hover { color: var(--stone-800); }
    .trade-field {
      margin-bottom: 1rem;
    }
    .trade-field label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-500);
      margin-bottom: 0.35rem;
    }
    .trade-field input {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--stone-300);
      font-size: 0.875rem;
      font-family: var(--font-sans);
    }
    .trade-field input:focus {
      outline: none;
      border-color: var(--stone-800);
    }
    .trade-toggle {
      margin-top: 1.25rem;
      text-align: center;
      font-size: 0.8125rem;
      color: var(--stone-500);
    }
    .trade-toggle a {
      color: var(--stone-800);
      text-decoration: underline;
      cursor: pointer;
    }
    .trade-msg {
      padding: 0.65rem 0.85rem;
      margin-bottom: 1rem;
      font-size: 0.8125rem;
      line-height: 1.4;
    }
    .trade-msg-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    .trade-msg-success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
    }

    /* Installation Inquiry */
    .install-inquiry-field {
      margin-bottom: 1rem;
    }
    .install-inquiry-field label {
      display: block;
      font-size: 0.8125rem;
      color: var(--stone-600);
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .install-inquiry-field input,
    .install-inquiry-field textarea {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--stone-300);
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
      background: #fff;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    .install-inquiry-field input:focus,
    .install-inquiry-field textarea:focus {
      outline: none;
      border-color: var(--stone-500);
    }
    .install-inquiry-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .install-inquiry-product-context {
      background: var(--stone-100);
      border-left: 3px solid #b8860b;
      padding: 0.75rem 1rem;
      margin-bottom: 1.25rem;
      font-size: 0.8125rem;
      color: var(--stone-700);
    }
    .install-inquiry-product-context strong {
      color: var(--stone-900);
    }
    .btn-install-cta {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: 1.5px solid #b8860b;
      background: transparent;
      color: #b8860b;
      font-size: 0.8125rem;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.25s;
      width: 100%;
      margin-top: 0.75rem;
    }
    .btn-install-cta:hover {
      background: #b8860b;
      color: #fff;
    }

    /* Trade Landing Page */
    .trade-page-hero {
      background: linear-gradient(135deg, var(--stone-900) 0%, #2c2521 50%, var(--stone-800) 100%);
      color: white;
      padding: 6rem 3rem;
      text-align: center;
    }
    .trade-page-hero h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3.5rem;
      font-weight: 300;
      margin-bottom: 1.5rem;
      letter-spacing: 0.02em;
    }
    .trade-page-hero p {
      font-size: 1.125rem;
      color: var(--stone-200);
      max-width: 600px;
      margin: 0 auto 2.5rem;
      line-height: 1.7;
    }
    .trade-hero-btn {
      display: inline-block;
      padding: 1rem 2.5rem;
      background: var(--gold);
      color: white;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: none;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    .trade-hero-btn:hover {
      background: #b8964f;
      transform: translateY(-1px);
    }

    .trade-benefits {
      padding: 5rem 3rem;
      text-align: center;
      background: white;
    }
    .trade-benefits h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.25rem;
      font-weight: 300;
      margin-bottom: 0.75rem;
      color: var(--stone-900);
    }
    .trade-benefits > p {
      color: var(--stone-600);
      font-size: 1rem;
      margin-bottom: 3rem;
    }
    .trade-benefits-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .trade-benefit-card {
      padding: 2.5rem 1.5rem;
      border: 1px solid var(--stone-200);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .trade-benefit-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    .trade-benefit-card svg {
      width: 40px;
      height: 40px;
      stroke: var(--gold);
      fill: none;
      stroke-width: 1.5;
      margin-bottom: 1.25rem;
    }
    .trade-benefit-card h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 0.75rem;
      color: var(--stone-900);
    }
    .trade-benefit-card p {
      font-size: 0.875rem;
      color: var(--stone-600);
      line-height: 1.6;
    }

    .trade-how-it-works {
      padding: 5rem 3rem;
      text-align: center;
      background: var(--stone-100);
    }
    .trade-how-it-works h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.25rem;
      font-weight: 300;
      margin-bottom: 3rem;
      color: var(--stone-900);
    }
    .trade-steps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .trade-step {
      padding: 2rem 1.5rem;
    }
    .trade-step-number {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--gold);
      color: white;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
    }
    .trade-step h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 0.75rem;
      color: var(--stone-900);
    }
    .trade-step p {
      font-size: 0.875rem;
      color: var(--stone-600);
      line-height: 1.6;
    }

    .trade-tiers {
      padding: 5rem 3rem;
      text-align: center;
      background: white;
    }
    .trade-tiers h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.25rem;
      font-weight: 300;
      margin-bottom: 0.75rem;
      color: var(--stone-900);
    }
    .trade-tiers > p {
      color: var(--stone-600);
      font-size: 1rem;
      margin-bottom: 3rem;
    }
    .trade-tiers-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
      max-width: 960px;
      margin: 0 auto;
    }
    .trade-tier-card {
      border: 1px solid var(--stone-200);
      padding: 2.5rem 2rem;
      position: relative;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .trade-tier-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    .trade-tier-card.featured {
      border: 2px solid var(--gold);
    }
    .trade-tier-card .tier-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gold);
      color: white;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 1rem;
    }
    .trade-tier-card h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 0.5rem;
      color: var(--stone-900);
    }
    .trade-tier-card .tier-discount {
      font-size: 2rem;
      font-weight: 300;
      color: var(--gold);
      margin-bottom: 1.5rem;
    }
    .trade-tier-card ul {
      list-style: none;
      text-align: left;
      margin-bottom: 1.5rem;
    }
    .trade-tier-card ul li {
      font-size: 0.875rem;
      color: var(--stone-600);
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--stone-100);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .trade-tier-card ul li svg {
      width: 16px;
      height: 16px;
      stroke: var(--gold);
      fill: none;
      stroke-width: 2;
      flex-shrink: 0;
    }

    .trade-cta-section {
      background: linear-gradient(135deg, var(--stone-900) 0%, #2c2521 100%);
      color: white;
      padding: 5rem 3rem;
      text-align: center;
    }
    .trade-cta-section h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.25rem;
      font-weight: 300;
      margin-bottom: 1rem;
    }
    .trade-cta-section p {
      color: var(--stone-200);
      font-size: 1rem;
      margin-bottom: 2.5rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .trade-cta-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .trade-cta-btn-primary {
      padding: 1rem 2.5rem;
      background: var(--gold);
      color: white;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: none;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    .trade-cta-btn-primary:hover {
      background: #b8964f;
      transform: translateY(-1px);
    }
    .trade-cta-btn-secondary {
      padding: 1rem 2.5rem;
      background: transparent;
      color: white;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: 1px solid rgba(255,255,255,0.3);
      cursor: pointer;
      transition: border-color 0.3s, transform 0.2s;
    }
    .trade-cta-btn-secondary:hover {
      border-color: white;
      transform: translateY(-1px);
    }

    @media (max-width: 968px) {
      .trade-benefits-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      .trade-page-hero {
        padding: 4rem 1.5rem;
      }
      .trade-page-hero h1 {
        font-size: 2.5rem;
      }
      .trade-benefits {
        padding: 3rem 1.5rem;
      }
      .trade-benefits-grid {
        grid-template-columns: 1fr;
      }
      .trade-how-it-works {
        padding: 3rem 1.5rem;
      }
      .trade-steps {
        grid-template-columns: 1fr;
      }
      .trade-tiers {
        padding: 3rem 1.5rem;
      }
      .trade-tiers-grid {
        grid-template-columns: 1fr;
      }
      .trade-cta-section {
        padding: 3rem 1.5rem;
      }
    }

    /* Multi-step registration */
    .trade-steps-indicator {
      display: flex;
      gap: 0;
      margin-bottom: 2rem;
    }
    .trade-step-dot {
      flex: 1;
      text-align: center;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-400);
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--stone-200);
      cursor: default;
    }
    .trade-step-dot.active {
      color: var(--stone-900);
      border-bottom-color: var(--gold);
      font-weight: 500;
    }
    .trade-step-dot.done {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    .trade-field select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--stone-300);
      font-size: 0.875rem;
      font-family: var(--font-sans);
      background: white;
    }
    .trade-field select:focus { outline: none; border-color: var(--stone-800); }
    .trade-doc-upload {
      border: 2px dashed var(--stone-300);
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s;
      margin-bottom: 0.75rem;
      font-size: 0.8125rem;
      color: var(--stone-500);
    }
    .trade-doc-upload:hover { border-color: var(--gold); }
    .trade-doc-upload.uploaded {
      border-color: #16a34a;
      background: #f0fdf4;
      color: #166534;
    }
    .trade-btn-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .trade-btn-row .btn { flex: 1; }
    .trade-btn-secondary {
      flex: 1;
      padding: 0.65rem 1rem;
      background: white;
      color: var(--stone-800);
      border: 1px solid var(--stone-300);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 0.8125rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: background 0.2s, border-color 0.2s;
    }
    .trade-btn-secondary:hover { border-color: var(--stone-800); background: var(--stone-50); }

    /* Trade Dashboard */
    .trade-dashboard {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    .trade-dash-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .trade-dash-header h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 300;
    }
    .trade-tier-badge {
      display: inline-block;
      background: linear-gradient(135deg, #c9a668, #dbb87a);
      color: white;
      border-radius: 20px;
      padding: 0.25rem 0.85rem;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .trade-dash-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--stone-200);
      margin-bottom: 2rem;
    }
    .trade-dash-tab {
      padding: 1rem 1.75rem;
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--stone-400);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 0.2s, border-color 0.3s;
    }
    .trade-dash-tab svg {
      width: 16px;
      height: 16px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    .trade-dash-tab:hover { color: var(--stone-800); }
    .trade-dash-tab:hover svg { opacity: 0.8; }
    .trade-dash-tab.active {
      color: var(--stone-900);
      border-bottom-color: var(--gold);
      font-weight: 500;
    }
    .trade-dash-tab.active svg { opacity: 1; }
    .trade-stat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .trade-stat-card {
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .trade-stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .trade-stat-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .trade-stat-card:hover::before {
      transform: scaleX(1);
    }
    .trade-stat-card .stat-icon {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      opacity: 0.12;
      color: var(--stone-600);
    }
    .trade-stat-card label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--stone-500);
      display: block;
      margin-bottom: 0.5rem;
    }
    .trade-stat-card .value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 400;
      color: var(--stone-900);
      line-height: 1.1;
    }
    .trade-tier-progress {
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .trade-tier-bar {
      height: 12px;
      background: var(--stone-100);
      border-radius: 6px;
      margin: 1rem 0 0.5rem;
      position: relative;
      overflow: hidden;
    }
    .trade-tier-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--gold-light));
      border-radius: 6px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .trade-orders-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .trade-orders-table th {
      text-align: left;
      padding: 1rem 1.25rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--stone-500);
      border-bottom: 1px solid var(--stone-200);
      background: var(--stone-50);
    }
    .trade-orders-table td {
      padding: 1rem 1.25rem;
      font-size: 0.875rem;
      border-bottom: 1px solid var(--stone-100);
    }
    .trade-orders-table tr:last-child td { border-bottom: none; }
    .trade-orders-table tbody tr { transition: background-color 0.15s; }
    .trade-orders-table tbody tr:hover { background-color: var(--stone-50); }
    .trade-status-badge {
      display: inline-block;
      padding: 0.2rem 0.65rem;
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: 20px;
      text-transform: capitalize;
    }
    .trade-status-badge.pending { background: #fef3c7; color: #92400e; }
    .trade-status-badge.confirmed { background: #dbeafe; color: #1e40af; }
    .trade-status-badge.shipped { background: #d1fae5; color: #065f46; }
    .trade-status-badge.delivered { background: #dcfce7; color: #16a34a; }
    .trade-status-badge.cancelled { background: #fee2e2; color: #991b1b; }
    .trade-status-badge.converted { background: #dcfce7; color: #16a34a; }
    .trade-status-badge.sent { background: #dbeafe; color: #2563eb; }
    .trade-status-badge.draft { background: var(--stone-100); color: var(--stone-500); }
    .trade-status-badge.active { background: #d1fae5; color: #065f46; }
    .trade-card {
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .trade-card h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 1rem;
    }
    .trade-project-card {
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      padding: 1.5rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .trade-project-card::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .trade-project-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .trade-project-card:hover::after {
      transform: scaleX(1);
    }
    .trade-project-card h4 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.125rem;
      font-weight: 400;
      margin-bottom: 0.5rem;
    }
    .trade-fav-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    .trade-fav-item {
      background: white;
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      padding: 1rem;
      text-align: center;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .trade-fav-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .trade-fav-item img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }
    .trade-fav-item .name {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .trade-rep-card {
      background: white;
      border: none;
      border-left: 3px solid var(--gold);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      padding: 2rem;
      display: flex;
      gap: 2rem;
      align-items: center;
    }
    .trade-rep-avatar {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: white;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(201, 166, 104, 0.3);
    }
    .trade-empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    }
    .trade-empty-state svg {
      width: 48px;
      height: 48px;
      color: var(--stone-300);
      margin-bottom: 1rem;
    }
    .trade-empty-state p {
      color: var(--stone-400);
      font-size: 0.9375rem;
      margin-bottom: 1.25rem;
    }
    .bulk-order-table { width: 100%; border-collapse: collapse; }
    .bulk-order-table th, .bulk-order-table td { padding: 0.5rem; text-align: left; font-size: 0.875rem; }
    .bulk-order-table input { width: 100%; padding: 0.4rem 0.5rem; border: 1px solid var(--stone-300); font-size: 0.875rem; }
    .bulk-order-table .remove-btn { background: none; border: none; color: var(--stone-400); cursor: pointer; font-size: 1.25rem; }
    .bulk-order-table .remove-btn:hover { color: #dc2626; }
    @media (max-width: 768px) {
      .trade-stat-grid { grid-template-columns: repeat(2, 1fr); }
      .trade-dash-tabs { overflow-x: auto; }
      .trade-dash-tab { padding: 0.75rem 1rem; font-size: 0.75rem; }
      .trade-rep-card { flex-direction: column; text-align: center; }
      .trade-dash-header { flex-direction: column; gap: 0.75rem; align-items: flex-start; }
    }
    @media (max-width: 480px) {
      .trade-stat-grid { grid-template-columns: 1fr; }
      .trade-dash-tab { padding: 0.6rem 0.75rem; font-size: 0.7rem; }
      .trade-dash-tab svg { width: 14px; height: 14px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

        const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3001'
      : `${window.location.protocol}//${window.location.hostname}:3001`;

    function getSessionId() {
      let id = localStorage.getItem('cart_session_id');
      if (!id) {
        id = 'sess_' + Math.random().toString(36).substr(2, 12) + Date.now().toString(36);
        localStorage.setItem('cart_session_id', id);
      }
      return id;
    }

    // Determine price label suffix from product category
    function priceLabel(product) {
      const slug = (product && product.category_slug) || '';
      if (slug.includes('countertop') || slug.includes('slab') || slug.includes('vanity') || slug.includes('sink') || slug.includes('faucet')) {
        return '';
      }
      return '/sqft';
    }

    // === SEO Utility Functions ===
    const SITE_NAME = 'Roma Flooring Designs';
    const SITE_URL = 'https://romaflooringdesigns.com';
    const DEFAULT_DESCRIPTION = 'Roma Flooring Designs offers premium flooring, tile, stone, and countertop products in Anaheim, CA. Shop our curated collections of hardwood, porcelain, marble, and more.';
    const DEFAULT_IMAGE = SITE_URL + '/uploads/og-default.jpg';

    function generateSlug(text) {
      return (text || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function buildUrl(view, params) {
      params = params || {};
      switch (view) {
        case 'home': return '/';
        case 'shop': {
          const sp = new URLSearchParams();
          if (params.category) sp.set('category', params.category);
          if (params.collection) sp.set('collection', params.collection);
          if (params.search) sp.set('q', params.search);
          if (params.filters) {
            Object.keys(params.filters).forEach(k => {
              if (params.filters[k] && params.filters[k].length) sp.set(k, params.filters[k].join(','));
            });
          }
          const qs = sp.toString();
          return '/shop' + (qs ? '?' + qs : '');
        }
        case 'collections': return '/collections';
        case 'product': return '/product/' + (params.id || '') + '/' + generateSlug(params.name || '');
        case 'trade': return '/trade';
        case 'trade-dashboard': return '/trade/dashboard';
        case 'bulk-order': return '/trade/bulk-order';
        case 'account': return '/account';
        case 'cart': return '/cart';
        case 'checkout': return '/checkout';
        case 'confirmation': return '/order-confirmation';
        case 'reset-password': return '/reset-password';
        default: return '/';
      }
    }

    function parseUrl(pathname, search) {
      const path = pathname || '/';
      const sp = new URLSearchParams(search || '');
      // Password reset token
      if (sp.get('reset_token')) return { view: 'reset-password', params: {} };
      if (path === '/' || path === '') return { view: 'home', params: {} };
      if (path === '/shop') {
        const params = {};
        if (sp.get('category')) params.category = sp.get('category');
        if (sp.get('collection')) params.collection = sp.get('collection');
        if (sp.get('q')) params.search = sp.get('q');
        // Parse filter params (anything not category/collection/q)
        const filters = {};
        sp.forEach((val, key) => {
          if (!['category', 'collection', 'q'].includes(key)) {
            filters[key] = val.split(',');
          }
        });
        if (Object.keys(filters).length) params.filters = filters;
        return { view: 'shop', params };
      }
      if (path === '/collections') return { view: 'collections', params: {} };
      if (path.startsWith('/collections/')) {
        const slug = path.replace('/collections/', '');
        return { view: 'shop', params: { collection: slug } };
      }
      if (path.startsWith('/product/')) {
        const parts = path.replace('/product/', '').split('/');
        return { view: 'product', params: { id: parts[0] } };
      }
      if (path === '/trade') return { view: 'trade', params: {} };
      if (path === '/trade/dashboard') return { view: 'trade-dashboard', params: {} };
      if (path === '/trade/bulk-order') return { view: 'bulk-order', params: {} };
      if (path === '/account') return { view: 'account', params: {} };
      if (path === '/cart') return { view: 'cart', params: {} };
      if (path === '/checkout') return { view: 'checkout', params: {} };
      if (path === '/order-confirmation') return { view: 'confirmation', params: {} };
      if (path === '/reset-password') return { view: 'reset-password', params: {} };
      return { view: 'home', params: {} };
    }

    function updateMeta(view, params) {
      params = params || {};
      let title, description, canonical, image;
      switch (view) {
        case 'home':
          title = SITE_NAME + ' | Premium Flooring & Tile in Anaheim, CA';
          description = DEFAULT_DESCRIPTION;
          canonical = SITE_URL + '/';
          image = DEFAULT_IMAGE;
          break;
        case 'shop': {
          let suffix = '';
          if (params.search) suffix = '  Search: ' + params.search;
          else if (params.categoryName) suffix = '  ' + params.categoryName;
          else if (params.collectionName) suffix = '  ' + params.collectionName;
          title = 'Shop' + suffix + ' | ' + SITE_NAME;
          description = 'Browse our selection of premium flooring, tile, and stone products.' + (suffix ? ' ' + suffix.replace('  ', '') + '.' : '');
          canonical = SITE_URL + buildUrl('shop', params);
          image = DEFAULT_IMAGE;
          break;
        }
        case 'collections':
          title = 'Collections | ' + SITE_NAME;
          description = 'Explore our curated flooring and tile collections from top manufacturers.';
          canonical = SITE_URL + '/collections';
          image = DEFAULT_IMAGE;
          break;
        case 'product': {
          const p = params.product;
          if (p) {
            title = p.name + (p.collection ? '  ' + p.collection : '') + ' | ' + SITE_NAME;
            description = p.description_short || (p.name + ' by ' + (p.vendor_name || SITE_NAME) + '. Premium flooring available at Roma Flooring Designs.');
            canonical = SITE_URL + '/product/' + p.id + '/' + generateSlug(p.name);
            image = params.primaryImage || DEFAULT_IMAGE;
          } else {
            title = 'Product | ' + SITE_NAME;
            description = DEFAULT_DESCRIPTION;
            canonical = SITE_URL + '/';
            image = DEFAULT_IMAGE;
          }
          break;
        }
        case 'trade':
          title = 'Trade Program | ' + SITE_NAME;
          description = 'Join the Roma Flooring Designs trade program for exclusive pricing, dedicated support, and bulk ordering.';
          canonical = SITE_URL + '/trade';
          image = DEFAULT_IMAGE;
          break;
        case 'trade-dashboard':
          title = 'Trade Dashboard | ' + SITE_NAME;
          description = 'Manage your trade account, orders, and projects.';
          canonical = SITE_URL + '/trade/dashboard';
          image = DEFAULT_IMAGE;
          break;
        case 'cart':
          title = 'Cart | ' + SITE_NAME;
          description = 'Review items in your cart.';
          canonical = SITE_URL + '/cart';
          image = DEFAULT_IMAGE;
          break;
        default:
          title = SITE_NAME + ' | Premium Flooring & Tile in Anaheim, CA';
          description = DEFAULT_DESCRIPTION;
          canonical = SITE_URL + '/';
          image = DEFAULT_IMAGE;
      }
      document.title = title;
      const setMeta = (sel, attr, val) => { const el = document.querySelector(sel); if (el) el.setAttribute(attr, val); };
      setMeta('meta[name="description"]', 'content', description);
      setMeta('link[rel="canonical"]', 'href', canonical);
      setMeta('meta[property="og:title"]', 'content', title);
      setMeta('meta[property="og:description"]', 'content', description);
      setMeta('meta[property="og:url"]', 'content', canonical);
      setMeta('meta[property="og:image"]', 'content', image);
      setMeta('meta[name="twitter:title"]', 'content', title);
      setMeta('meta[name="twitter:description"]', 'content', description);
      setMeta('meta[name="twitter:image"]', 'content', image);
    }

    function updateStructuredData(view, params) {
      let el = document.getElementById('dynamic-jsonld');
      if (view === 'product' && params && params.product) {
        const p = params.product;
        const sku = params.selectedSku;
        const data = {
          '@context': 'https://schema.org',
          '@graph': [
            {
              '@type': 'Product',
              name: p.name,
              description: p.description_short || p.description_long || (p.name + ' by ' + (p.vendor_name || SITE_NAME)),
              image: params.primaryImage || DEFAULT_IMAGE,
              brand: { '@type': 'Brand', name: p.vendor_name || SITE_NAME },
              category: p.category_name || '',
              offers: {
                '@type': 'Offer',
                url: SITE_URL + '/product/' + p.id + '/' + generateSlug(p.name),
                priceCurrency: 'USD',
                price: sku ? parseFloat(sku.retail_price || 0).toFixed(2) : parseFloat(p.price || 0).toFixed(2),
                availability: sku && sku.stock_status === 'out_of_stock' ? 'https://schema.org/OutOfStock' : 'https://schema.org/InStock',
                seller: { '@type': 'Organization', name: SITE_NAME }
              }
            },
            {
              '@type': 'BreadcrumbList',
              itemListElement: [
                { '@type': 'ListItem', position: 1, name: 'Home', item: SITE_URL + '/' },
                { '@type': 'ListItem', position: 2, name: 'Shop', item: SITE_URL + '/shop' },
                p.category_name ? { '@type': 'ListItem', position: 3, name: p.category_name, item: SITE_URL + '/shop?category=' + encodeURIComponent(p.category_slug || '') } : null,
                { '@type': 'ListItem', position: p.category_name ? 4 : 3, name: p.name, item: SITE_URL + '/product/' + p.id + '/' + generateSlug(p.name) }
              ].filter(Boolean)
            }
          ]
        };
        if (!el) {
          el = document.createElement('script');
          el.type = 'application/ld+json';
          el.id = 'dynamic-jsonld';
          document.head.appendChild(el);
        }
        el.textContent = JSON.stringify(data);
      } else {
        if (el) el.remove();
      }
    }

    function StockBadge({ status }) {
      const map = {
        in_stock: { label: 'In Stock', cls: 'in-stock' },
        low_stock: { label: 'Low Stock', cls: 'low-stock' },
        out_of_stock: { label: 'Out of Stock', cls: 'out-of-stock' },
      };
      const info = map[status] || { label: 'Check Availability', cls: 'unknown' };
      return React.createElement('span', { className: `stock-badge stock-badge--${info.cls}` }, info.label);
    }

    const stripePromise = Stripe('pk_test_51SzdrRAASarADPs5BQucZOHBLTPXAaFpGajCToKwXCjdVCasoYHDm3guDjMoEeQhhLr71AWiFPgq91BE2ggj2wNf004DucWYlf');

    function App() {
      const [view, setView] = useState('home');
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [products, setProducts] = useState([]);
      const [categories, setCategories] = useState([]);
      const [selectedCategory, setSelectedCategory] = useState(null);
      const [selectedCollection, setSelectedCollection] = useState(null);
      const [cart, setCart] = useState([]);
      const [cartOpen, setCartOpen] = useState(false);
      const [cartFlash, setCartFlash] = useState(false);
      const [filters, setFilters] = useState({});
      const [availableAttributes, setAvailableAttributes] = useState([]);
      const [searchQuery, setSearchQuery] = useState('');
      const [completedOrder, setCompletedOrder] = useState(null);
      const [deliveryMethod, setDeliveryMethod] = useState('shipping');
      const [tradeCustomer, setTradeCustomer] = useState(null);
      const [tradeToken, setTradeToken] = useState(localStorage.getItem('trade_token') || null);
      const [showTradeModal, setShowTradeModal] = useState(false);
      const [tradeModalMode, setTradeModalMode] = useState('login');
      const [showInstallModal, setShowInstallModal] = useState(false);
      const [installModalProduct, setInstallModalProduct] = useState(null);
      const [customer, setCustomer] = useState(null);
      const [customerToken, setCustomerToken] = useState(localStorage.getItem('customer_token') || null);
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [authModalMode, setAuthModalMode] = useState('login');
      const [appliedPromoCode, setAppliedPromoCode] = useState(null);
      const sessionId = useRef(getSessionId());

      const tradeHeaders = () => {
        const t = localStorage.getItem('trade_token');
        return t ? { 'X-Trade-Token': t } : {};
      };

      const fetchProducts = (categorySlug, activeFilters, searchTerm, collectionName) => {
        const f = activeFilters || {};
        let url = API + '/api/products';
        const params = new URLSearchParams();
        if (categorySlug) params.set('category', categorySlug);
        if (searchTerm) params.set('search', searchTerm);
        if (collectionName) params.set('collection', collectionName);
        Object.keys(f).forEach(slug => {
          if (f[slug] && f[slug].length > 0) {
            params.set(slug, f[slug].join(','));
          }
        });
        const qs = params.toString();
        if (qs) url += '?' + qs;
        fetch(url, { headers: tradeHeaders() })
          .then(r => r.json())
          .then(data => setProducts(data.products))
          .catch(err => console.error(err));
      };

      const fetchAttributes = (categorySlug) => {
        let url = API + '/api/attributes';
        if (categorySlug) url += '?category=' + encodeURIComponent(categorySlug);
        fetch(url)
          .then(r => r.json())
          .then(data => setAvailableAttributes(data.attributes || []))
          .catch(err => console.error(err));
      };

      // --- URL-based routing helper ---
      const navigateTo = (viewName, metaParams, urlParams, useReplace) => {
        const url = buildUrl(viewName, urlParams || {});
        if (useReplace) {
          history.replaceState({ view: viewName, params: urlParams }, '', url);
        } else {
          history.pushState({ view: viewName, params: urlParams }, '', url);
        }
        updateMeta(viewName, metaParams || {});
        updateStructuredData(viewName, metaParams || {});
      };

      // --- URL-based initialization ---
      useEffect(() => {
        fetchCart();

        fetch(API + '/api/categories')
          .then(r => r.json())
          .then(data => setCategories(data.categories || []))
          .catch(err => console.error(err));

        // Restore trade session
        const savedToken = localStorage.getItem('trade_token');
        if (savedToken) {
          fetch(API + '/api/trade/me', { headers: { 'X-Trade-Token': savedToken } })
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => { setTradeCustomer(data.customer); setTradeToken(savedToken); })
            .catch(() => { localStorage.removeItem('trade_token'); setTradeToken(null); });
        }

        // Restore customer session
        const savedCustToken = localStorage.getItem('customer_token');
        if (savedCustToken) {
          fetch(API + '/api/customer/me', { headers: { 'X-Customer-Token': savedCustToken } })
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => { setCustomer(data.customer); setCustomerToken(savedCustToken); })
            .catch(() => { localStorage.removeItem('customer_token'); setCustomerToken(null); });
        }

        // Parse current URL to determine initial view
        const parsed = parseUrl(window.location.pathname, window.location.search);

        if (parsed.view === 'product' && parsed.params.id) {
          // Deep-link to product: fetch minimal product data by ID
          const tToken = localStorage.getItem('trade_token');
          const hdrs = tToken ? { 'X-Trade-Token': tToken } : {};
          fetch(API + '/api/products/' + parsed.params.id, { headers: hdrs })
            .then(r => { if (!r.ok) throw new Error('Product not found'); return r.json(); })
            .then(data => {
              const p = data.product;
              setSelectedProduct(p);
              setView('product');
              updateMeta('product', { product: p });
            })
            .catch(() => {
              // Product not found  go home
              setView('home');
              fetchProducts();
              fetchAttributes();
              navigateTo('home', {}, {}, true);
            });
        } else if (parsed.view === 'shop') {
          setView('shop');
          if (parsed.params.category) {
            setSelectedCategory(parsed.params.category);
            fetchProducts(parsed.params.category, parsed.params.filters || {});
            fetchAttributes(parsed.params.category);
          } else if (parsed.params.collection) {
            setSelectedCollection(parsed.params.collection);
            fetchProducts(null, {}, null, parsed.params.collection);
            fetchAttributes();
          } else if (parsed.params.search) {
            setSearchQuery(parsed.params.search);
            fetchProducts(null, {}, parsed.params.search);
            fetchAttributes();
          } else {
            fetchProducts(null, parsed.params.filters || {});
            fetchAttributes();
          }
          if (parsed.params.filters) setFilters(parsed.params.filters);
          updateMeta('shop', parsed.params);
        } else if (parsed.view === 'reset-password') {
          setView('reset-password');
        } else if (parsed.view !== 'home') {
          setView(parsed.view);
          fetchProducts();
          fetchAttributes();
          updateMeta(parsed.view, {});
        } else {
          fetchProducts();
          fetchAttributes();
          updateMeta('home', {});
          history.replaceState({ view: 'home' }, '', '/');
        }

        // --- popstate handler for back/forward ---
        const handlePopState = (e) => {
          const state = e.state;
          if (state && state.view) {
            const v = state.view;
            const p = state.params || {};
            if (v === 'product' && p.id) {
              const tToken = localStorage.getItem('trade_token');
              const hdrs = tToken ? { 'X-Trade-Token': tToken } : {};
              fetch(API + '/api/products/' + p.id, { headers: hdrs })
                .then(r => r.json())
                .then(data => {
                  setSelectedProduct(data.product);
                  setView('product');
                  updateMeta('product', { product: data.product });
                  updateStructuredData('product', { product: data.product });
                })
                .catch(() => { setView('home'); });
            } else if (v === 'shop') {
              setView('shop');
              setSelectedCategory(p.category || null);
              setSelectedCollection(p.collection || null);
              setSearchQuery(p.search || '');
              setFilters(p.filters || {});
              fetchProducts(p.category || null, p.filters || {}, p.search || null, p.collection || null);
              fetchAttributes(p.category || null);
              updateMeta('shop', p);
              updateStructuredData('shop', {});
              if (v === 'shop') requestAnimationFrame(() => window.scrollTo(0, shopScrollY.current));
            } else {
              setView(v);
              if (v === 'home') {
                setSelectedProduct(null);
                setSelectedCategory(null);
                setSelectedCollection(null);
                setFilters({});
                setSearchQuery('');
                fetchProducts();
                fetchAttributes();
              }
              updateMeta(v, {});
              updateStructuredData(v, {});
            }
          } else {
            // No state  parse URL
            const reparsed = parseUrl(window.location.pathname, window.location.search);
            setView(reparsed.view);
            updateMeta(reparsed.view, reparsed.params);
          }
        };
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);

      const fetchCart = () => {
        fetch(API + '/api/cart?session_id=' + encodeURIComponent(sessionId.current))
          .then(r => r.json())
          .then(data => setCart(data.cart || []))
          .catch(err => console.error(err));
      };

      const handleTradeLogin = (token, cust) => {
        localStorage.setItem('trade_token', token);
        setTradeToken(token);
        setTradeCustomer(cust);
        setShowTradeModal(false);
        if (view === 'trade') {
          setView('trade-dashboard');
          navigateTo('trade-dashboard', {}, {});
        }
        fetchProducts(selectedCategory, filters, searchQuery);
      };

      const handleTradeLogout = () => {
        const t = localStorage.getItem('trade_token');
        if (t) {
          fetch(API + '/api/trade/logout', { method: 'POST', headers: { 'X-Trade-Token': t } }).catch(() => {});
        }
        localStorage.removeItem('trade_token');
        setTradeToken(null);
        setTradeCustomer(null);
        fetchProducts(selectedCategory, filters, searchQuery);
      };

      const handleCustomerLogin = (token, cust) => {
        localStorage.setItem('customer_token', token);
        setCustomerToken(token);
        setCustomer(cust);
        setShowAuthModal(false);
      };

      const handleCustomerLogout = () => {
        const t = localStorage.getItem('customer_token');
        if (t) {
          fetch(API + '/api/customer/logout', { method: 'POST', headers: { 'X-Customer-Token': t } }).catch(() => {});
        }
        localStorage.removeItem('customer_token');
        setCustomerToken(null);
        setCustomer(null);
        if (view === 'account') {
          setView('home');
          navigateTo('home', {}, {});
        }
      };

      const goAccount = () => { setView('account'); navigateTo('account', {}, {}); window.scrollTo(0, 0); };
      const openCustomerLogin = () => { setAuthModalMode('login'); setShowAuthModal(true); };
      const openCustomerRegister = () => { setAuthModalMode('register'); setShowAuthModal(true); };

      const addToCart = (item) => {
        fetch(API + '/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...item, session_id: sessionId.current })
        })
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              alert(data.error);
              return;
            }
            if (data.item) {
              setCart(prev => [...prev, data.item]);
              setCartFlash(true);
              setTimeout(() => setCartFlash(false), 600);
              setCartOpen(true);
              setTimeout(() => setCartOpen(false), 3000);
            }
          })
          .catch(err => console.error(err));
      };

      const removeFromCart = (itemId) => {
        fetch(API + '/api/cart/' + itemId, { method: 'DELETE' })
          .then(r => r.json())
          .then(() => setCart(prev => prev.filter(i => i.id !== itemId)))
          .catch(err => console.error(err));
      };

      const updateCartItem = (itemId, updates) => {
        fetch(API + '/api/cart/' + itemId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        })
          .then(r => r.json())
          .then(data => {
            if (data.item) {
              setCart(prev => prev.map(i => i.id === itemId ? data.item : i));
            }
          })
          .catch(err => console.error(err));
      };

      const shopScrollY = useRef(0);

      const viewProduct = (product) => {
        shopScrollY.current = window.scrollY;
        setSelectedProduct(product);
        setView('product');
        navigateTo('product', { product }, { id: product.id, name: product.name });
        window.scrollTo(0, 0);
      };

      const handleSearch = (query) => {
        setSearchQuery(query);
        setSelectedCategory(null);
        setSelectedCollection(null);
        setFilters({});
        setView('shop');
        fetchProducts(null, {}, query);
        fetchAttributes();
        navigateTo('shop', { search: query }, { search: query });
        window.scrollTo(0, 0);
      };

      const goHome = () => {
        setView('home');
        setSelectedProduct(null);
        setSelectedCategory(null);
        setSelectedCollection(null);
        setFilters({});
        setSearchQuery('');
        fetchProducts();
        fetchAttributes();
        navigateTo('home', {}, {});
      };

      const goShop = () => {
        setView('shop');
        setSelectedCategory(null);
        setSelectedCollection(null);
        setFilters({});
        setSearchQuery('');
        fetchProducts();
        fetchAttributes();
        navigateTo('shop', {}, {});
        window.scrollTo(0, 0);
      };

      const goCollections = () => {
        setView('collections');
        setSelectedCategory(null);
        setSelectedCollection(null);
        setFilters({});
        setSearchQuery('');
        navigateTo('collections', {}, {});
        window.scrollTo(0, 0);
      };

      const goCollection = (name) => {
        const slug = generateSlug(name);
        setSelectedCollection(name);
        setSelectedCategory(null);
        setFilters({});
        setSearchQuery('');
        setView('shop');
        fetchProducts(null, {}, null, name);
        fetchAttributes();
        navigateTo('shop', { collectionName: name }, { collection: slug });
        window.scrollTo(0, 0);
      };

      const goTrade = () => {
        const v = tradeCustomer ? 'trade-dashboard' : 'trade';
        setView(v);
        navigateTo(v, {}, {});
        window.scrollTo(0, 0);
      };
      const goTradeDashboard = () => { setView('trade-dashboard'); navigateTo('trade-dashboard', {}, {}); window.scrollTo(0, 0); };
      const goBulkOrder = () => { setView('bulk-order'); navigateTo('bulk-order', {}, {}); window.scrollTo(0, 0); };
      const openTradeRegister = () => { setTradeModalMode('register'); setShowTradeModal(true); };
      const openTradeLogin = () => { setTradeModalMode('login'); setShowTradeModal(true); };
      const handleRequestInstall = (product) => { setInstallModalProduct(product); setShowInstallModal(true); };
      const handleRequestInstallGeneral = () => { setInstallModalProduct(null); setShowInstallModal(true); };

      const handleCategorySelect = (slug) => {
        setSelectedCategory(slug);
        setSelectedCollection(null);
        setFilters({});
        fetchProducts(slug);
        fetchAttributes(slug);
        navigateTo('shop', { category: slug }, { category: slug });
      };

      const handleFilterToggle = (slug, value) => {
        setFilters(prev => {
          const current = prev[slug] || [];
          const next = current.includes(value)
            ? current.filter(v => v !== value)
            : [...current, value];
          const updated = { ...prev };
          if (next.length > 0) {
            updated[slug] = next;
          } else {
            delete updated[slug];
          }
          fetchProducts(selectedCategory, updated);
          const urlP = { filters: updated };
          if (selectedCategory) urlP.category = selectedCategory;
          if (selectedCollection) urlP.collection = generateSlug(selectedCollection);
          if (searchQuery) urlP.search = searchQuery;
          navigateTo('shop', urlP, urlP, true);
          return updated;
        });
      };

      const handleClearFilters = () => {
        setFilters({});
        fetchProducts(selectedCategory);
      };

      const goCart = () => {
        setView('cart');
        setCartOpen(false);
        navigateTo('cart', {}, {});
        window.scrollTo(0, 0);
      };

      const goBack = () => {
        if (view === 'product') {
          setView('shop');
          setSelectedProduct(null);
          fetchProducts(selectedCategory, filters);
          const urlP = {};
          if (selectedCategory) urlP.category = selectedCategory;
          if (selectedCollection) urlP.collection = generateSlug(selectedCollection);
          if (searchQuery) urlP.search = searchQuery;
          navigateTo('shop', urlP, urlP);
          requestAnimationFrame(() => window.scrollTo(0, shopScrollY.current));
        } else {
          goHome();
        }
      };

      const goCheckout = () => {
        setView('checkout');
        setCartOpen(false);
        navigateTo('checkout', {}, {});
        window.scrollTo(0, 0);
      };

      const handleOrderComplete = (order) => {
        setCompletedOrder(order);
        setCart([]);
        setView('confirmation');
        navigateTo('confirmation', {}, {}, true);
        window.scrollTo(0, 0);
      };

      return (
        <>
          <Header goHome={goHome} goShop={goShop} goCollections={goCollections} cart={cart} cartOpen={cartOpen} setCartOpen={setCartOpen}
            removeFromCart={removeFromCart} goCart={goCart} cartFlash={cartFlash}
            searchQuery={searchQuery} onSearch={handleSearch}
            tradeCustomer={tradeCustomer} onTradeClick={tradeCustomer ? goTradeDashboard : goTrade} onTradeLogout={handleTradeLogout}
            customer={customer} onAccountClick={customer ? goAccount : openCustomerLogin} onCustomerLogout={handleCustomerLogout} />

          {view === 'home' && (
            <>
              <Hero goShop={goShop} />
              <ProductGrid products={products.slice(0, 6)} viewProduct={viewProduct} />
            </>
          )}
          {view === 'collections' && (
            <CollectionsPage goCollection={goCollection} />
          )}
          {view === 'shop' && (
            <ShopPage
              products={products}
              categories={categories}
              selectedCategory={selectedCategory}
              selectedCollection={selectedCollection}
              onCategorySelect={handleCategorySelect}
              viewProduct={viewProduct}
              availableAttributes={availableAttributes}
              filters={filters}
              onFilterToggle={handleFilterToggle}
              onClearFilters={handleClearFilters}
              searchQuery={searchQuery}
            />
          )}
          {view === 'product' && (
            <ProductDetail product={selectedProduct} goBack={goBack} addToCart={addToCart} cart={cart} onRequestInstall={handleRequestInstall} viewProduct={viewProduct} />
          )}
          {view === 'cart' && (
            <CartPage cart={cart} goHome={goHome} removeFromCart={removeFromCart}
              updateCartItem={updateCartItem} goCheckout={goCheckout}
              deliveryMethod={deliveryMethod} setDeliveryMethod={setDeliveryMethod}
              sessionId={sessionId.current} appliedPromoCode={appliedPromoCode} setAppliedPromoCode={setAppliedPromoCode} />
          )}
          {view === 'checkout' && (
            <CheckoutPage cart={cart} sessionId={sessionId.current}
              goCart={goCart} handleOrderComplete={handleOrderComplete}
              deliveryMethod={deliveryMethod}
              tradeCustomer={tradeCustomer} tradeToken={tradeToken}
              customer={customer} customerToken={customerToken}
              onCustomerLogin={handleCustomerLogin}
              appliedPromoCode={appliedPromoCode} setAppliedPromoCode={setAppliedPromoCode} />
          )}
          {view === 'confirmation' && (
            <ConfirmationPage order={completedOrder} goHome={goHome} />
          )}
          {view === 'account' && customer && (
            <AccountPage customer={customer} customerToken={customerToken} setCustomer={setCustomer} goHome={goHome} />
          )}
          {view === 'reset-password' && (
            <ResetPasswordPage goHome={goHome} openLogin={openCustomerLogin} />
          )}
          {view === 'trade' && (
            <TradePage onApplyClick={openTradeRegister} onSignInClick={openTradeLogin} />
          )}
          {view === 'trade-dashboard' && tradeCustomer && (
            <TradeDashboard tradeCustomer={tradeCustomer} tradeToken={tradeToken}
              addToCart={addToCart} goShop={goShop} goBulkOrder={goBulkOrder}
              setTradeCustomer={setTradeCustomer} handleTradeLogout={handleTradeLogout} />
          )}
          {view === 'bulk-order' && tradeCustomer && (
            <BulkOrderPage tradeToken={tradeToken} addToCart={addToCart} goTradeDashboard={goTradeDashboard} />
          )}

          {showTradeModal && <TradeModal onClose={() => setShowTradeModal(false)} onLogin={handleTradeLogin} initialMode={tradeModalMode} />}
          {showAuthModal && <CustomerAuthModal onClose={() => setShowAuthModal(false)} onLogin={handleCustomerLogin} initialMode={authModalMode} />}
          {showInstallModal && <InstallationInquiryModal onClose={() => setShowInstallModal(false)} product={installModalProduct} />}
          <Footer onInstallClick={handleRequestInstallGeneral} />
        </>
      );
    }

    function Header({ goHome, goShop, goCollections, cart, cartOpen, setCartOpen, removeFromCart, goCart, cartFlash, searchQuery, onSearch, tradeCustomer, onTradeClick, onTradeLogout, customer, onAccountClick, onCustomerLogout }) {
      const [searchInput, setSearchInput] = useState('');
      const itemCount = cart.length;
      const productItems = cart.filter(i => !i.is_sample);
      const sampleItems = cart.filter(i => i.is_sample);
      const cartTotal = productItems.reduce((sum, i) => sum + parseFloat(i.subtotal || 0), 0)
        + (sampleItems.length > 0 ? 12 : 0);

      const handleSearchSubmit = (e) => {
        e.preventDefault();
        const q = searchInput.trim();
        if (q) {
          onSearch(q);
        }
      };

      // Clear input when searchQuery is cleared externally (e.g. goHome/goShop)
      useEffect(() => {
        if (!searchQuery) setSearchInput('');
      }, [searchQuery]);

      return (
        <header>
          <div className="logo" onClick={goHome}>Roma Flooring Designs</div>
          <nav>
            <a onClick={goShop}>Products</a>
            <a onClick={goCollections}>Collections</a>
            {tradeCustomer ? (
              <span className="trade-header-info">
                <a onClick={onTradeClick} style={{ cursor: 'pointer' }} className="trade-header-label">Trade: {tradeCustomer.company_name} ({tradeCustomer.tier_name || 'No Tier'})</a>
                <a onClick={onTradeLogout} style={{ marginLeft: '0.5rem', fontSize: '0.75rem', cursor: 'pointer' }}>Logout</a>
              </span>
            ) : (
              <a onClick={onTradeClick} style={{ cursor: 'pointer' }}>Trade</a>
            )}
            {customer ? (
              <span style={{ display: 'inline-flex', alignItems: 'center', gap: '0.35rem' }}>
                <a onClick={onAccountClick} style={{ cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: '0.3rem' }}>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ width: 18, height: 18 }}>
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
                  </svg>
                  {customer.first_name}
                </a>
                <a onClick={onCustomerLogout} style={{ fontSize: '0.7rem', cursor: 'pointer', color: 'var(--stone-500)' }}>Logout</a>
              </span>
            ) : (
              <a onClick={onAccountClick} style={{ cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: '0.25rem' }}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ width: 18, height: 18 }}>
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                Account
              </a>
            )}
            <form className="header-search" onSubmit={handleSearchSubmit}>
              <span className="header-search-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
              </span>
              <input
                type="text"
                placeholder="Search products..."
                value={searchInput}
                onChange={(e) => setSearchInput(e.target.value)}
              />
            </form>
            <div style={{ position: 'relative' }}>
              <div className={'cart-icon-wrap' + (cartFlash ? ' cart-flash' : '')} onClick={() => setCartOpen(!cartOpen)}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                  <line x1="3" y1="6" x2="21" y2="6"/>
                  <path d="M16 10a4 4 0 01-8 0"/>
                </svg>
                {itemCount > 0 && <span className="cart-badge">{itemCount}</span>}
              </div>
              {cartOpen && (
                <>
                  <div className="cart-dropdown-overlay" onClick={() => setCartOpen(false)} />
                  <div className="cart-dropdown">
                    <div className="cart-dropdown-header">Cart ({itemCount})</div>
                    {itemCount === 0 ? (
                      <div className="cart-dropdown-empty">Your cart is empty</div>
                    ) : (
                      <>
                        <div className="cart-dropdown-items">
                          {cart.map(item => (
                            <div key={item.id} className={'cart-dropdown-item' + (item.is_sample ? ' sample-item' : '')}>
                              <div className="cart-dropdown-item-info">
                                <div className="cart-dropdown-item-name">
                                  {item.product_name || 'Product'}
                                  {item.is_sample && <span className="sample-tag">Sample</span>}
                                </div>
                                {item.is_sample ? (
                                  <div className="cart-dropdown-item-meta">FREE SAMPLE</div>
                                ) : (
                                  <div className="cart-dropdown-item-meta">
                                    {item.num_boxes} box{item.num_boxes !== 1 ? 'es' : ''} &middot; {parseFloat(item.sqft_needed || 0).toFixed(0)} sqft
                                  </div>
                                )}
                              </div>
                              <div className="cart-dropdown-item-price">
                                {item.is_sample ? 'FREE' : '$' + parseFloat(item.subtotal).toFixed(2)}
                              </div>
                              <button className="cart-dropdown-item-remove" onClick={() => removeFromCart(item.id)}>Remove</button>
                            </div>
                          ))}
                        </div>
                        <div className="cart-dropdown-footer">
                          <div className="cart-dropdown-total">
                            <span>Subtotal</span>
                            <span>${cartTotal.toFixed(2)}</span>
                          </div>
                          <button className="btn" style={{ width: '100%' }} onClick={goCart}>View Cart</button>
                        </div>
                      </>
                    )}
                  </div>
                </>
              )}
            </div>
          </nav>
        </header>
      );
    }

    function Hero({ goShop }) {
      return (
        <div className="hero">
          <div>
            <h1>Premium Flooring Materials</h1>
            <p>Curated surfaces from the world's finest makers</p>
            <button className="btn" onClick={goShop}>Explore Collection</button>
          </div>
        </div>
      );
    }

    function ProductGrid({ products, viewProduct }) {
      return (
        <div className="section">
          <h2 className="section-title">Featured Products</h2>
          <div className="product-grid">
            {products.map(p => (
              <div key={p.id} className="product-card" onClick={() => viewProduct(p)}>
                <StockBadge status={p.stock_status} />
                <div className="product-image">
                  {p.primary_image && <img src={p.primary_image} alt={p.name} loading="lazy" />}
                </div>
                <div className="product-name">{p.name}</div>
                <div className="product-meta">{p.collection}  {p.vendor_name}</div>
                <div className="product-price">
                      {p.price ? (
                        p.trade_price ? (
                          <>
                            <span className="price-strike">${parseFloat(p.price).toFixed(2)}</span>
                            {' '}
                            <span className="trade-price">${parseFloat(p.trade_price).toFixed(2)}{priceLabel(p)}</span>
                          </>
                        ) : (
                          `$${parseFloat(p.price).toFixed(2)}${priceLabel(p)}`
                        )
                      ) : 'Contact for pricing'}
                    </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function CategorySidebar({ categories, selectedCategory, onCategorySelect }) {
      const [expanded, setExpanded] = useState({});

      // Auto-expand parent that contains the selected category
      useEffect(() => {
        if (selectedCategory) {
          categories.forEach(parent => {
            if (parent.children.some(ch => ch.slug === selectedCategory) || parent.slug === selectedCategory) {
              setExpanded(prev => ({ ...prev, [parent.slug]: true }));
            }
          });
        }
      }, [selectedCategory]);

      const toggleExpand = (slug, e) => {
        e.stopPropagation();
        setExpanded(prev => ({ ...prev, [slug]: !prev[slug] }));
      };

      const totalProducts = categories.reduce((sum, c) => sum + c.product_count, 0);

      return (
        <div className="category-sidebar">
          <h3>Categories</h3>
          <div
            className={'category-item' + (selectedCategory === null ? ' active' : '')}
            onClick={() => onCategorySelect(null)}
          >
            <span>All Products</span>
            <span className="category-count">{totalProducts}</span>
          </div>
          {categories.map(parent => (
            <div key={parent.slug}>
              <div
                className={'category-item' + (selectedCategory === parent.slug ? ' active' : '')}
                onClick={() => onCategorySelect(parent.slug)}
              >
                <div className="category-parent-label">
                  <button className="category-expand" onClick={(e) => toggleExpand(parent.slug, e)}>
                    {expanded[parent.slug] ? '' : '+'}
                  </button>
                  <span>{parent.name}</span>
                </div>
                <span className="category-count">{parent.product_count}</span>
              </div>
              {expanded[parent.slug] && (
                <div className="category-children">
                  {parent.children.map(child => (
                    <div
                      key={child.slug}
                      className={'category-item' + (selectedCategory === child.slug ? ' active' : '')}
                      onClick={() => onCategorySelect(child.slug)}
                    >
                      <span>{child.name}</span>
                      <span className="category-count">{child.product_count}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      );
    }

    function FilterPanel({ availableAttributes, filters, onFilterToggle, onClearFilters }) {
      const hasActiveFilters = Object.keys(filters).length > 0;
      // Only show groups with 2+ values
      const visibleGroups = availableAttributes.filter(g => g.values.length >= 2);

      if (visibleGroups.length === 0) return null;

      return (
        <div className="filter-panel">
          <div className="filter-panel-header">
            <h3>Filter By</h3>
            {hasActiveFilters && (
              <button className="filter-clear" onClick={onClearFilters}>Clear All</button>
            )}
          </div>
          {visibleGroups.map(group => (
            <div key={group.slug} className="filter-group">
              <div className="filter-group-title">{group.name}</div>
              {group.values.map(v => {
                const checked = (filters[group.slug] || []).includes(v.value);
                return (
                  <div key={v.value} className="filter-option">
                    <input
                      type="checkbox"
                      id={'filter-' + group.slug + '-' + v.value}
                      checked={checked}
                      onChange={() => onFilterToggle(group.slug, v.value)}
                    />
                    <label htmlFor={'filter-' + group.slug + '-' + v.value}>{v.value}</label>
                    <span className="filter-count">{v.count}</span>
                  </div>
                );
              })}
            </div>
          ))}
        </div>
      );
    }

    function CollectionsPage({ goCollection }) {
      const [collections, setCollections] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch(API + '/api/collections')
          .then(r => r.json())
          .then(data => { setCollections(data.collections || []); setLoading(false); })
          .catch(err => { console.error(err); setLoading(false); });
      }, []);

      if (loading) {
        return (
          <div className="shop-page" style={{ padding: '4rem 2rem', textAlign: 'center' }}>
            <p style={{ color: 'var(--stone-500)' }}>Loading collections...</p>
          </div>
        );
      }

      return (
        <div className="shop-page">
          <div className="shop-page-header">
            <h1>Collections <span style={{ fontSize: '1.25rem', color: 'var(--stone-600)', fontWeight: 300 }}>({collections.length})</span></h1>
          </div>
          <div className="product-grid" style={{ gridColumn: '1 / -1' }}>
            {collections.map(col => (
              <div key={col.slug} className="product-card" onClick={() => goCollection(col.name)} style={{ cursor: 'pointer' }}>
                <div className="product-image">
                  {col.image ? (
                    <img src={col.image} alt={col.name} loading="lazy" />
                  ) : (
                    <div style={{ width: '100%', height: '100%', background: 'linear-gradient(135deg, var(--stone-200), var(--stone-300))' }} />
                  )}
                </div>
                <div className="product-name">{col.name}</div>
                <div className="product-meta">{col.product_count} product{col.product_count !== 1 ? 's' : ''}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function ShopPage({ products, categories, selectedCategory, selectedCollection, onCategorySelect, viewProduct,
      availableAttributes, filters, onFilterToggle, onClearFilters, searchQuery }) {
      // Determine heading from selected collection, category, or search
      let heading = 'All Products';
      if (selectedCollection) {
        heading = selectedCollection;
      } else if (searchQuery) {
        heading = `Results for "${searchQuery}"`;
      } else if (selectedCategory) {
        for (const parent of categories) {
          if (parent.slug === selectedCategory) { heading = parent.name; break; }
          for (const child of parent.children) {
            if (child.slug === selectedCategory) { heading = child.name; break; }
          }
        }
      }

      // Collect active filter pills
      const activePills = [];
      Object.keys(filters).forEach(slug => {
        const group = availableAttributes.find(a => a.slug === slug);
        (filters[slug] || []).forEach(value => {
          activePills.push({ slug, value, label: (group ? group.name + ': ' : '') + value });
        });
      });

      return (
        <div className="shop-page">
          <div className="shop-page-header">
            <h1>{heading} <span style={{ fontSize: '1.25rem', color: 'var(--stone-600)', fontWeight: 300 }}>({products.length} product{products.length !== 1 ? 's' : ''})</span></h1>
          </div>
          <div>
            <CategorySidebar
              categories={categories}
              selectedCategory={selectedCategory}
              onCategorySelect={onCategorySelect}
            />
            <FilterPanel
              availableAttributes={availableAttributes}
              filters={filters}
              onFilterToggle={onFilterToggle}
              onClearFilters={onClearFilters}
            />
          </div>
          <div>
            {activePills.length > 0 && (
              <div className="active-filters">
                {activePills.map(pill => (
                  <span key={pill.slug + '-' + pill.value} className="filter-pill">
                    {pill.label}
                    <button onClick={() => onFilterToggle(pill.slug, pill.value)}>&times;</button>
                  </span>
                ))}
              </div>
            )}
            {products.length === 0 ? (
              <div className="shop-empty">No products found matching your filters.</div>
            ) : (
              <div className="product-grid">
                {products.map(p => (
                  <div key={p.id} className="product-card" onClick={() => viewProduct(p)}>
                    <StockBadge status={p.stock_status} />
                    <div className="product-image">
                      {p.primary_image && <img src={p.primary_image} alt={p.name} loading="lazy" />}
                    </div>
                    <div className="product-name">{p.name}</div>
                    <div className="product-meta">{p.collection} &bull; {p.vendor_name}</div>
                    <div className="product-price">
                      {p.price ? (
                        p.trade_price ? (
                          <>
                            <span className="price-strike">${parseFloat(p.price).toFixed(2)}</span>
                            {' '}
                            <span className="trade-price">${parseFloat(p.trade_price).toFixed(2)}{priceLabel(p)}</span>
                          </>
                        ) : (
                          `$${parseFloat(p.price).toFixed(2)}${priceLabel(p)}`
                        )
                      ) : 'Contact for pricing'}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    function ProductDetail({ product, goBack, addToCart, cart, onRequestInstall, viewProduct }) {
      // Calculator state - Elysium style where boxes and sqft sync
      const [sqftNeeded, setSqftNeeded] = useState('');
      const [numBoxes, setNumBoxes] = useState('');
      const [includeOverage, setIncludeOverage] = useState(false);
      const [fullProduct, setFullProduct] = useState(null);
      const [skus, setSkus] = useState([]);
      const [selectedSku, setSelectedSku] = useState(null);
      const [activeVariantType, setActiveVariantType] = useState(null);
      const [loading, setLoading] = useState(true);
      const [media, setMedia] = useState([]);
      const [selectedImage, setSelectedImage] = useState(null);
      const [recommendations, setRecommendations] = useState([]);

      useEffect(() => {
        if (!product) return;
        setLoading(true);
        const tToken = localStorage.getItem('trade_token');
        const hdrs = tToken ? { 'X-Trade-Token': tToken } : {};
        fetch(API + '/api/products/' + product.id, { headers: hdrs })
          .then(r => r.json())
          .then(data => {
            setFullProduct(data.product);
            const allSkus = data.skus || [];
            setSkus(allSkus);
            // Determine variant type groups
            const types = [...new Set(allSkus.map(s => s.variant_type || null))];
            const initialType = types.length > 1 ? types[0] : types[0] || null;
            setActiveVariantType(initialType);
            const typeSkus = types.length > 1 ? allSkus.filter(s => (s.variant_type || null) === initialType) : allSkus;
            const defaultSku = typeSkus.find(s => s.status === 'active') || typeSkus[0] || null;
            setSelectedSku(defaultSku);
            const mediaList = data.media || [];
            setMedia(mediaList);
            const primary = mediaList.find(m => m.asset_type === 'primary');
            const primaryUrl = primary ? primary.url : (mediaList.length > 0 ? mediaList[0].url : null);
            setSelectedImage(primaryUrl);
            setLoading(false);
            // Update structured data with full product info
            updateMeta('product', { product: data.product, primaryImage: primaryUrl });
            updateStructuredData('product', { product: data.product, selectedSku: defaultSku, primaryImage: primaryUrl });
          })
          .catch(err => {
            console.error(err);
            setLoading(false);
          });
        setRecommendations([]);
        fetch(API + '/api/products/' + product.id + '/recommendations')
          .then(r => r.json())
          .then(data => setRecommendations(data.recommendations || []))
          .catch(() => {});
      }, [product && product.id]);

      if (!product) return null;
      if (loading) return (
        <div style={{ textAlign: 'center', padding: '6rem 0', color: 'var(--stone-600)' }}>Loading...</div>
      );

      const displayProduct = fullProduct || product;

      // Group SKUs by variant_type
      const variantTypes = [...new Set(skus.map(s => s.variant_type || null))];
      const hasMultipleTypes = variantTypes.length > 1;
      const activeSkus = hasMultipleTypes
        ? skus.filter(s => (s.variant_type || null) === activeVariantType)
        : skus;

      const VARIANT_TYPE_LABELS = {
        tile: 'Tile', mosaic: 'Mosaic', slab: 'Slab',
        trim: 'Trim', accessory: 'Accessory', paver: 'Paver'
      };

      const handleVariantTypeChange = (type) => {
        setActiveVariantType(type);
        const typeSkus = skus.filter(s => (s.variant_type || null) === type);
        const first = typeSkus.find(s => s.status === 'active') || typeSkus[0] || null;
        setSelectedSku(first);
        setSqftNeeded('');
        setNumBoxes('');
      };

      const handleSkuChange = (skuId) => {
        const sku = skus.find(s => s.id === skuId);
        if (sku) {
          setSelectedSku(sku);
          setSqftNeeded('');
          setNumBoxes('');
        }
      };

      const sqftPerBox = selectedSku ? parseFloat(selectedSku.sqft_per_box) || 0 : 0;
      const piecesPerBox = selectedSku ? parseInt(selectedSku.pieces_per_box) || 0 : 0;
      const weightPerBox = selectedSku ? parseFloat(selectedSku.weight_per_box_lbs) || 0 : 0;
      const pricePerSqft = selectedSku ? parseFloat(selectedSku.retail_price) || 0 : parseFloat(product.price) || 0;
      const tradePrice = selectedSku && selectedSku.trade_price ? parseFloat(selectedSku.trade_price) : null;
      const displayPrice = tradePrice || pricePerSqft;

      const recalcBoxes = (sqft, withOverage) => {
        if (sqft && !isNaN(sqft) && sqft > 0) {
          const adjusted = withOverage ? parseFloat(sqft) * 1.1 : parseFloat(sqft);
          return Math.ceil(adjusted / sqftPerBox).toString();
        }
        return '';
      };

      // When user changes sqft, update boxes
      const handleSqftChange = (value) => {
        setSqftNeeded(value);
        setNumBoxes(recalcBoxes(value, includeOverage));
      };

      // When user changes boxes, update sqft
      const handleBoxesChange = (value) => {
        setNumBoxes(value);
        if (value && !isNaN(value) && value > 0) {
          const sqft = parseFloat(value) * sqftPerBox;
          setSqftNeeded(sqft.toFixed(2));
        } else {
          setSqftNeeded('');
        }
      };

      // When overage toggle changes, recalculate boxes from current sqft
      const handleOverageToggle = () => {
        const next = !includeOverage;
        setIncludeOverage(next);
        if (sqftNeeded) {
          setNumBoxes(recalcBoxes(sqftNeeded, next));
        }
      };

      // Calculate results
      const boxes = numBoxes ? parseInt(numBoxes) : 0;
      const actualSqft = boxes * sqftPerBox;
      const requestedSqft = sqftNeeded ? parseFloat(sqftNeeded) : 0;
      const totalWeight = boxes * weightPerBox;
      const totalPrice = actualSqft * displayPrice;
      const pricePerBox = sqftPerBox * displayPrice;

      return (
        <>
        <div>
          <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '2rem 3rem' }}>
            <a className="back-btn" onClick={goBack}>
               Back to Products
            </a>
          </div>

          <div className="product-detail">
            <div>
              <div className="product-detail-image">
                {selectedImage && <img src={selectedImage} alt={displayProduct.name} />}
              </div>
              {media.length > 1 && (
                <div className="product-gallery-thumbs">
                  {media.map(m => (
                    <div
                      key={m.id}
                      className={'product-gallery-thumb' + (selectedImage === m.url ? ' active' : '')}
                      onClick={() => setSelectedImage(m.url)}
                    >
                      <img src={m.url} alt={m.asset_type} />
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="product-detail-info">
              <h1>{displayProduct.name}</h1>
              <div className="product-detail-meta">
                {displayProduct.collection}  {displayProduct.vendor_name}
              </div>
              <div className="product-detail-price">
                {tradePrice ? (
                  <>
                    <span className="price-strike">${pricePerSqft.toFixed(2)}</span>
                    {' '}
                    <span className="trade-price">${tradePrice.toFixed(2)}</span>
                    {priceLabel(displayProduct) && <span> Per SqFt</span>}
                    <span className="trade-tier-badge">{selectedSku.trade_tier}</span>
                  </>
                ) : (
                  <>
                    ${pricePerSqft.toFixed(2)} {priceLabel(displayProduct) && <span>Per SqFt</span>}
                  </>
                )}
              </div>

              {displayProduct.description_short && (
                <p style={{ color: 'var(--stone-600)', fontSize: '0.9375rem', lineHeight: 1.7, marginBottom: '1rem' }}>
                  {displayProduct.description_short}
                </p>
              )}

              {selectedSku && (
                <div className="stock-status-detail">
                  <StockBadge status={selectedSku.stock_status} />
                  {selectedSku.stock_status === 'in_stock' && (
                    <span className="stock-qty">{parseInt(selectedSku.qty_on_hand)} boxes available</span>
                  )}
                  {selectedSku.stock_status === 'low_stock' && (
                    <span className="stock-qty stock-qty--low">Only {parseInt(selectedSku.qty_on_hand)} boxes left</span>
                  )}
                  {selectedSku.stock_status === 'out_of_stock' && parseInt(selectedSku.qty_in_transit) > 0 && (
                    <span className="stock-qty stock-qty--transit">{parseInt(selectedSku.qty_in_transit)} boxes in transit</span>
                  )}
                </div>
              )}

              {hasMultipleTypes && (
                <div className="variant-type-tabs">
                  {variantTypes.map(type => (
                    <button
                      key={type || 'other'}
                      className={'variant-type-tab' + (activeVariantType === type ? ' active' : '')}
                      onClick={() => handleVariantTypeChange(type)}
                    >
                      {type ? (VARIANT_TYPE_LABELS[type] || type) : 'Other'}
                      {' '}({skus.filter(s => (s.variant_type || null) === type).length})
                    </button>
                  ))}
                </div>
              )}

              {activeSkus.length > 1 && (
                <select
                  className="sku-selector"
                  value={selectedSku ? selectedSku.id : ''}
                  onChange={(e) => handleSkuChange(e.target.value)}
                >
                  {activeSkus.map(s => (
                    <option key={s.id} value={s.id}>
                      {s.variant_name || s.vendor_sku}
                    </option>
                  ))}
                </select>
              )}

              <div className="packaging-info">
                <h4>Packaging Information</h4>
                {piecesPerBox > 0 && <div>SqFt Per Piece: {(sqftPerBox / piecesPerBox).toFixed(2)}</div>}
                <div>Pieces Per Box: {piecesPerBox}</div>
                <div>SqFt Per Box: {sqftPerBox}</div>
                <div>Weight Per Box: {weightPerBox} lbs</div>
                <div>Price Per Box: ${pricePerBox.toFixed(2)}</div>
              </div>

              <div className="calculator-widget">
                <h3>Coverage Calculator</h3>

                <div className="calc-input-row">
                  <div className="calc-input-group">
                    <label>SqFt Needed</label>
                    <input
                      className="calc-input"
                      type="number"
                      placeholder="0"
                      value={sqftNeeded}
                      onChange={(e) => handleSqftChange(e.target.value)}
                      step="0.01"
                    />
                  </div>

                  <div className="calc-input-group">
                    <label>Number of Boxes</label>
                    <input
                      className="calc-input"
                      type="number"
                      placeholder="0"
                      value={numBoxes}
                      onChange={(e) => handleBoxesChange(e.target.value)}
                      step="1"
                    />
                  </div>
                </div>

                <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.875rem', cursor: 'pointer', marginBottom: '1rem' }}>
                  <input
                    type="checkbox"
                    checked={includeOverage}
                    onChange={handleOverageToggle}
                    style={{ width: '1rem', height: '1rem', cursor: 'pointer' }}
                  />
                  Add 10% overage for breakage &amp; cuts
                </label>

                {boxes > 0 && (
                  <div className="calc-summary">
                    <div className="calc-summary-row">
                      <span>Number of Boxes:</span>
                      <strong>{boxes} bx ({totalWeight} lbs)</strong>
                    </div>
                    <div className="calc-summary-row">
                      <span>Total Coverage:</span>
                      <strong>{actualSqft.toFixed(2)} SqFt</strong>
                    </div>
                    {requestedSqft > 0 && actualSqft > requestedSqft && (
                      <div className="calc-summary-row">
                        <span>Overage:</span>
                        <strong>{(actualSqft - requestedSqft).toFixed(2)} SqFt</strong>
                      </div>
                    )}
                    <div className="calc-summary-total">
                      <span>Total Price</span>
                      <strong>${totalPrice.toFixed(2)}</strong>
                    </div>
                  </div>
                )}
              </div>

              {selectedSku && (selectedSku.variant_type === 'slab' ||
                ['RSL','VSL','CSL','PSL'].some(p => (selectedSku.vendor_sku || '').toUpperCase().startsWith(p)) ||
                ['prefab-countertops','countertops'].includes((displayProduct.category_slug || '').toLowerCase())) && (
                <div style={{ background: '#fef3c7', border: '1px solid #f59e0b', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem', lineHeight: 1.5 }}>
                  <strong>Store Pickup Only</strong>  Slabs and prefab countertops are available for in-store pickup only. Ready 1 business day after purchase.
                </div>
              )}

              <div style={{ display: 'flex', gap: '1rem' }}>
                <button className="btn" style={{flex: 1}} onClick={() => {
                  if (boxes <= 0) {
                    alert('Please enter the square footage you need above.');
                    return;
                  }
                  addToCart({
                    product_id: product.id,
                    sku_id: selectedSku ? selectedSku.id : null,
                    sqft_needed: actualSqft,
                    num_boxes: boxes,
                    include_overage: includeOverage,
                    unit_price: displayPrice,
                    subtotal: totalPrice.toFixed(2)
                  });
                }}>
                  Add to Cart
                </button>
                <button className="btn btn-secondary" style={{flex: 1}} onClick={() => {
                  const sampleCount = cart.filter(i => i.is_sample).length;
                  if (sampleCount >= 5) {
                    alert('Sample limit reached (max 5)');
                    return;
                  }
                  if (cart.some(i => i.is_sample && i.product_id === product.id)) {
                    alert('You already have a sample of this product in your cart');
                    return;
                  }
                  addToCart({
                    product_id: product.id,
                    sku_id: selectedSku ? selectedSku.id : null,
                    sqft_needed: 0,
                    num_boxes: 1,
                    include_overage: false,
                    unit_price: 0,
                    subtotal: 0,
                    is_sample: true
                  });
                }}>
                  Request Sample
                </button>
              </div>
              <button className="btn-install-cta" onClick={() => onRequestInstall(fullProduct || product)}>
                Request Installation Quote
              </button>

              {displayProduct.description_long && (
                <div style={{ borderTop: '1px solid var(--stone-200)', marginTop: '1.5rem', paddingTop: '1.5rem' }}>
                  <h3 style={{ fontFamily: "'Cormorant Garamond', serif", fontSize: '1.25rem', fontWeight: 500, marginBottom: '0.75rem', color: 'var(--stone-800)' }}>
                    Product Description
                  </h3>
                  <p style={{ color: 'var(--stone-600)', fontSize: '0.875rem', lineHeight: 1.8, whiteSpace: 'pre-line' }}>
                    {displayProduct.description_long}
                  </p>
                </div>
              )}
            </div>
          </div>
        </div>
        {recommendations.length > 0 && (
          <div className="section" style={{ marginTop: '3rem' }}>
            <h2 className="section-title">You May Also Like</h2>
            <div className="product-grid">
              {recommendations.map(p => (
                <div key={p.id} className="product-card" onClick={() => viewProduct(p)}>
                  <div className="product-image">
                    {p.primary_image && <img src={p.primary_image} alt={p.name} loading="lazy" />}
                  </div>
                  <div className="product-name">{p.name}</div>
                  <div className="product-meta">{p.collection}{p.collection && p.vendor_name ? ' \u2022 ' : ''}{p.vendor_name}</div>
                  <div className="product-price">
                    {p.price ? `$${parseFloat(p.price).toFixed(2)}${priceLabel(p)}` : 'Contact for pricing'}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
        </>
      );
    }

    function InstallationInquiryModal({ onClose, product }) {
      const [form, setForm] = useState({ name: '', email: '', phone: '', zip: '', sqft: '', message: '' });
      const [submitting, setSubmitting] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);

      const formatPhone = (val) => {
        const digits = val.replace(/\D/g, '').slice(0, 10);
        if (digits.length <= 3) return digits;
        if (digits.length <= 6) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
        return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      };

      const handleChange = (field, value) => {
        if (field === 'phone') value = formatPhone(value);
        if (field === 'zip') value = value.replace(/\D/g, '').slice(0, 5);
        if (field === 'sqft') value = value.replace(/[^0-9.]/g, '');
        setForm(prev => ({ ...prev, [field]: value }));
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (!form.name.trim() || !form.email.trim()) {
          setError('Name and email are required.');
          return;
        }
        setSubmitting(true);
        try {
          const resp = await fetch(API + '/api/installation-inquiries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customer_name: form.name.trim(),
              customer_email: form.email.trim(),
              phone: form.phone || undefined,
              zip_code: form.zip || undefined,
              estimated_sqft: form.sqft ? parseFloat(form.sqft) : undefined,
              message: form.message.trim() || undefined,
              product_id: product ? product.id : undefined
            })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'Submission failed');
          setSuccess(true);
        } catch (err) {
          setError(err.message);
        } finally {
          setSubmitting(false);
        }
      };

      return (
        <div className="trade-modal-overlay" onClick={onClose}>
          <div className="trade-modal" onClick={e => e.stopPropagation()} style={{ maxWidth: 520 }}>
            <button className="trade-modal-close" onClick={onClose}></button>
            {success ? (
              <div style={{ textAlign: 'center', padding: '2rem 0' }}>
                <h2 style={{ fontFamily: "'Cormorant Garamond', serif", fontSize: '1.75rem', fontWeight: 400, marginBottom: '1rem', color: 'var(--stone-900)' }}>Inquiry Received</h2>
                <p style={{ color: 'var(--stone-600)', lineHeight: 1.6, marginBottom: '1.5rem' }}>Thank you! A member of our team will be in touch within 12 business days to discuss your installation needs.</p>
                <button className="btn" onClick={onClose}>Close</button>
              </div>
            ) : (
              <>
                <h2 style={{ fontFamily: "'Cormorant Garamond', serif", fontSize: '1.75rem', fontWeight: 400, marginBottom: '0.25rem', color: 'var(--stone-900)' }}>Request Installation Quote</h2>
                <p style={{ color: 'var(--stone-500)', fontSize: '0.8125rem', marginBottom: '1.25rem' }}>Our team will follow up within 12 business days.</p>

                {product && (
                  <div className="install-inquiry-product-context">
                    <strong>{product.name}</strong>{product.collection ? `  ${product.collection}` : ''}
                  </div>
                )}

                {error && <div className="trade-msg trade-msg-error">{error}</div>}

                <form onSubmit={handleSubmit}>
                  <div className="install-inquiry-row">
                    <div className="install-inquiry-field">
                      <label>Name *</label>
                      <input type="text" value={form.name} onChange={e => handleChange('name', e.target.value)} required />
                    </div>
                    <div className="install-inquiry-field">
                      <label>Email *</label>
                      <input type="email" value={form.email} onChange={e => handleChange('email', e.target.value)} required />
                    </div>
                  </div>
                  <div className="install-inquiry-row">
                    <div className="install-inquiry-field">
                      <label>Phone</label>
                      <input type="tel" value={form.phone} onChange={e => handleChange('phone', e.target.value)} placeholder="(555) 123-4567" />
                    </div>
                    <div className="install-inquiry-field">
                      <label>Zip Code</label>
                      <input type="text" value={form.zip} onChange={e => handleChange('zip', e.target.value)} placeholder="92806" />
                    </div>
                  </div>
                  <div className="install-inquiry-field">
                    <label>Estimated Square Footage</label>
                    <input type="text" value={form.sqft} onChange={e => handleChange('sqft', e.target.value)} placeholder="e.g. 500" />
                  </div>
                  <div className="install-inquiry-field">
                    <label>Message</label>
                    <textarea rows="3" value={form.message} onChange={e => handleChange('message', e.target.value)} placeholder="Tell us about your project..." />
                  </div>
                  <button className="btn" type="submit" disabled={submitting} style={{ width: '100%' }}>
                    {submitting ? 'Submitting...' : 'Submit Inquiry'}
                  </button>
                </form>
              </>
            )}
          </div>
        </div>
      );
    }

    function CartPage({ cart, goHome, removeFromCart, updateCartItem, goCheckout, deliveryMethod, setDeliveryMethod, sessionId, appliedPromoCode, setAppliedPromoCode }) {
      const [shippingZip, setShippingZip] = useState('');
      const [shippingEstimate, setShippingEstimate] = useState(null);
      const [shippingLoading, setShippingLoading] = useState(false);
      const [shippingError, setShippingError] = useState('');
      const [selectedShippingOption, setSelectedShippingOption] = useState(null);
      const [liftgateEnabled, setLiftgateEnabled] = useState(true);
      const [promoCode, setPromoCode] = useState(appliedPromoCode || '');
      const [promoResult, setPromoResult] = useState(null);
      const [promoLoading, setPromoLoading] = useState(false);
      const [promoError, setPromoError] = useState('');
      const promoSubtotalRef = useRef(null);

      const productItems = cart.filter(i => !i.is_sample);
      const sampleItems = cart.filter(i => i.is_sample);
      const productSubtotal = productItems.reduce((sum, i) => sum + parseFloat(i.subtotal || 0), 0);
      const sampleShipping = sampleItems.length > 0 ? 12 : 0;
      const productShipping = deliveryMethod === 'pickup' ? 0 : (selectedShippingOption ? selectedShippingOption.amount : 0);
      const promoDiscount = promoResult ? promoResult.discount_amount : 0;
      const cartTotal = productSubtotal + productShipping + sampleShipping - promoDiscount;

      // Clear promo result when cart changes significantly
      useEffect(() => {
        if (promoResult && promoSubtotalRef.current !== null && promoSubtotalRef.current !== productSubtotal) {
          setPromoResult(null);
          setPromoError('');
          setAppliedPromoCode(null);
        }
        promoSubtotalRef.current = productSubtotal;
      }, [productSubtotal]);

      // Auto-validate promo if appliedPromoCode is set on mount
      useEffect(() => {
        if (appliedPromoCode && !promoResult && cart.length > 0) {
          applyPromoCode(appliedPromoCode);
        }
      }, []);

      const applyPromoCode = (codeOverride) => {
        const code = codeOverride || promoCode.trim();
        if (!code) return;
        setPromoLoading(true);
        setPromoError('');
        fetch(API + '/api/promo-codes/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, session_id: sessionId })
        })
          .then(r => r.json())
          .then(data => {
            if (data.valid) {
              setPromoResult(data);
              setPromoError('');
              setAppliedPromoCode(data.code);
              setPromoCode(data.code);
            } else {
              setPromoResult(null);
              setPromoError(data.error || 'Invalid promo code');
              setAppliedPromoCode(null);
            }
            setPromoLoading(false);
          })
          .catch(() => {
            setPromoError('Unable to validate promo code');
            setPromoLoading(false);
          });
      };

      const removePromo = () => {
        setPromoResult(null);
        setPromoCode('');
        setPromoError('');
        setAppliedPromoCode(null);
      };
      const totalBoxes = productItems.reduce((sum, i) => sum + (parseInt(i.num_boxes) || 0), 0);

      // Pickup-only detection: if any non-sample product item is pickup_only, force pickup
      const hasPickupOnly = productItems.some(i => i.pickup_only);
      useEffect(() => {
        if (hasPickupOnly) setDeliveryMethod('pickup');
      }, [hasPickupOnly]);

      const fetchShippingEstimate = () => {
        const zip = shippingZip.trim();
        if (!zip || zip.length < 5) return;
        setShippingLoading(true);
        setShippingError('');
        setSelectedShippingOption(null);
        fetch(API + '/api/shipping/estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, destination: { zip }, residential: true, liftgate: liftgateEnabled })
        })
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              setShippingError(data.error);
              setShippingEstimate(null);
              setSelectedShippingOption(null);
            } else {
              setShippingEstimate(data);
              setShippingError('');
              // Auto-select cheapest option
              const opts = data.options || [];
              const cheapest = opts.find(o => o.is_cheapest) || opts[0];
              setSelectedShippingOption(cheapest || null);
            }
            setShippingLoading(false);
          })
          .catch(() => {
            setShippingError('Unable to estimate shipping');
            setShippingLoading(false);
          });
      };

      const handleQtyChange = (item, delta) => {
        const newBoxes = Math.max(1, (parseInt(item.num_boxes) || 0) + delta);
        const unitPrice = parseFloat(item.unit_price) || 0;
        const sqftPerBox = item.sqft_needed && item.num_boxes
          ? parseFloat(item.sqft_needed) / parseInt(item.num_boxes)
          : 17.11;
        const newSqft = (newBoxes * sqftPerBox).toFixed(2);
        const newSubtotal = (newBoxes * sqftPerBox * unitPrice).toFixed(2);
        updateCartItem(item.id, { num_boxes: newBoxes, sqft_needed: newSqft, subtotal: newSubtotal });
        // Clear shipping estimate since cart changed
        setShippingEstimate(null);
        setSelectedShippingOption(null);
      };

      return (
        <div className="cart-page">
          <a className="back-btn" onClick={goHome}> Continue Shopping</a>
          <h1>Your Cart</h1>

          {cart.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '4rem 0', color: 'var(--stone-600)' }}>
              <p style={{ fontSize: '1.125rem', marginBottom: '2rem' }}>Your cart is empty</p>
              <button className="btn" onClick={goHome}>Browse Products</button>
            </div>
          ) : (
            <div className="cart-page-layout">
              <div>
                <div className="cart-table">
                  <div className="cart-table-header">
                    <div>Product</div>
                    <div>Quantity</div>
                    <div>Coverage</div>
                    <div>Total</div>
                    <div></div>
                  </div>
                  {cart.map(item => {
                    const sqft = parseFloat(item.sqft_needed || 0);
                    return (
                      <div key={item.id} className={'cart-table-row' + (item.is_sample ? ' sample-item' : '')}>
                        <div>
                          <div className="cart-table-product-name">
                            {item.product_name || 'Product'}
                            {item.is_sample && <span className="sample-tag">Sample</span>}
                          </div>
                          {item.is_sample ? (
                            <div className="cart-table-product-meta">Free sample</div>
                          ) : (
                            <div className="cart-table-product-meta">
                              {item.collection && <span>{item.collection} &middot; </span>}
                              ${parseFloat(item.unit_price).toFixed(2)}/sqft
                            </div>
                          )}
                        </div>
                        <div>
                          {item.is_sample ? (
                            <span style={{ fontSize: '0.875rem' }}>1</span>
                          ) : (
                            <>
                              <div className="cart-qty-controls">
                                <button className="cart-qty-btn" onClick={() => handleQtyChange(item, -1)}></button>
                                <span className="cart-qty-value">{item.num_boxes}</span>
                                <button className="cart-qty-btn" onClick={() => handleQtyChange(item, 1)}>+</button>
                              </div>
                              <div style={{ fontSize: '0.75rem', color: 'var(--stone-600)', marginTop: '0.25rem' }}>
                                box{item.num_boxes !== 1 ? 'es' : ''}
                              </div>
                            </>
                          )}
                        </div>
                        <div>{item.is_sample ? '' : sqft.toFixed(1) + ' sqft'}</div>
                        <div style={{ fontWeight: 500 }}>{item.is_sample ? 'FREE' : '$' + parseFloat(item.subtotal).toFixed(2)}</div>
                        <div>
                          <button className="cart-remove-btn" onClick={() => removeFromCart(item.id)} title="Remove">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="order-summary">
                <h3>Order Summary</h3>
                {productItems.length > 0 && (
                  <div className="order-summary-row">
                    <span>Products Subtotal ({totalBoxes} box{totalBoxes !== 1 ? 'es' : ''})</span>
                    <span>${productSubtotal.toFixed(2)}</span>
                  </div>
                )}
                {sampleItems.length > 0 && (
                  <>
                    <div className="order-summary-row muted">
                      <span>Samples ({sampleItems.length})</span>
                      <span>FREE</span>
                    </div>
                    <div className="order-summary-row muted">
                      <span>Sample Shipping</span>
                      <span>$12.00</span>
                    </div>
                  </>
                )}
                {productItems.length > 0 && (
                  <div style={{ marginTop: '0.75rem', paddingTop: '0.75rem', borderTop: '1px solid var(--stone-200)' }}>
                    <div style={{ fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.5rem' }}>Delivery Method</div>
                    {hasPickupOnly && (
                      <div style={{ fontSize: '0.75rem', color: '#b45309', background: '#fef3c7', padding: '0.5rem 0.75rem', marginBottom: '0.5rem', borderLeft: '3px solid #f59e0b' }}>
                        Your cart contains slabs or prefab countertops which are available for store pickup only.
                      </div>
                    )}
                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.8125rem', cursor: hasPickupOnly ? 'not-allowed' : 'pointer', marginBottom: '0.4rem', opacity: hasPickupOnly ? 0.5 : 1 }}>
                      <input type="radio" name="deliveryMethod" value="shipping" checked={deliveryMethod === 'shipping'}
                        onChange={() => setDeliveryMethod('shipping')} disabled={hasPickupOnly}
                        style={{ cursor: hasPickupOnly ? 'not-allowed' : 'pointer' }} />
                      Ship to Address <span style={{ color: 'var(--stone-600)', fontSize: '0.75rem' }}>(5-10 business days)</span>
                    </label>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.8125rem', cursor: 'pointer', marginBottom: '0.5rem' }}>
                      <input type="radio" name="deliveryMethod" value="pickup" checked={deliveryMethod === 'pickup'}
                        onChange={() => { setDeliveryMethod('pickup'); setShippingEstimate(null); setSelectedShippingOption(null); }}
                        style={{ cursor: 'pointer' }} />
                      Store Pickup  Free <span style={{ color: 'var(--stone-600)', fontSize: '0.75rem' }}>(up to 5 business days)</span>
                    </label>

                    {deliveryMethod === 'pickup' && (
                      <div className="order-summary-row" style={{ marginTop: '0.5rem' }}>
                        <span>Shipping</span>
                        <span style={{ color: '#16a34a', fontWeight: 500 }}>FREE</span>
                      </div>
                    )}

                    {deliveryMethod === 'shipping' && (
                      <>
                        <div style={{ fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.5rem', marginTop: '0.5rem' }}>Estimate Shipping</div>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <input
                            className="checkout-input"
                            style={{ flex: 1, padding: '0.6rem 0.75rem', fontSize: '0.875rem' }}
                            type="text"
                            placeholder="ZIP Code"
                            value={shippingZip}
                            onChange={e => setShippingZip(e.target.value.replace(/\D/g, '').slice(0, 5))}
                            onKeyDown={e => e.key === 'Enter' && fetchShippingEstimate()}
                            maxLength={5}
                          />
                          <button
                            className="btn"
                            style={{ padding: '0.6rem 1rem', fontSize: '0.75rem' }}
                            onClick={fetchShippingEstimate}
                            disabled={shippingLoading || shippingZip.length < 5}
                          >
                            {shippingLoading ? '...' : 'Get Rate'}
                          </button>
                        </div>
                        {shippingError && (
                          <div style={{ fontSize: '0.75rem', color: '#dc2626', marginTop: '0.4rem' }}>{shippingError}</div>
                        )}
                        {shippingEstimate && shippingEstimate.options && shippingEstimate.options.length > 0 && shippingEstimate.options[0].amount > 0 && (
                          <div style={{ marginTop: '0.5rem' }}>
                            <div style={{ fontSize: '0.75rem', fontWeight: 500, marginBottom: '0.4rem', color: 'var(--stone-700)' }}>
                              {shippingEstimate.method === 'ltl_freight' ? 'LTL Freight Options' : 'Shipping'}
                            </div>
                            {shippingEstimate.options.map(opt => (
                              <label key={opt.id} onClick={() => setSelectedShippingOption(opt)}
                                style={{
                                  display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.6rem 0.75rem',
                                  marginBottom: '0.35rem', cursor: 'pointer', fontSize: '0.8125rem',
                                  border: selectedShippingOption && selectedShippingOption.id === opt.id ? '2px solid var(--gold)' : '1px solid var(--stone-200)',
                                  borderRadius: '6px', background: selectedShippingOption && selectedShippingOption.id === opt.id ? '#fefce8' : 'white',
                                  transition: 'border-color 0.15s'
                                }}>
                                <input type="radio" name="shippingOption" checked={selectedShippingOption && selectedShippingOption.id === opt.id}
                                  onChange={() => setSelectedShippingOption(opt)} style={{ cursor: 'pointer' }} />
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                                    <span style={{ fontWeight: 500 }}>{opt.carrier}</span>
                                    {opt.service && opt.service !== opt.carrier && <span style={{ color: 'var(--stone-600)', fontSize: '0.75rem' }}>{opt.service}</span>}
                                    {opt.is_cheapest && <span style={{ background: '#dcfce7', color: '#166534', fontSize: '0.625rem', fontWeight: 600, padding: '0.1rem 0.35rem', borderRadius: '3px' }}>Best Price</span>}
                                  </div>
                                  {opt.transit_days && (
                                    <div style={{ fontSize: '0.7rem', color: 'var(--stone-600)', marginTop: '0.15rem' }}>
                                      Est. {opt.transit_days} business day{opt.transit_days !== 1 ? 's' : ''}
                                    </div>
                                  )}
                                </div>
                                <span style={{ fontWeight: 600, whiteSpace: 'nowrap' }}>${opt.amount.toFixed(2)}</span>
                              </label>
                            ))}
                            {shippingEstimate.options.some(o => o.is_fallback) && (
                              <div style={{ fontSize: '0.7rem', color: '#b45309', background: '#fef3c7', padding: '0.4rem 0.6rem', marginTop: '0.25rem', borderRadius: '4px' }}>
                                Estimated rate. Final rate calculated at confirmation.
                              </div>
                            )}
                          </div>
                        )}
                        {shippingEstimate && shippingEstimate.options && shippingEstimate.options.length > 0 && shippingEstimate.options[0].amount === 0 && shippingEstimate.method === null && (
                          <div className="order-summary-row muted" style={{ marginTop: '0.5rem' }}>
                            <span>Shipping</span>
                            <span>$0.00</span>
                          </div>
                        )}
                        {!shippingEstimate && !shippingLoading && !shippingError && (
                          <div style={{ fontSize: '0.75rem', color: 'var(--stone-600)', marginTop: '0.4rem' }}>
                            Enter zip for shipping estimate
                          </div>
                        )}
                        {shippingEstimate && shippingEstimate.weight_lbs > 0 && (
                          <div style={{ fontSize: '0.7rem', color: 'var(--stone-600)', marginTop: '0.25rem' }}>
                            Est. weight: {shippingEstimate.weight_lbs} lbs ({shippingEstimate.total_boxes} box{shippingEstimate.total_boxes !== 1 ? 'es' : ''})
                          </div>
                        )}
                        {shippingEstimate && shippingEstimate.method === 'ltl_freight' && (
                          <label style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.75rem', color: 'var(--stone-600)', marginTop: '0.4rem', cursor: 'pointer' }}>
                            <input type="checkbox" checked={liftgateEnabled} onChange={e => {
                              setLiftgateEnabled(e.target.checked);
                              setShippingEstimate(null);
                              setSelectedShippingOption(null);
                            }} />
                            Liftgate delivery (residential)
                          </label>
                        )}
                      </>
                    )}
                  </div>
                )}
                {/* Promo Code */}
                <div style={{ borderTop: '1px solid var(--stone-200)', marginTop: '0.75rem', paddingTop: '0.75rem' }}>
                  {promoResult ? (
                    <div>
                      <div className="order-summary-row" style={{ color: '#16a34a' }}>
                        <span style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                          <span style={{ background: '#dcfce7', color: '#166534', padding: '0.15rem 0.5rem', borderRadius: '4px', fontSize: '0.75rem', fontWeight: 600 }}>{promoResult.code}</span>
                          <a onClick={removePromo} style={{ fontSize: '0.75rem', color: 'var(--stone-500)', cursor: 'pointer', textDecoration: 'underline' }}>Remove</a>
                        </span>
                        <span style={{ fontWeight: 500 }}>-${promoDiscount.toFixed(2)}</span>
                      </div>
                      {promoResult.description && (
                        <div style={{ fontSize: '0.7rem', color: 'var(--stone-500)', marginTop: '0.15rem' }}>{promoResult.description}</div>
                      )}
                    </div>
                  ) : (
                    <div>
                      <div style={{ display: 'flex', gap: '0.5rem' }}>
                        <input type="text" value={promoCode} onChange={e => { setPromoCode(e.target.value.toUpperCase()); setPromoError(''); }}
                          placeholder="Promo code" onKeyDown={e => e.key === 'Enter' && applyPromoCode()}
                          style={{ flex: 1, padding: '0.5rem 0.6rem', border: '1px solid var(--stone-300)', borderRadius: '4px', fontSize: '0.8rem', fontFamily: "'Inter', sans-serif" }} />
                        <button onClick={() => applyPromoCode()} disabled={promoLoading || !promoCode.trim()}
                          style={{ padding: '0.5rem 0.75rem', background: 'var(--stone-800)', color: 'white', border: 'none', borderRadius: '4px', fontSize: '0.8rem', cursor: 'pointer', opacity: promoLoading || !promoCode.trim() ? 0.5 : 1 }}>
                          {promoLoading ? '...' : 'Apply'}
                        </button>
                      </div>
                      {promoError && <div style={{ color: '#dc2626', fontSize: '0.75rem', marginTop: '0.3rem' }}>{promoError}</div>}
                    </div>
                  )}
                </div>
                <div className="order-summary-total">
                  <span>{selectedShippingOption ? 'Estimated Total' : 'Subtotal'}</span>
                  <span>${cartTotal.toFixed(2)}</span>
                </div>
                <button className="btn" style={{ width: '100%', marginTop: '1rem' }} onClick={goCheckout}>
                  Proceed to Checkout
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function CheckoutPage({ cart, sessionId, goCart, handleOrderComplete, deliveryMethod, tradeCustomer, tradeToken, customer, customerToken, onCustomerLogin, appliedPromoCode, setAppliedPromoCode }) {
      const [customerName, setCustomerName] = useState(
        tradeCustomer ? tradeCustomer.contact_name : (customer ? (customer.first_name + ' ' + customer.last_name) : '')
      );
      const [customerEmail, setCustomerEmail] = useState(
        tradeCustomer ? tradeCustomer.email : (customer ? customer.email : '')
      );
      const [phone, setPhone] = useState(
        tradeCustomer ? (tradeCustomer.phone || '') : (customer ? (customer.phone || '') : '')
      );
      const [line1, setLine1] = useState(customer ? (customer.address_line1 || '') : '');
      const [line2, setLine2] = useState(customer ? (customer.address_line2 || '') : '');
      const [city, setCity] = useState(customer ? (customer.city || '') : '');
      const [state, setState] = useState(customer ? (customer.state || '') : '');
      const [zip, setZip] = useState(customer ? (customer.zip || '') : '');
      const [createAccount, setCreateAccount] = useState(false);
      const [accountPassword, setAccountPassword] = useState('');
      const [confirmAccountPassword, setConfirmAccountPassword] = useState('');
      const [poNumber, setPoNumber] = useState('');
      const [projectId, setProjectId] = useState('');
      const [tradeProjects, setTradeProjects] = useState([]);
      const [error, setError] = useState('');
      const [processing, setProcessing] = useState(false);
      const [shippingEstimate, setShippingEstimate] = useState(null);
      const [shippingLoading, setShippingLoading] = useState(false);
      const [selectedOption, setSelectedOption] = useState(null);
      const shippingFetchedRef = useRef('');
      const cardRef = useRef(null);
      const cardMounted = useRef(false);
      const [promoCode, setPromoCode] = useState(appliedPromoCode || '');
      const [promoResult, setPromoResult] = useState(null);
      const [promoLoading, setPromoLoading] = useState(false);
      const [promoError, setPromoError] = useState('');

      const isTrade = !!tradeCustomer;
      const isTaxExempt = isTrade && tradeCustomer.subscription_status === 'active';

      useEffect(() => {
        if (isTrade && tradeToken) {
          fetch(API + '/api/trade/projects', { headers: { 'X-Trade-Token': tradeToken } })
            .then(r => r.json()).then(data => setTradeProjects(data.projects || [])).catch(() => {});
        }
      }, [isTrade]);

      // Auto-validate promo on mount if carried from cart
      useEffect(() => {
        if (appliedPromoCode && !promoResult) {
          applyCheckoutPromo(appliedPromoCode);
        }
      }, []);

      const applyCheckoutPromo = (codeOverride) => {
        const code = codeOverride || promoCode.trim();
        if (!code) return;
        setPromoLoading(true);
        setPromoError('');
        fetch(API + '/api/promo-codes/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, session_id: sessionId })
        })
          .then(r => r.json())
          .then(data => {
            if (data.valid) {
              setPromoResult(data);
              setPromoError('');
              setAppliedPromoCode(data.code);
              setPromoCode(data.code);
            } else {
              setPromoResult(null);
              setPromoError(data.error || 'Invalid promo code');
              setAppliedPromoCode(null);
            }
            setPromoLoading(false);
          })
          .catch(() => { setPromoError('Unable to validate promo code'); setPromoLoading(false); });
      };

      const removeCheckoutPromo = () => {
        setPromoResult(null);
        setPromoCode('');
        setPromoError('');
        setAppliedPromoCode(null);
      };

      const isPickup = deliveryMethod === 'pickup';
      const productItems = cart.filter(i => !i.is_sample);
      const sampleItems = cart.filter(i => i.is_sample);
      const productSubtotal = productItems.reduce((sum, i) => sum + parseFloat(i.subtotal || 0), 0);
      const sampleShipping = sampleItems.length > 0 ? 12 : 0;
      const productShipping = isPickup ? 0 : (selectedOption ? selectedOption.amount : 0);
      const checkoutPromoDiscount = promoResult ? promoResult.discount_amount : 0;
      const cartTotal = productSubtotal + productShipping + sampleShipping - checkoutPromoDiscount;

      // Fetch shipping estimate when zip + state are filled (only for shipping)
      useEffect(() => {
        if (isPickup) return;
        if (zip.length >= 5 && state && productItems.length > 0) {
          const key = zip + '-' + state + '-' + city;
          if (shippingFetchedRef.current === key) return;
          shippingFetchedRef.current = key;
          setShippingLoading(true);
          setSelectedOption(null);
          fetch(API + '/api/shipping/estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, destination: { zip, city, state }, residential: true, liftgate: true })
          })
            .then(r => r.json())
            .then(data => {
              if (!data.error) {
                setShippingEstimate(data);
                const opts = data.options || [];
                const cheapest = opts.find(o => o.is_cheapest) || opts[0];
                setSelectedOption(cheapest || null);
              }
              setShippingLoading(false);
            })
            .catch(() => setShippingLoading(false));
        }
      }, [zip, state, city, isPickup]);

      useEffect(() => {
        if (cardMounted.current) return;
        const elements = stripePromise.elements();
        const card = elements.create('card', {
          style: {
            base: {
              fontFamily: "'Inter', sans-serif",
              fontSize: '15px',
              color: '#292524',
              '::placeholder': { color: '#57534e' }
            }
          }
        });
        card.mount('#card-element');
        cardRef.current = card;
        cardMounted.current = true;
        return () => {
          if (cardRef.current) {
            cardRef.current.unmount();
            cardMounted.current = false;
          }
        };
      }, []);

      const US_STATES = [
        'AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY',
        'LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND',
        'OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'
      ];

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (!customerName || !customerEmail || !phone || phone.replace(/\D/g, '').length < 10) {
          setError('Please fill in all required fields, including a valid phone number.');
          return;
        }
        if (!isPickup && (!line1 || !city || !state || !zip)) {
          setError('Please fill in all required shipping fields.');
          return;
        }
        if (createAccount && !customer) {
          if (!accountPassword || accountPassword.length < 8 || !/[A-Z]/.test(accountPassword) || !/[0-9]/.test(accountPassword)) {
            setError('Account password must be at least 8 characters with 1 uppercase letter and 1 number.');
            return;
          }
          if (accountPassword !== confirmAccountPassword) {
            setError('Passwords do not match.');
            return;
          }
        }

        setProcessing(true);

        try {
          // 1. Create payment intent (include destination for shipping calc)
          const piBody = { session_id: sessionId, delivery_method: deliveryMethod };
          if (!isPickup) {
            piBody.destination = { zip, city, state };
            piBody.residential = true;
            piBody.liftgate = true;
            if (selectedOption) piBody.shipping_option_id = selectedOption.id;
          }
          if (promoResult) piBody.promo_code = promoResult.code;
          const piRes = await fetch(API + '/api/checkout/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(piBody)
          });
          const piData = await piRes.json();
          if (piData.error) {
            setError(piData.error);
            setProcessing(false);
            return;
          }

          // 2. Confirm card payment
          const { error: stripeError, paymentIntent } = await stripePromise.confirmCardPayment(
            piData.clientSecret, {
              payment_method: {
                card: cardRef.current,
                billing_details: {
                  name: customerName,
                  email: customerEmail,
                }
              }
            }
          );

          if (stripeError) {
            setError(stripeError.message);
            setProcessing(false);
            return;
          }

          // 3. Place order
          const orderBody = {
            session_id: sessionId,
            payment_intent_id: paymentIntent.id,
            customer_name: customerName,
            customer_email: customerEmail,
            phone: phone,
            delivery_method: deliveryMethod,
            shipping: isPickup ? null : { line1, line2, city, state, zip },
            residential: true,
            liftgate: true,
            ...(selectedOption ? { shipping_option_id: selectedOption.id } : {})
          };
          if (promoResult) orderBody.promo_code = promoResult.code;
          if (isTrade) {
            orderBody.trade_customer_id = tradeCustomer.id;
            if (poNumber) orderBody.po_number = poNumber;
            if (projectId) orderBody.project_id = projectId;
            orderBody.is_tax_exempt = isTaxExempt;
          }
          if (createAccount && !customer && accountPassword) {
            orderBody.create_account = true;
            orderBody.account_password = accountPassword;
          }
          const orderHeaders = { 'Content-Type': 'application/json' };
          if (tradeToken) orderHeaders['X-Trade-Token'] = tradeToken;
          if (customerToken) orderHeaders['X-Customer-Token'] = customerToken;
          const orderRes = await fetch(API + '/api/checkout/place-order', {
            method: 'POST',
            headers: orderHeaders,
            body: JSON.stringify(orderBody)
          });
          const orderData = await orderRes.json();
          if (orderData.error) {
            setError(orderData.error);
            setProcessing(false);
            return;
          }

          // Auto-login if account was created at checkout
          if (orderData.customer_token && orderData.customer && onCustomerLogin) {
            onCustomerLogin(orderData.customer_token, orderData.customer);
          }

          handleOrderComplete(orderData.order);
        } catch (err) {
          setError(err.message || 'Something went wrong. Please try again.');
          setProcessing(false);
        }
      };

      return (
        <div className="checkout-page">
          <h1>Checkout</h1>

          <form className="checkout-form" onSubmit={handleSubmit}>
            {error && <div className="checkout-error">{error}</div>}

            {isTrade && (
              <div className="checkout-section">
                <h3>Trade Order Details</h3>
                {isTaxExempt && (
                  <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem', color: '#166534' }}>
                    Tax Exempt  Trade membership active
                  </div>
                )}
                <div className="checkout-row">
                  <div className="checkout-field">
                    <label>PO Number (optional)</label>
                    <input className="checkout-input" value={poNumber}
                      onChange={e => setPoNumber(e.target.value)} placeholder="PO-12345" />
                  </div>
                  <div className="checkout-field">
                    <label>Assign to Project</label>
                    <select className="checkout-input" value={projectId} onChange={e => setProjectId(e.target.value)}
                      style={{ padding: '0.65rem 0.75rem' }}>
                      <option value="">None</option>
                      {tradeProjects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </select>
                  </div>
                </div>
              </div>
            )}

            <div className="checkout-section">
              <h3>Contact Information</h3>
              <div className="checkout-row">
                <div className="checkout-field">
                  <label>Full Name *</label>
                  <input className="checkout-input" value={customerName}
                    onChange={e => setCustomerName(e.target.value)} placeholder="John Smith" />
                </div>
                <div className="checkout-field">
                  <label>Email *</label>
                  <input className="checkout-input" type="email" value={customerEmail}
                    onChange={e => setCustomerEmail(e.target.value)} placeholder="john@example.com" />
                </div>
              </div>
              <div className="checkout-field">
                <label>Phone *</label>
                <input className="checkout-input" type="tel" value={phone}
                  onChange={e => {
                    const digits = e.target.value.replace(/\D/g, '').slice(0, 10);
                    let formatted = '';
                    if (digits.length > 0) formatted = '(' + digits.slice(0, 3);
                    if (digits.length >= 3) formatted += ') ';
                    if (digits.length > 3) formatted += digits.slice(3, 6);
                    if (digits.length >= 6) formatted += '-' + digits.slice(6);
                    setPhone(formatted);
                  }} placeholder="(555) 123-4567" />
              </div>
              {!customer && !isTrade && (
                <div style={{ marginTop: '1rem' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer', fontSize: '0.875rem', color: 'var(--stone-800)' }}>
                    <input type="checkbox" checked={createAccount} onChange={e => setCreateAccount(e.target.checked)} />
                    Create an account for order tracking
                  </label>
                  {createAccount && (
                    <div style={{ marginTop: '0.75rem', padding: '1rem', background: 'var(--stone-50)', border: '1px solid var(--stone-200)' }}>
                      <div className="checkout-row">
                        <div className="checkout-field">
                          <label>Password *</label>
                          <input className="checkout-input" type="password" value={accountPassword}
                            onChange={e => setAccountPassword(e.target.value)} placeholder="Min 8 chars, 1 uppercase, 1 number" />
                        </div>
                        <div className="checkout-field">
                          <label>Confirm Password *</label>
                          <input className="checkout-input" type="password" value={confirmAccountPassword}
                            onChange={e => setConfirmAccountPassword(e.target.value)} placeholder="Confirm password" />
                        </div>
                      </div>
                      <p style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginTop: '0.4rem' }}>
                        8+ characters, 1 uppercase letter, 1 number
                      </p>
                    </div>
                  )}
                </div>
              )}
            </div>

            {isPickup ? (
              <div className="checkout-section">
                <h3>Store Pickup</h3>
                <div style={{ background: 'var(--stone-100)', padding: '1.25rem', fontSize: '0.875rem', lineHeight: 1.6 }}>
                  <div style={{ fontWeight: 500, marginBottom: '0.5rem' }}>Pickup Location</div>
                  <div>Roma Flooring Designs</div>
                  <div>1440 S. State College Blvd., Suite 6M</div>
                  <div>Anaheim, CA 92806</div>
                  <div style={{ marginTop: '0.75rem', color: 'var(--stone-600)', fontSize: '0.8125rem' }}>
                    Your order will be ready for pickup within 5 business days. We will send a confirmation email when your order is ready.
                  </div>
                </div>
              </div>
            ) : (
              <div className="checkout-section">
                <h3>Shipping Address</h3>
                <div className="checkout-field">
                  <label>Address Line 1 *</label>
                  <input className="checkout-input" value={line1}
                    onChange={e => setLine1(e.target.value)} placeholder="123 Main Street" />
                </div>
                <div className="checkout-field">
                  <label>Address Line 2</label>
                  <input className="checkout-input" value={line2}
                    onChange={e => setLine2(e.target.value)} placeholder="Apt, Suite, Unit" />
                </div>
                <div className="checkout-row-3">
                  <div className="checkout-field">
                    <label>City *</label>
                    <input className="checkout-input" value={city}
                      onChange={e => setCity(e.target.value)} placeholder="New York" />
                  </div>
                  <div className="checkout-field">
                    <label>State *</label>
                    <select className="checkout-input" value={state} onChange={e => setState(e.target.value)}>
                      <option value="">Select</option>
                      {US_STATES.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                  </div>
                  <div className="checkout-field">
                    <label>ZIP Code *</label>
                    <input className="checkout-input" value={zip}
                      onChange={e => setZip(e.target.value)} placeholder="10001" />
                  </div>
                </div>
              </div>
            )}

            {!isPickup && shippingEstimate && shippingEstimate.options && shippingEstimate.options.length > 1 && (
              <div className="checkout-section">
                <h3>Shipping Option</h3>
                {shippingEstimate.options.map(opt => (
                  <label key={opt.id} onClick={() => setSelectedOption(opt)}
                    style={{
                      display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.75rem 1rem',
                      marginBottom: '0.4rem', cursor: 'pointer', fontSize: '0.875rem',
                      border: selectedOption && selectedOption.id === opt.id ? '2px solid var(--gold)' : '1px solid var(--stone-200)',
                      borderRadius: '6px', background: selectedOption && selectedOption.id === opt.id ? '#fefce8' : 'white'
                    }}>
                    <input type="radio" name="checkoutShipping" checked={selectedOption && selectedOption.id === opt.id}
                      onChange={() => setSelectedOption(opt)} style={{ cursor: 'pointer' }} />
                    <div style={{ flex: 1 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                        <span style={{ fontWeight: 500 }}>{opt.carrier}</span>
                        {opt.service && opt.service !== opt.carrier && <span style={{ color: 'var(--stone-600)', fontSize: '0.8rem' }}>{opt.service}</span>}
                        {opt.is_cheapest && <span style={{ background: '#dcfce7', color: '#166534', fontSize: '0.675rem', fontWeight: 600, padding: '0.1rem 0.4rem', borderRadius: '3px' }}>Best Price</span>}
                      </div>
                      {opt.transit_days && (
                        <div style={{ fontSize: '0.75rem', color: 'var(--stone-600)', marginTop: '0.15rem' }}>
                          Est. {opt.transit_days} business day{opt.transit_days !== 1 ? 's' : ''}
                        </div>
                      )}
                    </div>
                    <span style={{ fontWeight: 600, whiteSpace: 'nowrap' }}>${opt.amount.toFixed(2)}</span>
                  </label>
                ))}
                {shippingEstimate.options.some(o => o.is_fallback) && (
                  <div style={{ fontSize: '0.75rem', color: '#b45309', background: '#fef3c7', padding: '0.5rem 0.75rem', marginTop: '0.25rem', borderRadius: '4px' }}>
                    Estimated rate. Final rate calculated at confirmation.
                  </div>
                )}
              </div>
            )}

            <div className="checkout-section">
              <h3>Payment</h3>
              <div className="checkout-field">
                <label>Card Details</label>
                <div id="card-element" className="stripe-element"></div>
              </div>
            </div>

            <button type="submit" className="checkout-btn" disabled={processing || shippingLoading}>
              {processing && <span className="checkout-spinner"></span>}
              {processing ? 'Processing...' : `Place Order - $${cartTotal.toFixed(2)}`}
            </button>
          </form>

          <div className="order-summary">
            <h3>Order Summary</h3>
            {cart.map(item => (
              <div key={item.id} className="order-summary-row" style={{ fontSize: '0.875rem' }}>
                <span>
                  {item.product_name || 'Product'}
                  {item.is_sample ? ' (Sample)' : ` x ${item.num_boxes} bx`}
                </span>
                <span>{item.is_sample ? 'FREE' : '$' + parseFloat(item.subtotal).toFixed(2)}</span>
              </div>
            ))}
            {productItems.length > 0 && (
              <div className="order-summary-row" style={{ borderTop: '1px solid var(--stone-200)', marginTop: '0.5rem', paddingTop: '0.75rem' }}>
                <span>Subtotal</span>
                <span>${productSubtotal.toFixed(2)}</span>
              </div>
            )}
            {productItems.length > 0 && (
              <div className="order-summary-row muted">
                <span>
                  {isPickup ? 'Shipping (Store Pickup)' : (
                    <>Shipping{selectedOption && selectedOption.carrier && (
                      <span> via {selectedOption.carrier}</span>
                    )}
                    {selectedOption && selectedOption.transit_days && (
                      <span style={{ fontSize: '0.7rem', color: 'var(--stone-500)' }}> ({selectedOption.transit_days} day{selectedOption.transit_days !== 1 ? 's' : ''})</span>
                    )}</>
                  )}
                </span>
                <span>
                  {isPickup ? <span style={{ color: '#16a34a', fontWeight: 500 }}>FREE</span> :
                    shippingLoading ? '...' :
                    selectedOption ? '$' + productShipping.toFixed(2) :
                    'Enter address'}
                </span>
              </div>
            )}
            {selectedOption && selectedOption.is_fallback && (
              <div style={{ fontSize: '0.7rem', color: '#b45309', padding: '0.25rem 0' }}>
                Estimated rate. Final rate calculated at confirmation.
              </div>
            )}
            {sampleItems.length > 0 && (
              <div className="order-summary-row muted">
                <span>Sample Shipping</span>
                <span>$12.00</span>
              </div>
            )}
            {/* Promo Code in Checkout */}
            <div style={{ borderTop: '1px solid var(--stone-200)', marginTop: '0.5rem', paddingTop: '0.5rem' }}>
              {promoResult ? (
                <div className="order-summary-row" style={{ color: '#16a34a' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                    <span style={{ background: '#dcfce7', color: '#166534', padding: '0.15rem 0.5rem', borderRadius: '4px', fontSize: '0.75rem', fontWeight: 600 }}>{promoResult.code}</span>
                    <a onClick={removeCheckoutPromo} style={{ fontSize: '0.75rem', color: 'var(--stone-500)', cursor: 'pointer', textDecoration: 'underline' }}>Remove</a>
                  </span>
                  <span style={{ fontWeight: 500 }}>-${checkoutPromoDiscount.toFixed(2)}</span>
                </div>
              ) : (
                <div>
                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                    <input type="text" value={promoCode} onChange={e => { setPromoCode(e.target.value.toUpperCase()); setPromoError(''); }}
                      placeholder="Promo code" onKeyDown={e => e.key === 'Enter' && applyCheckoutPromo()}
                      style={{ flex: 1, padding: '0.4rem 0.5rem', border: '1px solid var(--stone-300)', borderRadius: '4px', fontSize: '0.8rem', fontFamily: "'Inter', sans-serif" }} />
                    <button onClick={() => applyCheckoutPromo()} disabled={promoLoading || !promoCode.trim()}
                      style={{ padding: '0.4rem 0.6rem', background: 'var(--stone-800)', color: 'white', border: 'none', borderRadius: '4px', fontSize: '0.8rem', cursor: 'pointer', opacity: promoLoading || !promoCode.trim() ? 0.5 : 1 }}>
                      {promoLoading ? '...' : 'Apply'}
                    </button>
                  </div>
                  {promoError && <div style={{ color: '#dc2626', fontSize: '0.75rem', marginTop: '0.3rem' }}>{promoError}</div>}
                </div>
              )}
            </div>
            <div className="order-summary-total">
              <span>Total</span>
              <span>${cartTotal.toFixed(2)}</span>
            </div>
            <a className="back-btn" onClick={goCart} style={{ marginTop: '1rem', display: 'inline-block' }}>
               Back to Cart
            </a>
          </div>
        </div>
      );
    }

    function ConfirmationPage({ order, goHome }) {
      if (!order) return null;

      const items = order.items || [];
      const productItems = items.filter(i => !i.is_sample);
      const sampleItems = items.filter(i => i.is_sample);

      return (
        <div className="confirmation-page">
          <div className="confirmation-check">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </div>
          <h1>Order Confirmed</h1>
          <div className="confirmation-order-number">
            Order number: <strong>{order.order_number}</strong>
          </div>

          <div className="confirmation-details">
            <h3>Items Ordered</h3>
            {items.map((item, idx) => (
              <div key={idx} className="confirmation-item">
                <span>
                  {item.product_name || 'Product'}
                  {item.is_sample && ' (Sample)'}
                  {!item.is_sample && ` - ${item.num_boxes} box${item.num_boxes !== 1 ? 'es' : ''}`}
                </span>
                <span style={{ fontWeight: 500 }}>
                  {item.is_sample ? 'FREE' : '$' + parseFloat(item.subtotal || 0).toFixed(2)}
                </span>
              </div>
            ))}
            {productItems.length > 0 && (
              <div className="confirmation-item" style={{ color: 'var(--stone-600)' }}>
                <span>Subtotal</span>
                <span>${parseFloat(order.subtotal || 0).toFixed(2)}</span>
              </div>
            )}
            {order.delivery_method === 'pickup' ? (
              <div className="confirmation-item" style={{ color: '#16a34a' }}>
                <span>Shipping (Store Pickup)</span>
                <span style={{ fontWeight: 500 }}>FREE</span>
              </div>
            ) : parseFloat(order.shipping || 0) > 0 ? (
              <div className="confirmation-item" style={{ color: 'var(--stone-600)' }}>
                <span>Shipping ({order.shipping_method === 'ltl_freight' ? 'LTL Freight' : 'Parcel'})</span>
                <span>${parseFloat(order.shipping).toFixed(2)}</span>
              </div>
            ) : null}
            {parseFloat(order.sample_shipping || 0) > 0 && (
              <div className="confirmation-item" style={{ color: 'var(--stone-600)' }}>
                <span>Sample Shipping</span>
                <span>${parseFloat(order.sample_shipping).toFixed(2)}</span>
              </div>
            )}
            {parseFloat(order.discount_amount || 0) > 0 && (
              <div className="confirmation-item" style={{ color: '#16a34a' }}>
                <span>Discount{order.promo_code ? ` (${order.promo_code})` : ''}</span>
                <span>-${parseFloat(order.discount_amount).toFixed(2)}</span>
              </div>
            )}
            <div className="confirmation-item" style={{ fontWeight: 600 }}>
              <span>Total</span>
              <span>${parseFloat(order.total || 0).toFixed(2)}</span>
            </div>
          </div>

          <div className="confirmation-details">
            {order.delivery_method === 'pickup' ? (
              <>
                <h3>Store Pickup</h3>
                <div className="confirmation-address">
                  <div style={{ fontWeight: 500 }}>Roma Flooring Designs</div>
                  <div>1440 S. State College Blvd., Suite 6M</div>
                  <div>Anaheim, CA 92806</div>
                  <div style={{ marginTop: '0.75rem', color: 'var(--stone-600)', fontSize: '0.875rem' }}>
                    Ready for pickup within 5 business days. We will email {order.customer_email} when your order is ready.
                  </div>
                </div>
              </>
            ) : (
              <>
                <h3>Shipping To</h3>
                <div className="confirmation-address">
                  <div>{order.customer_name}</div>
                  <div>{order.shipping_address_line1}</div>
                  {order.shipping_address_line2 && <div>{order.shipping_address_line2}</div>}
                  <div>{order.shipping_city}, {order.shipping_state} {order.shipping_zip}</div>
                  {order.customer_email && <div style={{ marginTop: '0.5rem' }}>{order.customer_email}</div>}
                  <div style={{ marginTop: '0.5rem', color: 'var(--stone-600)', fontSize: '0.875rem' }}>
                    Estimated delivery: 5-10 business days
                  </div>
                </div>
              </>
            )}
          </div>

          <button className="btn" onClick={goHome} style={{ marginTop: '1rem' }}>
            Continue Shopping
          </button>
        </div>
      );
    }

    function TradeModal({ onClose, onLogin, initialMode }) {
      const [mode, setMode] = useState(initialMode || 'login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [companyName, setCompanyName] = useState('');
      const [contactName, setContactName] = useState('');
      const [phone, setPhone] = useState('');
      const [businessType, setBusinessType] = useState('');
      const [addressLine1, setAddressLine1] = useState('');
      const [city, setCity] = useState('');
      const [addrState, setAddrState] = useState('');
      const [zip, setZip] = useState('');
      const [contractorLicense, setContractorLicense] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [loading, setLoading] = useState(false);
      // Multi-step: 1=company, 2=documents, 3=payment, 4=submit
      const [step, setStep] = useState(1);
      const [docs, setDocs] = useState({ ein: null, resale_cert: null, business_card: null });
      const [docUploads, setDocUploads] = useState({}); // { doc_type: { id, file_name } }
      const [uploading, setUploading] = useState('');
      const [setupIntentSecret, setSetupIntentSecret] = useState(null);
      const cardRef = useRef(null);
      const cardMounted = useRef(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setError(''); setSuccess(''); setLoading(true);
        try {
          const resp = await fetch(API + '/api/trade/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          onLogin(data.token, data.customer);
        } catch (err) {
          setError('Network error. Please try again.');
        }
        setLoading(false);
      };

      const formatPhone = (val) => {
        const digits = val.replace(/\D/g, '').slice(0, 10);
        if (digits.length === 0) return '';
        if (digits.length <= 3) return '(' + digits;
        if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
        return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
      };

      const handlePhoneChange = (e) => {
        setPhone(formatPhone(e.target.value));
      };

      const passwordValid = password.length >= 8 && /[A-Z]/.test(password) && /[0-9]/.test(password);
      const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      const [emailTouched, setEmailTouched] = useState(false);

      // Step 1 -> Step 2: validate company info
      const goStep2 = () => {
        if (!companyName || !contactName || !email || !password || !businessType || !phone || !addressLine1 || !city || !addrState || !zip) {
          setError('Please fill in all required fields.');
          return;
        }
        if (!emailValid) { setError('Please enter a valid email address.'); return; }
        if (phone.replace(/\D/g, '').length < 10) { setError('Please enter a valid 10-digit phone number.'); return; }
        if (!passwordValid) { setError('Password must be at least 8 characters with one uppercase letter and one number.'); return; }
        if (password !== confirmPassword) { setError('Passwords do not match.'); return; }
        setError('');
        setStep(2);
      };

      // Upload document
      const handleDocUpload = async (docType, file) => {
        if (!file) return;
        setUploading(docType);
        setError('');
        try {
          const formData = new FormData();
          formData.append('document', file);
          formData.append('doc_type', docType);
          formData.append('email', email);
          const resp = await fetch(API + '/api/trade/register/upload', { method: 'POST', body: formData });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error || 'Upload failed'); setUploading(''); return; }
          setDocUploads(prev => ({ ...prev, [docType]: { id: data.document_id, file_name: file.name } }));
        } catch (err) {
          setError('Upload failed. Please try again.');
        }
        setUploading('');
      };

      // Step 2 -> Step 3: validate docs
      const goStep3 = async () => {
        if (!docUploads.ein || !docUploads.resale_cert || !docUploads.business_card) {
          setError('EIN certificate, Resale Certificate, and Business Card are required.');
          return;
        }
        setError('');
        setLoading(true);
        try {
          const resp = await fetch(API + '/api/trade/register/setup-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          setSetupIntentSecret(data.client_secret);
          setStep(3);
        } catch (err) {
          setError('Network error. Please try again.');
        }
        setLoading(false);
      };

      // Mount Stripe card element for step 3
      useEffect(() => {
        if (step === 3 && !cardMounted.current && setupIntentSecret) {
          setTimeout(() => {
            const el = document.getElementById('trade-card-element');
            if (!el) return;
            const elements = stripePromise.elements();
            const card = elements.create('card', {
              style: { base: { fontFamily: "'Inter', sans-serif", fontSize: '15px', color: '#292524', '::placeholder': { color: '#57534e' } } }
            });
            card.mount('#trade-card-element');
            cardRef.current = card;
            cardMounted.current = true;
          }, 100);
        }
        return () => {
          if (cardMounted.current && cardRef.current) {
            cardRef.current.unmount();
            cardMounted.current = false;
          }
        };
      }, [step, setupIntentSecret]);

      // Step 3 -> Submit: confirm SetupIntent + register
      const handleFullRegister = async () => {
        setError('');
        setLoading(true);
        try {
          const { error: stripeError, setupIntent } = await stripePromise.confirmCardSetup(setupIntentSecret, {
            payment_method: { card: cardRef.current, billing_details: { name: contactName, email: email } }
          });
          if (stripeError) { setError(stripeError.message); setLoading(false); return; }

          const docIds = Object.values(docUploads).map(d => d.id);
          const resp = await fetch(API + '/api/trade/register/enhanced', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email, password, company_name: companyName, contact_name: contactName, phone,
              business_type: businessType,
              address_line1: addressLine1, city, state: addrState, zip,
              contractor_license: contractorLicense || null,
              document_ids: docIds,
              stripe_setup_intent_id: setupIntent.id
            })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          setStep(4);
          setSuccess(data.message || 'Application submitted! We will review your application and email you once approved.');
        } catch (err) {
          setError('Registration failed. Please try again.');
        }
        setLoading(false);
      };

      const stepLabels = ['Company', 'Documents', 'Payment', 'Done'];

      const docLabel = (type) => {
        const map = { ein: 'EIN Certificate *', resale_cert: 'Resale Certificate *', business_card: 'Business Card *' };
        return map[type] || type;
      };

      return (
        <div className="trade-modal-overlay" onClick={onClose}>
          <div className="trade-modal" onClick={e => e.stopPropagation()} style={mode === 'register' ? { maxWidth: '480px' } : {}}>
            <button className="trade-modal-close" onClick={onClose}>&times;</button>
            <h2 style={{ fontFamily: "'Cormorant Garamond', serif", marginBottom: '1.5rem' }}>
              {mode === 'login' ? 'Trade Login' : step === 4 ? 'Application Submitted' : 'Trade Registration'}
            </h2>

            {error && <div className="trade-msg trade-msg-error">{error}</div>}
            {success && <div className="trade-msg trade-msg-success">{success}</div>}

            {mode === 'login' ? (
              <form onSubmit={handleLogin}>
                <div className="trade-field">
                  <label>Email</label>
                  <input type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                </div>
                <div className="trade-field">
                  <label>Password</label>
                  <input type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                </div>
                <button className="btn" type="submit" disabled={loading} style={{ width: '100%', marginTop: '0.5rem' }}>
                  {loading ? 'Signing in...' : 'Sign In'}
                </button>
                <div className="trade-toggle">
                  Don't have an account? <a onClick={() => { setMode('register'); setError(''); setSuccess(''); }}>Apply for Trade</a>
                </div>
              </form>
            ) : step === 4 ? (
              <div style={{ textAlign: 'center', padding: '1rem 0' }}>
                <p style={{ color: 'var(--stone-600)', lineHeight: 1.6, marginBottom: '1.5rem' }}>
                  Your application is under review. You'll receive an email once approved.
                </p>
                <button className="btn" onClick={onClose} style={{ width: '100%' }}>Close</button>
              </div>
            ) : (
              <>
                <div className="trade-steps-indicator">
                  {stepLabels.slice(0, 3).map((s, i) => (
                    <div key={s} className={'trade-step-dot' + (step === i + 1 ? ' active' : step > i + 1 ? ' done' : '')}>{s}</div>
                  ))}
                </div>

                {step === 1 && (
                  <div>
                    <div className="trade-field">
                      <label>Company Name *</label>
                      <input type="text" value={companyName} onChange={e => setCompanyName(e.target.value)} autoComplete="organization" />
                    </div>
                    <div className="trade-field">
                      <label>Contact Name *</label>
                      <input type="text" value={contactName} onChange={e => setContactName(e.target.value)} autoComplete="name" />
                    </div>
                    <div className="trade-field">
                      <label>Business Type *</label>
                      <select value={businessType} onChange={e => setBusinessType(e.target.value)}>
                        <option value="">Select...</option>
                        <option value="contractor">General Contractor</option>
                        <option value="interior_designer">Interior Designer</option>
                        <option value="architect">Architect</option>
                        <option value="builder">Builder / Developer</option>
                        <option value="retailer">Flooring Retailer</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                      <div className="trade-field">
                        <label>Email *</label>
                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} onBlur={() => setEmailTouched(true)} autoComplete="email" style={emailTouched && email && !emailValid ? { borderColor: '#dc2626' } : {}} />
                        {emailTouched && email && !emailValid && (
                          <div style={{ fontSize: '0.7rem', marginTop: '0.35rem', color: '#dc2626' }}>Please enter a valid email address</div>
                        )}
                      </div>
                      <div className="trade-field">
                        <label>Phone *</label>
                        <input type="tel" value={phone} onChange={handlePhoneChange} autoComplete="tel" placeholder="(555) 123-4567" />
                      </div>
                    </div>
                    <div className="trade-field">
                      <label>Address *</label>
                      <input type="text" value={addressLine1} onChange={e => setAddressLine1(e.target.value)} autoComplete="address-line1" placeholder="Street address" />
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem' }}>
                      <div className="trade-field">
                        <label>City *</label>
                        <input type="text" value={city} onChange={e => setCity(e.target.value)} autoComplete="address-level2" />
                      </div>
                      <div className="trade-field">
                        <label>State *</label>
                        <input type="text" value={addrState} onChange={e => setAddrState(e.target.value)} maxLength="2" placeholder="CA" style={{ textTransform: 'uppercase' }} autoComplete="address-level1" />
                      </div>
                      <div className="trade-field">
                        <label>Zip *</label>
                        <input type="text" value={zip} onChange={e => setZip(e.target.value)} maxLength="10" placeholder="90210" autoComplete="postal-code" />
                      </div>
                    </div>
                    <div className="trade-field">
                      <label>Password *</label>
                      <input type="password" value={password} onChange={e => setPassword(e.target.value)} autoComplete="new-password" />
                      <div style={{ fontSize: '0.7rem', marginTop: '0.35rem', color: password ? (passwordValid ? '#16a34a' : 'var(--stone-400)') : 'var(--stone-400)' }}>
                        Min 8 characters, one uppercase, one number
                      </div>
                    </div>
                    <div className="trade-field">
                      <label>Confirm Password *</label>
                      <input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} autoComplete="new-password" />
                      {confirmPassword && confirmPassword !== password && (
                        <div style={{ fontSize: '0.7rem', marginTop: '0.35rem', color: '#dc2626' }}>Passwords do not match</div>
                      )}
                    </div>
                    <button className="btn" onClick={goStep2} style={{ width: '100%', marginTop: '0.5rem' }}>Continue</button>
                    <div className="trade-toggle">
                      Already have an account? <a onClick={() => { setMode('login'); setError(''); setSuccess(''); setStep(1); }}>Sign In</a>
                    </div>
                  </div>
                )}

                {step === 2 && (
                  <div>
                    <p style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', marginBottom: '1rem', lineHeight: 1.5 }}>
                      Upload your business documents for verification. EIN, Resale Certificate, and Business Card are required.
                    </p>
                    {['ein', 'resale_cert', 'business_card'].map(docType => (
                      <div key={docType}>
                        <label style={{ display: 'block', fontSize: '0.75rem', textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--stone-500)', marginBottom: '0.35rem' }}>
                          {docLabel(docType)}
                        </label>
                        <div className={'trade-doc-upload' + (docUploads[docType] ? ' uploaded' : '')}
                          onClick={() => { const inp = document.getElementById('doc-' + docType); if (inp) inp.click(); }}>
                          {uploading === docType ? 'Uploading...' : docUploads[docType] ? docUploads[docType].file_name : 'Click to upload'}
                          <input type="file" id={'doc-' + docType} accept=".pdf,.jpg,.jpeg,.png" style={{ display: 'none' }}
                            onChange={e => handleDocUpload(docType, e.target.files[0])} />
                        </div>
                      </div>
                    ))}
                    <div className="trade-field" style={{ marginTop: '0.5rem' }}>
                      <label>Contractor License # (optional)</label>
                      <input type="text" value={contractorLicense} onChange={e => setContractorLicense(e.target.value)} placeholder="e.g. 830966" />
                    </div>
                    <div className="trade-btn-row">
                      <button type="button" className="trade-btn-secondary" onClick={() => setStep(1)}>Back</button>
                      <button className="btn" onClick={goStep3} disabled={loading}>
                        {loading ? 'Setting up...' : 'Continue'}
                      </button>
                    </div>
                  </div>
                )}

                {step === 3 && (
                  <div>
                    <p style={{ fontSize: '0.8125rem', color: 'var(--stone-500)', marginBottom: '1rem', lineHeight: 1.5 }}>
                      Add a payment method for your $99/year trade membership. You won't be charged until approved.
                    </p>
                    <div style={{ border: '1px solid var(--stone-300)', padding: '1rem', marginBottom: '1rem' }}>
                      <div id="trade-card-element"></div>
                    </div>
                    <div className="trade-btn-row">
                      <button type="button" className="trade-btn-secondary" onClick={() => setStep(2)}>Back</button>
                      <button className="btn" onClick={handleFullRegister} disabled={loading}>
                        {loading ? 'Submitting...' : 'Submit Application'}
                      </button>
                    </div>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      );
    }

    // ========== Trade Dashboard ==========
    function TradeDashboard({ tradeCustomer, tradeToken, addToCart, goShop, goBulkOrder, setTradeCustomer, handleTradeLogout }) {
      const [tab, setTab] = useState('overview');
      const [dashData, setDashData] = useState(null);
      const [orders, setOrders] = useState([]);
      const [projects, setProjects] = useState([]);
      const [favorites, setFavorites] = useState([]);
      const [account, setAccount] = useState(null);
      const [loading, setLoading] = useState(true);
      const [membership, setMembership] = useState(null);
      const [rep, setRep] = useState(null);
      const [showProjectForm, setShowProjectForm] = useState(false);
      const [projectForm, setProjectForm] = useState({ name: '', client_name: '', address: '', notes: '' });
      const [editingProject, setEditingProject] = useState(null);
      const [showFavForm, setShowFavForm] = useState(false);
      const [favName, setFavName] = useState('');
      const [expandedOrder, setExpandedOrder] = useState(null);
      const [quotes, setQuotes] = useState([]);
      const [expandedQuote, setExpandedQuote] = useState(null);
      const [quoteDetail, setQuoteDetail] = useState(null);

      const headers = { 'X-Trade-Token': tradeToken, 'Content-Type': 'application/json' };
      const authHeaders = { 'X-Trade-Token': tradeToken };

      const loadTab = (t) => {
        setLoading(true);
        if (t === 'overview') {
          fetch(API + '/api/trade/dashboard', { headers: authHeaders })
            .then(r => r.json()).then(d => { setDashData(d); setLoading(false); }).catch(() => setLoading(false));
        } else if (t === 'orders') {
          Promise.all([
            fetch(API + '/api/trade/orders', { headers: authHeaders }).then(r => r.json()),
            fetch(API + '/api/trade/projects', { headers: authHeaders }).then(r => r.json()).catch(() => ({ projects: [] }))
          ]).then(([od, pd]) => { setOrders(od.orders || []); setProjects(pd.projects || []); setLoading(false); }).catch(() => setLoading(false));
        } else if (t === 'projects') {
          fetch(API + '/api/trade/projects', { headers: authHeaders })
            .then(r => r.json()).then(d => { setProjects(d.projects || []); setLoading(false); }).catch(() => setLoading(false));
        } else if (t === 'favorites') {
          fetch(API + '/api/trade/favorites', { headers: authHeaders })
            .then(r => r.json()).then(d => { setFavorites(d.collections || []); setLoading(false); }).catch(() => setLoading(false));
        } else if (t === 'quotes') {
          fetch(API + '/api/trade/quotes', { headers: authHeaders })
            .then(r => r.json()).then(d => { setQuotes(d.quotes || []); setExpandedQuote(null); setQuoteDetail(null); setLoading(false); }).catch(() => setLoading(false));
        } else if (t === 'account') {
          Promise.all([
            fetch(API + '/api/trade/account', { headers: authHeaders }).then(r => r.json()),
            fetch(API + '/api/trade/membership', { headers: authHeaders }).then(r => r.json()).catch(() => ({})),
            fetch(API + '/api/trade/my-rep', { headers: authHeaders }).then(r => r.json()).catch(() => ({}))
          ]).then(([acc, mem, rp]) => {
            setAccount(acc.customer || acc);
            setMembership(mem);
            setRep(rp.rep || null);
            setLoading(false);
          }).catch(() => setLoading(false));
        }
      };

      useEffect(() => { loadTab(tab); }, [tab]);

      const switchTab = (t) => { setTab(t); };

      const saveProject = async () => {
        const method = editingProject ? 'PUT' : 'POST';
        const url = editingProject ? API + '/api/trade/projects/' + editingProject : API + '/api/trade/projects';
        await fetch(url, { method, headers, body: JSON.stringify(projectForm) });
        setShowProjectForm(false);
        setEditingProject(null);
        setProjectForm({ name: '', client_name: '', address: '', notes: '' });
        loadTab('projects');
      };

      const createCollection = async () => {
        if (!favName.trim()) return;
        await fetch(API + '/api/trade/favorites', { method: 'POST', headers, body: JSON.stringify({ collection_name: favName }) });
        setShowFavForm(false);
        setFavName('');
        loadTab('favorites');
      };

      const cancelMembership = async () => {
        if (!confirm('Cancel your trade membership? You will retain access until your current period ends.')) return;
        await fetch(API + '/api/trade/cancel-membership', { method: 'POST', headers: authHeaders });
        loadTab('account');
      };

      const deleteProject = async (id) => {
        if (!confirm('Delete this project? Orders will be unlinked but not deleted.')) return;
        await fetch(API + '/api/trade/projects/' + id, { method: 'DELETE', headers: authHeaders });
        loadTab('projects');
      };

      const deleteCollection = async (id) => {
        if (!confirm('Delete this collection and all its items?')) return;
        await fetch(API + '/api/trade/favorites/' + id, { method: 'DELETE', headers: authHeaders });
        loadTab('favorites');
      };

      const expandQuote = async (quoteId) => {
        if (expandedQuote === quoteId) { setExpandedQuote(null); setQuoteDetail(null); return; }
        setExpandedQuote(quoteId);
        const resp = await fetch(API + '/api/trade/quotes/' + quoteId, { headers: authHeaders });
        const data = await resp.json();
        setQuoteDetail(data);
      };

      const acceptQuote = async (quoteId) => {
        if (!confirm('Accept this quote and convert it to an order?')) return;
        const resp = await fetch(API + '/api/trade/quotes/' + quoteId + '/accept', { method: 'POST', headers: authHeaders });
        if (resp.ok) { alert('Quote accepted! Order has been created.'); loadTab('quotes'); }
        else { const d = await resp.json(); alert(d.error || 'Failed to accept quote'); }
      };

      const downloadQuotePdf = (quoteId) => {
        window.open(API + '/api/trade/quotes/' + quoteId + '/pdf?token=' + tradeToken, '_blank');
      };

      const assignOrderProject = async (orderId, projectId) => {
        await fetch(API + '/api/trade/orders/' + orderId + '/project', {
          method: 'PUT', headers, body: JSON.stringify({ project_id: projectId || null })
        });
        loadTab('orders');
      };

      const [editAccount, setEditAccount] = useState(false);
      const [accountForm, setAccountForm] = useState({});
      const [passwordForm, setPasswordForm] = useState({ current: '', new_password: '', confirm: '' });
      const [showPwForm, setShowPwForm] = useState(false);

      const saveAccount = async () => {
        await fetch(API + '/api/trade/account', { method: 'PUT', headers, body: JSON.stringify(accountForm) });
        setEditAccount(false);
        loadTab('account');
      };

      const changePassword = async () => {
        if (passwordForm.new_password !== passwordForm.confirm) { alert('Passwords do not match'); return; }
        const resp = await fetch(API + '/api/trade/change-password', {
          method: 'POST', headers, body: JSON.stringify({ current_password: passwordForm.current, new_password: passwordForm.new_password })
        });
        if (resp.ok) { alert('Password updated'); setShowPwForm(false); setPasswordForm({ current: '', new_password: '', confirm: '' }); }
        else { const d = await resp.json(); alert(d.error || 'Failed to change password'); }
      };

      const tabs = ['overview', 'orders', 'quotes', 'projects', 'favorites', 'account'];

      const tabIcons = {
        overview: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>,
        orders: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>,
        quotes: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
        projects: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>,
        favorites: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>,
        account: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      };

      const statIcons = {
        tier: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="stat-icon"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
        spend: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="stat-icon"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>,
        orders: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="stat-icon"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>,
        membership: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="stat-icon"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      };

      return (
        <div className="trade-dashboard">
          <div className="trade-dash-header">
            <h1>Trade Dashboard</h1>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', fontSize: '0.875rem', color: 'var(--stone-500)' }}>
              {tradeCustomer.company_name}
              <span className="trade-tier-badge">{tradeCustomer.tier_name || 'Silver'}</span>
            </div>
          </div>

          <div className="trade-dash-tabs">
            {tabs.map(t => (
              <button key={t} className={'trade-dash-tab' + (tab === t ? ' active' : '')} onClick={() => switchTab(t)}>
                {tabIcons[t]}
                {t.charAt(0).toUpperCase() + t.slice(1)}
              </button>
            ))}
          </div>

          {loading ? <div style={{ padding: '3rem', textAlign: 'center', color: 'var(--stone-400)' }}>Loading...</div> : (
            <>
              {/* ===== OVERVIEW ===== */}
              {tab === 'overview' && dashData && (
                <div>
                  <div className="trade-stat-grid">
                    <div className="trade-stat-card" style={{ background: 'linear-gradient(135deg, #fffbf0 0%, white 100%)' }}>
                      {statIcons.tier}
                      <label>Tier</label>
                      <div className="value">{dashData.tier_name || 'Silver'}</div>
                    </div>
                    <div className="trade-stat-card" style={{ background: 'linear-gradient(135deg, #f0fdf4 0%, white 100%)' }}>
                      {statIcons.spend}
                      <label>Total Spend</label>
                      <div className="value">${parseFloat(dashData.total_spend || 0).toLocaleString()}</div>
                    </div>
                    <div className="trade-stat-card" style={{ background: 'linear-gradient(135deg, #f0f9ff 0%, white 100%)' }}>
                      {statIcons.orders}
                      <label>Orders</label>
                      <div className="value">{dashData.order_count || 0}</div>
                    </div>
                    <div className="trade-stat-card" style={{ background: 'linear-gradient(135deg, #faf5ff 0%, white 100%)' }}>
                      {statIcons.membership}
                      <label>Membership</label>
                      <div className="value" style={{ fontSize: '1.25rem' }}>{dashData.subscription_status === 'active' ? 'Active' : dashData.subscription_status || 'Pending'}</div>
                    </div>
                  </div>

                  {dashData.next_tier_name && (
                    <div className="trade-tier-progress">
                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8125rem' }}>
                        <span>Progress to <strong>{dashData.next_tier_name}</strong></span>
                        <span>${parseFloat(dashData.total_spend || 0).toLocaleString()} / ${parseFloat(dashData.next_tier_threshold || 0).toLocaleString()}</span>
                      </div>
                      <div className="trade-tier-bar">
                        <div className="trade-tier-bar-fill" style={{ width: Math.min(100, (parseFloat(dashData.total_spend || 0) / parseFloat(dashData.next_tier_threshold || 1) * 100)) + '%' }}></div>
                      </div>
                    </div>
                  )}

                  {dashData.recent_orders && dashData.recent_orders.length > 0 && (
                    <div className="trade-card">
                      <h3>Recent Orders</h3>
                      <table className="trade-orders-table">
                        <thead><tr><th>Order #</th><th>Date</th><th>Total</th><th>Status</th></tr></thead>
                        <tbody>
                          {dashData.recent_orders.map(o => (
                            <tr key={o.id}>
                              <td style={{ fontWeight: 500 }}>{o.order_number}</td>
                              <td>{new Date(o.created_at).toLocaleDateString()}</td>
                              <td>${parseFloat(o.total).toFixed(2)}</td>
                              <td><span className={'trade-status-badge ' + (o.status || 'pending')}>{o.status}</span></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}

                  <div style={{ display: 'flex', gap: '1rem', marginTop: '1.5rem' }}>
                    <button className="btn" onClick={goShop}>Shop Products</button>
                    <button className="btn" style={{ background: 'white', color: 'var(--stone-800)', border: '1px solid var(--stone-300)' }} onClick={goBulkOrder}>Bulk Order</button>
                  </div>
                </div>
              )}

              {/* ===== ORDERS ===== */}
              {tab === 'orders' && (
                <div>
                  {orders.length === 0 ? (
                    <div className="trade-empty-state">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
                      <p>No orders yet</p>
                      <button className="btn" onClick={goShop}>Start Shopping</button>
                    </div>
                  ) : (
                    <table className="trade-orders-table">
                      <thead><tr><th>Order #</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th><th>PO #</th><th>Project</th><th></th></tr></thead>
                      <tbody>
                        {orders.map(o => (
                          <React.Fragment key={o.id}>
                            <tr onClick={() => setExpandedOrder(expandedOrder === o.id ? null : o.id)} style={{ cursor: 'pointer' }}>
                              <td style={{ fontWeight: 500 }}>{o.order_number}</td>
                              <td>{new Date(o.created_at).toLocaleDateString()}</td>
                              <td>{o.item_count}</td>
                              <td>${parseFloat(o.total).toFixed(2)}</td>
                              <td><span className={'trade-status-badge ' + (o.status || 'pending')}>{o.status}</span></td>
                              <td style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{o.po_number || '\u2014'}</td>
                              <td onClick={e => e.stopPropagation()}>
                                <select value={o.project_id || ''} onChange={e => assignOrderProject(o.id, e.target.value)}
                                  style={{ fontSize: '0.75rem', padding: '0.2rem', border: '1px solid var(--stone-300)' }}>
                                  <option value="">None</option>
                                  {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                              </td>
                              <td style={{ fontSize: '0.8125rem' }}>{expandedOrder === o.id ? '\u25B2' : '\u25BC'}</td>
                            </tr>
                            {expandedOrder === o.id && o.items && (
                              <tr><td colSpan="8" style={{ background: 'var(--stone-50)', padding: '1rem' }}>
                                {o.items.map((item, idx) => (
                                  <div key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.35rem 0', fontSize: '0.8125rem' }}>
                                    <span>{item.product_name}  {item.sku_code}</span>
                                    <span>{item.quantity}  ${parseFloat(item.unit_price).toFixed(2)}</span>
                                  </div>
                                ))}
                              </td></tr>
                            )}
                          </React.Fragment>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
              )}

              {/* ===== QUOTES ===== */}
              {tab === 'quotes' && (
                <div>
                  {quotes.length > 0 ? (
                    <div className="trade-card">
                      <table className="trade-orders-table">
                        <thead><tr><th>Quote #</th><th>Date</th><th>Items</th><th>Total</th><th>Expires</th><th>Status</th><th></th></tr></thead>
                        <tbody>
                          {quotes.map(q => {
                            const isExpired = q.expires_at && new Date(q.expires_at) < new Date();
                            const daysLeft = q.expires_at ? Math.ceil((new Date(q.expires_at) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                            const urgent = daysLeft !== null && daysLeft > 0 && daysLeft <= 3;
                            return (
                              <React.Fragment key={q.id}>
                                <tr style={{ cursor: 'pointer' }} onClick={() => expandQuote(q.id)}>
                                  <td style={{ fontWeight: 500 }}>{q.quote_number || 'Q-' + q.id.substring(0, 8).toUpperCase()}</td>
                                  <td>{new Date(q.created_at).toLocaleDateString()}</td>
                                  <td>{q.item_count || 0}</td>
                                  <td>${parseFloat(q.total || 0).toFixed(2)}</td>
                                  <td>
                                    {q.expires_at ? (
                                      <span style={{ color: isExpired ? '#dc2626' : urgent ? '#ea580c' : 'inherit', fontWeight: isExpired || urgent ? 600 : 400 }}>
                                        {isExpired ? 'Expired' : daysLeft + ' days left'}
                                      </span>
                                    ) : ''}
                                  </td>
                                  <td>
                                    <span className={'trade-status-badge ' + (q.status || 'draft')}>
                                      {q.status === 'converted' ? 'Accepted' : (q.status || 'draft').charAt(0).toUpperCase() + (q.status || 'draft').slice(1)}
                                    </span>
                                  </td>
                                  <td style={{ textAlign: 'right' }}>
                                    <button onClick={(e) => { e.stopPropagation(); downloadQuotePdf(q.id); }}
                                      style={{ background: 'none', border: 'none', color: 'var(--gold)', fontSize: '0.8125rem', cursor: 'pointer', fontWeight: 500, marginRight: '0.5rem' }}>PDF</button>
                                    {q.status !== 'converted' && !isExpired && (
                                      <button onClick={(e) => { e.stopPropagation(); acceptQuote(q.id); }}
                                        className="btn" style={{ padding: '0.25rem 0.75rem', fontSize: '0.75rem' }}>Accept</button>
                                    )}
                                  </td>
                                </tr>
                                {expandedQuote === q.id && quoteDetail && (
                                  <tr><td colSpan="7" style={{ padding: '1rem 1.5rem', background: '#fafaf9' }}>
                                    <table style={{ width: '100%', fontSize: '0.8125rem' }}>
                                      <thead><tr style={{ borderBottom: '1px solid var(--stone-200)' }}>
                                        <th style={{ padding: '0.5rem', fontWeight: 500 }}>Item</th>
                                        <th style={{ padding: '0.5rem', fontWeight: 500 }}>Description</th>
                                        <th style={{ padding: '0.5rem', fontWeight: 500, textAlign: 'right' }}>Qty</th>
                                        <th style={{ padding: '0.5rem', fontWeight: 500, textAlign: 'right' }}>Unit Price</th>
                                        <th style={{ padding: '0.5rem', fontWeight: 500, textAlign: 'right' }}>Subtotal</th>
                                      </tr></thead>
                                      <tbody>
                                        {(quoteDetail.items || []).map((item, i) => (
                                          <tr key={i} style={{ borderBottom: '1px solid #e7e5e4' }}>
                                            <td style={{ padding: '0.5rem' }}>{item.product_name || ''}</td>
                                            <td style={{ padding: '0.5rem' }}>{item.collection || item.description || ''}</td>
                                            <td style={{ padding: '0.5rem', textAlign: 'right' }}>{item.num_boxes || item.quantity || 1}</td>
                                            <td style={{ padding: '0.5rem', textAlign: 'right' }}>${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                                            <td style={{ padding: '0.5rem', textAlign: 'right' }}>${parseFloat(item.subtotal || 0).toFixed(2)}</td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                    <div style={{ textAlign: 'right', marginTop: '0.75rem', fontWeight: 500 }}>
                                      {parseFloat(q.shipping || 0) > 0 && <div style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>Shipping: ${parseFloat(q.shipping).toFixed(2)}</div>}
                                      <div>Total: ${parseFloat(q.total || 0).toFixed(2)}</div>
                                    </div>
                                  </td></tr>
                                )}
                              </React.Fragment>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  ) : (
                    <div className="trade-empty-state">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                      <p>No quotes yet. Contact your trade representative to request a custom quote.</p>
                    </div>
                  )}
                </div>
              )}

              {/* ===== PROJECTS ===== */}
              {tab === 'projects' && (
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                    <span style={{ fontSize: '0.875rem', color: 'var(--stone-500)' }}>{projects.length} project{projects.length !== 1 ? 's' : ''}</span>
                    <button className="btn" onClick={() => { setShowProjectForm(true); setEditingProject(null); setProjectForm({ name: '', client_name: '', address: '', notes: '' }); }}>
                      New Project
                    </button>
                  </div>

                  {showProjectForm && (
                    <div className="trade-card" style={{ marginBottom: '1.5rem' }}>
                      <h3>{editingProject ? 'Edit Project' : 'New Project'}</h3>
                      <div className="trade-field"><label>Project Name *</label><input type="text" value={projectForm.name} onChange={e => setProjectForm({ ...projectForm, name: e.target.value })} /></div>
                      <div className="trade-field"><label>Client Name</label><input type="text" value={projectForm.client_name} onChange={e => setProjectForm({ ...projectForm, client_name: e.target.value })} /></div>
                      <div className="trade-field"><label>Address</label><input type="text" value={projectForm.address} onChange={e => setProjectForm({ ...projectForm, address: e.target.value })} /></div>
                      <div className="trade-field"><label>Notes</label><input type="text" value={projectForm.notes} onChange={e => setProjectForm({ ...projectForm, notes: e.target.value })} /></div>
                      <div className="trade-btn-row">
                        <button type="button" className="trade-btn-secondary" onClick={() => setShowProjectForm(false)}>Cancel</button>
                        <button className="btn" onClick={saveProject} disabled={!projectForm.name}>Save</button>
                      </div>
                    </div>
                  )}

                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem' }}>
                    {projects.map(p => (
                      <div key={p.id} className="trade-project-card" onClick={() => {
                        setEditingProject(p.id);
                        setProjectForm({ name: p.name, client_name: p.client_name || '', address: p.address || '', notes: p.notes || '' });
                        setShowProjectForm(true);
                      }}>
                        <h4>{p.name}</h4>
                        {p.client_name && <div style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{p.client_name}</div>}
                        {p.address && <div style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{p.address}</div>}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '0.5rem' }}>
                          <span style={{ fontSize: '0.75rem', color: 'var(--stone-400)' }}>
                            {p.status || 'active'}  {p.order_count || 0} order{(p.order_count || 0) !== 1 ? 's' : ''}
                          </span>
                          <button onClick={e => { e.stopPropagation(); deleteProject(p.id); }}
                            style={{ background: 'none', border: 'none', color: '#dc2626', fontSize: '0.75rem', cursor: 'pointer' }}>Delete</button>
                        </div>
                      </div>
                    ))}
                  </div>
                  {projects.length === 0 && !showProjectForm && (
                    <div className="trade-empty-state">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
                      <p>No projects yet. Create one to organize your orders.</p>
                      <button className="btn" onClick={() => { setShowProjectForm(true); setEditingProject(null); setProjectForm({ name: '', client_name: '', address: '', notes: '' }); }}>New Project</button>
                    </div>
                  )}
                </div>
              )}

              {/* ===== FAVORITES ===== */}
              {tab === 'favorites' && (
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                    <span style={{ fontSize: '0.875rem', color: 'var(--stone-500)' }}>{favorites.length} collection{favorites.length !== 1 ? 's' : ''}</span>
                    <button className="btn" onClick={() => setShowFavForm(true)}>New Collection</button>
                  </div>

                  {showFavForm && (
                    <div className="trade-card" style={{ marginBottom: '1.5rem' }}>
                      <div className="trade-field"><label>Collection Name</label><input type="text" value={favName} onChange={e => setFavName(e.target.value)} /></div>
                      <div className="trade-btn-row">
                        <button type="button" className="trade-btn-secondary" onClick={() => setShowFavForm(false)}>Cancel</button>
                        <button className="btn" onClick={createCollection}>Create</button>
                      </div>
                    </div>
                  )}

                  {favorites.map(col => (
                    <div key={col.id} className="trade-card" style={{ marginBottom: '1rem' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h3>{col.collection_name}</h3>
                        <button onClick={() => deleteCollection(col.id)}
                          style={{ background: 'none', border: 'none', color: '#dc2626', fontSize: '0.8125rem', cursor: 'pointer' }}>Delete</button>
                      </div>
                      {col.items && col.items.length > 0 ? (
                        <div className="trade-fav-grid">
                          {col.items.map(item => (
                            <div key={item.id} className="trade-fav-item">
                              {item.primary_image_url ? <img src={item.primary_image_url} alt={item.product_name} /> : <div style={{ height: 140, background: 'var(--stone-100)' }}></div>}
                              <div className="name">{item.product_name}</div>
                              <button className="btn" style={{ marginTop: '0.5rem', fontSize: '0.75rem', padding: '0.35rem 0.75rem' }}
                                onClick={() => addToCart({ product_id: item.product_id, sku_id: item.sku_id, sqft_needed: 1, num_boxes: 1 })}>Add to Cart</button>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p style={{ color: 'var(--stone-400)', fontSize: '0.875rem' }}>No items in this collection yet. Browse products and add favorites.</p>
                      )}
                    </div>
                  ))}
                  {favorites.length === 0 && !showFavForm && (
                    <div className="trade-empty-state">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                      <p>No collections yet. Create one to save your favorite products.</p>
                      <button className="btn" onClick={() => setShowFavForm(true)}>New Collection</button>
                    </div>
                  )}
                </div>
              )}

              {/* ===== ACCOUNT ===== */}
              {tab === 'account' && account && (
                <div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                    <div className="trade-card">
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <h3>Company Information</h3>
                        {!editAccount && <button onClick={() => { setEditAccount(true); setAccountForm({ contact_name: account.contact_name, phone: account.phone || '', company_name: account.company_name }); }}
                          style={{ background: 'none', border: 'none', color: 'var(--gold)', fontSize: '0.8125rem', cursor: 'pointer', fontWeight: 500 }}>Edit</button>}
                      </div>
                      {editAccount ? (
                        <div>
                          <div className="trade-field"><label>Company Name</label><input value={accountForm.company_name || ''} onChange={e => setAccountForm({ ...accountForm, company_name: e.target.value })} /></div>
                          <div className="trade-field"><label>Contact Name</label><input value={accountForm.contact_name || ''} onChange={e => setAccountForm({ ...accountForm, contact_name: e.target.value })} /></div>
                          <div className="trade-field"><label>Phone</label><input value={accountForm.phone || ''} onChange={e => setAccountForm({ ...accountForm, phone: e.target.value })} /></div>
                          <div className="trade-btn-row">
                            <button type="button" className="trade-btn-secondary" onClick={() => setEditAccount(false)}>Cancel</button>
                            <button className="btn" onClick={saveAccount}>Save</button>
                          </div>
                        </div>
                      ) : (
                        <div style={{ fontSize: '0.875rem', lineHeight: 2 }}>
                          <div><strong>{account.company_name}</strong></div>
                          <div>{account.contact_name}</div>
                          <div>{account.email}</div>
                          {account.phone && <div>{account.phone}</div>}
                          {account.business_type && <div style={{ textTransform: 'capitalize' }}>{(account.business_type || '').replace('_', ' ')}</div>}
                        </div>
                      )}
                    </div>

                    <div className="trade-card">
                      <h3>Membership</h3>
                      <div style={{ fontSize: '0.875rem', lineHeight: 2 }}>
                        <div>Tier: <span className="trade-tier-badge">{account.tier_name || 'Silver'}</span></div>
                        <div>Status: {membership && membership.subscription_status === 'active' ? 'Active' : membership ? membership.subscription_status : 'Pending'}</div>
                        {membership && membership.subscription_expires_at && (
                          <div>Renews: {new Date(membership.subscription_expires_at).toLocaleDateString()}</div>
                        )}
                        <div>Total Spend: ${parseFloat(account.total_spend || 0).toLocaleString()}</div>
                      </div>
                      {membership && membership.subscription_status === 'active' && (
                        <button onClick={cancelMembership} style={{ marginTop: '1rem', background: 'none', border: '1px solid #dc2626', color: '#dc2626', padding: '0.5rem 1rem', fontSize: '0.8125rem', cursor: 'pointer' }}>
                          Cancel Membership
                        </button>
                      )}
                    </div>
                  </div>

                  {rep && (
                    <div className="trade-rep-card" style={{ marginTop: '1.5rem' }}>
                      <div className="trade-rep-avatar">{(rep.first_name || 'R').charAt(0)}{(rep.last_name || '').charAt(0)}</div>
                      <div>
                        <div style={{ fontWeight: 500, marginBottom: '0.25rem' }}>Your Trade Representative</div>
                        <div style={{ fontSize: '0.875rem', color: 'var(--stone-600)' }}>{rep.first_name} {rep.last_name}</div>
                        {rep.email && <div style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{rep.email}</div>}
                        {rep.phone && <div style={{ fontSize: '0.8125rem', color: 'var(--stone-500)' }}>{rep.phone}</div>}
                      </div>
                    </div>
                  )}

                  <div className="trade-card" style={{ marginTop: '1.5rem' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <h3>Security</h3>
                      {!showPwForm && <button onClick={() => setShowPwForm(true)}
                        style={{ background: 'none', border: 'none', color: 'var(--gold)', fontSize: '0.8125rem', cursor: 'pointer', fontWeight: 500 }}>Change Password</button>}
                    </div>
                    {showPwForm && (
                      <div>
                        <div className="trade-field"><label>Current Password</label><input type="password" value={passwordForm.current} onChange={e => setPasswordForm({ ...passwordForm, current: e.target.value })} /></div>
                        <div className="trade-field"><label>New Password</label><input type="password" value={passwordForm.new_password} onChange={e => setPasswordForm({ ...passwordForm, new_password: e.target.value })} /></div>
                        <div className="trade-field"><label>Confirm Password</label><input type="password" value={passwordForm.confirm} onChange={e => setPasswordForm({ ...passwordForm, confirm: e.target.value })} /></div>
                        <div className="trade-btn-row">
                          <button type="button" className="trade-btn-secondary" onClick={() => setShowPwForm(false)}>Cancel</button>
                          <button className="btn" onClick={changePassword} disabled={!passwordForm.current || !passwordForm.new_password}>Update Password</button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      );
    }

    // ========== Bulk Order Page ==========
    function BulkOrderPage({ tradeToken, addToCart, goTradeDashboard }) {
      const [rows, setRows] = useState([{ sku_code: '', quantity: '' }]);
      const [preview, setPreview] = useState(null);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const updateRow = (idx, field, value) => {
        setRows(prev => prev.map((r, i) => i === idx ? { ...r, [field]: value } : r));
      };

      const addRow = () => setRows(prev => [...prev, { sku_code: '', quantity: '' }]);
      const removeRow = (idx) => setRows(prev => prev.filter((_, i) => i !== idx));

      const validateOrder = async () => {
        setError('');
        setLoading(true);
        const items = rows.filter(r => r.sku_code.trim() && r.quantity).map(r => ({ sku_code: r.sku_code.trim(), quantity: parseInt(r.quantity) }));
        if (items.length === 0) { setError('Add at least one item.'); setLoading(false); return; }
        try {
          const resp = await fetch(API + '/api/trade/bulk-order', {
            method: 'POST',
            headers: { 'X-Trade-Token': tradeToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error || 'Validation failed'); setLoading(false); return; }
          setPreview(data);
        } catch (err) {
          setError('Network error.');
        }
        setLoading(false);
      };

      const confirmOrder = async () => {
        setLoading(true);
        try {
          const resp = await fetch(API + '/api/trade/bulk-order/confirm', {
            method: 'POST',
            headers: { 'X-Trade-Token': tradeToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: preview.validated_items })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          alert('Bulk order placed successfully!');
          goTradeDashboard();
        } catch (err) {
          setError('Failed to place order.');
        }
        setLoading(false);
      };

      return (
        <div className="trade-dashboard">
          <div className="trade-dash-header">
            <h1>Bulk Order</h1>
            <button className="btn" style={{ background: 'white', color: 'var(--stone-800)', border: '1px solid var(--stone-300)' }} onClick={goTradeDashboard}>Back to Dashboard</button>
          </div>

          {error && <div className="trade-msg trade-msg-error" style={{ marginBottom: '1rem' }}>{error}</div>}

          {!preview ? (
            <div className="trade-card">
              <p style={{ fontSize: '0.875rem', color: 'var(--stone-500)', marginBottom: '1.5rem' }}>Enter SKU codes and quantities. Click Validate to check availability and pricing.</p>
              <table className="bulk-order-table">
                <thead><tr><th>SKU Code</th><th style={{ width: 120 }}>Quantity</th><th style={{ width: 40 }}></th></tr></thead>
                <tbody>
                  {rows.map((r, i) => (
                    <tr key={i}>
                      <td><input value={r.sku_code} onChange={e => updateRow(i, 'sku_code', e.target.value)} placeholder="e.g. FLR-OAK-001" /></td>
                      <td><input type="number" min="1" value={r.quantity} onChange={e => updateRow(i, 'quantity', e.target.value)} placeholder="Qty" /></td>
                      <td>{rows.length > 1 && <button className="remove-btn" onClick={() => removeRow(i)}>&times;</button>}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div style={{ display: 'flex', gap: '0.75rem', marginTop: '1rem' }}>
                <button onClick={addRow} style={{ background: 'none', border: '1px dashed var(--stone-300)', padding: '0.5rem 1rem', cursor: 'pointer', fontSize: '0.8125rem', color: 'var(--stone-500)' }}>+ Add Row</button>
                <button className="btn" onClick={validateOrder} disabled={loading}>{loading ? 'Validating...' : 'Validate Order'}</button>
              </div>
            </div>
          ) : (
            <div className="trade-card">
              <h3>Order Preview</h3>
              <table className="trade-orders-table">
                <thead><tr><th>SKU</th><th>Product</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr></thead>
                <tbody>
                  {preview.validated_items.map((item, i) => (
                    <tr key={i}>
                      <td style={{ fontWeight: 500 }}>{item.sku_code}</td>
                      <td>{item.product_name}</td>
                      <td>{item.quantity}</td>
                      <td>${parseFloat(item.unit_price).toFixed(2)}</td>
                      <td>${parseFloat(item.subtotal).toFixed(2)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {preview.errors && preview.errors.length > 0 && (
                <div style={{ marginTop: '1rem' }}>
                  {preview.errors.map((err, i) => <div key={i} className="trade-msg trade-msg-error">{err}</div>)}
                </div>
              )}
              <div style={{ textAlign: 'right', marginTop: '1rem', fontSize: '1.125rem', fontWeight: 500 }}>
                Total: ${parseFloat(preview.total || 0).toFixed(2)}
              </div>
              <div className="trade-btn-row" style={{ marginTop: '1.5rem' }}>
                <button type="button" className="trade-btn-secondary" onClick={() => setPreview(null)}>Edit</button>
                <button className="btn" onClick={confirmOrder} disabled={loading}>{loading ? 'Placing Order...' : 'Place Order'}</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function TradePage({ onApplyClick, onSignInClick }) {
      const checkSvg = React.createElement('svg', { viewBox: '0 0 24 24' },
        React.createElement('polyline', { points: '20 6 9 17 4 12' })
      );
      return (
        <div>
          {/* Hero */}
          <section className="trade-page-hero">
            <h1>Trade Program</h1>
            <p>Exclusive pricing, dedicated support, and priority access for design professionals, contractors, and trade partners.</p>
            <button className="trade-hero-btn" onClick={onApplyClick}>Apply Now</button>
          </section>

          {/* Benefits */}
          <section className="trade-benefits">
            <h2>Why Join Our Trade Program</h2>
            <p>Built for professionals who demand more from their suppliers.</p>
            <div className="trade-benefits-grid">
              <div className="trade-benefit-card">
                <svg viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></svg>
                <h3>Tiered Pricing</h3>
                <p>Up to 20% off retail pricing with volume-based tier progression across our full catalog.</p>
              </div>
              <div className="trade-benefit-card">
                <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>
                <h3>Dedicated Support</h3>
                <p>A dedicated trade representative to assist with specifications, sourcing, and project coordination.</p>
              </div>
              <div className="trade-benefit-card">
                <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg>
                <h3>Priority Access</h3>
                <p>Early access to new collections, limited-edition materials, and exclusive trade-only products.</p>
              </div>
              <div className="trade-benefit-card">
                <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13" /><polygon points="16 8 20 8 23 11 23 16 16 16 16 8" /><circle cx="5.5" cy="18.5" r="2.5" /><circle cx="18.5" cy="18.5" r="2.5" /></svg>
                <h3>Streamlined Ordering</h3>
                <p>Net terms available, consolidated shipping, and a simplified ordering process for large projects.</p>
              </div>
            </div>
          </section>

          {/* How It Works */}
          <section className="trade-how-it-works">
            <h2>How It Works</h2>
            <div className="trade-steps">
              <div className="trade-step">
                <div className="trade-step-number">1</div>
                <h3>Apply</h3>
                <p>Fill out a quick application with your business details and credentials. It only takes a minute.</p>
              </div>
              <div className="trade-step">
                <div className="trade-step-number">2</div>
                <h3>Get Approved</h3>
                <p>Our team reviews your application and assigns your starting tier based on your business profile.</p>
              </div>
              <div className="trade-step">
                <div className="trade-step-number">3</div>
                <h3>Shop at Trade Prices</h3>
                <p>Log in to see your exclusive pricing across our entire catalog and start ordering immediately.</p>
              </div>
            </div>
          </section>

          {/* Tier Overview */}
          <section className="trade-tiers">
            <h2>Trade Tier Overview</h2>
            <p>Your discount grows as your relationship with us deepens.</p>
            <div className="trade-tiers-grid">
              <div className="trade-tier-card">
                <h3>Silver</h3>
                <div className="tier-discount">10% Off</div>
                <ul>
                  <li>{checkSvg} Trade pricing on all products</li>
                  <li>{checkSvg} Dedicated trade support</li>
                  <li>{checkSvg} Priority order processing</li>
                  <li>{checkSvg} Access to trade portal</li>
                </ul>
              </div>
              <div className="trade-tier-card featured">
                <span className="tier-badge">Most Popular</span>
                <h3>Gold</h3>
                <div className="tier-discount">15% Off</div>
                <ul>
                  <li>{checkSvg} Everything in Silver</li>
                  <li>{checkSvg} Early access to new collections</li>
                  <li>{checkSvg} Net-30 payment terms</li>
                  <li>{checkSvg} Free sample program</li>
                </ul>
              </div>
              <div className="trade-tier-card">
                <h3>Platinum</h3>
                <div className="tier-discount">20% Off</div>
                <ul>
                  <li>{checkSvg} Everything in Gold</li>
                  <li>{checkSvg} Custom project pricing</li>
                  <li>{checkSvg} Net-60 payment terms</li>
                  <li>{checkSvg} Dedicated account manager</li>
                </ul>
              </div>
            </div>
          </section>

          {/* Bottom CTA */}
          <section className="trade-cta-section">
            <h2>Ready to Get Started?</h2>
            <p>Join hundreds of design professionals who trust Roma Flooring Designs for their projects.</p>
            <div className="trade-cta-buttons">
              <button className="trade-cta-btn-primary" onClick={onApplyClick}>Apply Now</button>
              <button className="trade-cta-btn-secondary" onClick={onSignInClick}>Sign In</button>
            </div>
          </section>
        </div>
      );
    }

    // ==================== Customer Auth Modal ====================
    function CustomerAuthModal({ onClose, onLogin, initialMode }) {
      const [mode, setMode] = useState(initialMode || 'login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [firstName, setFirstName] = useState('');
      const [lastName, setLastName] = useState('');
      const [phone, setPhone] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [loading, setLoading] = useState(false);

      const formatPhone = (val) => {
        const digits = val.replace(/\D/g, '').slice(0, 10);
        if (digits.length === 0) return '';
        if (digits.length <= 3) return '(' + digits;
        if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
        return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError(''); setLoading(true);
        try {
          const resp = await fetch(API + '/api/customer/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          onLogin(data.token, data.customer);
        } catch {
          setError('Network error. Please try again.');
        }
        setLoading(false);
      };

      const handleRegister = async (e) => {
        e.preventDefault();
        setError('');
        if (password !== confirmPassword) { setError('Passwords do not match'); return; }
        if (password.length < 8 || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
          setError('Password must be at least 8 characters with 1 uppercase letter and 1 number');
          return;
        }
        setLoading(true);
        try {
          const resp = await fetch(API + '/api/customer/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, first_name: firstName, last_name: lastName, phone })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          onLogin(data.token, data.customer);
        } catch {
          setError('Network error. Please try again.');
        }
        setLoading(false);
      };

      const handleForgot = async (e) => {
        e.preventDefault();
        setError(''); setSuccess(''); setLoading(true);
        try {
          await fetch(API + '/api/customer/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          setSuccess('If an account exists with that email, we\'ve sent a reset link.');
        } catch {
          setSuccess('If an account exists with that email, we\'ve sent a reset link.');
        }
        setLoading(false);
      };

      const modalStyle = {
        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)',
        display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
      };
      const boxStyle = {
        background: '#fff', maxWidth: 440, width: '90%', maxHeight: '90vh', overflow: 'auto',
        padding: '2.5rem', position: 'relative'
      };
      const inputStyle = {
        width: '100%', padding: '0.65rem 0.75rem', border: '1px solid var(--stone-200)',
        fontSize: '0.875rem', fontFamily: 'Inter, sans-serif', outline: 'none',
        transition: 'border-color 0.2s'
      };
      const labelStyle = { display: 'block', marginBottom: '0.35rem', fontSize: '0.8125rem', fontWeight: 500, color: 'var(--stone-800)' };
      const fieldStyle = { marginBottom: '1rem' };

      return (
        <div style={modalStyle} onClick={onClose}>
          <div style={boxStyle} onClick={e => e.stopPropagation()}>
            <div onClick={onClose} style={{ position: 'absolute', top: '1rem', right: '1rem', cursor: 'pointer', fontSize: '1.25rem', color: 'var(--stone-500)' }}>&times;</div>

            <h2 style={{ fontFamily: "'Cormorant Garamond', Georgia, serif", fontSize: '1.75rem', fontWeight: 400, marginBottom: '1.5rem', textAlign: 'center' }}>
              {mode === 'login' ? 'Sign In' : mode === 'register' ? 'Create Account' : 'Reset Password'}
            </h2>

            {error && <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#991b1b', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{error}</div>}
            {success && <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', color: '#166534', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{success}</div>}

            {mode === 'login' && (
              <form onSubmit={handleLogin}>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Email</label>
                  <input style={inputStyle} type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="you@example.com" required />
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Password</label>
                  <input style={inputStyle} type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Your password" required />
                </div>
                <button className="btn" style={{ width: '100%', marginBottom: '1rem' }} disabled={loading}>
                  {loading ? 'Signing in...' : 'Sign In'}
                </button>
                <div style={{ textAlign: 'center', fontSize: '0.8125rem' }}>
                  <a onClick={() => { setMode('forgot'); setError(''); setSuccess(''); }} style={{ color: 'var(--gold)', cursor: 'pointer' }}>Forgot password?</a>
                  <span style={{ margin: '0 0.5rem', color: 'var(--stone-400)' }}>|</span>
                  <a onClick={() => { setMode('register'); setError(''); setSuccess(''); }} style={{ color: 'var(--gold)', cursor: 'pointer' }}>Create account</a>
                </div>
              </form>
            )}

            {mode === 'register' && (
              <form onSubmit={handleRegister}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                  <div style={fieldStyle}>
                    <label style={labelStyle}>First Name *</label>
                    <input style={inputStyle} value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="John" required />
                  </div>
                  <div style={fieldStyle}>
                    <label style={labelStyle}>Last Name *</label>
                    <input style={inputStyle} value={lastName} onChange={e => setLastName(e.target.value)} placeholder="Smith" required />
                  </div>
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Email *</label>
                  <input style={inputStyle} type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="you@example.com" required />
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Phone</label>
                  <input style={inputStyle} type="tel" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} placeholder="(555) 123-4567" />
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                  <div style={fieldStyle}>
                    <label style={labelStyle}>Password *</label>
                    <input style={inputStyle} type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Min 8 characters" required />
                  </div>
                  <div style={fieldStyle}>
                    <label style={labelStyle}>Confirm Password *</label>
                    <input style={inputStyle} type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} placeholder="Confirm" required />
                  </div>
                </div>
                <p style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '1rem' }}>8+ characters, 1 uppercase letter, 1 number</p>
                <button className="btn" style={{ width: '100%', marginBottom: '1rem' }} disabled={loading}>
                  {loading ? 'Creating Account...' : 'Create Account'}
                </button>
                <div style={{ textAlign: 'center', fontSize: '0.8125rem' }}>
                  <span style={{ color: 'var(--stone-600)' }}>Already have an account? </span>
                  <a onClick={() => { setMode('login'); setError(''); setSuccess(''); }} style={{ color: 'var(--gold)', cursor: 'pointer' }}>Sign in</a>
                </div>
              </form>
            )}

            {mode === 'forgot' && (
              <form onSubmit={handleForgot}>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Email</label>
                  <input style={inputStyle} type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="you@example.com" required />
                </div>
                <button className="btn" style={{ width: '100%', marginBottom: '1rem' }} disabled={loading}>
                  {loading ? 'Sending...' : 'Send Reset Link'}
                </button>
                <div style={{ textAlign: 'center', fontSize: '0.8125rem' }}>
                  <a onClick={() => { setMode('login'); setError(''); setSuccess(''); }} style={{ color: 'var(--gold)', cursor: 'pointer' }}>Back to Sign In</a>
                </div>
              </form>
            )}
          </div>
        </div>
      );
    }

    // ==================== Account Page ====================
    function AccountPage({ customer, customerToken, setCustomer, goHome }) {
      const [tab, setTab] = useState('orders');
      const [orders, setOrders] = useState([]);
      const [expandedOrder, setExpandedOrder] = useState(null);
      const [orderDetail, setOrderDetail] = useState(null);
      const [loadingOrders, setLoadingOrders] = useState(true);

      // Profile state
      const [firstName, setFirstName] = useState(customer.first_name || '');
      const [lastName, setLastName] = useState(customer.last_name || '');
      const [phone, setPhone] = useState(customer.phone || '');
      const [addressLine1, setAddressLine1] = useState(customer.address_line1 || '');
      const [addressLine2, setAddressLine2] = useState(customer.address_line2 || '');
      const [city, setCity] = useState(customer.city || '');
      const [addrState, setAddrState] = useState(customer.state || '');
      const [zip, setZip] = useState(customer.zip || '');
      const [profileMsg, setProfileMsg] = useState('');
      const [profileError, setProfileError] = useState('');
      const [saving, setSaving] = useState(false);

      // Password state
      const [currentPw, setCurrentPw] = useState('');
      const [newPw, setNewPw] = useState('');
      const [confirmPw, setConfirmPw] = useState('');
      const [pwMsg, setPwMsg] = useState('');
      const [pwError, setPwError] = useState('');
      const [pwSaving, setPwSaving] = useState(false);

      const headers = { 'X-Customer-Token': customerToken, 'Content-Type': 'application/json' };
      const authHeaders = { 'X-Customer-Token': customerToken };

      useEffect(() => {
        fetch(API + '/api/customer/orders', { headers: authHeaders })
          .then(r => r.json())
          .then(data => { setOrders(data.orders || []); setLoadingOrders(false); })
          .catch(() => setLoadingOrders(false));
      }, []);

      const viewOrderDetail = async (orderId) => {
        if (expandedOrder === orderId) { setExpandedOrder(null); setOrderDetail(null); return; }
        setExpandedOrder(orderId);
        try {
          const resp = await fetch(API + '/api/customer/orders/' + orderId, { headers: authHeaders });
          const data = await resp.json();
          setOrderDetail(data);
        } catch {
          setOrderDetail(null);
        }
      };

      const saveProfile = async () => {
        setSaving(true); setProfileMsg(''); setProfileError('');
        try {
          const resp = await fetch(API + '/api/customer/profile', {
            method: 'PUT', headers,
            body: JSON.stringify({ first_name: firstName, last_name: lastName, phone, address_line1: addressLine1, address_line2: addressLine2, city, state: addrState, zip })
          });
          const data = await resp.json();
          if (!resp.ok) { setProfileError(data.error); setSaving(false); return; }
          setCustomer(data.customer);
          setProfileMsg('Profile updated successfully.');
        } catch { setProfileError('Failed to save.'); }
        setSaving(false);
      };

      const changePassword = async () => {
        setPwSaving(true); setPwMsg(''); setPwError('');
        if (newPw !== confirmPw) { setPwError('Passwords do not match.'); setPwSaving(false); return; }
        try {
          const resp = await fetch(API + '/api/customer/password', {
            method: 'PUT', headers,
            body: JSON.stringify({ current_password: currentPw, new_password: newPw })
          });
          const data = await resp.json();
          if (!resp.ok) { setPwError(data.error); setPwSaving(false); return; }
          setPwMsg('Password updated successfully.');
          setCurrentPw(''); setNewPw(''); setConfirmPw('');
        } catch { setPwError('Failed to update password.'); }
        setPwSaving(false);
      };

      const formatPhone = (val) => {
        const digits = val.replace(/\D/g, '').slice(0, 10);
        if (digits.length === 0) return '';
        if (digits.length <= 3) return '(' + digits;
        if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
        return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
      };

      const statusBadge = (status) => {
        const colors = {
          pending: { bg: '#fef3c7', text: '#92400e' },
          confirmed: { bg: '#dbeafe', text: '#1e40af' },
          shipped: { bg: '#e0e7ff', text: '#3730a3' },
          delivered: { bg: '#dcfce7', text: '#166534' },
          cancelled: { bg: '#fef2f2', text: '#991b1b' }
        };
        const c = colors[status] || colors.pending;
        return (
          <span style={{ display: 'inline-block', padding: '0.2rem 0.6rem', fontSize: '0.7rem', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', background: c.bg, color: c.text, borderRadius: '3px' }}>
            {status}
          </span>
        );
      };

      const US_STATES = [
        'AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY',
        'LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND',
        'OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'
      ];

      const inputStyle = {
        width: '100%', padding: '0.65rem 0.75rem', border: '1px solid var(--stone-200)',
        fontSize: '0.875rem', fontFamily: 'Inter, sans-serif', outline: 'none'
      };
      const labelStyle = { display: 'block', marginBottom: '0.35rem', fontSize: '0.8125rem', fontWeight: 500, color: 'var(--stone-800)' };
      const fieldStyle = { marginBottom: '1rem' };

      return (
        <div style={{ maxWidth: 900, margin: '3rem auto', padding: '0 1.5rem' }}>
          <h1 style={{ fontFamily: "'Cormorant Garamond', Georgia, serif", fontSize: '2rem', fontWeight: 400, marginBottom: '0.5rem' }}>
            My Account
          </h1>
          <p style={{ color: 'var(--stone-600)', fontSize: '0.875rem', marginBottom: '2rem' }}>
            Welcome back, {customer.first_name}
          </p>

          {/* Tabs */}
          <div style={{ display: 'flex', gap: '2rem', borderBottom: '1px solid var(--stone-200)', marginBottom: '2rem' }}>
            {['orders', 'profile'].map(t => (
              <button key={t} onClick={() => setTab(t)}
                style={{
                  background: 'none', border: 'none', padding: '0.75rem 0', cursor: 'pointer',
                  fontSize: '0.875rem', fontWeight: 500, fontFamily: 'Inter, sans-serif',
                  color: tab === t ? 'var(--stone-900)' : 'var(--stone-500)',
                  borderBottom: tab === t ? '2px solid var(--gold)' : '2px solid transparent',
                  marginBottom: '-1px', textTransform: 'capitalize'
                }}>
                {t === 'orders' ? 'Order History' : 'Profile'}
              </button>
            ))}
          </div>

          {/* Orders Tab */}
          {tab === 'orders' && (
            <div>
              {loadingOrders ? (
                <p style={{ color: 'var(--stone-500)', fontSize: '0.875rem' }}>Loading orders...</p>
              ) : orders.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '3rem 0' }}>
                  <p style={{ color: 'var(--stone-500)', marginBottom: '1rem' }}>No orders yet.</p>
                  <button className="btn" onClick={goHome}>Start Shopping</button>
                </div>
              ) : (
                <div>
                  {orders.map(order => (
                    <div key={order.id} style={{ border: '1px solid var(--stone-200)', marginBottom: '0.75rem' }}>
                      <div onClick={() => viewOrderDetail(order.id)}
                        style={{
                          display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '1rem 1.25rem',
                          cursor: 'pointer', background: expandedOrder === order.id ? 'var(--stone-50)' : '#fff'
                        }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '1.5rem', flex: 1, flexWrap: 'wrap' }}>
                          <span style={{ fontWeight: 500, fontSize: '0.875rem' }}>{order.order_number}</span>
                          <span style={{ color: 'var(--stone-500)', fontSize: '0.8125rem' }}>
                            {new Date(order.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                          </span>
                          {statusBadge(order.status)}
                          <span style={{ fontWeight: 500, fontSize: '0.875rem' }}>
                            ${parseFloat(order.total).toFixed(2)}
                          </span>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
                          width: 16, height: 16, transform: expandedOrder === order.id ? 'rotate(180deg)' : 'rotate(0)', transition: 'transform 0.2s'
                        }}><polyline points="6 9 12 15 18 9"/></svg>
                      </div>

                      {expandedOrder === order.id && orderDetail && (
                        <div style={{ padding: '1.25rem', borderTop: '1px solid var(--stone-200)', background: 'var(--stone-50)' }}>
                          {/* Tracking */}
                          {orderDetail.order.tracking_number && (
                            <div style={{ background: '#dbeafe', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem', color: '#1e40af' }}>
                              Tracking: {orderDetail.order.shipping_carrier && <strong>{orderDetail.order.shipping_carrier} </strong>}
                              {orderDetail.order.tracking_number}
                              {orderDetail.order.shipped_at && <span style={{ marginLeft: '0.5rem' }}>
                                (Shipped {new Date(orderDetail.order.shipped_at).toLocaleDateString()})
                              </span>}
                            </div>
                          )}

                          {/* Status timeline */}
                          <div style={{ display: 'flex', gap: '0', marginBottom: '1.25rem', fontSize: '0.75rem' }}>
                            {['pending', 'confirmed', 'shipped', 'delivered'].map((s, i) => {
                              const steps = ['pending', 'confirmed', 'shipped', 'delivered'];
                              const currentIdx = steps.indexOf(orderDetail.order.status);
                              const isActive = i <= currentIdx;
                              return (
                                <div key={s} style={{ flex: 1, textAlign: 'center' }}>
                                  <div style={{
                                    width: 24, height: 24, borderRadius: '50%', margin: '0 auto 0.35rem',
                                    background: isActive ? 'var(--gold)' : 'var(--stone-200)',
                                    color: isActive ? '#fff' : 'var(--stone-500)',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    fontSize: '0.7rem', fontWeight: 600
                                  }}>{i + 1}</div>
                                  <span style={{ color: isActive ? 'var(--stone-800)' : 'var(--stone-400)', textTransform: 'capitalize' }}>{s}</span>
                                </div>
                              );
                            })}
                          </div>

                          {/* Items */}
                          <div style={{ marginBottom: '1rem' }}>
                            <h4 style={{ fontSize: '0.8125rem', fontWeight: 500, marginBottom: '0.5rem' }}>Items</h4>
                            {orderDetail.items.map(item => (
                              <div key={item.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.4rem 0', borderBottom: '1px solid var(--stone-100)', fontSize: '0.8125rem' }}>
                                <span>{item.product_name || 'Product'} {item.is_sample ? '(Sample)' : `x${item.num_boxes} box${item.num_boxes !== 1 ? 'es' : ''}`}</span>
                                <span style={{ fontWeight: 500 }}>${parseFloat(item.subtotal || 0).toFixed(2)}</span>
                              </div>
                            ))}
                          </div>

                          {/* Shipping address */}
                          {orderDetail.order.shipping_address_line1 && (
                            <div style={{ fontSize: '0.8125rem', color: 'var(--stone-600)' }}>
                              <strong>Ships to:</strong> {orderDetail.order.shipping_address_line1}
                              {orderDetail.order.shipping_address_line2 && ', ' + orderDetail.order.shipping_address_line2}
                              , {orderDetail.order.shipping_city}, {orderDetail.order.shipping_state} {orderDetail.order.shipping_zip}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Profile Tab */}
          {tab === 'profile' && (
            <div>
              {profileMsg && <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', color: '#166534', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{profileMsg}</div>}
              {profileError && <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#991b1b', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{profileError}</div>}

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                <div style={fieldStyle}>
                  <label style={labelStyle}>First Name</label>
                  <input style={inputStyle} value={firstName} onChange={e => setFirstName(e.target.value)} />
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Last Name</label>
                  <input style={inputStyle} value={lastName} onChange={e => setLastName(e.target.value)} />
                </div>
              </div>
              <div style={fieldStyle}>
                <label style={labelStyle}>Email</label>
                <input style={{ ...inputStyle, background: 'var(--stone-100)', color: 'var(--stone-500)' }} value={customer.email} readOnly />
              </div>
              <div style={fieldStyle}>
                <label style={labelStyle}>Phone</label>
                <input style={inputStyle} type="tel" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} placeholder="(555) 123-4567" />
              </div>

              <h3 style={{ fontSize: '1rem', fontWeight: 500, marginTop: '1.5rem', marginBottom: '1rem' }}>Saved Address</h3>
              <div style={fieldStyle}>
                <label style={labelStyle}>Address Line 1</label>
                <input style={inputStyle} value={addressLine1} onChange={e => setAddressLine1(e.target.value)} placeholder="123 Main Street" />
              </div>
              <div style={fieldStyle}>
                <label style={labelStyle}>Address Line 2</label>
                <input style={inputStyle} value={addressLine2} onChange={e => setAddressLine2(e.target.value)} placeholder="Apt, Suite, Unit" />
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '0.75rem' }}>
                <div style={fieldStyle}>
                  <label style={labelStyle}>City</label>
                  <input style={inputStyle} value={city} onChange={e => setCity(e.target.value)} />
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>State</label>
                  <select style={{ ...inputStyle, padding: '0.65rem 0.5rem' }} value={addrState} onChange={e => setAddrState(e.target.value)}>
                    <option value="">Select</option>
                    {US_STATES.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>ZIP</label>
                  <input style={inputStyle} value={zip} onChange={e => setZip(e.target.value)} />
                </div>
              </div>
              <button className="btn" onClick={saveProfile} disabled={saving} style={{ marginBottom: '2.5rem' }}>
                {saving ? 'Saving...' : 'Save Changes'}
              </button>

              <h3 style={{ fontSize: '1rem', fontWeight: 500, marginBottom: '1rem', paddingTop: '1.5rem', borderTop: '1px solid var(--stone-200)' }}>Change Password</h3>
              {pwMsg && <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', color: '#166534', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{pwMsg}</div>}
              {pwError && <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#991b1b', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{pwError}</div>}
              <div style={fieldStyle}>
                <label style={labelStyle}>Current Password</label>
                <input style={inputStyle} type="password" value={currentPw} onChange={e => setCurrentPw(e.target.value)} />
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                <div style={fieldStyle}>
                  <label style={labelStyle}>New Password</label>
                  <input style={inputStyle} type="password" value={newPw} onChange={e => setNewPw(e.target.value)} />
                </div>
                <div style={fieldStyle}>
                  <label style={labelStyle}>Confirm New Password</label>
                  <input style={inputStyle} type="password" value={confirmPw} onChange={e => setConfirmPw(e.target.value)} />
                </div>
              </div>
              <p style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '1rem' }}>8+ characters, 1 uppercase letter, 1 number</p>
              <button className="btn" onClick={changePassword} disabled={pwSaving}>
                {pwSaving ? 'Updating...' : 'Update Password'}
              </button>
            </div>
          )}
        </div>
      );
    }

    // ==================== Reset Password Page ====================
    function ResetPasswordPage({ goHome, openLogin }) {
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);
      const [loading, setLoading] = useState(false);

      const token = new URLSearchParams(window.location.search).get('reset_token');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (newPassword !== confirmPassword) { setError('Passwords do not match.'); return; }
        if (newPassword.length < 8 || !/[A-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
          setError('Password must be at least 8 characters with 1 uppercase letter and 1 number.');
          return;
        }
        setLoading(true);
        try {
          const resp = await fetch(API + '/api/customer/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, new_password: newPassword })
          });
          const data = await resp.json();
          if (!resp.ok) { setError(data.error); setLoading(false); return; }
          setSuccess(true);
          // Clean URL
          window.history.replaceState({}, '', window.location.pathname);
        } catch {
          setError('Something went wrong. Please try again.');
        }
        setLoading(false);
      };

      const inputStyle = {
        width: '100%', padding: '0.65rem 0.75rem', border: '1px solid var(--stone-200)',
        fontSize: '0.875rem', fontFamily: 'Inter, sans-serif', outline: 'none'
      };

      return (
        <div style={{ maxWidth: 440, margin: '4rem auto', padding: '0 1.5rem' }}>
          <h1 style={{ fontFamily: "'Cormorant Garamond', Georgia, serif", fontSize: '2rem', fontWeight: 400, marginBottom: '1.5rem', textAlign: 'center' }}>
            Reset Your Password
          </h1>

          {success ? (
            <div style={{ textAlign: 'center' }}>
              <div style={{ background: '#f0fdf4', border: '1px solid #bbf7d0', color: '#166534', padding: '1rem', marginBottom: '1.5rem', fontSize: '0.875rem' }}>
                Your password has been reset successfully.
              </div>
              <button className="btn" onClick={() => { goHome(); setTimeout(openLogin, 100); }}>
                Sign In
              </button>
            </div>
          ) : (
            <form onSubmit={handleSubmit}>
              {error && <div style={{ background: '#fef2f2', border: '1px solid #fecaca', color: '#991b1b', padding: '0.75rem 1rem', marginBottom: '1rem', fontSize: '0.8125rem' }}>{error}</div>}
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', marginBottom: '0.35rem', fontSize: '0.8125rem', fontWeight: 500 }}>New Password</label>
                <input style={inputStyle} type="password" value={newPassword} onChange={e => setNewPassword(e.target.value)} required />
              </div>
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ display: 'block', marginBottom: '0.35rem', fontSize: '0.8125rem', fontWeight: 500 }}>Confirm New Password</label>
                <input style={inputStyle} type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} required />
              </div>
              <p style={{ fontSize: '0.75rem', color: 'var(--stone-500)', marginBottom: '1rem' }}>8+ characters, 1 uppercase letter, 1 number</p>
              <button className="btn" style={{ width: '100%' }} disabled={loading}>
                {loading ? 'Resetting...' : 'Reset Password'}
              </button>
            </form>
          )}
        </div>
      );
    }

    function Footer({ onInstallClick }) {
      return (
        <footer>
          <p style={{ marginBottom: '0.5rem' }}>
            <span onClick={onInstallClick} style={{ color: '#c9a96e', cursor: 'pointer', fontSize: '0.8125rem', letterSpacing: '0.04em' }}
              onMouseOver={e => e.target.style.textDecoration = 'underline'}
              onMouseOut={e => e.target.style.textDecoration = 'none'}>
              Installation Services
            </span>
          </p>
          <p> 2026 Roma Flooring Designs</p>
        </footer>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
